# ุฏููู ุงูุชุฑุญูู - ูุธุงู ุงูุตูุงุญูุงุช ุงูููุญุฏ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ููุถุญ ููููุฉ ุชุฑุญูู ุงููุธุงู ูู ุงููุธุงู ุงููุฏูู (ูููุตู Capabilities/ Roles) ุฅูู ุงููุธุงู ุงูุฌุฏูุฏ ุงูููุญุฏ.

## ๐ ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ

- โ Node.js 18+
- โ MongoDB 4.4+
- โ npm ุฃู yarn
- โ Backup ุญุฏูุซ ููุงุนุฏุฉ ุงูุจูุงูุงุช

## ๐๏ธ ุงููููุงุช ุงููููุฉ

```
scripts/
โโโ migrate-capabilities-to-user.ts    # Script ุงูุชุฑุญูู ุงูุฑุฆูุณู
โโโ cleanup-capabilities.ts           # ุชูุธูู ุงูุจูุงูุงุช ุงููุฏููุฉ
โโโ run-migration.ts                  # Runner ููุชุฑุญูู

src/modules/audit/                    # ูุธุงู ุงูุชุฏููู ุงูุฌุฏูุฏ
โโโ schemas/audit-log.schema.ts
โโโ audit.controller.ts
โโโ audit.module.ts
```

## ๐ ุฎุทูุงุช ุงูุชุฑุญูู

### ุงูุฎุทูุฉ 1: ุงูุชุญุถูุฑ

```bash
# 1. ุฅูุดุงุก backup ุดุงูู
mongodump --db solar-commerce --out backup-$(date +%Y%m%d-%H%M%S)

# 2. ุชุดุบูู ุงูุฎุงุฏู ูู ูุถุน ุงูุชุทููุฑ
npm run start:dev

# 3. ุงูุชุฃูุฏ ูู ุนูู ุงูุฎุงุฏู
curl http://localhost:3000/health
```

### ุงูุฎุทูุฉ 2: ุงูุชุฑุญูู

```bash
# ุชุดุบูู script ุงูุชุฑุญูู
npm run migrate:capabilities

# ุงููุชููุน ูู ุงูุฅุฎุฑุงุฌ:
# ๐ ุจุฏุก ุชุฑุญูู ุงูุจูุงูุงุช ูู Capabilities ุฅูู User...
# ๐ ุนุฏุฏ ุณุฌูุงุช Capabilities: X
# โ ุชู ุชุฑุญูู ูุณุชุฎุฏู: +966XXXXXXXXX
# ๐ ุชูุฑูุฑ ุงูุชุฑุญูู:
# โ ุชู ุงูุชุฑุญูู: X
# โญ๏ธ  ุชู ุงูุชุฎุทู: Y
# โ ุฃุฎุทุงุก: 0
```

### ุงูุฎุทูุฉ 3: ุงูุงุฎุชุจุงุฑ

```bash
# 1. ุงุฎุชุจุงุฑ endpoints ุงูุฌุฏูุฏุฉ
curl -H "Authorization: Bearer <admin_token>" \
  http://localhost:3000/admin/audit/logs

# 2. ุงุฎุชุจุงุฑ capabilities
curl -H "Authorization: Bearer <admin_token>" \
  http://localhost:3000/auth/admin/pending

# 3. ุงุฎุชุจุงุฑ audit logs
curl -H "Authorization: Bearer <admin_token>" \
  "http://localhost:3000/admin/audit/stats"
```

### ุงูุฎุทูุฉ 4: ุงููุดุฑ

```bash
# 1. ุจูุงุก ุงููุดุฑูุน
npm run build

# 2. ุชุดุบูู ูู ุงูุฅูุชุงุฌ
npm run start:prod

# 3. ูุฑุงูุจุฉ ุงูุณุฌูุงุช ููุชุฃูุฏ ูู ุนูู ุงููุธุงู
```

### ุงูุฎุทูุฉ 5: ุงูุชูุธูู (ุงุฎุชูุงุฑู)

```bash
# โ๏ธ  ููุท ุจุนุฏ ุงูุชุฃูุฏ ูู ูุฌุงุญ ุงูุชุฑุญูู

# ุญุฐู Capabilities collection ุงููุฏููุฉ
npm run migrate:cleanup

# ุณูุทูุจ ุชุฃููุฏ:
# ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู Capabilities collectionุ (ุงูุชุจ "ูุนู" ููุชุฃููุฏ): ูุนู
```

## ๐ ุงูุชุญูู ูู ุงููุฌุงุญ

### ูุญุต ุงูุจูุงูุงุช
```javascript
// ูู MongoDB shell
db.users.findOne({phone: "+966XXXXXXXXX"})
// ูุฌุจ ุฃู ูุญุชูู ุนูู:
// - customer_capable, engineer_capable, etc.
// - roles array ูุญุฏุซ
// - permissions array
```

### ูุญุต ุงูุตูุงุญูุงุช
```bash
# GET admin/users ูุฌุจ ุฃู ูุนูู ูุน token ุฃุฏูู
# POST admin/approve ูุฌุจ ุฃู ูุนูู
# GET admin/audit/logs ูุฌุจ ุฃู ูุนูู
```

### ูุญุต Audit Logs
```bash
# ูุฌุจ ุฃู ุชุญุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนูู ุฌุฏูู audit_logs
# ูุฌุจ ุฃู ุชุธูุฑ ุงูุนูููุงุช ูู ุงูุณุฌูุงุช
```

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฎุทุฃ: "Capabilities collection ูุงุฑุบ"
```
โ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุฑุญูู
```
**ุงูุญู:** ูุฐุง ุทุจูุนู ุฅุฐุง ูุงูุช Capabilities ูุงุฑุบุฉ. ุงููุธุงู ุงูุฌุฏูุฏ ุฌุงูุฒ.

### ุฎุทุฃ: "ูุดู ูู ุงูุชุฑุญูู"
```
โ ุฎุทุฃ ูู ุชุฑุญูู capability X: MongoError
```
**ุงูุญู:**
1. ุชุญูู ูู ุตุญุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. ุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ูู Capabilities
3. ุดุบู ุงูุชุฑุญูู ูุฑุฉ ุฃุฎุฑู

### ุฎุทุฃ: "Endpoint ูุฑูุถ ุงููุตูู"
```
403 Forbidden
```
**ุงูุญู:**
1. ุชุฃูุฏ ูู token ุงูุฃุฏูู ุตุญูุญ
2. ุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุฏูู ุงูุตูุงุญูุงุช ุงููุทููุจุฉ
3. ุชุญูู ูู ุฃู AdminGuard ูู ูุนุฏ ูุณูุญ ููุฌููุน

## ๐ ูุง ุชุบูุฑ

### ูุจู ุงูุชุฑุญูู
```javascript
// Capabilities collection ูููุตู
{
  userId: ObjectId,
  customer_capable: true,
  engineer_capable: false,
  engineer_status: "none"
}

// User collection
{
  roles: ["user"],
  permissions: []
}
```

### ุจุนุฏ ุงูุชุฑุญูู
```javascript
// User collection ููุญุฏ
{
  // ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
  phone: "+966XXXXXXXXX",
  firstName: "ุฃุญูุฏ",

  // ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช
  roles: ["user", "engineer"],
  permissions: ["admin.access"],

  // Capabilities ูุฏูุฌุฉ
  customer_capable: true,
  engineer_capable: true,
  engineer_status: "approved",
  wholesale_capable: false,
  wholesale_status: "none",
  admin_capable: false,
  admin_status: "none"
}
```

## ๐ ุงูุตูุงุญูุงุช ุงูุฌุฏูุฏุฉ

| Endpoint | ุงูุตูุงุญูุฉ ุงููุทููุจุฉ | ุงููุตู |
|----------|-------------------|--------|
| `GET /admin/users` | `users.read, admin.access` | ูุงุฆูุฉ ุงููุณุชุฎุฏููู |
| `POST /admin/users` | `users.create, admin.access` | ุฅูุดุงุก ูุณุชุฎุฏู |
| `PATCH /admin/users/:id` | `users.update, admin.access` | ุชุญุฏูุซ ูุณุชุฎุฏู |
| `DELETE /admin/users/:id` | `users.delete, admin.access` | ุญุฐู ูุณุชุฎุฏู |
| `GET /auth/admin/pending` | `capabilities.read, admin.access` | ุทูุจุงุช ุงููุฏุฑุงุช |
| `POST /auth/admin/approve` | `capabilities.update, admin.access` | ุงูููุงููุฉ ุนูู ุงููุฏุฑุงุช |
| `GET /admin/audit/logs` | `admin.access` (Super Admin only) | ุณุฌูุงุช ุงูุชุฏููู |

## ๐ ุงูุฏุนู

### ูู ุญุงูุฉ ุงููุดุงูู
1. ุฑุงุฌุน ูุฐุง ุงูุฏููู ุฃููุงู
2. ุชุญูู ูู ุงูุณุฌูุงุช ูู ูุญุฏุฉ ุงูุชุญูู
3. ุฑุงุฌุน `WEEK2_COMPLETION_REPORT.md` ููุชูุงุตูู
4. ุงุชุตู ุจูุฑูู ุงูุชุทููุฑ

### ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ
- ุฌููุน ุงูุนูููุงุช ุงูุญุณุงุณุฉ ููุณุฌูุฉ ูู `audit_logs`
- ูููู ุงูุจุญุซ ูุงูููุชุฑุฉ ูู ุงูุณุฌูุงุช
- ุงูุณุฌูุงุช ูุญููุธุฉ ููุฏุฉ 90 ููู ุงูุชุฑุงุถูุงู

---

## โ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ

- [ ] Backup ุชู ุฅูุดุงุคู
- [ ] ุงูุฎุงุฏู ูุนูู ูู ูุถุน ุงูุชุทููุฑ
- [ ] Migration script ุชู ุชุดุบููู ุจูุฌุงุญ
- [ ] ุฌููุน endpoints ุชุนูู
- [ ] Audit logs ุชุญุชูู ุนูู ุงูุณุฌูุงุช
- [ ] ุงุฎุชุจุงุฑ ุดุงูู ุชู ุฅุฌุฑุงุคู
- [ ] ุงููุดุฑ ููุฅูุชุงุฌ ุชู
- [ ] Cleanup (ุงุฎุชูุงุฑู) ุชู

**ุชุงุฑูุฎ ุงูุชุฑุญูู:** _______________
**ุงูุดุฎุต ุงููุณุคูู:** _______________
**ุงูุญุงูุฉ:** โ ููุชูู / โ ูุญุชุงุฌ ูุฑุงุฌุนุฉ
