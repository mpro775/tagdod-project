# مميزات نظام الخدمات والطلبات الشامل

## مقدمة عن النظام

نظام خدمات متقدم وشامل مصمم خصيصاً لمنصة خدمات الطاقة الشمسية يتيح للعملاء طلب خدمات المهندسين مع نظام عروض تنافسي وحساب المسافات التلقائي. النظام يدعم ثلاثة أدوار رئيسية: العملاء، المهندسون، والمشرفون مع إمكانيات متقدمة للتتبع والمراقبة.

## قسم الأدوار والصلاحيات

### نظام الأدوار المتعددة

#### 1. **دور العميل (Customer)**
```typescript
// صلاحيات العميل
enum ServicePermission {
  CUSTOMER = 'customer',
  ENGINEER = 'engineer',
  ADMIN = 'admin'
}
```

**المسؤوليات:**
- إنشاء طلبات الخدمة
- مراجعة العروض المقدمة
- قبول أو رفض العروض
- تقييم الخدمات المكتملة
- إلغاء الطلبات في المراحل المبكرة

#### 2. **دور المهندس (Engineer)**
**المسؤوليات:**
- البحث عن الطلبات القريبة من موقعه
- تقديم عروض تنافسية للطلبات
- تعديل عروضه قبل القبول
- بدء وإنهاء العمل المكلف به
- مراجعة عروضه السابقة

#### 3. **دور المشرف (Admin)**
**المسؤوليات:**
- مراقبة جميع الطلبات والعروض
- إدارة حالات الطلبات يدوياً
- تعيين مهندسين لطلبات محددة
- إلغاء طلبات لأسباب إدارية
- مراجعة الإحصائيات والتقارير الشاملة

## قسم أنواع البيانات والحالات

### أنواع البيانات الرئيسية

#### 1. **طلب الخدمة (Service Request)**
```typescript
interface ServiceRequest {
  // البيانات الأساسية
  _id: string;
  userId: string;           // معرف العميل
  title: string;           // عنوان الطلب
  type?: string;           // نوع الخدمة
  description?: string;    // وصف مفصل
  images?: string[];       // صور مرفقة

  // الموقع والتوقيت
  addressId?: string;      // معرف العنوان
  location: {              // إحداثيات GeoJSON
    type: 'Point';
    coordinates: [number, number]; // [lng, lat]
  };
  scheduledAt?: Date;      // موعد محدد للخدمة

  // حالة الطلب
  status: ServiceStatus;

  // بعد القبول
  engineerId?: string;     // معرف المهندس المكلف
  acceptedOffer?: {        // تفاصيل العرض المقبول
    offerId: string;
    amount: number;
    note?: string;
  };

  // التقييم
  rating?: {
    score?: number;        // 1-5 نجوم
    comment?: string;
    at?: Date;
  };

  // ملاحظات إدارية
  adminNotes?: Array<{
    note: string;
    at: Date;
  }>;

  // تواريخ النظام
  createdAt: Date;
  updatedAt: Date;
}
```

#### 2. **عرض المهندس (Engineer Offer)**
```typescript
interface EngineerOffer {
  _id: string;
  requestId: string;       // معرف الطلب
  engineerId: string;      // معرف المهندس

  // تفاصيل العرض
  amount: number;          // السعر المقترح
  note?: string;           // ملاحظات إضافية

  // المسافة المحسوبة
  distanceKm?: number;     // المسافة من موقع المهندس للطلب

  // حالة العرض
  status: OfferStatus;

  // تواريخ النظام
  createdAt: Date;
  updatedAt: Date;
}
```

## قسم حالات النظام

### حالات طلب الخدمة

| الحالة | الوصف | المسموح لـ |
|--------|-------|-----------|
| `OPEN` | طلب مفتوح جديد | العميل، المهندس، المشرف |
| `OFFERS_COLLECTING` | جمع العروض قيد التشغيل | العميل، المهندس، المشرف |
| `ASSIGNED` | تم تعيين مهندس | العميل، المهندس، المشرف |
| `IN_PROGRESS` | العمل قيد التنفيذ | العميل، المهندس، المشرف |
| `COMPLETED` | تم إنجاز العمل | العميل، المهندس، المشرف |
| `RATED` | تم التقييم | العميل، المهندس، المشرف |
| `CANCELLED` | تم إلغاء الطلب | العميل، المهندس، المشرف |

### حالات عرض المهندس

| الحالة | الوصف | المسموح لـ |
|--------|-------|-----------|
| `OFFERED` | عرض مقدم بانتظار الرد | المهندس، العميل، المشرف |
| `ACCEPTED` | تم قبول العرض | المهندس، العميل، المشرف |
| `REJECTED` | تم رفض العرض | المهندس، المشرف |
| `CANCELLED` | تم إلغاء العرض | المهندس، المشرف |

## قسم واجهات برمجة التطبيقات

### APIs حسب الأدوار

#### 1. **واجهات العميل (Customer APIs)**
```typescript
// إنشاء طلب خدمة جديد
POST /services/customer
{
  "title": "تصليح نظام الطاقة الشمسية",
  "type": "صيانة",
  "description": "مشكلة في الألواح الشمسية",
  "addressId": "addr_123",
  "scheduledAt": "2024-01-15T10:00:00Z"
}

// مراجعة طلباتي
GET /services/customer/my

// تفاصيل طلب محدد
GET /services/customer/:id

// مراجعة العروض المقدمة لطلبي
GET /services/customer/:id/offers

// قبول عرض محدد
POST /services/customer/:id/accept-offer
{
  "offerId": "offer_123"
}

// إلغاء طلب
POST /services/customer/:id/cancel

// تقييم الخدمة المكتملة
POST /services/customer/:id/rate
{
  "score": 5,
  "comment": "خدمة ممتازة ومهنية"
}
```

#### 2. **واجهات المهندس (Engineer APIs)**
```typescript
// البحث عن طلبات قريبة من موقعي
GET /services/engineer/requests/nearby?lat=24.7136&lng=46.7382&radiusKm=10

// تقديم عرض للطلب
POST /services/engineer/offers
{
  "requestId": "req_123",
  "amount": 150,
  "note": "متوفر خلال ساعة",
  "lat": 24.7200,
  "lng": 46.7400
}

// مراجعة عروضي السابقة
GET /services/engineer/offers/my

// تعديل عرضي قبل القبول
PATCH /services/engineer/offers/:id
{
  "amount": 140,
  "note": "سعر محدث"
}

// بدء العمل المكلف
POST /services/engineer/requests/:id/start

// إنهاء العمل
POST /services/engineer/requests/:id/complete
```

#### 3. **واجهات المشرف (Admin APIs)**
```typescript
// قائمة شاملة بجميع الطلبات مع فلترة
GET /services/admin/requests?status=OPEN&type=صيانة&page=1&limit=20

// تفاصيل طلب محدد
GET /services/admin/requests/:id

// مراجعة جميع العروض لطلب محدد
GET /services/admin/requests/:id/offers

// تحديث حالة طلب يدوياً
PATCH /services/admin/requests/:id/status
{
  "status": "ASSIGNED",
  "note": "تعيين مهندس محدد"
}

// تعيين مهندس لطلب محدد
POST /services/admin/requests/:id/assign-engineer
{
  "engineerId": "eng_123",
  "note": "تعيين مهندس متخصص"
}

// إلغاء طلب لأسباب إدارية
POST /services/admin/requests/:id/cancel
{
  "reason": "إلغاء بناءً على طلب العميل"
}

// إحصائيات شاملة
GET /services/admin/statistics/overview
GET /services/admin/statistics/requests?groupBy=month
```

## قسم نظام الحسابات والمسافات

### حساب المسافات التلقائي

#### 1. **صيغة هافرساين (Haversine Formula)**
```typescript
// حساب دقيق للمسافة بين نقطتين على سطح الأرض
calculateDistance(lat1, lng1, lat2, lng2) => distanceKm

// مثال:
موقع الطلب: 24.7136, 46.7382
موقع المهندس: 24.7200, 46.7400
المسافة: 0.87 كم
```

#### 2. **البحث بالقرب الجغرافي**
```typescript
// البحث عن طلبات في نطاق محدد
GET /services/engineer/requests/nearby?lat=24.7136&lng=46.7382&radiusKm=10

// يستخدم:
// - 2dsphere index للبحث السريع
// - فلترة دقيقة حسب المسافة
// - ترتيب حسب القرب أولاً
```

## قسم التقييم والمراجعة

### نظام التقييم الشامل

#### 1. **تقييم الخدمات**
```typescript
interface ServiceRating {
  score?: number;      // 1-5 نجوم
  comment?: string;    // تعليق نصي
  at?: Date;          // تاريخ التقييم
}
```

#### 2. **إحصائيات المهندسين**
```typescript
interface EngineersOverviewStatisticsDto {
  totalEngineers!: number;           // إجمالي المهندسين
  averageRating!: number;           // متوسط التقييم
  averageCompletionRate!: number;   // معدل إنجاز الأعمال
  totalRevenue!: number;            // إجمالي الإيرادات
}
```

#### 3. **إحصائيات العروض**
```typescript
interface OffersStatisticsDto {
  totalOffers!: number;        // إجمالي العروض
  acceptedOffers!: number;     // العروض المقبولة
  pendingOffers!: number;      // العروض المعلقة
  totalValue!: number;         // إجمالي قيمة العروض
  averageOffer!: number;       // متوسط قيمة العرض
}
```

## قسم الإشعارات والتتبع

### نظام الإشعارات الذكي

#### 1. **أنواع الإشعارات**
```typescript
enum NotificationType {
  SERVICE_REQUEST_OPENED = 'service_request_opened',
  OFFER_RECEIVED = 'offer_received',
  OFFER_ACCEPTED = 'offer_accepted',
  OFFER_REJECTED = 'offer_rejected',
  SERVICE_STARTED = 'service_started',
  SERVICE_COMPLETED = 'service_completed',
  SERVICE_RATED = 'service_rated',
  SERVICE_CANCELLED = 'service_cancelled'
}
```

#### 2. **الإشعارات حسب الدور**

**للعملاء:**
- إشعار بفتح طلب خدمة جديد
- إشعار بتلقي عرض جديد
- إشعار بقبول عرضهم
- إشعار ببدء العمل
- إشعار بإنجاز العمل

**للمهندسين:**
- إشعار بطلبات جديدة قريبة من موقعهم
- إشعار بقبول عرضهم
- إشعار ببدء العمل المكلف بهم

**للمشرفين:**
- إشعار بطلبات جديدة تحتاج مراجعة
- إشعار بحالات استثنائية تحتاج تدخل

## قسم التقارير والإحصائيات

### التقارير الإدارية الشاملة

#### 1. **تقرير نظرة عامة**
```typescript
GET /services/admin/statistics/overview

// يتضمن:
- إجمالي الطلبات حسب الحالة
- إجمالي العروض والمقبولة منها
- متوسط وقت الاستجابة
- أكثر أنواع الخدمات طلباً
- أداء المهندسين (الأعلى تقييماً)
```

#### 2. **تقرير الطلبات بالتفصيل**
```typescript
GET /services/admin/statistics/requests?groupBy=month

// يتضمن:
- توزيع الطلبات حسب الشهر/الأسبوع/اليوم
- مقارنة مع الفترات السابقة
- تحليل الاتجاهات الموسمية
- توقعات مستقبلية للطلبات
```

#### 3. **تقرير أداء المهندسين**
```typescript
GET /services/admin/statistics/engineers

// يتضمن:
- متوسط التقييم لكل مهندس
- معدل إنجاز الأعمال
- إجمالي الإيرادات المحققة
- عدد الطلبات المكتملة
```

## قسم الأمان والحماية

### الحماية متعددة الطبقات

#### 1. **حماية المصادقة**
- **JWT Authentication**: تشفير وحماية شاملة للجلسات
- **Role-based Access Control**: صلاحيات محددة لكل دور
- **Permission Guards**: حراسة دقيقة للوصول للموارد

#### 2. **حماية البيانات**
- **Input Validation**: التحقق من صحة جميع البيانات المدخلة
- **Sanitization**: تنظيف البيانات من الرموز الضارة
- **Rate Limiting**: تحديد معدل الطلبات لمنع الإساءة

#### 3. **حماية الموقع**
- **Geolocation Security**: التحقق من صحة المواقع المرسلة
- **Distance Validation**: التحقق من منطقية المسافات المحسوبة
- **IP Tracking**: تتبع محاولات الوصول المشبوهة

## قسم قابلية التوسع والمرونة

### تصميم مرن وقابل للتوسع

#### 1. **إضافة أنواع خدمات جديدة**
```typescript
// إضافة نوع خدمة جديد
{
  "type": "تركيب أنظمة تخزين",
  "category": "طاقة متجددة",
  "estimatedDuration": "4 ساعات",
  "requiredSkills": ["كهرباء", "طاقة شمسية"]
}
```

#### 2. **تخصيص خوارزميات الترتيب**
```typescript
// ترتيب العروض حسب:
- المسافة (الأقرب أولاً)
- السعر (الأرخص أولاً)
- التقييم (الأعلى تقييماً أولاً)
- الخبرة (الأكثر خبرة أولاً)
```

#### 3. **تكامل مع أنظمة خارجية**
- **نظام المستخدمين**: ربط مع ملفات المستخدمين الموجودة
- **نظام العناوين**: استخدام نظام العناوين الموحد
- **نظام التقييمات**: تكامل مع نظام التقييم العام
- **نظام الإشعارات**: إرسال إشعارات فورية للأطراف المعنية

## قسم البيئات والاختبار

### دعم جميع البيئات

#### 1. **البيئة التطويرية**
- **التسجيل المفصل**: سجلات شاملة للتتبع والتشخيص
- **اختبار سهل**: إمكانية اختبار جميع السيناريوهات
- **مرونة في البيانات**: قبول بيانات اختبار متنوعة

#### 2. **البيئة الإنتاجية**
- **الأداء المحسن**: استعلامات محسّنة وفهارس فعالة
- **التخزين المؤقت**: تسريع الاستجابة مع Redis
- **المراقبة المستمرة**: تتبع الأداء والأخطاء في الوقت الفعلي

## الخلاصة

نظام الخدمات هذا يوفر **حلول متكاملة ومتقدمة** لإدارة طلبات الخدمات بين العملاء والمهندسين مع نظام عروض تنافسي وحساب مسافات دقيق.

### نقاط القوة:
- ✅ **ثلاثة أدوار محددة** مع صلاحيات واضحة ومفصولة
- ✅ **حساب مسافات دقيق** باستخدام صيغة هافرساين المتقدمة
- ✅ **نظام عروض تنافسي** مع ترتيب ذكي حسب المسافة والسعر
- ✅ **تتبع شامل** لجميع مراحل الطلب من الفتح للتقييم
- ✅ **تقارير إدارية مفصلة** مع إحصائيات شاملة
- ✅ **حماية أمنية متقدمة** مع تشفير ورصد للتهديدات
- ✅ **قابلية التوسع** والتكيف مع احتياجات جديدة

### المميزات التقنية:
- 🗺️ **حساب مسافات دقيق** باستخدام إحداثيات GPS
- 📊 **إحصائيات شاملة** للأداء والكفاءة
- 🔔 **إشعارات ذكية** حسب الدور والحدث
- 🔒 **حماية متقدمة** من الهجمات والإساءة
- 📈 **مراقبة مستمرة** للأداء والجودة
- 🔧 **مرونة في التخصيص** والتطوير المستقبلي

هذا النظام يضمن **تجربة سلسة وفعالة** لجميع الأطراف المعنية مع **إدارة ذكية ومتقدمة** لعمليات طلب وتقديم الخدمات في مجال الطاقة الشمسية.
