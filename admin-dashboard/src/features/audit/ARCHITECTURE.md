# بنية نظام التدقيق

## نظرة عامة على النظام

```
┌─────────────────────────────────────────────────────────────┐
│                    نظام التدقيق (Audit System)                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   Frontend      │    │    Backend      │                │
│  │   (React)       │◄──►│   (NestJS)      │                │
│  │                 │    │                 │                │
│  └─────────────────┘    └─────────────────┘                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## بنية الواجهة الأمامية (Frontend)

```
audit/
├── 📁 api/
│   └── auditApi.ts              # API calls
├── 📁 components/
│   ├── AuditFilters.tsx         # فلاتر البحث
│   ├── AuditStatsCards.tsx      # بطاقات الإحصائيات
│   ├── AuditLogsTable.tsx       # جدول السجلات
│   ├── AuditLogDetails.tsx     # تفاصيل السجل
│   └── index.ts
├── 📁 hooks/
│   └── useAudit.ts             # React hooks
├── 📁 pages/
│   ├── AuditMainPage.tsx       # الصفحة الرئيسية
│   ├── AuditLogsPage.tsx       # صفحة السجلات
│   ├── AuditAnalyticsPage.tsx  # صفحة التحليلات
│   └── index.ts
├── 📁 types/
│   └── audit.types.ts          # تعريفات الأنواع
├── index.ts
└── README.md
```

## تدفق البيانات

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User      │    │  Frontend   │    │  Backend    │
│  Action     │───►│  Components │───►│   API       │
└─────────────┘    └─────────────┘    └─────────────┘
                           │                   │
                           ▼                   ▼
                   ┌─────────────┐    ┌─────────────┐
                   │   React     │    │  Database   │
                   │   Hooks     │◄───│  (MongoDB)  │
                   └─────────────┘    └─────────────┘
```

## أنواع البيانات

### AuditLog
```typescript
interface AuditLog {
  _id: string;
  userId: string;              // المستخدم المتأثر
  performedBy?: string;        // من قام بالعملية
  action: AuditAction;         // نوع العملية
  resource: AuditResource;    // نوع المورد
  resourceId?: string;        // معرف المورد
  oldValues?: any;            // القيم القديمة
  newValues?: any;            // القيم الجديدة
  metadata?: any;             // بيانات إضافية
  ipAddress?: string;        // عنوان IP
  userAgent?: string;         // متصفح المستخدم
  reason?: string;           // سبب العملية
  isSensitive?: boolean;     // هل العملية حساسة
  sessionId?: string;       // معرف الجلسة
  timestamp: string;         // وقت العملية
  createdAt: string;
  updatedAt: string;
}
```

### AuditAction (أنواع العمليات)
```
┌─────────────────────────────────────────────────────────────┐
│                    أنواع العمليات                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📋 إدارة المستخدمين                                        │
│  ├── USER_CREATED      (إنشاء مستخدم)                      │
│  ├── USER_UPDATED      (تحديث مستخدم)                      │
│  ├── USER_DELETED      (حذف مستخدم)                        │
│  ├── USER_SUSPENDED    (تعليق مستخدم)                      │
│  └── USER_ACTIVATED    (تفعيل مستخدم)                      │
│                                                             │
│  🔐 المصادقة والتفويض                                       │
│  ├── LOGIN_SUCCESS     (تسجيل دخول ناجح)                   │
│  ├── LOGIN_FAILED      (فشل تسجيل الدخول)                 │
│  ├── LOGOUT           (تسجيل خروج)                       │
│  ├── PASSWORD_CHANGED  (تغيير كلمة المرور)                 │
│  └── PASSWORD_RESET    (إعادة تعيين كلمة المرور)           │
│                                                             │
│  🔑 الصلاحيات والأدوار                                      │
│  ├── PERMISSION_GRANTED (منح صلاحية)                       │
│  ├── PERMISSION_REVOKED (سحب صلاحية)                       │
│  ├── ROLE_ASSIGNED     (تعيين دور)                         │
│  ├── ROLE_REMOVED      (إزالة دور)                         │
│  ├── CAPABILITY_APPROVED (موافقة على قدرة)                 │
│  └── CAPABILITY_REJECTED (رفض قدرة)                        │
│                                                             │
│  ⚙️ الإجراءات الإدارية                                      │
│  └── ADMIN_ACTION      (إجراء إداري)                       │
│                                                             │
│  🖥️ أحداث النظام                                           │
│  ├── SYSTEM_BACKUP     (نسخ احتياطي للنظام)                │
│  ├── SYSTEM_MAINTENANCE (صيانة النظام)                     │
│  └── DATA_MIGRATION    (ترحيل البيانات)                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### AuditResource (أنواع الموارد)
```
┌─────────────────────────────────────────────────────────────┐
│                    أنواع الموارد                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  👤 USER        - مستخدم                                    │
│  🔑 PERMISSION  - صلاحية                                    │
│  👑 ROLE        - دور                                        │
│  ⚡ CAPABILITY  - قدرة                                      │
│  🖥️ SYSTEM      - نظام                                      │
│  🔐 AUTH        - مصادقة                                    │
│  ⚙️ ADMIN       - إدارة                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## مكونات الواجهة

### 1. الصفحة الرئيسية (AuditMainPage)
```
┌─────────────────────────────────────────────────────────────┐
│                    الصفحة الرئيسية                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📊 بطاقات الإحصائيات السريعة                               │
│  ├── إجمالي السجلات                                         │
│  ├── العمليات الحساسة                                       │
│  ├── الإجراءات الإدارية                                      │
│  └── أحداث المصادقة                                         │
│                                                             │
│  📑 تبويبات المحتوى                                         │
│  ├── سجلات التدقيق                                          │
│  └── التحليلات والإحصائيات                                  │
│                                                             │
│  🖥️ حالة النظام                                             │
│  ├── النظام نشط                                             │
│  ├── آخر تحديث                                             │
│  └── المستخدمون النشطون                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. صفحة السجلات (AuditLogsPage)
```
┌─────────────────────────────────────────────────────────────┐
│                    صفحة السجلات                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🔍 أدوات البحث والفلترة                                    │
│  ├── البحث النصي                                            │
│  ├── فلاتر سريعة                                           │
│  ├── فلاتر متقدمة                                          │
│  └── تصدير البيانات                                        │
│                                                             │
│  📋 جدول السجلات                                            │
│  ├── الوقت                                                  │
│  ├── المستخدم                                              │
│  ├── نوع العملية                                           │
│  ├── المورد                                                │
│  ├── البيانات                                              │
│  ├── الحساسية                                              │
│  └── الإجراءات                                             │
│                                                             │
│  📄 تفاصيل السجل                                            │
│  ├── المعلومات الأساسية                                    │
│  ├── معلومات المستخدم                                      │
│  ├── المعلومات التقنية                                      │
│  ├── تغييرات البيانات                                      │
│  └── البيانات الإضافية                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3. صفحة التحليلات (AuditAnalyticsPage)
```
┌─────────────────────────────────────────────────────────────┐
│                    صفحة التحليلات                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ⚙️ أدوات التحكم                                           │
│  ├── الفترة الزمنية                                         │
│  ├── نوع السجلات                                           │
│  └── ملخص الفترة                                           │
│                                                             │
│  📊 الإحصائيات                                              │
│  ├── إجمالي السجلات                                         │
│  ├── العمليات الحساسة                                       │
│  ├── تغييرات الصلاحيات                                      │
│  ├── الإجراءات الإدارية                                     │
│  ├── أحداث المصادقة                                        │
│  ├── تغييرات الأدوار                                       │
│  ├── قرارات القدرات                                        │
│  └── نسبة الحساسية                                         │
│                                                             │
│  📈 المخططات                                                │
│  ├── نظرة عامة على النشاط                                   │
│  ├── نظرة عامة على الأمان                                   │
│  └── النشاط الأخير                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## تدفق العمليات

### 1. تسجيل العملية
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User      │    │  Frontend   │    │  Backend    │
│  Action     │───►│  Component  │───►│  Service    │
└─────────────┘    └─────────────┘    └─────────────┘
                           │                   │
                           ▼                   ▼
                   ┌─────────────┐    ┌─────────────┐
                   │   State     │    │  Database   │
                   │  Update     │◄───│  Storage    │
                   └─────────────┘    └─────────────┘
```

### 2. عرض السجلات
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User      │    │  Frontend   │    │  Backend    │
│  Request    │───►│  Component  │───►│   API       │
└─────────────┘    └─────────────┘    └─────────────┘
                           │                   │
                           ▼                   ▼
                   ┌─────────────┐    ┌─────────────┐
                   │   React     │    │  Database   │
                   │   Query     │◄───│  Query      │
                   └─────────────┘    └─────────────┘
```

## الأمان والخصوصية

### تصنيف العمليات حسب الخطورة
```
┌─────────────────────────────────────────────────────────────┐
│                    مستويات الخطورة                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🟢 منخفض (Low)                                            │
│  ├── تسجيل الدخول الناجح                                    │
│  ├── تسجيل الخروج                                          │
│  └── العمليات العادية                                      │
│                                                             │
│  🟡 متوسط (Medium)                                         │
│  ├── تغيير كلمة المرور                                      │
│  ├── تحديث البيانات                                        │
│  └── العمليات المتوسطة                                     │
│                                                             │
│  🟠 عالي (High)                                            │
│  ├── تعليق المستخدمين                                      │
│  ├── تغيير الصلاحيات                                       │
│  ├── تعديل الأدوار                                         │
│  └── العمليات الحساسة                                      │
│                                                             │
│  🔴 حرج (Critical)                                         │
│  ├── العمليات الإدارية                                     │
│  ├── ترحيل البيانات                                        │
│  ├── صيانة النظام                                          │
│  └── العمليات الحرجة                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## الأداء والتحسين

### استراتيجيات التحسين
1. **التخزين المؤقت**: استخدام React Query
2. **التحميل التدريجي**: تحميل البيانات على دفعات
3. **الفهرسة**: فهرسة قاعدة البيانات للبحث السريع
4. **الضغط**: ضغط البيانات المرسلة
5. **التحديث الذكي**: تحديث البيانات عند الحاجة فقط

### مقاييس الأداء
- **وقت الاستجابة**: < 200ms للعمليات العادية
- **الذاكرة**: استخدام ذاكرة محدود
- **الشبكة**: تقليل حجم البيانات المرسلة
- **قاعدة البيانات**: استعلامات محسنة

## التطوير المستقبلي

### المميزات المخططة
- [ ] إشعارات فورية للعمليات الحساسة
- [ ] تحليلات بالذكاء الاصطناعي
- [ ] تقارير مخصصة
- [ ] تكامل مع أنظمة خارجية
- [ ] دعم البيانات الضخمة
- [ ] API للوصول الخارجي

### التحسينات التقنية
- [ ] تحسين استعلامات قاعدة البيانات
- [ ] إضافة المزيد من الفلاتر
- [ ] تحسين واجهة المستخدم
- [ ] إضافة المزيد من المخططات
- [ ] تحسين الأداء
- [ ] إضافة المزيد من الأمان
