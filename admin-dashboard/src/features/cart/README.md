# ميزة إدارة السلة - Cart Management Feature

## نظرة عامة

ميزة إدارة السلة توفر نظام شامل لإدارة وعرض جميع سلال التسوق في النظام، مع إمكانيات متقدمة لتتبع السلال المتروكة وإرسال التذكيرات وتحليل الأداء. تم تطوير النظام بالكامل باستخدام TypeScript و Material-UI مع التوافق الكامل مع API الباك إند.

## المكونات الرئيسية

### 1. صفحات الإدارة
- **CartManagementPage**: الصفحة الرئيسية لإدارة جميع السلال
- **AbandonedCartsPage**: صفحة متخصصة للسلال المتروكة
- **CartAnalyticsPage**: صفحة التحليلات والإحصائيات الشاملة
- **ConvertToOrderDialog**: نافذة تحويل السلة إلى طلب
- **SendReminderDialog**: نافذة إرسال تذكيرات للعملاء

### 2. المكونات
- **CartStatsCards**: بطاقات عرض الإحصائيات
- **CartFilters**: مكون تصفية السلال
- **CartTable**: جدول عرض السلال
- **CartDetailsModal**: نافذة تفاصيل السلة

### 3. الـ Hooks
- **useCartList**: إدارة قائمة السلال
- **useCartDetails**: تفاصيل سلة محددة
- **useAbandonedCarts**: إدارة السلال المتروكة
- **useCartAnalytics**: تحليلات السلة
- **useCartStatistics**: إحصائيات السلة
- **useConversionRates**: معدلات التحويل
- **useRecoveryCampaignAnalytics**: تحليلات حملات الاسترداد
- **useCustomerBehaviorAnalytics**: تحليل سلوك العملاء
- **useRevenueImpactAnalytics**: تحليل تأثير الإيرادات
- **useConvertCartToOrder**: تحويل السلة إلى طلب
- **useSendCartReminder**: إرسال تذكير للسلة
- **useSendAllReminders**: إرسال تذكيرات لجميع السلال
- **useBulkActions**: تنفيذ إجراءات جماعية
- **useCartFilters**: إدارة مرشحات السلة
- **useCartSelection**: إدارة اختيار السلال
- **useCartDashboard**: بيانات لوحة التحكم

## الميزات الرئيسية

### إدارة السلال
- عرض جميع السلال مع إمكانية التصفية والترتيب
- عرض تفاصيل شاملة لكل سلة
- إمكانية تحويل السلة إلى طلب يدوياً
- إرسال تذكيرات للسلال المتروكة
- إجراءات جماعية (حذف، مسح، تحديث)

### تتبع السلال المتروكة
- تحديد السلال المتروكة تلقائياً
- إرسال تذكيرات متدرجة (1 ساعة، 24 ساعة، 72 ساعة)
- إحصائيات مفصلة عن السلال المتروكة
- إمكانية الإجراءات الجماعية

### التحليلات الشاملة
- إحصائيات عامة (عدد السلال، القيم، معدلات التحويل)
- تحليل سلوك العملاء
- تحليل تأثير الإيرادات
- تحليل حملات الاسترداد
- مقارنة الأداء عبر فترات زمنية مختلفة

## API Endpoints

### الباك إند - نقاط النهاية الإدارية

#### السلال العامة
- `GET /admin/carts/all` - جلب جميع السلال مع التصفية والترقيم
- `GET /admin/carts/:id` - جلب تفاصيل سلة محددة
- `POST /admin/carts/:id/convert-to-order` - تحويل السلة إلى طلب

#### السلال المتروكة
- `GET /admin/carts/abandoned` - جلب السلال المتروكة
- `POST /admin/carts/send-reminders` - إرسال تذكيرات لجميع السلال المتروكة
- `POST /admin/carts/:id/send-reminder` - إرسال تذكير لسلة محددة

#### التحليلات
- `GET /admin/carts/analytics` - تحليلات شاملة للسلة
- `GET /admin/carts/statistics` - إحصائيات السلة
- `GET /admin/carts/conversion-rates` - معدلات التحويل
- `GET /admin/carts/recovery-campaigns` - تحليل حملات الاسترداد
- `GET /admin/carts/customer-behavior` - تحليل سلوك العملاء
- `GET /admin/carts/revenue-impact` - تحليل تأثير الإيرادات

#### الإجراءات الجماعية
- `POST /admin/carts/bulk-actions` - تنفيذ إجراءات جماعية

## أنواع البيانات

### Cart
```typescript
interface Cart {
  _id: string;
  userId?: string;
  deviceId?: string;
  status: CartStatus;
  items: CartItem[];
  pricingSummary?: PricingSummary;
  lastActivityAt?: Date;
  isAbandoned?: boolean;
  abandonmentEmailsSent?: number;
  lastAbandonmentEmailAt?: Date;
  convertedToOrderId?: string;
  convertedAt?: Date;
  expiresAt?: Date;
  createdAt: Date;
  updatedAt: Date;
  user?: UserInfo;
}
```

### CartStatus
```typescript
enum CartStatus {
  ACTIVE = 'active',
  ABANDONED = 'abandoned',
  CONVERTED = 'converted',
  EXPIRED = 'expired',
}
```

## التكامل مع النظام

### التوجيه
تم إضافة المسارات التالية:
- `/carts` - إدارة السلال
- `/carts/abandoned` - السلال المتروكة
- `/carts/analytics` - تحليلات السلة

### الشريط الجانبي
تم إضافة قسم "إدارة السلال" تحت قسم "المبيعات" مع الخيارات:
- إدارة السلال
- السلال المتروكة
- تحليلات السلة

## النظام الآلي

### المهام المجدولة
- **كل 30 دقيقة**: تحديد السلال المتروكة
- **كل ساعة**: معالجة السلال المتروكة وإرسال التذكيرات
- **يومياً (2 صباحاً)**: تنظيف السلال المنتهية الصلاحية
- **أسبوعياً**: حذف السلال المحولة القديمة

### استراتيجية التذكيرات
1. **التذكير الأول**: بعد ساعة من عدم النشاط
2. **Thirty reminder الثاني**: بعد 24 ساعة (فقط إذا تم إرسال الأول)
3. **التذكير الأخير**: بعد 72 ساعة (فقط إذا تم إرسال الثاني)

## التحليلات المتقدمة

### تحليل حملات الاسترداد
- معدل الاسترداد بعد الإيميل
- معدلات فتح الإيميل
- معدلات النقر
- تحليل الاسترداد حسب الساعة

### تحليل سلوك العملاء
- مدة الجلسة المتوسطة
- قيمة السلة حسب نوع الجهاز
- معدل الهجر حسب الوقت
- إحصائيات العملاء المتكررين والجدد

### تحليل تأثير الإيرادات
- الإيرادات المفقودة
- الإيرادات المستردة
- الإيرادات المحتملة
- كفاءة الاسترداد

## الاستخدام

### الوصول للميزة
1. تسجيل الدخول إلى لوحة التحكم الإدارية
2. الانتقال إلى قسم "المبيعات" في الشريط الجانبي
3. اختيار "إدارة السلال" أو "السلال المتروكة" أو "تحليلات السلة"

### إدارة السلال
- استخدام المرشحات للعثور على سلات محددة
- النقر على "عرض" لرؤية تفاصيل السلة
- استخدام "تحويل" لتحويل السلة إلى طلب
- استخدام "تذكير" لإرسال تذكير للسلة المتروكة

### مراقبة الأداء
- مراجعة الإحصائيات اليومية والأسبوعية
- تحليل معدلات التحويل والهجر
- متابعة حملات الاسترداد
- مراقبة تأثير الإيرادات

## التخصيص والتطوير

### إضافة تحليلات جديدة
يمكن إضافة تحليلات جديدة من خلال:
1. إضافة الطرق في `CartService`
2. إضافة نقاط النهاية في `AdminCartController`
3. إضافة الـ hooks في `useCart.ts`
4. إنشاء مكونات العرض المناسبة

### تحسين الأداء
- استخدام الفهرسة المناسبة في قاعدة البيانات
- تطبيق التخزين المؤقت للتحليلات المعقدة
- تحسين الاستعلامات المجمعة
- استخدام التحميل التدريجي للبيانات الكبيرة

## الأمان والصلاحيات

### الصلاحيات المطلوبة
- `ADMIN` أو `SUPER_ADMIN` للوصول لجميع الميزات
- صلاحية قراءة البيانات للعرض
- صلاحية كتابة البيانات للإجراءات

### حماية البيانات
- تشفير البيانات الحساسة
- تسجيل جميع الإجراءات الإدارية
- التحقق من صحة البيانات المدخلة
- حماية من هجمات SQL Injection

## معالجة الأخطاء

### أنواع الأخطاء المدعومة
- أخطاء التحقق من صحة البيانات
- أخطاء الشبكة والاتصال
- أخطاء الخادم
- أخطاء الصلاحيات
- أخطاء عدم وجود البيانات

### استراتيجية إعادة المحاولة
- إعادة المحاولة التلقائية للأخطاء المؤقتة
- تجنب إعادة المحاولة للأخطاء الدائمة
- تأخير متزايد بين المحاولات

## الدعم والصيانة

### المراقبة
- مراقبة أداء الاستعلامات
- تتبع معدلات الخطأ
- مراقبة استخدام الذاكرة
- تتبع أوقات الاستجابة

### الصيانة
- تنظيف البيانات القديمة بانتظام
- تحديث الفهارس حسب الحاجة
- مراجعة وتحسين الاستعلامات
- نسخ احتياطي للبيانات المهمة

## التطوير المستقبلي

### الميزات المخططة
- تكامل مع أنظمة الإيميل المتقدمة
- تحليلات أكثر تفصيلاً
- إشعارات فورية للتحديثات
- تكامل مع أنظمة CRM

### التحسينات المطلوبة
- تحسين أداء الاستعلامات المعقدة
- إضافة المزيد من المرشحات
- تحسين تجربة المستخدم للهواتف المحمولة
- إضافة المزيد من خيارات التصدير