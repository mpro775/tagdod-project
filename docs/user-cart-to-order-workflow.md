# سيناريو تدفق المستخدم: من السلة إلى الطلب

هذا المستند يلخص رحلة العميل داخل واجهة برمجة التطبيقات الخاصة بالـCart و Checkout، بدءًا من إضافة المنتجات إلى السلة مرورًا بتطبيق كوبونات الخصم، ووصولًا لتأكيد الطلب واختيار طريقة الدفع. جميع النقاط هنا تركز على مسارات المستخدمين فقط.

## نظرة عامة سريعة على المكونات

- `CartController` (`/cart`): إدارة عناصر السلة، معاينة التكلفة، وتطبيق أو إزالة الكوبونات.
- `OrderController` (`/orders`): معاينة الطلب قبل التأكيد، إنشاء الطلب، ومتابعة الطلبات اللاحقة (لا يغطيها هذا السيناريو).

## المتطلبات المسبقة

- المستخدم مصدّق بواسطة `JwtAuthGuard`.
- وجود منتجات جاهزة للإضافة (بـ `productId` أو `variantId`).
- وجود عنوان توصيل فعّال (`deliveryAddressId`) مخزَّن مسبقًا.
- التعرف على طرق الدفع المدعومة عبر `PaymentMethod` (مثل: `COD`, `BANK_TRANSFER`, `WALLET` ... إلخ).

## سيناريو تدفق العمل (Workflow)

1. **جلب السلة الحالية**
   - **Endpoint:** `GET /cart`
   - **الهدف:** الحصول على حالة السلة قبل أي تعديل، والتأكد من وجود العناصر الحالية أو بداية سلة فارغة.

2. **إضافة منتجات إلى السلة**
   - **Endpoint:** `POST /cart/items`
   - **Body (مثال):**
     ```json
     {
       "productId": "64f2c9...",
       "variantId": "optional",
       "quantity": 2
     }
     ```
   - **الهدف:** إضافة عنصر (بمنتج بسيط أو بمتغير محدد) مع تحديد الكمية المطلوبة.

3. **تحديث الكمية أو إزالة العناصر (اختياري)**
   - **تحديث الكمية:** `PATCH /cart/items/:itemId`
   - **إزالة عنصر:** `DELETE /cart/items/:itemId`
   - **الهدف:** ضبط السلة لتحتوي فقط على العناصر والكميات النهائية قبل الانتقال للمعاينة.

4. **تطبيق كوبون خصم (اختياري)**
   - **تطبيق كوبون:** `POST /cart/coupon`
     ```json
     {
       "couponCode": "COUPON10"
     }
     ```
   - **إزالة كوبون:** `DELETE /cart/coupon`
   - **الهدف:** تفعيل الخصومات قبل المعاينة أو الإلغاء عند الحاجة.

5. **معاينة السلة بالتكلفة النهائية**
   - **Endpoint:** `POST /cart/preview`
   - **Body (مثال):**
     ```json
     {
       "currency": "SAR"
     }
     ```
   - **الهدف:** احتساب الإجمالي بعد الضرائب والشحن والخصومات، والتأكد من أن الأرقام متوقعة قبل الدفع.

6. **معاينة الطلب من منظور checkout**
   - **Endpoint:** `POST /orders/checkout/preview`
   - **Body (مثال):**
     ```json
     {
       "currency": "SAR",
       "couponCode": "COUPON10"
     }
     ```
   - **الهدف:** التأكد من أن بيانات السلة، العنوان، والخصومات جاهزة قبل إنشاء الطلب الفعلي (قد يعيد تفاصيل إضافية خاصة بمرحلة الدفع أو التحقق).

7. **تأكيد الطلب وإنشاؤه**
   - **Endpoint:** `POST /orders/checkout/confirm`
   - **Body (مثال):**
     ```json
     {
       "deliveryAddressId": "65abc123def456789",
       "currency": "SAR",
       "paymentMethod": "COD",
       "shippingMethod": "standard",
       "couponCodes": ["COUPON10"],
       "customerNotes": "الرجاء الاتصال قبل التوصيل"
     }
     ```
   - **الهدف:** إنشاء الطلب النهائي مع طريقة الدفع المطلوبة. بالنسبة لطريقة الدفع:
     - `paymentMethod` يجب أن تكون قيمة من `PaymentMethod`.
     - بعض الطرق (مثل التحويل البنكي) قد تتطلب `paymentProvider`, `localPaymentAccountId`, أو `paymentReference`.

8. **متابعة الطلب (خارج نطاق هذا السيناريو)**
   - بعد الإنشاء يمكن استخدام `GET /orders/:id` أو `GET /orders/:id/track` للاطلاع على حالة الطلب، لكن ذلك ليس جزءًا من مسار التحويل من السلة إلى الطلب.

## ملاحظات إضافية

- عند كل خطوة يمكن للمستخدم إعادة استدعاء `GET /cart` للتأكد من الحالة الحالية للسلة.
- في حال تعدد الكوبونات، يدعم الـCheckout استخدام `couponCodes` (مصفوفة) إلى جانب أو بدلاً من `couponCode`.
- الدفاعات في `CartController` و `OrderController` تعتمد على التحقق من هوية المستخدم (`req.user.sub`) لضمان عزلة بيانات كل مستخدم.
- يفضّل استدعاء `POST /orders/checkout/preview` قبل `POST /orders/checkout/confirm` للتأكد من أن متطلبات الدفع والشحن مكتملة (مثلاً عند اختيار حساب محلي يجب إرفاق `paymentReference`).

بهذا يكون المسار الكامل من السلة إلى الطلب موثقًا بوضوح مع نقاط التكامل الأساسية بين وحدتي السلة والـCheckout.

