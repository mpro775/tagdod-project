# تحديثات السلة والطلب (رقم الصنف SKU) — دليل مطوّر Flutter

هذا الملف يلخص التغييرات التي حدثت في **Backend** على واجهات السلة (Cart) والطلب (Order) المتعلقة بـ **رقم الصنف (SKU)**، وما الذي يجب على مطوّر الفرونت (Flutter) تعديله أو إضافته.

---

## 1. ملخص التغييرات في الـ Backend

- **السلة (Cart):** إضافة حقل اختياري `sku` داخل `productSnapshot` لعناصر السلة؛ يتم تعبئته من **منتج** أو **متغير** (مع تفضيل SKU المتغير إن وُجد).
- **الطلب (Order):** عنصر الطلب يحتوي أصلاً على `snapshot.sku`؛ الفاتورة (PDF) تعرض الآن عموداً مخصّصاً لـ **رقم الصنف / SKU** في جدول الأصناف.
- لا تغيير على **مسارات الـ API** أو أسماء الـ endpoints؛ التغيير فقط على **الشكل الاختياري للبيانات** (حقل جديد/موجود في الـ response).

---

## 2. السلة (Cart)

### 2.1 التغيير في الـ API

في استجابات الـ API التي تُرجع عناصر السلة (مثل: جلب السلة، إضافة صنف، معاينة السلة/الدفع)، كل عنصر سلة يحتوي على `productSnapshot`. تم إضافة حقل **اختياري** داخل `productSnapshot`:

| الحقل                 | النوع    | مطلوب؟ | الوصف                                                          |
| --------------------- | -------- | ------ | -------------------------------------------------------------- |
| `productSnapshot.sku` | `string` | لا     | رقم الصنف (من المنتج أو من المتغير؛ المتغير له أولوية إن وُجد) |

### 2.2 شكل الـ Response (مثال)

```json
{
  "items": [
    {
      "productId": "...",
      "variantId": "...",
      "qty": 2,
      "productSnapshot": {
        "name": "لوح شمسي 400 واط",
        "slug": "solar-panel-400w",
        "sku": "PV-400-001",
        "image": "...",
        "brandName": "...",
        "variantAttributes": [...]
      },
      "pricing": { ... }
    }
  ]
}
```

- إذا كان الصنف **من متغير** وله `sku`، سيظهر في `productSnapshot.sku`.
- إذا كان الصنف **منتج بدون متغير** وله `sku`، سيظهر أيضاً في `productSnapshot.sku`.
- إن لم يكن هناك `sku` (منتج/متغير بدون رقم صنف)، قد لا يرد الحقل أو يكون `null`.

### 2.3 ما يلزم مطوّر Flutter

1. **تحديث نموذج (Model) عنصر السلة:**
   - في الـ class الذي يمثّل `productSnapshot`، أضف حقلاً اختيارياً:
   - `String? sku` (أو `String? sku` في Dart).
2. **عرض رقم الصنف (اختياري):**
   - في شاشة السلة أو تفاصيل الصنف أو ملخص الطلب، يمكن عرض `productSnapshot.sku` إن وُجد (مثلاً تحت اسم المنتج أو بجانبه).
3. **عدم كسر التطبيق القديم:**
   - الحقل اختياري؛ إن لم يرده الـ API أو كان `null`، لا تعرض شيء أو اعرض نصاً افتراضياً مثل "—".

---

## 3. الطلب (Order)

### 3.1 التغيير في الـ API

في استجابات الـ API التي تُرجع تفاصيل الطلب أو قائمة الطلبات (كل طلب يحتوي `items`)، كل عنصر في `order.items` له `snapshot`. الحقل `snapshot.sku` **موجود مسبقاً** في الـ schema؛ الفرق أن الـ Backend أصبح يملأه من السلة عند إنشاء الطلب (من `productSnapshot.sku`)، والفاتورة PDF تعرضه في عمود مخصّص.

قد يرد أيضاً في الـ snapshot حقول إضافية يُستخدمها الـ Backend داخلياً (مثل `variantSku` أو `variantSkuCode`)؛ يمكن للفرونت الاعتماد على `snapshot.sku` فقط للعرض.

### 3.2 شكل عنصر الطلب (مثال)

```json
{
  "orderNumber": "ORD-2025-001",
  "items": [
    {
      "productId": "...",
      "variantId": "...",
      "qty": 2,
      "snapshot": {
        "name": "لوح شمسي 400 واط",
        "slug": "solar-panel-400w",
        "sku": "PV-400-001",
        "brandName": "...",
        "attributes": { ... },
        "variantAttributes": [ ... ]
      },
      "finalPrice": 100,
      "lineTotal": 200,
      ...
    }
  ]
}
```

### 3.3 ما يلزم مطوّر Flutter

1. **تحديث نموذج (Model) عنصر الطلب:**
   - في الـ class الذي يمثّل `snapshot` لعنصر الطلب، تأكد من وجود حقل اختياري:
   - `String? sku` (وإن أردت دعم حقول إضافية للتوافق المستقبلي: `String? variantSku`, `String? variantSkuCode`).
2. **عرض رقم الصنف في تفاصيل الطلب:**
   - في شاشة تفاصيل الطلب أو قائمة الأصناف داخل الطلب، اعرض `snapshot.sku` إن وُجد (مثلاً بجانب اسم المنتج أو في سطر فرعي).
3. **توحيد العرض مع الفاتورة:**
   - الفاتورة PDF من الـ Backend تعرض عمود **"رقم الصنف / SKU"**؛ يمكن استخدام نفس القيمة (`snapshot.sku`) في تطبيق Flutter لتوحيد التجربة.

---

## 4. الفاتورة (PDF) — للمعلومية فقط

- الفاتورة (العادية والإرجاع) تُولَّد من الـ Backend وتتضمن جدول أصناف بعمود **"رقم الصنف / SKU"**.
- القيمة المعروضة في الفاتورة: من `snapshot.sku` أو من حقول احتياطية مثل `variantSku` أو `variantSkuCode`؛ لا يلزم الفرونت توليد PDF، فقط عرض نفس الـ SKU في شاشات الطلب إن رغبت.

---

## 5. خلاصة سريعة لمطوّر Flutter

| المكوّن                         | التعديل المطلوب                                                  |
| ------------------------------- | ---------------------------------------------------------------- |
| **Cart Item / productSnapshot** | إضافة `String? sku` في الـ model وعرضه اختيارياً في واجهة السلة. |
| **Order Item / snapshot**       | التأكد من وجود `String? sku` في الـ model وعرضه في تفاصيل الطلب. |
| **API Endpoints**               | لا تغيير؛ نفس المسارات ونفس البنية مع حقل اختياري جديد/معبّى.    |

---

## 6. ملاحظات إضافية

- **الطلبات القديمة:** طلبات أنشئت قبل هذا التحديث قد لا تحتوي على `snapshot.sku`؛ تعامل مع الحقل كاختياري دائماً.
- **المنتجات/المتغيرات بدون SKU:** إن لم يُعرّف رقم صنف للمنتج أو المتغير في الـ Backend، لن يرد `sku` أو سيكون فارغاً؛ لا تعتمد عليه كقيمة إلزامية في الواجهة.

إذا احتجت أمثلة كود Dart/Flutter للـ models أو لعرض الحقل في الـ UI، يمكن طلبها بشكل منفصل.
