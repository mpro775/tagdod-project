%% Pricing Engine Flow
%% View at https://mermaid.live
flowchart TD
  A[حساب السعر] --> B{نوع الطلب?}
  B -->|سعر متغير واحد| C[حساب سعر متغير]
  B -->|معاينة قاعدة| D[معاينة قاعدة تسعير]

  %% Single Variant Pricing
  C --> C1[استلام معرف المتغير والكمية]
  C1 --> C2[استرجاع المتغير من قاعدة البيانات]
  C2 --> C3[استرجاع قواعد الأسعار النشطة]
  C3 --> C4[ترتيب القواعد حسب الأولوية]
  C4 --> C5[تطبيق القواعد المتطابقة]
  C5 --> C6[حساب السعر النهائي]
  C6 --> C7[إرجاع النتائج]

  %% Preview Price Rule
  D --> D1[استلام قاعدة التسعير والمتغير]
  D1 --> D2[محاكاة تطبيق القاعدة]
  D2 --> D3[حساب السعر المتوقع]
  D3 --> D4[إرجاع نتائج المعاينة]

  %% Rule Application Logic
  C5 --> C5A[فحص الشروط لكل قاعدة]
  C5A --> C5B{تطابق الشروط?}
  C5B -->|نعم| C5C[تطبيق التأثير]
  C5B -->|لا| C5D[تخطي القاعدة]
  C5C --> C5E{قواعد أخرى?}
  C5D --> C5E
  C5E -->|نعم| C5A
  C5E -->|لا| C6
