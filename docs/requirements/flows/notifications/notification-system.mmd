%% Unified Notification System Flow
%% View at https://mermaid.live
flowchart TD
  A[طلب إرسال إشعار] --> B{نوع الطلب?}
  B -->|إشعار واحد| C[CreateNotificationDto]
  B -->|إشعارات جماعية| D[BulkSendNotificationDto]
  B -->|باستخدام قالب| E[SendTemplateNotificationDto]

  %% Single Notification Flow
  C --> C1[استلام البيانات]
  C1 --> C2[إنشاء UnifiedNotification]
  C2 --> C3[تحديد الفئة تلقائياً حسب النوع]
  C3 --> C4[إنشاء trackingId فريد]
  C4 --> C5{مجدول؟}
  C5 -->|نعم| C6[حفظ كـ SCHEDULED]
  C5 -->|لا| C7[إرسال فوري]

  %% Bulk Notifications Flow
  D --> D1[استلام مصفوفة الإشعارات]
  D1 --> D2[معالجة كل إشعار على حدة]
  D2 --> D3[إنشاء UnifiedNotification لكل واحد]

  %% Template Notifications Flow
  E --> E1[استلام templateKey وبيانات المتغيرات]
  E1 --> E2[البحث عن القالب في TEMPLATES]
  E2 --> E3[استبدال المتغيرات في العنوان والرسالة]
  E3 --> E4[إنشاء UnifiedNotification]

  %% Sending Process
  C7 --> F[إرسال الإشعار]
  D3 --> F
  E4 --> F
  C6 --> G[انتظار الموعد المجدول]

  F --> F1{القناة?}
  F1 -->|IN_APP| F2[حفظ في قاعدة البيانات فقط]
  F1 -->|PUSH| F3[PushNotificationAdapter]
  F1 -->|SMS| F4[SmsNotificationAdapter]
  F1 -->|EMAIL| F5[EmailNotificationAdapter]
  F1 -->|DASHBOARD| F6[حفظ في لوحة التحكم]

  %% Push Notifications Flow
  F3 --> F3A{FCM مهيأ?}
  F3A -->|نعم| F3B[FCMAdapter.sendToDevice]
  F3A -->|لا| F3C[Mock Implementation]
  F3B --> F3D[Firebase Cloud Messaging]
  F3D --> F3E{نجح الإرسال?}
  F3E -->|نعم| F8
  F3E -->|لا| F11
  F3C --> F8

  %% Email Flow
  F5 --> F5A{SMTP مهيأ?}
  F5A -->|نعم| F5B[EmailAdapter.sendEmail]
  F5A -->|لا| F5C[Mock Implementation]
  F5B --> F5D[SMTP Server]
  F5D --> F5E{نجح الإرسال?}
  F5E -->|نعم| F8
  F5E -->|لا| F11
  F5C --> F8

  %% SMS Flow
  F4 --> F4A{Twilio مهيأ?}
  F4A -->|نعم| F4B[SMSAdapter.sendSMS]
  F4A -->|لا| F4C[Mock Implementation]
  F4B --> F4D[Twilio API]
  F4D --> F4E{نجح الإرسال?}
  F4E -->|نعم| F8
  F4E -->|لا| F11
  F4C --> F8

  F2 --> F7[تحديث الحالة إلى SENT]
  F6 --> F7
  F8 --> F10[تحديث الحالة إلى DELIVERED]
  F11 --> F12[زيادة retryCount]
  F12 --> F13{retryCount < 5?}
  F13 -->|نعم| F14[جدولة إعادة المحاولة]
  F13 -->|لا| F15[إيقاف إعادة المحاولة]

  %% Status Tracking
  H[المستخدم يتفاعل] --> I{نوع التفاعل?}
  I -->|قراءة| J[تحديث readAt و status إلى READ]
  I -->|نقر| K[تحديث clickedAt و status إلى CLICKED]
  I -->|توصيل| L[تحديث deliveredAt و status إلى DELIVERED]

  %% Scheduled Notifications
  G --> M[استيقاظ الجدولة]
  M --> N[فحص الإشعارات المجدولة]
  N --> O[إرسال الإشعارات المستحقة]
  O --> F
  F14 --> F

  %% Error Handling
  P[خطأ في الإرسال] --> Q[حفظ errorMessage و errorCode]
  Q --> R[تحديث status إلى FAILED]
  R --> S[زيادة retryCount]

  %% End points
  F10 --> Z[نهاية - نجاح]
  F15 --> Z
  J --> Z
  K --> Z
  L --> Z
  F14 --> F
