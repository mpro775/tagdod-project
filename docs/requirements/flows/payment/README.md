# تدفقات الدفع (Payment Flows)

## الملفات المتاحة
- `webhook.mmd` - مخطط معالجة Webhook الدفع

## شرح التدفقات

### 1. إنشاء نية الدفع (Payment Intent)
- **المدخلات:** مبلغ الدفع، معلومات الطلب
- **النتيجة:** إنشاء Payment Intent مع موفر الدفع
- **المعرف:** حفظ paymentIntentId في الطلب

### 2. معالجة Webhook
- **المصدر:** موفر الدفع (Moyasar, Stripe, إلخ)
- **التحقق:** التحقق من توقيع الطلب
- **الأحداث:**
  - `payment_succeeded`: نجح الدفع
  - `payment_failed`: فشل الدفع
  - `payment_refunded`: تم الاسترداد

### 3. تحديث حالة الطلب
- **نجح الدفع:**
  - تحديث حالة الطلب إلى CONFIRMED
  - حجز المخزون نهائياً
  - إرسال إشعارات التأكيد
- **فشل الدفع:**
  - تحديث حالة الطلب إلى PAYMENT_FAILED
  - إرجاع المخزون المحجوز
  - إرسال إشعار الفشل

### 4. إدارة الاسترداد
- **طلب الاسترداد:** من الإدارة أو العميل
- **المعالجة:** إنشاء استرداد مع موفر الدفع
- **التحديث:** تحديث حالة الطلب إلى REFUNDED

## نقاط مهمة
- تشفير جميع بيانات الدفع
- سجل مفصل لجميع المعاملات
- معالجة آمنة لـ Webhooks
- دعم الاسترداد الجزئي والكامل
- تزامن مع نظام المخزون
