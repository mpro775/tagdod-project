# تدفقات الدفع (Payment Flows)

## الملفات المتاحة
- `webhook.mmd` - مخطط معالجة Webhook الدفع

## شرح التدفقات

### 1. نظام الدفع المتقدم (Advanced Payment System)
- **طرق الدفع:** COD (الدفع عند الاستلام) و ONLINE (الدفع الإلكتروني)
- **العملات المتعددة:** دعم YER, SAR, USD مع تحويل تلقائي
- **مقدمي الخدمة:** دعم مقدمي خدمات دفع متعددين
- **الأمان:** تشفير جميع بيانات الدفع مع توقيع HMAC
- **المعاملات:** معاملات قاعدة بيانات آمنة لضمان التكامل

### 2. نظام Payment Intent المتقدم (Advanced Payment Intent)
- **إنشاء Intent:** إنشاء معرف فريد للدفع مع توقيع أمني
- **التوقيع:** توقيع HMAC للتحقق من صحة الطلب
- **المعرف:** حفظ paymentIntentId في الطلب مع معلومات إضافية
- **الحالة:** تتبع حالة الدفع (PENDING, SUCCESS, FAILED)
- **التحقق:** التحقق من صحة التوقيع قبل المعالجة

### 3. نظام COD (Cash on Delivery) المتقدم
- **التأكيد الفوري:** تأكيد الطلب فوراً عند اختيار COD
- **حجز المخزون:** حجز المخزون نهائياً مع تحديث قاعدة البيانات
- **تحديث الحالة:** تحديث حالة الطلب إلى CONFIRMED
- **الإشعارات:** إرسال إشعارات التأكيد للمستخدم
- **المخزون:** تحديث المخزون مع تسجيل في ledger

### 4. نظام الدفع الإلكتروني المتقدم (Advanced Online Payment)
- **إنشاء Intent:** إنشاء payment intent مع مقدم الخدمة
- **التوجيه:** توجيه المستخدم لصفحة الدفع
- **الانتظار:** انتظار تأكيد الدفع من مقدم الخدمة
- **Webhook:** استقبال تأكيد الدفع عبر webhook
- **التحقق:** التحقق من صحة التوقيع والبيانات

### 5. نظام Webhook المتقدم (Advanced Webhook System)
- **الاستقبال:** استقبال webhooks من مقدمي الخدمة
- **التحقق:** التحقق من توقيع الطلب باستخدام HMAC
- **المعالجة:** معالجة أحداث الدفع المختلفة
- **الأحداث المدعومة:**
  - `SUCCESS`: نجح الدفع
  - `FAILED`: فشل الدفع
  - `REFUNDED`: تم الاسترداد
- **الأمان:** التحقق من صحة التوقيع قبل المعالجة

### 6. نظام إدارة حالة الطلب المتقدم (Advanced Order Status Management)
- **نجح الدفع:**
  - تحديث حالة الطلب إلى CONFIRMED
  - حجز المخزون نهائياً مع معاملة قاعدة بيانات
  - تحديث المخزون مع تسجيل في ledger
  - إرسال إشعارات التأكيد
  - تحديث حالة الدفع إلى PAID
- **فشل الدفع:**
  - تحديث حالة الطلب إلى PAYMENT_FAILED
  - إرجاع المخزون المحجوز
  - تحديث المخزون مع تسجيل في ledger
  - إرسال إشعار الفشل
  - تحديث حالة الدفع إلى FAILED

### 7. نظام إدارة المخزون المتقدم (Advanced Inventory Management)
- **الحجز:** حجز المخزون عند إنشاء الطلب
- **التأكيد:** تأكيد الحجز عند نجح الدفع
- **الإرجاع:** إرجاع المخزون عند فشل الدفع
- **Ledger:** تسجيل جميع التغييرات في inventory ledger
- **المعاملات:** استخدام معاملات قاعدة بيانات لضمان التكامل

### 8. نظام Multi-currency المتقدم (Advanced Multi-currency)
- **العملات المدعومة:** YER, SAR, USD
- **التحويل:** تحويل تلقائي للعملات حسب السعر الحالي
- **التسعير:** عرض الأسعار بالعملة المفضلة للمستخدم
- **الحساب:** حساب المبالغ بالعملة المختارة
- **التخزين:** حفظ المبالغ بالعملة الأصلية

### 9. نظام Database Transactions المتقدم (Advanced Database Transactions)
- **المعاملات:** استخدام MongoDB transactions لضمان التكامل
- **التراجع:** إمكانية التراجع عن جميع التغييرات عند الفشل
- **التزامن:** ضمان التزامن في العمليات المتعددة
- **الاسترداد:** استرداد تلقائي عند فشل المعاملات
- **السجل:** تسجيل مفصل لجميع المعاملات

### 10. نظام Reservation System المتقدم (Advanced Reservation System)
- **الحجز المؤقت:** حجز المخزون لمدة محددة (TTL)
- **الانتهاء:** انتهاء صلاحية الحجز تلقائياً
- **التحديث:** تحديث حالة الحجز حسب حالة الدفع
- **التحرير:** تحرير المخزون عند انتهاء الحجز
- **التتبع:** تتبع جميع عمليات الحجز

## هيكل البيانات

### حقول الدفع الأساسية (Payment Fields)
- `paymentIntentId`: معرف نية الدفع (string) - مطلوب
- `paymentMethod`: طريقة الدفع (enum) - مطلوب
- `paymentProvider`: مقدم خدمة الدفع (string) - اختياري
- `paymentStatus`: حالة الدفع (enum) - مطلوب
- `amount`: المبلغ (number) - مطلوب
- `currency`: العملة (string) - مطلوب

### حقول التوقيع (Signature Fields)
- `signature`: التوقيع الأمني (string) - مطلوب
- `signingKey`: مفتاح التوقيع (string) - مطلوب
- `payload`: البيانات الموقعة (string) - مطلوب

### حقول Webhook (Webhook Fields)
- `intentId`: معرف نية الدفع (string) - مطلوب
- `status`: حالة الدفع (enum) - مطلوب
- `amount`: المبلغ (number) - مطلوب
- `signature`: التوقيع (string) - مطلوب

### طرق الدفع المتاحة (Payment Methods)
1. **COD** - الدفع عند الاستلام
2. **ONLINE** - الدفع الإلكتروني

### حالات الدفع المتاحة (Payment Status)
1. **PENDING** - في الانتظار
2. **PAID** - تم الدفع
3. **FAILED** - فشل الدفع
4. **REFUNDED** - تم الاسترداد

### العملات المدعومة (Supported Currencies)
1. **YER** - الريال اليمني
2. **SAR** - الريال السعودي
3. **USD** - الدولار الأمريكي

## API Endpoints المتاحة

### معالجة الدفع
- **POST /checkout/preview** - معاينة الطلب قبل التأكيد
- **POST /checkout/confirm** - تأكيد الطلب وإنشاء نية الدفع
- **POST /payments/webhook** - استقبال webhooks من مقدمي الخدمة

### إدارة الطلبات
- **GET /orders** - قائمة طلبات المستخدم
- **GET /orders/:id** - تفاصيل طلب محدد
- **POST /orders/:id/cancel** - إلغاء طلب

### إدارة الإدارة
- **GET /admin/orders** - قائمة جميع الطلبات
- **POST /admin/orders/:id/status** - تحديث حالة الطلب
- **POST /admin/orders/:id/ship** - شحن الطلب
- **POST /admin/orders/:id/refund** - استرداد مبلغ

## DTOs المتاحة

### معاينة الطلب
- `CheckoutPreviewDto`: معاينة الطلب
  - `currency`: العملة (required)
  - `deliveryAddressId`: معرف عنوان التسليم (optional)

### تأكيد الطلب
- `CheckoutConfirmDto`: تأكيد الطلب
  - `currency`: العملة (required)
  - `paymentMethod`: طريقة الدفع (required)
  - `paymentProvider`: مقدم خدمة الدفع (optional)
  - `deliveryAddressId`: معرف عنوان التسليم (optional)
  - `couponCode`: كود الكوبون (optional)

### Webhook
- `WebhookDto`: webhook الدفع
  - `intentId`: معرف نية الدفع (required)
  - `status`: حالة الدفع (required)
  - `amount`: المبلغ (required)
  - `signature`: التوقيع (required)

## نقاط مهمة
- **أمان عالي:** تشفير جميع بيانات الدفع مع توقيع HMAC
- **معاملات آمنة:** استخدام MongoDB transactions لضمان التكامل
- **دعم متعدد العملات:** YER, SAR, USD مع تحويل تلقائي
- **نظام COD:** دعم الدفع عند الاستلام مع تأكيد فوري
- **نظام Online:** دعم الدفع الإلكتروني مع webhooks آمنة
- **إدارة المخزون:** تكامل كامل مع نظام المخزون
- **حجز ذكي:** نظام حجز المخزون مع TTL
- **تتبع شامل:** تتبع جميع عمليات الدفع والمخزون
- **إشعارات:** إشعارات تلقائية لجميع حالات الدفع
- **استرداد:** دعم الاسترداد الجزئي والكامل
