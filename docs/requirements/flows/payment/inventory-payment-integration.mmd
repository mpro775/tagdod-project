%% Inventory Payment Integration Flow
%% View at https://mermaid.live
flowchart TD
  A[تأكيد طلب] --> B{طريقة الدفع?}
  B -->|COD| C[تأكيد فوري للطلب]
  B -->|ONLINE| D[انتظار webhook الدفع]

  C --> E[تحديث حالة الطلب إلى CONFIRMED]
  D --> F[تحديث حالة الطلب إلى PENDING_PAYMENT]

  E --> G[تحديث المخزون - تقليل الكميات]
  F --> H[المخزون محجوز مؤقتاً]

  G --> I[فحص مستويات المخزون]
  H --> J[انتظار تأكيد الدفع]

  I --> K{المخزون أقل من الحد الأدنى?}
  K -->|نعم| L[إرسال إشعار مخزون منخفض]
  K -->|لا| M[استمرار التشغيل العادي]

  J --> N{استقبال webhook?}
  N -->|نجح الدفع| O[تحديث حالة الطلب إلى CONFIRMED]
  N -->|فشل الدفع| P[تحديث حالة الطلب إلى PAYMENT_FAILED]

  O --> Q[تحديث المخزون - تقليل الكميات]
  P --> R[المخزون لا يزال محجوزاً]

  Q --> S[فحص مستويات المخزون]
  R --> T[يمكن إرجاع المخزون لاحقاً]

  S --> U{المخزون نفد?}
  U -->|نعم| V[إرسال إشعار نفاد مخزون]
  U -->|لا| W[استمرار التشغيل العادي]

  L --> X[نهاية]
  M --> X
  V --> X
  W --> X
  T --> X

  %% Inventory Update Process
  Y[تحديث المخزون] --> Y1[لكل عنصر في الطلب]
  Y1 --> Y2[تقليل stock بمقدار quantity]
  Y2 --> Y3[حفظ التغيير في inventory ledger]

  %% Inventory Notifications
  Z[إشعارات المخزون] --> Z1[LOW_STOCK - مخزون منخفض]
  Z1 --> Z2[OUT_OF_STOCK - نفاد المخزون]
  Z2 --> Z3[PRODUCT_BACK_IN_STOCK - عودة المخزون]

  %% Order Status Impact
  AA[تأثير حالة الطلب] --> AA1[CONFIRMED - يقلل المخزون]
  AA1 --> AA2[PAYMENT_FAILED - يحتفظ بالمخزون المحجوز]
  AA2 --> AA3[CANCELLED - يعيد المخزون]
