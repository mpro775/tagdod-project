%% Inventory Payment Integration Flow
%% View at https://mermaid.live
flowchart TD
  A[تأكيد طلب] --> B{طريقة الدفع?}
  B -->|COD| C[تأكيد فوري للطلب]
  B -->|ONLINE| D[انتظار webhook الدفع]
  B -->|BANK_TRANSFER| AA[حفظ رقم الحوالة]

  C --> E[تحديث حالة الطلب إلى CONFIRMED]
  D --> F[تحديث حالة الطلب إلى PENDING_PAYMENT]

  E --> G[تحديث المخزون - تقليل الكميات]
  F --> H[المخزون محجوز مؤقتاً]
  AA --> AB[حالة الطلب: PENDING_PAYMENT]

  G --> I[فحص مستويات المخزون]
  H --> J[انتظار تأكيد الدفع]
  AB --> AC[المخزون محجوز مؤقتاً]

  I --> K{المخزون أقل من الحد الأدنى?}
  K -->|نعم| L[إرسال إشعار مخزون منخفض]
  K -->|لا| M[استمرار التشغيل العادي]

  J --> N{استقبال webhook?}
  N -->|نجح الدفع| O[تحديث حالة الطلب إلى CONFIRMED]
  N -->|فشل الدفع| P[تحديث حالة الطلب إلى PAYMENT_FAILED]

  AC --> AD{مطابقة الدفع من لوحة التحكم?}
  AD -->|المبلغ كافٍ| AE[تحديث حالة الطلب إلى CONFIRMED]
  AD -->|المبلغ غير كافٍ| AF[تحديث حالة الطلب إلى PAYMENT_FAILED]

  O --> Q[تحديث المخزون - تقليل الكميات]
  P --> R[المخزون لا يزال محجوزاً]
  AE --> Q
  AF --> R

  Q --> S[فحص مستويات المخزون]
  R --> T[يمكن إرجاع المخزون لاحقاً]

  S --> U{المخزون نفد?}
  U -->|نعم| V[إرسال إشعار نفاد مخزون]
  U -->|لا| W[استمرار التشغيل العادي]

  L --> X[نهاية]
  M --> X
  V --> X
  W --> X
  T --> X

  %% Inventory Update Process
  Y[تحديث المخزون] --> Y1[لكل عنصر في الطلب]
  Y1 --> Y2[تقليل stock بمقدار quantity]
  Y2 --> Y3[حفظ التغيير في inventory ledger]

  %% Inventory Notifications
  Z[إشعارات المخزون] --> Z1[LOW_STOCK - مخزون منخفض]
  Z1 --> Z2[OUT_OF_STOCK - نفاد المخزون]
  Z2 --> Z3[PRODUCT_BACK_IN_STOCK - عودة المخزون]

  %% Order Status Impact
  AG[تأثير حالة الطلب] --> AG1[CONFIRMED - يقلل المخزون]
  AG1 --> AG2[PAYMENT_FAILED - يحتفظ بالمخزون المحجوز]
  AG2 --> AG3[CANCELLED - يعيد المخزون]
  AG3 --> AG4[PENDING_PAYMENT - يحتفظ بالمخزون المحجوز حتى المطابقة]

  %% Local Payment Verification Process
  AH[مطابقة الدفع المحلي] --> AH1[الإدارة تراجع رقم الحوالة]
  AH1 --> AH2[الإدارة تدخل المبلغ والعملة]
  AH2 --> AH3{مقارنة المبلغ: المطابق >= المطلوب?}
  AH3 -->|نعم| AH4[قبول الدفع - PAID + CONFIRMED]
  AH3 -->|لا| AH5[رفض الدفع - FAILED]
  AH4 --> AH6[تحديث المخزون]
  AH5 --> AH7[المخزون لا يزال محجوزاً]
