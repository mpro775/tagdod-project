%% Payment Webhook Processing Flow
%% View at https://mermaid.live
flowchart TD
  A[استقبال Webhook من Payment Provider] --> B[استخراج البيانات من الطلب]
  B --> C{التحقق من التوقيع?}
  C -->|توقيع غير صحيح| D[إرجاع خطأ 401 - توقيع غير صحيح]
  
  %% Note: BANK_TRANSFER لا يستخدم webhooks
  AA[ملاحظة: الدفع المحلي BANK_TRANSFER] --> AB[لا يستخدم webhooks]
  AB --> AC[يتم المطابقة يدوياً من لوحة التحكم]
  AC --> AD[انظر: Local Payment Verification Flow]

  C -->|توقيع صحيح| E[البحث عن الطلب بـ paymentIntentId]
  E --> F{وجد الطلب?}
  F -->|لا| G[إرجاع خطأ - طلب غير موجود]

  F -->|نعم| H{حالة الدفع في Webhook?}
  H -->|SUCCESS| I[تحديث حالة الدفع إلى PAID]
  H -->|FAILED| J[تحديث حالة الدفع إلى FAILED]

  I --> K[تحديث حالة الطلب إلى CONFIRMED]
  K --> L[تحديث confirmedAt إلى الآن]
  L --> M[إرسال إشعار تأكيد الطلب]

  J --> N[تحديث حالة الطلب إلى PAYMENT_FAILED]
  N --> O[إرسال إشعار فشل الدفع]

  M --> P[تحديث المخزون - تقليل الكميات]
  O --> Q[لا تغيير في المخزون - الكميات محجوزة]

  P --> R[إرسال إشعارات مخزون إذا لزم الأمر]
  Q --> R

  R --> S[حفظ تفاصيل Webhook في السجل]
  S --> T[إرجاع استجابة نجاح 200]

  %% Error Cases
  D --> U[نهاية - خطأ]
  G --> U

  T --> V[نهاية - نجاح]

  %% Webhook Data Structure
  W[بيانات Webhook المتوقعة] --> W1[intentId: معرف نية الدفع]
  W1 --> W2[status: SUCCESS أو FAILED]
  W2 --> W3[amount: المبلغ المدفوع]
  W3 --> W4[signature: توقيع HMAC]

  %% Signature Verification
  X[التحقق من التوقيع] --> X1[استخراج signature من headers]
  X1 --> X2[إنشاء HMAC من البيانات]
  X2 --> X3[مقارنة التوقيعين]

  X3 -->|متطابق| Y[التوقيع صحيح]
  X3 -->|غير متطابق| Z[التوقيع غير صحيح]

  Y --> C
  Z --> D
