# تدفقات إدارة العناوين (Address Management Flows)

## الملفات المتاحة
- `address-management.mmd` - مخطط إدارة العناوين

## شرح التدفقات

### 1. إضافة عنوان جديد
- **المدخلات:** تفاصيل العنوان الكاملة (label, recipientName, recipientPhone, line1, city, etc.)
- **التحقق:** التحقق من صحة العنوان وتنسيق البيانات
- **الجغرافيا:** تحديد الإحداثيات تلقائياً (coords) - اختياري
- **الافتراضي:** إذا كان العنوان الأول، يصبح افتراضياً تلقائياً
- **الحفظ:** حفظ العنوان مع معلومات إضافية (usageCount, isActive)

### 2. تعديل العنوان
- **التحميل:** تحميل بيانات العنوان الحالي
- **التعديل:** إجراء التغييرات المطلوبة
- **التحقق:** التحقق من صحة البيانات الجديدة
- **الافتراضي:** إذا تم تعيينه كافتراضي، إلغاء الافتراضية من العناوين الأخرى
- **التحديث:** حفظ التغييرات

### 3. حذف العنوان (Soft Delete)
- **التحقق:** فحص إذا كان العنوان الوحيد النشط (منع الحذف)
- **الافتراضي:** إذا كان افتراضياً، تعيين عنوان آخر كافتراضي تلقائياً
- **الحذف:** حذف ناعم (Soft Delete) - تعيين deletedAt
- **التحديث:** تحديث الإحصائيات

### 4. تعيين العنوان الافتراضي
- **التحديث:** تعيين العنوان الجديد كافتراضي
- **الإلغاء:** إلغاء الافتراضية من العناوين الأخرى
- **التحديث:** تحديث قاعدة البيانات

### 5. استعادة العنوان المحذوف
- **التحقق:** التأكد من وجود العنوان المحذوف
- **الاستعادة:** إلغاء الحذف الناعم (حذف deletedAt)
- **التفعيل:** تعيين isActive = true
- **التحديث:** تحديث قاعدة البيانات

### 6. الحصول على العناوين النشطة فقط
- **الفلترة:** استرجاع العناوين النشطة وغير المحذوفة
- **الترتيب:** ترتيب حسب الافتراضي، آخر استخدام، تاريخ الإنشاء

### 7. التحقق من ملكية العنوان
- **التحقق:** التأكد من أن العنوان يخص المستخدم
- **الأمان:** منع الوصول للعناوين الخاصة بمستخدمين آخرين

### 8. تتبع استخدام العناوين
- **التسجيل:** تحديث lastUsedAt و usageCount تلقائياً عند استخدام العنوان في الطلبات
- **الإحصائيات:** تتبع أكثر العناوين استخداماً للترتيب الذكي

## API Endpoints المتاحة

### GET /addresses
- **الوصف:** الحصول على جميع عناوين المستخدم
- **المعاملات:** `includeDeleted` (اختياري) - تضمين العناوين المحذوفة
- **الترتيب:** حسب الافتراضي، آخر استخدام، تاريخ الإنشاء

### GET /addresses/active
- **الوصف:** الحصول على العناوين النشطة فقط
- **الفلترة:** isActive=true و deletedAt=null

### GET /addresses/default
- **الوصف:** الحصول على العنوان الافتراضي
- **المنطق:** إذا لم يوجد افتراضي، يعيد الأكثر استخداماً أو الأحدث

### GET /addresses/:id
- **الوصف:** الحصول على عنوان محدد
- **الأمان:** التحقق من ملكية العنوان

### POST /addresses
- **الوصف:** إنشاء عنوان جديد
- **المنطق:** إذا كان الأول، يصبح افتراضياً تلقائياً

### PATCH /addresses/:id
- **الوصف:** تحديث عنوان موجود
- **المنطق:** إذا تم تعيينه كافتراضي، إلغاء الافتراضية من الآخرين

### DELETE /addresses/:id
- **الوصف:** حذف عنوان (Soft Delete)
- **الحماية:** منع حذف العنوان الوحيد
- **المنطق:** إذا كان افتراضياً، تعيين آخر كافتراضي

### POST /addresses/:id/set-default
- **الوصف:** تعيين عنوان كافتراضي
- **المنطق:** إلغاء الافتراضية من جميع العناوين الأخرى

### POST /addresses/:id/restore
- **الوصف:** استعادة عنوان محذوف
- **الشروط:** العنوان يجب أن يكون محذوفاً

### GET /addresses/validate/:id
- **الوصف:** التحقق من ملكية العنوان
- **الاستخدام:** للأمان والتحقق من الصلاحيات

## نقاط مهمة
- **دعم الإحداثيات الجغرافية:** coords (lat, lng) - إجباري لجميع العناوين
- **نظام حذف ناعم:** Soft Delete مع deletedAt و deletedBy
- **تتبع الاستخدام:** usageCount و lastUsedAt للترتيب الذكي
- **منع حذف العنوان الوحيد:** حماية من فقدان جميع العناوين النشطة
- **الإدارة التلقائية للافتراضي:** تعيين عنوان آخر كافتراضي عند حذف العنوان الافتراضي
- **الملاحظات:** notes لتعليمات التسليم الخاصة
- **الترتيب الذكي:** حسب الافتراضي، آخر استخدام، تاريخ الإنشاء
- **الأمان:** التحقق من ملكية العناوين لكل المستخدمين
- **الاستعادة:** إمكانية استعادة العناوين المحذوفة
- **الفهرسة:** indexes محسنة للأداء (userId, isDefault, deletedAt, coords, etc.)
- **الاستجابة الموحدة:** جميع الـ endpoints ترجع نفس تنسيق الاستجابة

## هيكل البيانات

### حقول العنوان المطلوبة
- `label`: تسمية العنوان (مثل: "المنزل", "المكتب") - مطلوب
- `line1`: العنوان الرئيسي (الشارع، رقم المبنى) - مطلوب
- `city`: المدينة - مطلوب
- `coords`: الإحداثيات `{lat: number, lng: number}` - مطلوب

### حقول العنوان الاختيارية
- `notes`: ملاحظات أو تعليمات التسليم (حتى 500 حرف)

### حقول النظام التلقائية
- `userId`: معرف المستخدم (ObjectId)
- `isDefault`: العنوان الافتراضي (boolean) - افتراضي: false
- `isActive`: العنوان نشط (boolean) - افتراضي: true
- `usageCount`: عدد مرات الاستخدام (number) - افتراضي: 0
- `lastUsedAt`: آخر استخدام (Date)
- `deletedAt`: تاريخ الحذف (Date) - للحذف الناعم
- `deletedBy`: من قام بالحذف (ObjectId)
- `createdAt`: تاريخ الإنشاء (Date)
- `updatedAt`: تاريخ التحديث (Date)

## معالجة الأخطاء

### أخطاء التحقق (400)
- بيانات مطلوبة مفقودة (label, line1, city, coords)
- تنسيق الإحداثيات غير صحيح

### أخطاء الأمان (401/403)
- غير مصرح بالوصول
- العنوان لا يخص المستخدم

### أخطاء المنطق (400)
- محاولة حذف العنوان الوحيد
- العنوان غير موجود

### أخطاء الخادم (500)
- خطأ في قاعدة البيانات
- خطأ في الخدمة
