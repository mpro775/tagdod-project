%% Authentication Flow
%% View at https://mermaid.live
sequenceDiagram
  participant User as User
  participant API as API
  participant DB as Database
  participant SMS as SMS Service

  %% OTP Send Flow
  User->>API: POST /auth/send-otp
  API->>API: Validate phone number
  API->>SMS: Send OTP code
  SMS->>API: Confirmation
  API->>User: OTP sent successfully

  %% OTP Verification Flow
  User->>API: POST /auth/verify-otp (phone, otp)
  API->>API: Validate OTP code
  alt OTP Valid
    API->>DB: Check if user exists
    alt User exists
      API->>API: Generate JWT token
      API->>DB: Update lastActivityAt
      API->>User: Return JWT token
    else User doesn't exist
      API->>User: First login - set password required
    end
  else OTP Invalid
    API->>User: Invalid OTP
  end

  %% Set Password Flow
  User->>API: POST /auth/set-password
  API->>API: Validate JWT token
  API->>API: Hash password
  API->>DB: Save password hash
  API->>User: Password set successfully

  %% Forgot Password Flow
  User->>API: POST /auth/forgot-password
  API->>API: Validate phone number
  API->>DB: Check user exists
  API->>SMS: Send reset OTP
  API->>User: Reset code sent

  %% Reset Password Flow
  User->>API: POST /auth/reset-password (phone, otp, newPassword)
  API->>API: Validate OTP
  API->>API: Hash new password
  API->>DB: Update password hash
  API->>User: Password reset successfully

  %% Update Preferred Currency
  User->>API: PATCH /auth/preferred-currency (JWT)
  API->>API: Validate JWT token
  API->>DB: Update preferredCurrency
  API->>User: Currency updated

  %% API Request with JWT
  User->>API: API Request with JWT header
  API->>API: Extract JWT token
  API->>API: Verify token signature
  API->>API: Decode token payload
  API->>DB: Load user data
  API->>API: Check user status
  alt User active
    API->>API: Process request
    API->>User: Response
  else User suspended/deleted
    API->>User: Access denied
  end
