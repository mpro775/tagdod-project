# تدفقات إدارة الأدوار والصلاحيات (RBAC Flows)

## الملفات المتاحة

### المخططات الرئيسية
- `role-permissions.mmd` - مخطط نظام RBAC (نظرة عامة)
- `capabilities-management.mmd` - مخطط إدارة القدرات والصلاحيات
- `authentication-flow.mmd` - مخطط تدفق المصادقة والتحقق
- `permission-control.mmd` - مخطط فحص الصلاحيات والتحكم في الوصول
- `role-assignment.mmd` - مخطط تعيين الأدوار وإدارة المستخدمين
- `security-measures.mmd` - مخطط إجراءات الأمان والحماية

## شرح التدفقات

### 1. نظام القدرات (Capabilities Management)
- **إدارة القدرات:** عرض وتحديث قدرات المستخدمين
- **حالات القدرات:** none, pending, approved, rejected
- **الموافقة على الأدوار:** نظام موافقة متدرج للأدوار
- **خصومات التاجر:** إدارة خصومات التاجر بالنسبة المئوية
- **مراقبة الاستخدام:** تتبع استخدام الأدوار والصلاحيات

### 2. تدفق المصادقة (Authentication Flow)
- **التحقق من الهوية:** استخراج وتحقق من JWT token
- **المصادقة متعددة العوامل:** OTP عبر SMS/Email
- **إدارة الجلسات:** إنشاء وإدارة جلسات المستخدمين
- **أمان الرموز:** توليد وتحقق من أمان الرموز
- **أمان كلمات المرور:** تشفير وإدارة كلمات المرور

### 3. التحكم في الصلاحيات (Permission Control)
- **فحص الصلاحيات:** التحقق من الصلاحيات المطلوبة
- **التحكم في الموارد:** فحص ملكية وإمكانية الوصول للموارد
- **التحكم في الميزات:** تفعيل/إلغاء الميزات حسب الدور
- **التحكم في البيانات:** تصفية البيانات حسب مستوى الصلاحية
- **مصفوفة الصلاحيات:** مصفوفة شاملة للأدوار والصلاحيات

### 4. تعيين الأدوار (Role Assignment)
- **تعيين الأدوار:** تعيين أدوار جديدة للمستخدمين
- **إزالة الأدوار:** إزالة الأدوار من المستخدمين
- **تحديث الأدوار:** تعديل إعدادات الأدوار الموجودة
- **التعيين الجماعي:** تعيين أدوار لعدة مستخدمين
- **طلبات الأدوار:** معالجة طلبات الحصول على أدوار

### 5. إجراءات الأمان (Security Measures)
- **أمان المصادقة:** حماية عمليات تسجيل الدخول
- **أمان التفويض:** حماية عمليات التحقق من الصلاحيات
- **حماية البيانات:** تشفير وإخفاء البيانات الحساسة
- **أمان الشبكة:** حماية الشبكة من التهديدات
- **المراجعة والمراقبة:** تسجيل ومراقبة الأحداث الأمنية

## الأدوار في النظام

### 1. دور العميل (Customer Role)
- **الصلاحيات الأساسية:** تصفح المنتجات، إدارة الطلبات
- **الصلاحيات المتقدمة:** تذاكر الدعم، تقييم المنتجات
- **القيود:** الوصول المحدود للموارد الإدارية
- **الحالة الافتراضية:** مفعل لجميع المستخدمين

### 2. دور المهندس (Engineer Role)
- **الصلاحيات المضافة:** إدارة طلبات الخدمة، قبول المهام
- **الصلاحيات المتخصصة:** لوحة تحكم المهندس، تحديث حالة الخدمة
- **متطلبات الموافقة:** التحقق من المؤهلات والخبرة
- **الحالة:** يتطلب موافقة إدارية

### 3. دور التاجر (Wholesale Role)
- **الصلاحيات المضافة:** أسعار الجملة، خصومات الحجم
- **الصلاحيات المتخصصة:** كتالوج الجملة، تقارير المبيعات
- **خصم التاجر:** نسبة خصم قابلة للتخصيص (0-100%)
- **الحالة:** يتطلب موافقة إدارية

### 4. دور المدير (Admin Role)
- **الصلاحيات الكاملة:** جميع صلاحيات النظام
- **إدارة المستخدمين:** إنشاء وتعديل وحذف المستخدمين
- **إعدادات النظام:** تكوين النظام والإعدادات
- **التحليلات:** الوصول لجميع التقارير والإحصائيات
- **الأمان:** التحكم في الأمان والصلاحيات

## حالات القدرات

### 1. حالة "none" - لا توجد قدرة
- **الوصف:** المستخدم لا يملك القدرة
- **السلوك:** لا يمكن الوصول للميزات المتخصصة
- **التغيير:** يمكن طلب الحصول على القدرة

### 2. حالة "pending" - في انتظار الموافقة
- **الوصف:** طلب الحصول على القدرة قيد المراجعة
- **السلوك:** لا يمكن الوصول للميزات حتى الموافقة
- **التغيير:** ينتظر قرار الإدارة

### 3. حالة "approved" - موافق عليه
- **الوصف:** القدرة معتمدة ومفعلة
- **السلوك:** يمكن الوصول لجميع الميزات المتخصصة
- **التغيير:** يمكن إلغاء أو تعديل القدرة

### 4. حالة "rejected" - مرفوض
- **الوصف:** طلب الحصول على القدرة مرفوض
- **السلوك:** لا يمكن الوصول للميزات المتخصصة
- **التغيير:** يمكن تقديم طلب جديد بعد فترة

## ميزات الأمان

### 1. المصادقة متعددة العوامل
- **OTP عبر SMS:** رمز التحقق عبر الرسائل النصية
- **OTP عبر Email:** رمز التحقق عبر البريد الإلكتروني
- **الرموز المؤقتة:** رموز صالحة لمدة محددة
- **معدل المحاولات:** تحديد عدد محاولات التحقق

### 2. التحكم في الوصول
- **قائمة التحكم في الوصول:** ACL للموارد
- **ملكية الموارد:** فحص ملكية المستخدم للموارد
- **السياق الزمني:** صلاحيات محددة بوقت معين
- **السياق المكاني:** صلاحيات محددة بموقع معين

### 3. حماية البيانات
- **تشفير البيانات:** تشفير البيانات الحساسة
- **إخفاء البيانات:** إخفاء البيانات الحساسة في السجلات
- **نسخ احتياطية آمنة:** نسخ احتياطية مشفرة
- **الاحتفاظ بالبيانات:** سياسات الاحتفاظ بالبيانات

### 4. مراقبة الأمان
- **سجلات الأمان:** تسجيل جميع الأحداث الأمنية
- **كشف التهديدات:** كشف الأنشطة المشبوهة
- **الاستجابة للحوادث:** إجراءات الاستجابة للحوادث الأمنية
- **التقارير الأمنية:** تقارير شاملة عن الأمان

## التكامل مع الأنظمة الأخرى

### تكامل مع نظام المستخدمين
- **إدارة الملفات الشخصية:** ربط الأدوار بالملفات الشخصية
- **تحديث البيانات:** تحديث معلومات المستخدمين
- **إدارة الحسابات:** إنشاء وحذف الحسابات

### تكامل مع نظام الطلبات
- **صلاحيات الطلبات:** التحكم في عرض وتعديل الطلبات
- **صلاحيات الشحن:** التحكم في عمليات الشحن
- **صلاحيات الاسترداد:** التحكم في عمليات الاسترداد

### تكامل مع نظام المنتجات
- **صلاحيات الكتالوج:** التحكم في عرض المنتجات
- **صلاحيات الأسعار:** التحكم في عرض الأسعار
- **صلاحيات المخزون:** التحكم في عرض المخزون

## نقاط مهمة
- **نظام مرن:** دعم أدوار متعددة ومتدرجة
- **أمان متقدم:** حماية شاملة للنظام والبيانات
- **مراقبة مستمرة:** تتبع جميع العمليات والأحداث
- **تكامل كامل:** تكامل مع جميع أنظمة المنصة
- **قابلية التوسع:** دعم إضافة أدوار وصلاحيات جديدة
- **امتثال للقوانين:** الالتزام باللوائح الأمنية والخصوصية
