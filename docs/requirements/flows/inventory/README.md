# تدفقات المخزون (Inventory Flows)

## الملفات المتاحة
- `adjustments.mmd` - مخطط تعديلات المخزون

## شرح التدفقات

### 1. نظام المخزون الأساسي (Inventory Management)
- **المخزون الفعلي (on_hand):** الكمية المتاحة فعلياً
- **المخزون المحجوز (reserved):** الكمية المحجوزة للطلبات
- **مخزون الأمان (safety_stock):** الحد الأدنى المطلوب
- **المخزون المتاح:** on_hand - reserved - safety_stock
- **التحقق:** فحص توفر المخزون قبل الحجز

### 2. نظام التحفظ المتقدم (Reservation System)
- **التحفظ المؤقت:** حجز المخزون لمدة محددة (15 دقيقة افتراضياً)
- **حالات التحفظ:** ACTIVE, CANCELLED, COMMITTED
- **انتهاء الصلاحية:** TTL index للحذف التلقائي
- **الربط بالطلب:** ربط التحفظ بمعرف الطلب
- **التتبع:** تتبع حالة كل تحفظ

### 3. تأكيد المخزون (Commitment Process)
- **الوقت:** عند نجاح الدفع
- **المعاملات:** استخدام Database Transactions للأمان
- **التحويل:** تحويل التحفظ إلى بيع فعلي
- **التحديث:** تقليل المخزون الفعلي
- **السجل:** تسجيل الحركة في Inventory Ledger

### 4. إرجاع المخزون (Return Process)
- **أسباب الإرجاع:**
  - فشل الدفع (ORDER_CANCELLED_RELEASE)
  - إلغاء الطلب (ORDER_CANCELLED_RELEASE)
  - إرجاع المنتج من العميل (PRODUCT_RETURN)
  - تعديل يدوي (MANUAL_ADJUSTMENT)
- **المعالجة:** زيادة الكمية المتاحة
- **التسجيل:** تسجيل سبب الإرجاع في Ledger

### 5. نظام سجل المخزون (Inventory Ledger)
- **تسجيل شامل:** جميع حركات المخزون
- **المعلومات المسجلة:**
  - معرف التنويع (variantId)
  - التغيير في الكمية (change: +qty or -qty)
  - سبب التغيير (reason)
  - معرف المرجع (refId) - اختياري
- **التتبع:** إمكانية تتبع المخزون عبر الوقت

### 6. نظام انتهاء الصلاحية التلقائي (Auto-expiry)
- **TTL Index:** حذف تلقائي للتحفظات المنتهية
- **المدة الافتراضية:** 15 دقيقة (قابلة للتخصيص)
- **التحقق:** فحص التحفظات المنتهية
- **الإرجاع:** إرجاع المخزون المحجوز تلقائياً

### 7. نظام معاملات قاعدة البيانات (Database Transactions)
- **الأمان:** ضمان تكامل البيانات
- **العمليات الذرية:** نجاح أو فشل جميع العمليات معاً
- **التحفظ:** حجز المخزون في معاملة واحدة
- **التأكيد:** تأكيد الطلب في معاملة واحدة

### 8. نظام تتبع الحالة (Status Tracking)
- **حالات التحفظ:**
  - ACTIVE: نشط ومحجوز
  - CANCELLED: ملغي
  - COMMITTED: مؤكد ومحول لبيع
- **التتبع:** تتبع تغييرات الحالة
- **السجل:** حفظ تاريخ التغييرات

### 9. نظام مرجع التتبع (Reference Tracking)
- **معرف المرجع:** ربط العمليات بمعرفات محددة
- **الطلبات:** ربط التحفظ بالطلب
- **التعديلات:** ربط التعديلات بالمرجع
- **التتبع:** إمكانية تتبع العمليات

### 10. نظام التحقق من المخزون (Inventory Validation)
- **التحقق المسبق:** فحص توفر المخزون قبل الحجز
- **منع النقص:** منع البيع عند عدم توفر المخزون
- **التحقق المستمر:** فحص المخزون في كل خطوة
- **الأمان:** ضمان عدم بيع مخزون غير متوفر

## هيكل البيانات

### حقول المخزون الأساسية (Inventory)
- `variantId`: معرف التنويع (ObjectId) - فريد
- `on_hand`: المخزون الفعلي (number) - افتراضي 0
- `reserved`: المخزون المحجوز (number) - افتراضي 0
- `safety_stock`: مخزون الأمان (number) - افتراضي 0

### حقول التحفظ (Reservation)
- `variantId`: معرف التنويع (ObjectId)
- `orderId`: معرف الطلب (ObjectId)
- `qty`: الكمية المحجوزة (number) - الحد الأدنى 1
- `expiresAt`: تاريخ انتهاء الصلاحية (Date) - مفهرس
- `status`: حالة التحفظ (enum) - افتراضي ACTIVE

### حقول سجل المخزون (Inventory Ledger)
- `variantId`: معرف التنويع (ObjectId)
- `change`: التغيير في الكمية (number) - موجب أو سالب
- `reason`: سبب التغيير (string)
- `refId`: معرف المرجع (string) - اختياري

### حالات التحفظ المتاحة
1. **ACTIVE** - نشط ومحجوز
2. **CANCELLED** - ملغي
3. **COMMITTED** - مؤكد ومحول لبيع

### أسباب التغيير في سجل المخزون
1. **ORDER_CONFIRMED_OUT** - تأكيد الطلب (خروج)
2. **ORDER_CANCELLED_RELEASE** - إلغاء الطلب (إرجاع)
3. **PRODUCT_RETURN** - إرجاع المنتج
4. **MANUAL_ADJUSTMENT** - تعديل يدوي
5. **STOCK_RECEIVED** - استلام مخزون جديد
6. **DAMAGE_LOSS** - تلف أو فقدان
7. **AUDIT_ADJUSTMENT** - تعديل مراجعة

## API Endpoints المتاحة

### إدارة المخزون
- **GET /inventory/:variantId** - عرض مخزون تنويع محدد
- **POST /inventory/:variantId/adjust** - تعديل المخزون
- **GET /inventory/:variantId/ledger** - سجل حركات المخزون
- **GET /inventory/:variantId/reservations** - التحفظات النشطة

### إدارة التحفظات
- **POST /inventory/reserve** - حجز مخزون
- **POST /inventory/:reservationId/cancel** - إلغاء تحفظ
- **POST /inventory/:reservationId/commit** - تأكيد تحفظ
- **GET /inventory/reservations/expired** - التحفظات المنتهية

### التقارير والإحصائيات
- **GET /inventory/reports/low-stock** - تقرير المخزون المنخفض
- **GET /inventory/reports/movements** - تقرير حركات المخزون
- **GET /inventory/reports/summary** - ملخص المخزون
- **GET /inventory/analytics/trends** - تحليل اتجاهات المخزون

## نقاط مهمة
- **تتبع دقيق:** تتبع المخزون في الوقت الفعلي
- **منع النقص:** منع البيع عند نفاد المخزون
- **معاملات آمنة:** استخدام Database Transactions
- **انتهاء تلقائي:** TTL index للحذف التلقائي
- **سجل شامل:** تسجيل جميع الحركات
- **تتبع الحالة:** تتبع حالات التحفظ
- **مرجع التتبع:** ربط العمليات بالمراجع
- **التحقق المستمر:** فحص المخزون في كل خطوة
- **مخزون الأمان:** حماية من النقص المفاجئ
- **فهرسة محسنة:** indexes محسنة للأداء السريع
