%% City-Based Filtering Flow for Services
%% View at https://mermaid.live
flowchart TD
  %% Customer creates request
  A[العميل ينشئ طلب خدمة] --> B[ملء النموذج]
  B --> B1[عنوان الطلب]
  B1 --> B2[وصف الطلب]
  B2 --> B3[🏙️ اختيار المدينة - إلزامي]
  B3 --> B3A{هل المدينة صحيحة؟}
  
  B3A -->|لا| B3B[عرض خطأ: المدينة يجب أن تكون من المدن اليمنية]
  B3B --> B3
  
  B3A -->|نعم| B4[نوع الخدمة]
  B4 --> B5[العنوان والإحداثيات]
  
  B5 --> C[POST /services]
  C --> C1[حفظ في قاعدة البيانات]
  C1 --> C2[city: المدينة المختارة مثال صنعاء]
  C2 --> C3[status: OPEN]
  C3 --> C4[فهرسة بـ city + status]
  
  %% Engineer searches for requests
  D[المهندس يبحث عن طلبات] --> E[GET /services/requests/nearby]
  E --> E1[engineerId: معرف المهندس]
  E1 --> E2[lat, lng: إحداثيات المهندس]
  E2 --> E3[radiusKm: نطاق البحث]
  
  E3 --> F[الباك إند يعالج الطلب]
  F --> F1[🔍 Step 1: جلب مدينة المهندس]
  F1 --> F2[SELECT city FROM users WHERE _id = engineerId]
  F2 --> F3[engineerCity مثال: صنعاء]
  
  F3 --> G[🔍 Step 2: البحث في قاعدة البيانات]
  G --> G1[WHERE city = engineerCity]
  G1 --> G2[AND status IN OPEN, OFFERS_COLLECTING]
  G2 --> G3[AND engineerId IS NULL]
  G3 --> G4[AND location NEAR lat, lng WITHIN radiusKm]
  G4 --> G5[AND userId != engineerId]
  
  G5 --> H[🔍 Step 3: إرجاع النتائج]
  H --> H1[فقط الطلبات من نفس المدينة]
  H1 --> H2[مرتبة حسب المسافة]
  H2 --> H3[محدودة بـ 100 طلب]
  
  H3 --> I{عدد النتائج}
  I -->|0 طلبات| I1[لا توجد طلبات في مدينتك]
  I -->|> 0 طلبات| I2[عرض القائمة للمهندس]
  
  I2 --> J[المهندس يرى الطلبات]
  J --> J1[طلب 1: صنعاء - 2 كم]
  J1 --> J2[طلب 2: صنعاء - 5 كم]
  J2 --> J3[طلب 3: صنعاء - 8 كم]
  
  J3 --> K{يختار المهندس طلباً}
  K -->|نعم| L[تقديم عرض]
  K -->|لا| M[البحث مرة أخرى]
  
  %% Examples
  N[مثال 1: مهندس صنعاء] --> N1[engineerCity: صنعاء]
  N1 --> N2[يبحث عن طلبات]
  N2 --> N3[✅ يرى: طلبات صنعاء فقط]
  N3 --> N4[❌ لا يرى: طلبات عدن، تعز...]
  
  O[مثال 2: مهندس عدن] --> O1[engineerCity: عدن]
  O1 --> O2[يبحث عن طلبات]
  O2 --> O3[✅ يرى: طلبات عدن فقط]
  O3 --> O4[❌ لا يرى: طلبات صنعاء، تعز...]
  
  %% Database Query
  P[استعلام قاعدة البيانات] --> P1[servicerequests.find]
  P1 --> P2[Filter 1: city = engineerCity]
  P2 --> P3[Filter 2: status IN OPEN, OFFERS_COLLECTING]
  P3 --> P4[Filter 3: engineerId = null]
  P4 --> P5[Filter 4: location.$near with $maxDistance]
  P5 --> P6[Limit: 100]
  P6 --> P7[Sort: distance ASC]
  
  %% Performance
  Q[تحسين الأداء] --> Q1[Index: city + status]
  Q1 --> Q2[Index: city + createdAt]
  Q2 --> Q3[Index: location 2dsphere]
  Q3 --> Q4[Query Optimization]
  Q4 --> Q5[استعلام سريع جداً]

