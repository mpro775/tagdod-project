%% City-Based Filtering Flow for Services
%% View at https://mermaid.live
flowchart TD
  %% Customer creates request
  A[Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠÙ†Ø´Ø¦ Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø©] --> B[Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬]
  B --> B1[Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨]
  B1 --> B2[ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨]
  B2 --> B3[ðŸ™ï¸ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© - Ø¥Ù„Ø²Ø§Ù…ÙŠ]
  B3 --> B3A{Ù‡Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ØµØ­ÙŠØ­Ø©ØŸ}
  
  B3A -->|Ù„Ø§| B3B[Ø¹Ø±Ø¶ Ø®Ø·Ø£: Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ù…Ø¯Ù† Ø§Ù„ÙŠÙ…Ù†ÙŠØ©]
  B3B --> B3
  
  B3A -->|Ù†Ø¹Ù…| B4[Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©]
  B4 --> B5[Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª]
  
  B5 --> C[POST /services]
  C --> C1[Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª]
  C1 --> C2[city: Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ø«Ø§Ù„ ØµÙ†Ø¹Ø§Ø¡]
  C2 --> C3[status: OPEN]
  C3 --> C4[ÙÙ‡Ø±Ø³Ø© Ø¨Ù€ city + status]
  
  %% Engineer searches for requests
  D[Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙŠØ¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª] --> E[GET /services/requests/nearby]
  E --> E1[engineerId: Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³]
  E1 --> E2[lat, lng: Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³]
  E2 --> E3[radiusKm: Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø«]
  
  E3 --> F[Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠØ¹Ø§Ù„Ø¬ Ø§Ù„Ø·Ù„Ø¨]
  F --> F1[ðŸ” Step 1: Ø¬Ù„Ø¨ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³]
  F1 --> F2[SELECT city FROM users WHERE _id = engineerId]
  F2 --> F3[engineerCity Ù…Ø«Ø§Ù„: ØµÙ†Ø¹Ø§Ø¡]
  
  F3 --> G[ðŸ” Step 2: Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª]
  G --> G1[WHERE city = engineerCity]
  G1 --> G2[AND status IN OPEN, OFFERS_COLLECTING]
  G2 --> G3[AND engineerId IS NULL]
  G3 --> G4[AND location NEAR lat, lng WITHIN radiusKm]
  G4 --> G5[AND userId != engineerId]
  
  G5 --> H[ðŸ” Step 3: Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬]
  H --> H1[ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©]
  H1 --> H2[Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©]
  H2 --> H3[Ù…Ø­Ø¯ÙˆØ¯Ø© Ø¨Ù€ 100 Ø·Ù„Ø¨]
  
  H3 --> I{Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬}
  I -->|0 Ø·Ù„Ø¨Ø§Øª| I1[Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù…Ø¯ÙŠÙ†ØªÙƒ]
  I -->|> 0 Ø·Ù„Ø¨Ø§Øª| I2[Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³]
  
  I2 --> J[Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙŠØ±Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª]
  J --> J1[Ø·Ù„Ø¨ 1: ØµÙ†Ø¹Ø§Ø¡ - 2 ÙƒÙ…]
  J1 --> J2[Ø·Ù„Ø¨ 2: ØµÙ†Ø¹Ø§Ø¡ - 5 ÙƒÙ…]
  J2 --> J3[Ø·Ù„Ø¨ 3: ØµÙ†Ø¹Ø§Ø¡ - 8 ÙƒÙ…]
  
  J3 --> K{ÙŠØ®ØªØ§Ø± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø·Ù„Ø¨Ø§Ù‹}
  K -->|Ù†Ø¹Ù…| L[ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶]
  K -->|Ù„Ø§| M[Ø§Ù„Ø¨Ø­Ø« Ù…Ø±Ø© Ø£Ø®Ø±Ù‰]
  
  %% Examples
  N[Ù…Ø«Ø§Ù„ 1: Ù…Ù‡Ù†Ø¯Ø³ ØµÙ†Ø¹Ø§Ø¡] --> N1[engineerCity: ØµÙ†Ø¹Ø§Ø¡]
  N1 --> N2[ÙŠØ¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª]
  N2 --> N3[âœ… ÙŠØ±Ù‰: Ø·Ù„Ø¨Ø§Øª ØµÙ†Ø¹Ø§Ø¡ ÙÙ‚Ø·]
  N3 --> N4[âŒ Ù„Ø§ ÙŠØ±Ù‰: Ø·Ù„Ø¨Ø§Øª Ø¹Ø¯Ù†ØŒ ØªØ¹Ø²...]
  
  O[Ù…Ø«Ø§Ù„ 2: Ù…Ù‡Ù†Ø¯Ø³ Ø¹Ø¯Ù†] --> O1[engineerCity: Ø¹Ø¯Ù†]
  O1 --> O2[ÙŠØ¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª]
  O2 --> O3[âœ… ÙŠØ±Ù‰: Ø·Ù„Ø¨Ø§Øª Ø¹Ø¯Ù† ÙÙ‚Ø·]
  O3 --> O4[âŒ Ù„Ø§ ÙŠØ±Ù‰: Ø·Ù„Ø¨Ø§Øª ØµÙ†Ø¹Ø§Ø¡ØŒ ØªØ¹Ø²...]
  
  %% Database Query
  P[Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª] --> P1[servicerequests.find]
  P1 --> P2[Filter 1: city = engineerCity]
  P2 --> P3[Filter 2: status IN OPEN, OFFERS_COLLECTING]
  P3 --> P4[Filter 3: engineerId = null]
  P4 --> P5[Filter 4: location.$near with $maxDistance]
  P5 --> P6[Limit: 100]
  P6 --> P7[Sort: distance ASC]
  
  %% Performance
  Q[ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡] --> Q1[Index: city + status]
  Q1 --> Q2[Index: city + createdAt]
  Q2 --> Q3[Index: location 2dsphere]
  Q3 --> Q4[Query Optimization]
  Q4 --> Q5[Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹]

