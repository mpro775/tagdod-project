%% Service Request Flow
%% View at https://mermaid.live
flowchart TD
  A[طلب خدمة جديد] --> B[استلام البيانات]
  B --> B1[title: عنوان الطلب - مطلوب]
  B1 --> B2[description: الوصف - اختياري]
  B2 --> B3[images: الصور - اختياري]
  B3 --> B3A[city: المدينة اليمنية - مطلوب - افتراضي صنعاء]
  B3A --> B4[addressId: معرف العنوان - اختياري]
  B4 --> B5[location: الإحداثيات - مطلوب]
  B5 --> B6[type: نوع الخدمة - اختياري]
  B6 --> B7[scheduledAt: التاريخ المجدول - اختياري]

  B7 --> C[إنشاء السجل في قاعدة البيانات]
  C --> C1[status: OPEN]
  C1 --> C2[engineerId: null]
  C2 --> C3[acceptedOffer: null]
  C3 --> C4[rating: null]
  C4 --> C5[adminNotes: empty]
  C5 --> C6[city: المدينة المحددة]

  C5 --> D[تغيير الحالة]
  D --> D1[OPEN → OFFERS_COLLECTING]
  D1 --> D2[OFFERS_COLLECTING → ASSIGNED]
  D2 --> D3[ASSIGNED → IN_PROGRESS]
  D3 --> D4[IN_PROGRESS → COMPLETED]
  D4 --> D5[COMPLETED → RATED]

  D5 --> E[إلغاء الطلب]
  E --> E1[CANCELLED من أي حالة]

  %% Customer Actions
  F[إجراءات العميل] --> F1[POST /services - إنشاء طلب]
  F1 --> F2[GET /services/my - عرض طلباتي]
  F2 --> F3[GET /services/:id - عرض تفاصيل]
  F3 --> F4[POST /services/:id/cancel - إلغاء]
  F4 --> F5[POST /services/:id/accept-offer - قبول عرض]
  F5 --> F6[POST /services/:id/rate - تقييم]
  F6 --> F7[GET /services/:id/offers - عرض العروض]

  %% Admin Actions
  G[إجراءات الإدارة] --> G1[GET /admin/services/requests - عرض الجميع]
  G1 --> G2[GET /admin/services/requests/:id - تفاصيل]
  G2 --> G3[GET /admin/services/requests/:id/offers - العروض]
  G3 --> G4[POST /admin/services/requests/:id/cancel - إلغاء إداري]
  G4 --> G5[POST /admin/services/requests/:id/assign-engineer - تعيين مهندس]

  %% Status Transitions
  H[انتقالات الحالات] --> H1[تلقائي: OPEN → OFFERS_COLLECTING]
  H1 --> H2[يدوي: قبول عرض → ASSIGNED]
  H2 --> H3[يدوي: بدء العمل → IN_PROGRESS]
  H3 --> H4[يدوي: إكمال العمل → COMPLETED]
  H4 --> H5[يدوي: التقييم → RATED]

  %% End points
  D5 --> I[نهاية - طلب مكتمل]
  E1 --> I
