# تدفقات نظام الخدمات (Services Flows)

## الملفات المتاحة

### المخططات الرئيسية
- `services-overview.mmd` - نظرة عامة على نظام الخدمات
- `service-request-flow.mmd` - مخطط تدفق طلبات الخدمات
- `engineer-offers-flow.mmd` - مخطط تدفق عروض المهندسين
- `city-filtering-flow.mmd` - مخطط نظام فلترة المدن ⭐ جديد
- `service-management.mmd` - مخطط إدارة الخدمات
- `distance-calculation.mmd` - مخطط حساب المسافات
- `service-analytics.mmd` - مخطط تحليلات الخدمات

### التوثيق الإضافي
- `CITIES_UPDATE_CHANGELOG.md` - سجل تحديثات نظام المدن ⭐ جديد

## شرح التدفقات

### 1. طلبات الخدمات (Service Request Flow)
- **إنشاء الطلبات:** إنشاء طلبات خدمة جديدة مع العنوان والوصف والصور
- **تحديد المدينة:** تحديد المدينة اليمنية إلزامياً (افتراضي: صنعاء) ⭐ جديد
- **المدن المدعومة:** 22 مدينة يمنية (صنعاء، عدن، تعز، الحديدة، إب، ذمار، وغيرها)
- **حالات الطلب:** OPEN، OFFERS_COLLECTING، ASSIGNED، IN_PROGRESS، COMPLETED، RATED، CANCELLED
- **إدارة الطلبات:** عرض، إلغاء، تتبع حالة الطلبات
- **تقييم الخدمة:** تقييم الخدمة بعد الانتهاء منها
- **البحث الجغرافي:** البحث حسب الموقع باستخدام فهارس 2dsphere

### 2. عروض المهندسين (Engineer Offers Flow)
- **فلترة حسب المدينة:** المهندسون يرون فقط طلبات مدينتهم ⭐ جديد
- **البحث عن الطلبات:** البحث عن الطلبات القريبة حسب الموقع
- **تقديم العروض:** تقديم عروض مع السعر والملاحظات
- **حساب المسافات:** حساب المسافة بين المهندس والطلب
- **إدارة العروض:** عرض، تعديل، إلغاء العروض
- **حالات العرض:** OFFERED، ACCEPTED، REJECTED، CANCELLED

### 2.1. نظام فلترة المدن (City Filtering Flow) ⭐ جديد
- **تحديد المدينة:** كل طلب وكل مهندس مرتبط بمدينة محددة
- **فلترة تلقائية:** عند بحث المهندس، يتم فلترة الطلبات حسب مدينته
- **22 مدينة يمنية:** دعم شامل لجميع المدن اليمنية الرئيسية
- **القيمة الافتراضية:** صنعاء
- **Validation:** قبول المدن اليمنية فقط
- **Performance:** فهارس محسّنة للبحث السريع

### 3. إدارة الخدمات (Service Management)
- **إدارة الطلبات:** عرض جميع الطلبات مع فلاتر متقدمة
- **تعيين المهندسين:** تعيين مهندس لطلب خدمة
- **تتبع التقدم:** بدء وإكمال الخدمات
- **إدارة الحالات:** تحديث حالات الخدمات
- **الإحصائيات:** إحصائيات شاملة للطلبات والمهندسين

### 4. حساب المسافات (Distance Calculation)
- **معادلة Haversine:** حساب المسافة الدقيقة بين نقطتين جغرافيتين
- **الاستعلامات الجغرافية:** استخدام فهارس 2dsphere للبحث السريع
- **تحسين الأداء:** حسابات محسنة للمسافات

### 5. تحليلات الخدمات (Service Analytics)
- **إحصائيات الطلبات:** عدد الطلبات حسب الحالة والنوع
- **إحصائيات المهندسين:** أداء المهندسين والإيرادات
- **إحصائيات الأنواع:** توزيع الخدمات حسب النوع
- **إحصائيات الإيرادات:** إجمالي الإيرادات والأرباح

## هيكل البيانات

### حقول طلب الخدمة الأساسية (Service Request Schema)
- `userId`: معرف العميل (ObjectId) - مطلوب
- `title`: عنوان الطلب (string) - مطلوب
- `type`: نوع الخدمة (string) - اختياري
- `description`: وصف الطلب (string) - اختياري
- `images`: مصفوفة روابط الصور (string[]) - افتراضي []
- `city`: المدينة اليمنية (string) - مطلوب - افتراضي "صنعاء" ⭐ جديد
- `addressId`: معرف العنوان (ObjectId) - اختياري
- `location`: إحداثيات الموقع (GeoJSON Point) - مطلوب للبحث الجغرافي
- `status`: حالة الطلب (enum) - افتراضي OPEN
- `scheduledAt`: تاريخ الجدولة (Date) - اختياري
- `engineerId`: معرف المهندس المعين (ObjectId) - افتراضي null
- `acceptedOffer`: العرض المقبول (object) - اختياري
- `rating`: تقييم الخدمة (ServiceRating) - اختياري
- `adminNotes`: ملاحظات الإدارة (array) - افتراضي []

### حقول تقييم الخدمة (ServiceRating Schema)
- `score`: التقييم (number, 1-5) - اختياري
- `comment`: التعليق (string) - اختياري
- `at`: تاريخ التقييم (Date) - اختياري

### حقول عرض المهندس (EngineerOffer Schema)
- `requestId`: معرف طلب الخدمة (ObjectId) - مطلوب
- `engineerId`: معرف المهندس (ObjectId) - مطلوب
- `amount`: مبلغ العرض (number) - مطلوب
- `note`: ملاحظات العرض (string) - اختياري
- `distanceKm`: المسافة بالكيلومتر (number) - اختياري
- `status`: حالة العرض (enum) - افتراضي OFFERED

### حالات طلبات الخدمات (Service Request Status)
- **OPEN** - مفتوح: في انتظار العروض
- **OFFERS_COLLECTING** - جمع العروض: يجمع العروض من المهندسين
- **ASSIGNED** - معين: تم تعيين مهندس
- **IN_PROGRESS** - قيد التنفيذ: العمل جاري
- **COMPLETED** - مكتمل: تم الانتهاء من الخدمة
- **RATED** - مقيم: تم تقييم الخدمة
- **CANCELLED** - ملغي: تم إلغاء الطلب

### حالات عروض المهندسين (Engineer Offer Status)
- **OFFERED** - معروض: في انتظار الرد
- **ACCEPTED** - مقبول: تم قبول العرض
- **REJECTED** - مرفوض: تم رفض العرض
- **CANCELLED** - ملغي: تم إلغاء العرض

### فهارس الأداء (Performance Indexes)
- فهرس جغرافي 2dsphere للبحث حسب الموقع
- فهرس نصي للبحث في العنوان والوصف ونوع الخدمة
- فهارس مركبة للبحث حسب المستخدم والحالة والتاريخ
- **فهرس المدينة:** `{ city: 1, status: 1 }` - للبحث السريع حسب المدينة ⭐ جديد
- **فهرس المدينة والتاريخ:** `{ city: 1, createdAt: -1 }` - لترتيب الطلبات ⭐ جديد

## API Endpoints المتاحة

### APIs العملاء (Customer APIs)
- **POST /services** - إنشاء طلب خدمة جديد
- **GET /services/my** - عرض طلبات الخدمات الخاصة بالعميل
- **GET /services/:id** - عرض تفاصيل طلب خدمة محدد
- **POST /services/:id/cancel** - إلغاء طلب خدمة
- **POST /services/:id/accept-offer** - قبول عرض من مهندس
- **POST /services/:id/rate** - تقييم الخدمة المكتملة
- **GET /services/:id/offers** - عرض العروض المقدمة لطلب الخدمة

### APIs المهندسين (Engineer APIs)
- **GET /services/requests/nearby** - البحث عن الطلبات القريبة
- **POST /services/offers** - تقديم عرض لطلب خدمة
- **POST /services/requests/:id/start** - بدء العمل في الطلب
- **POST /services/requests/:id/complete** - إكمال الطلب
- **GET /services/offers/my** - عرض عروضي المقدمة

### APIs الإدارة (Admin APIs)
- **GET /admin/services/requests** - عرض جميع طلبات الخدمات
- **GET /admin/services/requests/:id** - تفاصيل طلب خدمة محدد
- **GET /admin/services/requests/:id/offers** - عروض طلب خدمة محدد
- **POST /admin/services/requests/:id/cancel** - إلغاء طلب خدمة (إدارياً)
- **POST /admin/services/requests/:id/assign-engineer** - تعيين مهندس لطلب
- **GET /admin/services/statistics/overview** - إحصائيات عامة
- **GET /admin/services/statistics/requests** - إحصائيات الطلبات
- **GET /admin/services/statistics/engineers** - إحصائيات المهندسين
- **GET /admin/services/statistics/services-types** - إحصائيات أنواع الخدمات
- **GET /admin/services/statistics/revenue** - إحصائيات الإيرادات
- **GET /admin/services/engineers** - قائمة المهندسين
- **GET /admin/services/engineers/:id/statistics** - إحصائيات مهندس محدد
- **GET /admin/services/engineers/:id/offers** - عروض مهندس محدد
- **GET /admin/services/engineers/statistics/overview** - إحصائيات عامة للمهندسين

## التكامل مع الأنظمة الأخرى

### تكامل مع نظام المستخدمين
- **أدوار المستخدمين:** العملاء، المهندسين، الإداريين
- **صلاحيات مختلفة:** وصول محدود حسب الدور
- **إدارة الجلسات:** تسجيل دخول محمي

### تكامل مع نظام العناوين
- **ربط العناوين:** ربط طلبات الخدمات بالعناوين المحفوظة
- **الإحداثيات الجغرافية:** استخدام إحداثيات العناوين للبحث الجغرافي

### تكامل مع نظام الإشعارات
- **إشعارات العروض:** إشعار العميل بتلقي عرض جديد
- **إشعارات الحالات:** إشعار بتغيير حالة الطلب
- **إشعارات المهندسين:** إشعار المهندسين بالطلبات الجديدة

### تكامل مع نظام التحليلات
- **إحصائيات الخدمات:** تتبع أداء الخدمات والمهندسين
- **تقارير الإيرادات:** تحليل الإيرادات من الخدمات
- **مقاييس الأداء:** مؤشرات الأداء الرئيسية

## نظام المدن اليمنية ⭐ جديد

### المدن المدعومة (22 مدينة)
```
المدن الرئيسية:
🏛️ صنعاء (افتراضي) | 🌊 عدن | ⛰️ تعز | 🏖️ الحديدة | 🌄 إب | 🏔️ ذمار

المدن الأخرى:
🏝️ المكلا | 🌾 حجة | 🏰 عمران | 🏜️ صعدة | 🕌 سيئون | 🏘️ زنجبار
🏛️ مأرب | ⛰️ البيضاء | 🌳 لحج | 🌴 أبين | 🏔️ شبوة | 🌄 المحويت
🏛️ حضرموت | 🏜️ الجوف | 🏝️ المهرة | 🏝️ سقطرى
```

### آلية عمل الفلترة
1. **عند إنشاء طلب خدمة:** يجب اختيار المدينة (إلزامي)
2. **عند تسجيل مهندس:** يتم تحديد مدينة عمله
3. **عند البحث:** المهندس يرى فقط طلبات مدينته

### الفوائد
- ✅ **تقليل المسافات:** مهندسون قريبون من العملاء
- ✅ **توفير الوقت:** استجابة أسرع للطلبات
- ✅ **توفير التكاليف:** تقليل تكاليف التنقل
- ✅ **تحسين الجودة:** خدمة أفضل في نفس المنطقة

### مثال عملي
```
مهندس في صنعاء:
  ✅ يرى: طلبات صنعاء فقط
  ❌ لا يرى: طلبات عدن، تعز، الحديدة...

مهندس في عدن:
  ✅ يرى: طلبات عدن فقط
  ❌ لا يرى: طلبات صنعاء، تعز، الحديدة...
```

## نقاط مهمة
- **نظام بسيط:** إدارة طلبات الخدمات وعروض المهندسين
- **فلترة ذكية:** المهندسون يرون فقط طلبات مدينتهم ⭐
- **22 مدينة يمنية:** دعم كامل للمدن اليمنية الرئيسية ⭐
- **البحث الجغرافي:** البحث حسب الموقع باستخدام MongoDB 2dsphere
- **إدارة الحالات:** تتبع شامل لحالات الطلبات والعروض
- **إحصائيات شاملة:** إحصائيات مفصلة للطلبات والمهندسين والإيرادات
- **أمان الوصول:** صلاحيات مختلفة للعملاء والمهندسين والإداريين
- **أداء محسّن:** فهارس خاصة للمدن لسرعة البحث ⭐
