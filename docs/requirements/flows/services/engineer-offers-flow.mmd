%% Engineer Offers Flow
%% View at https://mermaid.live
flowchart TD
  A[البحث عن طلبات قريبة] --> B[GET /services/requests/nearby]
  B --> B1[استلام إحداثيات المهندس]
  B1 --> B1A[جلب مدينة المهندس من قاعدة البيانات]
  B1A --> B1B[engineerCity مثال: صنعاء]
  B1B --> B2[البحث في نطاق معين]
  B2 --> B2A[فلترة أولاً: city === engineerCity]
  B2A --> B3[فلترة حسب الحالة OPEN]
  B3 --> B4[ترتيب حسب المسافة]

  B4 --> C[عرض النتائج]
  C --> C1[قائمة الطلبات القريبة من نفس المدينة فقط]
  C1 --> C2[معلومات كل طلب + المدينة]
  C2 --> C3[المسافة المحسوبة]

  C3 --> D{المهندس مهتم؟}
  D -->|نعم| E[تقديم عرض]
  D -->|لا| F[البحث مرة أخرى]

  E --> E1[POST /services/offers]
  E1 --> E2[requestId: معرف الطلب]
  E2 --> E3[engineerId: معرف المهندس]
  E3 --> E4[amount: مبلغ العرض]
  E4 --> E5[note: ملاحظات العرض]
  E5 --> E6[distanceKm: المسافة المحسوبة]

  E6 --> G[إنشاء عرض في قاعدة البيانات]
  G --> G1[status: OFFERED]
  G1 --> G2[فهرس فريد: requestId + engineerId]

  G2 --> H[تغيير حالة الطلب]
  H --> H1[إذا كان أول عرض: OPEN → OFFERS_COLLECTING]

  H1 --> I[انتظار رد العميل]
  I --> I1[العرض مقبول - ACCEPTED]
  I1 --> I2[العرض مرفوض - REJECTED]
  I2 --> I3[العرض ملغي - CANCELLED]

  I1 --> J[إذا تم القبول]
  J --> J1[تحديث العرض: status = ACCEPTED]
  J1 --> J2[تحديث الطلب: acceptedOffer]
  J2 --> J3[تحديث الطلب: engineerId]
  J3 --> J4[تحديث الطلب: status = ASSIGNED]

  I2 --> K[إذا تم الرفض]
  K --> K1[تحديث العرض: status = REJECTED]

  I3 --> L[إلغاء العرض]
  L --> L1[تحديث العرض: status = CANCELLED]

  %% Engineer Actions
  M[إجراءات المهندس] --> M1[GET /services/requests/nearby - البحث القريب]
  M1 --> M2[POST /services/offers - تقديم عرض]
  M2 --> M3[GET /services/offers/my - عروضي]
  M3 --> M4[POST /services/requests/:id/start - بدء العمل]
  M4 --> M5[POST /services/requests/:id/complete - إكمال العمل]

  %% Admin Actions
  N[إجراءات الإدارة] --> N1[GET /admin/services/requests/:id/offers - عروض الطلب]
  N1 --> N2[GET /admin/services/engineers/:id/offers - عروض المهندس]
  N2 --> N3[GET /admin/services/engineers - قائمة المهندسين]

  %% End points
  J4 --> O[نهاية - عرض مقبول]
  K1 --> O
  L1 --> O
