%% Advanced Checkout: Preview -> Confirm -> Payment -> Inventory -> Notifications
%% View at https://mermaid.live
flowchart TD
  A[Start Checkout] --> B[Checkout Preview]
  B --> C[Validate cart items availability]
  C --> D[Calculate items discount from promotions]
  D --> E[Apply multiple coupons cumulatively]
  E --> F[Calculate coupon discounts on remaining amount]
  F --> G[Apply currency conversion]
  G --> H[Calculate shipping costs]
  H --> I[Apply wholesale/engineer discounts]
  I --> J[Check COD eligibility if COD selected]
  J --> K[Return preview with totals and COD status]
  
  %% Checkout Confirmation
  K --> L[User confirms checkout]
  L --> M[Start Database Transaction]
  M --> N[Create Order with PENDING status]
  N --> O[Reserve inventory items]
  O --> P[Generate order number]
  P --> Q[Save order snapshot]
  Q --> R{Payment method?}
  
  %% COD Payment Flow (with Eligibility Check)
  R -->|COD| S[Check COD Eligibility]
  S --> T{User eligible for COD?}
  T -->|No - Regular user with <3 orders| U[Return error: COD not eligible]
  U --> V[Show progress: X/3 completed orders]
  V --> W[End - COD Not Allowed]
  T -->|Yes - Admin or >=3 orders| X[Set payment status to PAID]
  X --> Y[Mark order as CONFIRMED]
  Y --> Z[Update inventory]
  Z --> AA[Send confirmation notifications]
  AA --> AB[End - COD Order Complete]
  
  %% Local Payment (Bank Transfer) Flow
  R -->|BANK_TRANSFER| AC[Validate local payment account]
  AC --> AD{Account valid and active?}
  AD -->|No| AE[Return validation error]
  AD -->|Yes| AF{Currency matches?}
  AF -->|No| AG[Return currency mismatch error]
  AF -->|Yes| AH{Payment reference provided?}
  AH -->|No| AI[Return reference required error]
  AH -->|Yes| AJ[Save localPaymentAccountId and paymentReference]
  AJ --> AK[Set payment status to PENDING]
  AK --> AL[Set order status to PENDING_PAYMENT]
  AL --> AM[Reserve inventory temporarily]
  AM --> AN[Send order confirmation with payment reference]
  AN --> AO[End - Waiting for manual verification]
  
  %% Online Payment Flow
  R -->|ONLINE| AP[Create Payment Intent]
  AP --> AQ[Generate payment URL]
  AQ --> AR[Return payment URL to user]
  AR --> AS[User redirects to payment]
  AS --> AT[Payment provider processes]
  AT --> AU[Payment webhook received]
  AU --> AV{Payment successful?}
  AV -->|SUCCESS| AW[Verify webhook signature]
  AW --> AX[Update payment status to PAID]
  AX --> AY[Mark order as CONFIRMED]
  AY --> AZ[Update inventory]
  AZ --> BA[Send confirmation notifications]
  BA --> BB[End - Online Payment Complete]
  AV -->|FAILED| BC[Mark payment status to FAILED]
  BC --> BD[Mark order as PAYMENT_FAILED]
  BD --> BE[Release reserved inventory]
  BE --> BF[Send failure notifications]
  BF --> BG[End - Payment Failed]
  
  %% Order Management Flow (with Payment Validation)
  MM[Order Status Update] --> NN{New status?}
  NN -->|CANCELLED| RR[Allow - No payment check needed]
  RR --> RRA[Release inventory]
  RRA --> SS[Send status notification]
  NN -->|CONFIRMED/PROCESSING/SHIPPED/etc| OO[Check payment status]
  OO --> PP{Payment status is PAID?}
  PP -->|No| QQ[Return error: Payment required]
  QQ --> RRB[Show current payment status]
  RRB --> SS
  PP -->|Yes| RRC[Validate status transition]
  RRC --> RRD{Transition valid?}
  RRD -->|No| RRE[Return error: Invalid transition]
  RRE --> SS
  RRD -->|Yes| RRF[Update order status]
  RRF --> RRG[Add to status history]
  RRG --> SS
  
  %% Inventory Management
  TT[Inventory Reservation] --> UU[Check stock availability]
  UU --> VV{Stock available?}
  VV -->|Yes| WW[Reserve items with TTL]
  VV -->|No| XX[Return out of stock error]
  WW --> YY[Create inventory ledger entry]
  YY --> ZZ[End - Inventory Reserved]
  XX --> AAA[End - Insufficient Stock]
  
  %% Webhook Processing
  BBB[Payment Webhook] --> CCC[Verify signature]
  CCC --> DDD{Signature valid?}
  DDD -->|Yes| EEE[Process payment status]
  DDD -->|No| FFF[Reject webhook]
  EEE --> GGG[Update order status]
  GGG --> HHH[Send notifications]
  HHH --> III[End - Webhook Processed]
  FFF --> JJJ[End - Invalid Webhook]
  
  %% Local Payment Verification Flow
  BBBB[Admin reviews order] --> CCCC[Open verify payment dialog]
  CCCC --> DDDD[Enter verified amount and currency]
  DDDD --> EEEE{Amount >= Order total?}
  EEEE -->|Yes| FFFF[Accept payment - Set status to PAID]
  EEEE -->|No| GGGG[Reject payment - Set status to FAILED]
  FFFF --> HHHH[Update order status to CONFIRMED]
  HHHH --> IIII[Update inventory - reduce stock]
  IIII --> JJJJ[Send payment accepted notification]
  GGGG --> KKKK[Keep order as PAYMENT_FAILED]
  KKK  K --> LLLL[Send payment rejected notification]
  JJJJ --> MMMM[End - Payment Verified Successfully]
  LLLL --> NNNN[End - Payment Verification Failed]
  
  %% Multiple Coupons Flow
  OOOO[Apply Coupon] --> PPPP[Check if coupon already applied]
  PPPP --> QQQQ{Already in appliedCouponCodes?}
  QQQQ -->|Yes| RRRR[Error: Coupon already applied]
  QQQQ -->|No| SSSS[Validate coupon code and conditions]
  SSSS --> TTTT{Coupon valid?}
  TTTT -->|No| UUUU[Return validation error]
  TTTT -->|Yes| VVVV[Add to appliedCouponCodes array]
  VVVV --> WWWW[Calculate discount on remaining subtotal]
  WWWW --> XXXX[Update appliedCoupons with details]
  XXXX --> YYYY[Recalculate total discount]
  YYYY --> ZZZZ[Save cart with updated coupons]
  ZZZZ --> AAAAA[Return updated cart with breakdown]
  
  %% End points
  W --> KKK[End]
  AB --> KKK
  BB --> KKK
  BG --> KKK
  AO --> KKK
  SS --> KKK
  ZZ --> KKK
  AAA --> KKK
  III --> KKK
  JJJ --> KKK
  AE --> KKK
  AG --> KKK
  AI --> KKK
  MMMM --> KKK
  NNNN --> KKK
  AAAAA --> KKK
