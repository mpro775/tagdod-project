%% User Management Flow
%% View at https://mermaid.live
flowchart TD
  A[إدارة المستخدمين] --> B[عرض المستخدمين]
  A --> C[إنشاء مستخدمين]
  A --> D[تحديث المستخدمين]
  A --> E[حذف المستخدمين]

  %% List Users
  B --> B1[GET /admin/users]
  B1 --> B2[فلاتر وبحث]
  B2 --> B3[role, status, phone, firstName, lastName]
  B3 --> B4[ترتيب وتصفح]
  B4 --> B5[عرض القائمة]

  B5 --> B6[تفاصيل المستخدم]
  B6 --> B7[GET /admin/users/:id]
  B7 --> B8[معلومات كاملة]
  B8 --> B9[Capabilities وصلاحيات]

  %% View Deleted Accounts
  B --> B10[GET /admin/users/deleted]
  B10 --> B11[عرض الحسابات المحذوفة]
  B11 --> B12[سبب الحذف + تفاصيل]
  B12 --> B13[deletedAt, deletedBy, deletionReason]

  %% Create Users
  C --> C1[POST /admin/users/create-admin]
  C1 --> C2[إنشاء مدير جديد]
  C2 --> C3[roles: ['admin']]

  C3 --> C4[POST /admin/users/create-role-admin]
  C4 --> C5[إنشاء مع دور محدد]
  C5 --> C6[دور مخصص]

  C6 --> C7[POST /admin/users]
  C7 --> C8[إنشاء مستخدم عام]
  C8 --> C9[بيانات أساسية]

  %% Update Users
  D --> D1[PATCH /admin/users/:id]
  D1 --> D2[تحديث البيانات]
  D2 --> D3[roles, permissions, capabilities]
  D3 --> D4[status, preferredCurrency]

  D4 --> D5[إدارة الحالة]
  D5 --> D6[POST /admin/users/:id/suspend]
  D6 --> D7[suspendedReason, suspendedBy, suspendedAt]

  D7 --> D8[POST /admin/users/:id/activate]
  D8 --> D9[تفعيل الحساب]

  %% Delete Users
  E --> E1[DELETE /admin/users/:id]
  E1 --> E2[Soft Delete]
  E2 --> E3[deletedAt, deletedBy]

  %% User Self Delete
  E --> E8[DELETE /auth/me]
  E8 --> E9[حذف الحساب من قبل المستخدم]
  E9 --> E10[إدخال سبب الحذف]
  E10 --> E11[reason: string]
  E11 --> E12[Soft Delete مع deletionReason]
  E12 --> E13[deletedAt, deletedBy = userId, deletionReason]

  E3 --> E4[POST /admin/users/:id/restore]
  E4 --> E5[إعادة التفعيل]

  E5 --> E6[DELETE /admin/users/:id/permanent]
  E6 --> E7[حذف نهائي]

  %% Statistics
  F[إحصائيات المستخدمين] --> F1[GET /admin/users/stats/summary]
  F1 --> F2[إجمالي المستخدمين]
  F2 --> F3[حسب الدور والحالة]
  F3 --> F4[نشاط الحسابات]

  %% Verification System
  V[نظام التحقق] --> V1[التسجيل]
  V1 --> V2[حالة UNVERIFIED]
  V2 --> V3[رفع الوثائق]
  V3 --> V31[المهندس: CV + ملاحظة]
  V3 --> V32[التاجر: صورة المحل + اسم المحل + ملاحظة]
  V31 --> V4[POST /users/verification/submit]
  V32 --> V4
  V4 --> V5[حالة PENDING]
  V5 --> V6[GET /admin/users/verification/pending]
  V6 --> V7[مراجعة من المدير]
  V7 --> V8[GET /admin/users/verification/:userId]
  V8 --> V9[عرض الوثائق والملاحظات]
  V9 --> V10[اتخاذ قرار]
  V10 --> V11[POST /admin/users/verification/:userId/approve]
  V10 --> V12[POST /admin/users/verification/:userId/reject]
  V11 --> V13[حالة APPROVED]
  V12 --> V14[حالة REJECTED]
  V13 --> V15[إضافة الدور للمستخدم]
  V14 --> V16[حذف الوثائق]

  %% End points
  E7 --> G[نهاية - إدارة مكتملة]
  E13 --> G
  F4 --> G
  V15 --> G
  V16 --> G
  B13 --> G
