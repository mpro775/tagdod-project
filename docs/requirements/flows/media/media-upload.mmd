%% Media Upload & Management Flow
%% View at https://mermaid.live
flowchart TD
  A[رفع ملف وسائط] --> B{نوع الرفع?}
  B -->|رفع مباشر| C[رفع ملف إلى Bunny.net]
  B -->|رفع للمكتبة| D[رفع ملف إلى مكتبة الوسائط]

  %% Direct Upload
  C --> C1[استلام الملف والمعاملات]
  C1 --> C2[التحقق من نوع وحجم الملف]
  C2 --> C3[إنشاء اسم فريد للملف]
  C3 --> C4[رفع الملف إلى Bunny.net]
  C4 --> C5[إرجاع رابط CDN]

  %% Media Library Upload
  D --> D1[استلام الملف والبيانات الوصفية]
  D1 --> D2[حساب hash SHA256 للملف]
  D2 --> D3[البحث عن ملفات متطابقة]
  D3 --> D4{وجد ملف مطابق?}
  D4 -->|نعم| D5[زيادة عداد الاستخدام للملف الموجود]
  D4 -->|لا| D6[إنشاء اسم فريد ورفع إلى Bunny.net]
  D6 --> D7[استخراج معلومات الصورة إذا كانت صورة]
  D7 --> D8[إنشاء سجل في مكتبة الوسائط]
  D8 --> D9[إرجاع معلومات الملف]

  D5 --> D9

  %% File Validation
  C2 --> C2A{نوع الملف صحيح?}
  C2A -->|لا| C2B[إرجاع خطأ نوع الملف]
  C2A -->|نعم| C2C{حجم الملف مناسب?}
  C2C -->|لا| C2D[إرجاع خطأ الحجم]
  C2C -->|نعم| C3

  C2B --> Z[نهاية - خطأ]
  C2D --> Z

  %% Bunny.net Operations
  C4 --> C4A{تم الرفع بنجاح?}
  C4A -->|لا| C4B[معالجة خطأ Bunny.net]
  C4A -->|نعم| C5

  C4B --> Z

  D6 --> D6A{تم الرفع بنجاح?}
  D6A -->|لا| D6B[معالجة خطأ Bunny.net]
  D6A -->|نعم| D7

  D6B --> Z

  %% End points
  C5 --> Z
  D9 --> Z
