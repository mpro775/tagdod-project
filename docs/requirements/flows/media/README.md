# تدفقات الوسائط (Media Flows)

## الملفات المتاحة
- `media-upload.mmd` - مخطط رفع وإدارة الوسائط
- `analytics-stats.mmd` - مخطط الإحصائيات والتحليلات

## شرح التدفقات

### 1. رفع الملفات (File Upload)
- **التحقق من الملف:** فحص نوع وحجم الملف
- **رفع آمن:** رفع الملفات إلى Bunny.net Storage
- **أسماء فريدة:** إنشاء أسماء ملفات فريدة
- **روابط CDN:** توليد روابط للوصول السريع

### 2. مكتبة الوسائط (Media Library)
- **التصنيف:** تصنيف الملفات حسب الفئة (بانرات، منتجات، فئات، علامات، أخرى)
- **أنواع الملفات:** دعم الصور، الفيديوهات، والمستندات
- **البيانات الوصفية:** إضافة أوصاف ووسوم للبحث
- **الخصوصية:** تحديد ما إذا كان الملف عام أم خاص
- **تتبع المالك:** حفظ من قام برفع الملف

### 3. منع التكرار (Duplicate Detection)
- **حساب Hash:** حساب hash للملفات لاكتشاف التكرار
- **البحث عن التكرار:** البحث عن ملفات متطابقة في قاعدة البيانات
- **إعادة الاستخدام:** استخدام الملف الموجود بدلاً من رفع جديد
- **تحديث الاستخدام:** زيادة عداد استخدام الملف المكرر

### 4. تتبع الاستخدام (Usage Tracking)
- **عداد الاستخدام:** تتبع عدد مرات استخدام كل ملف
- **مواقع الاستخدام:** تتبع أين تم استخدام الملف
- **تحديث آلي:** تحديث عداد الاستخدام عند الاستخدام

### 5. معالجة الصور (Image Processing)
- **استخراج الأبعاد:** استخراج عرض وارتفاع الصور
- **حفظ المعلومات:** حفظ معلومات الصورة في قاعدة البيانات
- **دعم أنواع متعددة:** دعم أنواع صور مختلفة

### 6. البحث والفلترة (Search & Filtering)
- **البحث النصي:** بحث في الاسم والوصف والوسوم
- **الفلترة:** فلترة حسب الفئة والنوع والخصوصية
- **الترتيب:** ترتيب حسب التاريخ والحجم
- **الصفحات:** نظام صفحات للنتائج الكبيرة

### 7. إدارة الملفات (File Management)
- **Soft Delete:** حذف آمن مع إمكانية الاسترداد
- **الحذف النهائي:** حذف نهائي للملفات من قاعدة البيانات وBunny.net
- **تتبع الحذف:** تسجيل من قام بالحذف

### 8. الإحصائيات (Statistics)
- **إحصائيات أساسية:** عدد الملفات حسب الفئة والنوع
- **حجم التخزين:** إجمالي حجم الملفات
- **الملفات الحديثة:** آخر 5 ملفات تم رفعها

## هيكل البيانات

### حقول الوسائط الأساسية (Media Schema)
- `url`: رابط الملف في CDN (string) - مطلوب
- `filename`: اسم الملف الأصلي (string) - مطلوب
- `storedFilename`: اسم الملف المخزن في Bunny.net (string) - مطلوب
- `name`: الاسم الوصفي الذي يضعه الأدمن (string) - مطلوب
- `category`: الفئة (enum: BANNER, PRODUCT, CATEGORY, BRAND, OTHER) - مطلوب
- `type`: نوع الملف (enum: IMAGE, VIDEO, DOCUMENT) - افتراضي IMAGE
- `mimeType`: نوع MIME (string)
- `size`: حجم الملف بالبايت (number)

### حقول الصور (Image Fields)
- `width`: عرض الصورة (number) - اختياري
- `height`: ارتفاع الصورة (number) - اختياري

### حقول البحث والتنظيم
- `fileHash`: hash SHA256 للكشف عن التكرار (string) - اختياري
- `description`: وصف الملف (string) - افتراضي ''
- `tags`: وسوم للبحث (array of strings) - افتراضي []
- `isPublic`: هل الملف عام (boolean) - افتراضي false

### حقول التتبع والاستخدام
- `uploadedBy`: معرف المستخدم الذي رفع الملف (ObjectId)
- `usageCount`: عدد مرات استخدام الملف (number) - افتراضي 0
- `usedIn`: مصفوفة معرفات الأماكن التي استخدم فيها الملف (array of strings)

### حقول Soft Delete
- `deletedAt`: تاريخ الحذف (Date) - افتراضي null
- `deletedBy`: معرف المستخدم الذي قام بالحذف (ObjectId) - اختياري

### فئات الوسائط المتاحة (MediaCategory)
- **BANNER**: بانرات الإعلانية
- **PRODUCT**: صور المنتجات
- **CATEGORY**: صور الفئات
- **BRAND**: صور العلامات التجارية
- **OTHER**: ملفات أخرى

### أنواع الوسائط المتاحة (MediaType)
- **IMAGE**: ملفات الصور
- **VIDEO**: ملفات الفيديو
- **DOCUMENT**: المستندات والملفات الأخرى

## API Endpoints المتاحة

### رفع الملفات (Upload Controller)
- **POST /upload/file** - رفع ملف واحد مع إمكانية تحديد المجلد واسم مخصص
- **DELETE /upload/file** - حذف ملف من Bunny.net

### إدارة مكتبة الوسائط (Media Controller)
- **POST /admin/media/upload** - رفع ملف وسائط إلى المكتبة مع البيانات الوصفية
- **GET /admin/media** - قائمة الملفات مع البحث والفلترة والصفحات
- **GET /admin/media/:id** - عرض تفاصيل ملف محدد
- **PATCH /admin/media/:id** - تحديث بيانات الملف (الاسم، الوصف، الوسوم، إلخ)
- **DELETE /admin/media/:id** - حذف ملف (Soft Delete)
- **GET /admin/media/stats/summary** - إحصائيات المكتبة

## DTOs المتاحة

### رفع الملفات (Upload DTOs)
- `UploadFileDto`: رفع ملف واحد
  - `file`: الملف (binary)
  - `folder`: المجلد (optional)
  - `filename`: اسم مخصص (optional)

- `DeleteFileDto`: حذف ملف
  - `filename`: اسم الملف المراد حذفه

### إدارة مكتبة الوسائط (Media DTOs)
- `UploadMediaDto`: رفع ملف إلى المكتبة
  - `name`: الاسم الوصفي (required)
  - `category`: الفئة (required)
  - `description`: الوصف (optional)
  - `tags`: الوسوم (optional)
  - `isPublic`: هل عام (optional)

- `UpdateMediaDto`: تحديث بيانات الملف
  - `name`: الاسم الوصفي (optional)
  - `category`: الفئة (optional)
  - `description`: الوصف (optional)
  - `tags`: الوسوم (optional)
  - `isPublic`: هل عام (optional)

- `ListMediaDto`: قائمة الملفات
  - `page`: رقم الصفحة (optional)
  - `limit`: عدد العناصر (optional)
  - `search`: البحث في الاسم والوصف والوسوم (optional)
  - `category`: الفئة (optional)
  - `type`: النوع (optional)
  - `isPublic`: الخصوصية (optional)
  - `includeDeleted`: تضمين الملفات المحذوفة (optional)
  - `sortBy`: ترتيب حسب (optional)
  - `sortOrder`: اتجاه الترتيب (optional)

## نقاط مهمة
- **تكامل Bunny.net:** رفع وحذف الملفات من Bunny.net Storage مع CDN
- **منع التكرار:** كشف الملفات المكررة باستخدام hash SHA256
- **تتبع الاستخدام:** تتبع عدد مرات وأماكن استخدام الملفات
- **معالجة الصور:** استخراج أبعاد الصور تلقائياً
- **بحث وفلترة:** بحث نصي وفلترة متقدمة في مكتبة الوسائط
- **Soft Delete:** حذف آمن مع إمكانية الاسترداد
- **إحصائيات أساسية:** إحصائيات المكتبة والتخزين
- **فهرسة محسنة:** indexes للبحث السريع والفلترة
- **أمان ومصادقة:** JWT authentication وصلاحيات الأدمن
