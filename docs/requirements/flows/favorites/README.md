# تدفقات المفضلات (Favorites Flows)

## الملفات المتاحة
- `favorites-sync.mmd` - مخطط إدارة المفضلات ومزامنتها

## شرح التدفقات

### 1. إدارة المفضلات للمستخدمين المسجلين
- **إضافة للمفضلات:** حفظ مع ملاحظات ووسوم
- **تحديث المفضلة:** تعديل الملاحظات والوسوم
- **إزالة من المفضلات:** Soft Delete مع الحفاظ على البيانات
- **عرض المفضلات:** قائمة مع تفاصيل المنتجات
- **البحث بالوسوم:** فلترة المفضلات حسب الوسوم
- **عداد المشاهدات:** تتبع عدد مرات فتح المفضلة

### 2. إدارة المفضلات للزوار
- **إضافة للمفضلات:** حفظ مع deviceId
- **عرض المفضلات:** قائمة المفضلات للزائر
- **إزالة من المفضلات:** Soft Delete
- **مسح جميع المفضلات:** حذف جميع مفضلات الزائر
- **عداد المفضلات:** عدد المفضلات للزائر

### 3. مزامنة المفضلات المتقدمة
- **المشكلة:** فقدان المفضلات عند التسجيل
- **الحل:** دمج مفضلات الزائر مع مفضلات المستخدم
- **الخطوات المتقدمة:**
  1. البحث عن مفضلات الزائر (deviceId)
  2. البحث عن مفضلات المستخدم (userId)
  3. التحقق من عدم التكرار
  4. دمج المفضلات الجديدة فقط
  5. تعيين علامة المزامنة (isSynced)
  6. حذف مفضلات الزائر بعد المزامنة
  7. تسجيل إحصائيات المزامنة

### 4. نظام الوسوم والملاحظات
- **الوسوم:** تنظيم المفضلات بالوسوم (tags)
- **الملاحظات:** ملاحظات شخصية لكل مفضلة
- **البحث بالوسوم:** فلترة المفضلات حسب الوسوم
- **إحصائيات الوسوم:** أكثر الوسوم استخداماً

### 5. نظام الإحصائيات والتحليلات
- **عداد المشاهدات:** تتبع عدد مرات فتح المفضلة
- **آخر مشاهدة:** تاريخ آخر مشاهدة للمفضلة
- **إحصائيات المنتجات:** أكثر المنتجات إضافة للمفضلات
- **إحصائيات المستخدمين:** عدد المفضلات لكل مستخدم
- **إحصائيات الزوار:** عدد المفضلات لكل زائر
- **إحصائيات المزامنة:** عدد المفضلات المزامنة

### 6. نظام Soft Delete
- **الحذف الآمن:** عدم حذف البيانات نهائياً
- **استرداد المفضلات:** إمكانية استرداد المفضلات المحذوفة
- **تتبع الحذف:** تسجيل تاريخ الحذف
- **تنظيف البيانات:** حذف البيانات القديمة بعد فترة

### 7. نظام التحليلات المتقدم
- **أكثر المنتجات إضافة:** قائمة بأكثر المنتجات إضافة للمفضلات
- **أكثر الوسوم استخداماً:** إحصائيات الوسوم
- **إحصائيات المزامنة:** تتبع عمليات المزامنة
- **إحصائيات شاملة:** تقارير مفصلة عن استخدام المفضلات

### 8. نظام الأداء والتحسين
- **فهرسة محسنة:** indexes محسنة للبحث السريع
- **منع التكرار:** unique indexes لمنع التكرار
- **تجميع البيانات:** استخدام MongoDB Aggregation
- **تخزين مؤقت:** تحسين الأداء مع التخزين المؤقت

## API Endpoints المتاحة

### للمستخدمين المسجلين
- **GET /favorites** - قائمة المفضلات
- **POST /favorites** - إضافة للمفضلات
- **DELETE /favorites** - إزالة من المفضلات
- **PATCH /favorites/:id** - تحديث مفضلة
- **DELETE /favorites/clear/all** - مسح جميع المفضلات
- **GET /favorites/count** - عدد المفضلات
- **GET /favorites/by-tags** - المفضلات حسب الوسوم
- **POST /favorites/sync** - مزامنة من الزائر
- **POST /favorites/:id/view** - زيادة عداد المشاهدات

### للزوار
- **GET /favorites/guest** - قائمة المفضلات للزائر
- **POST /favorites/guest** - إضافة للمفضلات (زائر)
- **DELETE /favorites/guest** - إزالة من المفضلات (زائر)
- **DELETE /favorites/guest/clear** - مسح جميع المفضلات (زائر)
- **GET /favorites/guest/count** - عدد المفضلات (زائر)

### للمديرين
- **GET /admin/favorites/stats** - إحصائيات شاملة
- **GET /admin/favorites/most-favorited** - أكثر المنتجات إضافة
- **GET /admin/favorites/sync-stats** - إحصائيات المزامنة

## هيكل البيانات

### حقول المفضلة الأساسية
- `_id`: معرف المفضلة (ObjectId)
- `userId`: معرف المستخدم (ObjectId) - للمستخدمين المسجلين
- `deviceId`: معرف الجهاز (string) - للزوار
- `productId`: معرف المنتج (ObjectId)
- `variantId`: معرف التنويع (ObjectId) - اختياري

### حقول التنظيم
- `note`: ملاحظة شخصية (string)
- `tags`: وسوم التنظيم (array of strings)

### حقول الإحصائيات
- `viewsCount`: عدد المشاهدات (number)
- `lastViewedAt`: آخر مشاهدة (Date)

### حقول المزامنة
- `isSynced`: هل تمت المزامنة (boolean)
- `syncedAt`: تاريخ المزامنة (Date)

### حقول Soft Delete
- `deletedAt`: تاريخ الحذف (Date)
- `createdAt`: تاريخ الإنشاء (Date)
- `updatedAt`: تاريخ التحديث (Date)

## DTOs المتاحة

### للمستخدمين المسجلين
- `AddFavoriteDto`: إضافة مفضلة
  - `productId`: معرف المنتج (required)
  - `variantId`: معرف التنويع (optional)
  - `note`: ملاحظة شخصية (optional)
  - `tags`: وسوم (optional)

- `RemoveFavoriteDto`: إزالة مفضلة
  - `productId`: معرف المنتج (required)
  - `variantId`: معرف التنويع (optional)

- `UpdateFavoriteDto`: تحديث مفضلة
  - `note`: ملاحظة شخصية (optional)
  - `tags`: وسوم (optional)

### للزوار
- `GuestAddFavoriteDto`: إضافة مفضلة للزائر
  - `deviceId`: معرف الجهاز (required)
  - `productId`: معرف المنتج (required)
  - `variantId`: معرف التنويع (optional)
  - `note`: ملاحظة شخصية (optional)
  - `tags`: وسوم (optional)

- `GuestRemoveFavoriteDto`: إزالة مفضلة للزائر
  - `deviceId`: معرف الجهاز (required)
  - `productId`: معرف المنتج (required)
  - `variantId`: معرف التنويع (optional)

### للمزامنة
- `SyncFavoritesDto`: مزامنة المفضلات
  - `deviceId`: معرف الجهاز للمزامنة (required)

## نقاط مهمة
- **دعم مزدوج:** للمستخدمين المسجلين والزوار
- **مزامنة ذكية:** منع التكرار أثناء المزامنة
- **تنظيم متقدم:** وسوم وملاحظات شخصية
- **إحصائيات شاملة:** تتبع المشاهدات والاستخدام
- **حذف آمن:** Soft Delete مع إمكانية الاسترداد
- **أداء محسن:** فهرسة محسنة ومنع التكرار
- **تحليلات متقدمة:** إحصائيات شاملة للاستخدام
- **مرونة عالية:** دعم المنتجات والتنويعات
- **تتبع شامل:** تسجيل جميع العمليات
- **أمان عالي:** التحقق من الصلاحيات
