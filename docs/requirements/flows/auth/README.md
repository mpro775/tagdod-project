# تدفقات المصادقة (Authentication Flows)

## الملفات المتاحة
- `signup-login.mmd` - مخطط تسجيل المستخدمين وتسجيل الدخول
- `biometric-register.mmd` - مخطط تسجيل جهاز بصمة جديد (WebAuthn)
- `biometric-login.mmd` - مخطط تسجيل الدخول بالبصمة باستخدام جهاز مسجّل

## شرح التدفقات

### 1. إرسال رمز التحقق (Send OTP)
- **المدخلات:** رقم الهاتف، السياق (register/reset)
- **المعالجة:** إنشاء رمز OTP عشوائي وتخزينه في Redis
- **النتيجة:** إرسال الرمز عبر SMS وإرجاع devCode في بيئة التطوير

### 2. التحقق من الرمز وتسجيل الدخول (Verify OTP)
- **المدخلات:** رقم الهاتف، رمز التحقق، بيانات إضافية (اختيارية)
- **التحقق:** مقارنة الرمز مع المخزن في Redis
- **المنطق:** إنشاء مستخدم جديد إذا لم يوجد، أو تسجيل دخول إذا كان موجود
- **النتيجة:** إصدار JWT tokens (access + refresh) وإرجاع بيانات المستخدم

### 3. إدارة كلمة المرور
- **نسيان كلمة المرور:** إرسال OTP بسياق "reset"
- **إعادة تعيين كلمة المرور:** التحقق من OTP وتحديث كلمة المرور
- **تعيين كلمة المرور:** للمستخدمين المسجلين (محمي بـ JWT)

### 4. إدارة الملف الشخصي (Profile Management)
- **عرض الملف الشخصي:** الحصول على بيانات المستخدم وقدراته
- **تحديث الملف الشخصي:** تعديل الاسم، الجنس، المسمى الوظيفي
- **حذف الحساب:** حذف ناعم للمستخدم وسجل قدراته

### 5. إدارة القدرات (Capabilities Management)
- **طلب قدرات جديدة:** engineer أو wholesale
- **الموافقة على الطلبات:** للمديرين فقط
- **إدارة الخصومات:** تحديد نسبة خصم الجملة

### 6. إدارة العملة المفضلة
- **تحديث العملة:** USD, YER, SAR
- **تطبيق التفضيلات:** على جميع العمليات المالية

### 7. مزامنة المفضلات
- **ربط الجهاز:** ربط المفضلات بالحساب عند التسجيل
- **مزامنة تلقائية:** نقل المفضلات من الجهاز إلى الحساب

## API Endpoints المتاحة

### POST /auth/send-otp
- **الوصف:** إرسال رمز التحقق
- **المدخلات:** `{ phone: string, context?: 'register'|'reset' }`
- **النتيجة:** `{ sent: boolean, devCode?: string }`

### POST /auth/verify-otp
- **الوصف:** التحقق من الرمز وإكمال التسجيل/الدخول
- **المدخلات:** `{ phone, code, firstName?, lastName?, gender?, capabilityRequest?, jobTitle?, deviceId? }`
- **النتيجة:** `{ tokens: { access, refresh }, me: { id, phone } }`

### POST /auth/forgot-password
- **الوصف:** طلب إعادة تعيين كلمة المرور
- **المدخلات:** `{ phone: string }`

### POST /auth/reset-password
- **الوصف:** إعادة تعيين كلمة المرور
- **المدخلات:** `{ phone, code, newPassword }`

### POST /auth/set-password (محمي)
- **الوصف:** تعيين/تحديث كلمة المرور
- **المدخلات:** `{ password: string }`

### GET /auth/me (محمي)
- **الوصف:** الحصول على الملف الشخصي
- **النتيجة:** `{ user, capabilities }`

### PATCH /auth/me (محمي)
- **الوصف:** تحديث الملف الشخصي
- **المدخلات:** `{ firstName?, lastName?, gender?, jobTitle? }`

### PATCH /auth/preferred-currency (محمي)
- **الوصف:** تحديث العملة المفضلة
- **المدخلات:** `{ currency: 'USD'|'YER'|'SAR' }`

### DELETE /auth/me (محمي)
- **الوصف:** حذف الحساب
- **المنطق:** حذف ناعم للمستخدم وقدراته

### GET /auth/admin/pending (محمي، مدير)
- **الوصف:** الحصول على طلبات القدرات المعلقة

### POST /auth/admin/approve (محمي، مدير)
- **الوصف:** الموافقة/الرفض على طلبات القدرات
- **المدخلات:** `{ userId, capability, approve, wholesaleDiscountPercent? }`

### للتطوير والاختبار (3 endpoints - غير متاح في الإنتاج)
- **POST /auth/create-super-admin** - إنشاء الادمن الرئيسي
- **POST /auth/dev-login** - تسجيل دخول السوبر أدمن للتطوير

## هيكل البيانات

### حقول المستخدم الأساسية
- `phone`: رقم الهاتف (فريد، مطلوب)
- `firstName`: الاسم الأول (اختياري)
- `lastName`: اسم العائلة (اختياري)
- `gender`: الجنس (male/female/other)
- `jobTitle`: المسمى الوظيفي (للمهندسين)

### حقول النظام
- `passwordHash`: كلمة المرور المشفرة (bcrypt)
- `roles`: الأدوار (array) - user, admin, super_admin, merchant, engineer
- `permissions`: الصلاحيات المخصصة (array)
- `status`: حالة الحساب (active/suspended/pending)
- `preferredCurrency`: العملة المفضلة (USD/YER/SAR)
- `lastActivityAt`: آخر نشاط (Date)

### حقول الحذف الناعم
- `deletedAt`: تاريخ الحذف (Date)
- `deletedBy`: من قام بالحذف (userId)
- `suspendedReason`: سبب الإيقاف (string)
- `suspendedBy`: من قام بالإيقاف (userId)
- `suspendedAt`: تاريخ الإيقاف (Date)

## نقاط مهمة
- **نظام OTP أساسي:** لا يوجد تسجيل بالبريد الإلكتروني
- **JWT مزدوج:** Access Token (15 دقيقة) + Refresh Token (30 يوم)
- **نظام قدرات متقدم:** engineer, wholesale مع نظام موافقة
- **دعم العملات المتعددة:** USD, YER, SAR
- **مزامنة المفضلات:** ربط تلقائي مع الجهاز
- **نظام أدوار مرن:** user, admin, super_admin, merchant, engineer
- **حذف ناعم:** حماية البيانات مع إمكانية الاستعادة
- **تتبع النشاط:** lastActivityAt لتتبع استخدام النظام
- **Redis للتخزين:** OTP مع صلاحية محددة
- **بيئة التطوير:** devCode للاختبار المحلي
- **أمان متقدم:** تشفير bcrypt، JWT محمي

## معالجة الأخطاء

### أخطاء التحقق (400)
- رقم هاتف غير صحيح
- رمز OTP غير صحيح أو منتهي الصلاحية
- بيانات مطلوبة مفقودة
- كلمة مرور قصيرة جداً (أقل من 8 أحرف)

### أخطاء الأمان (401/403)
- رمز OTP منتهي الصلاحية
- JWT token غير صحيح أو منتهي الصلاحية
- محاولة الوصول لعمليات تتطلب صلاحيات إدارية
- حساب معطل أو معلق

### أخطاء المنطق (400)
- محاولة إعادة تعيين كلمة مرور لحساب غير موجود
- طلب قدرات غير صالح
- محاولة حذف حساب غير موجود

### أخطاء الخادم (500)
- خطأ في Redis (تخزين/استرجاع OTP)
- خطأ في قاعدة البيانات
- خطأ في إرسال SMS

## المتغيرات البيئية المطلوبة

### JWT Configuration
- `JWT_SECRET`: مفتاح تشفير Access Token
- `REFRESH_SECRET`: مفتاح تشفير Refresh Token

### OTP Configuration
- `REDIS_URL`: رابط اتصال Redis
- `OTP_TTL_SECONDS`: مدة صلاحية OTP (افتراضي: 300 ثانية)
- `OTP_LENGTH`: طول رمز OTP (افتراضي: 6 أرقام)
- `OTP_DEV_ECHO`: عرض الرمز في بيئة التطوير (افتراضي: false)

### SMS Configuration
- `SMS_PROVIDER`: مزود خدمة SMS
- `SMS_API_KEY`: مفتاح API للـ SMS
- `SMS_SENDER_ID`: معرف المرسل

## تدفق الأمان

### 1. حماية OTP
- تخزين مشفر في Redis
- صلاحية محدودة (5 دقائق افتراضياً)
- حذف تلقائي بعد الاستخدام

### 2. حماية JWT
- Access Token قصير المدى (15 دقيقة)
- Refresh Token طويل المدى (30 يوم)
- تشفير قوي باستخدام HMAC

### 3. حماية البيانات
- تشفير كلمات المرور بـ bcrypt
- حذف ناعم للمستخدمين
- تتبع عمليات الحذف والإيقاف

### 4. حماية API
- JWT Guard للعمليات المحمية
- Admin Guard للعمليات الإدارية
- Engineer Guard للعمليات الهندسية

## حالات الاستخدام المتقدمة

### 1. تسجيل مهندس جديد
- إرسال OTP → التحقق → طلب قدرة engineer
- إدخال jobTitle → انتظار موافقة المدير
- تفعيل القدرة بعد الموافقة

### 2. تسجيل تاجر جملة
- إرسال OTP → التحقق → طلب قدرة wholesale
- انتظار موافقة المدير
- تحديد نسبة خصم الجملة

### 3. مزامنة المفضلات
- ربط deviceId عند التسجيل
- نقل المفضلات من الجهاز إلى الحساب
- مزامنة تلقائية في المستقبل

### 4. إدارة العملة
- اختيار العملة المفضلة
- تطبيق التفضيل على جميع العمليات
- دعم USD, YER, SAR
