%% Product Pricing Management Flow
%% View at https://mermaid.live
flowchart TD
  A[إدارة أسعار المنتجات] --> B{نوع العملية?}
  B -->|عرض الأسعار| C[عرض أسعار المنتج]
  B -->|تحديث الأسعار| D[تحديث أسعار التنويعات]
  B -->|عرض النطاق| E[عرض نطاق الأسعار]

  %% Display Pricing
  C --> C1[استرجاع جميع التنويعات]
  C1 --> C2[عرض basePriceUSD لكل variant]
  C2 --> C3[عرض compareAtPriceUSD إذا كان متوفراً]
  C3 --> C4[عرض costPriceUSD للإدارة]

  %% Update Pricing
  D --> D1[تحديد التنويعة المراد تحديثها]
  D1 --> D2[إدخال basePriceUSD الجديد]
  D2 --> D3[إدخال compareAtPriceUSD الجديد - اختياري]
  D3 --> D4[إدخال costPriceUSD الجديد - اختياري]
  D4 --> D5[حفظ التغييرات]

  %% Price Range
  E --> E1[استرجاع جميع التنويعات النشطة]
  E1 --> E2[استخراج basePriceUSD لكل variant]
  E2 --> E3[العثور على السعر الأدنى]
  E3 --> E4[العثور على السعر الأعلى]
  E4 --> E5[إرجاع النطاق السعري]

  %% Currency Conversion
  F[تحويل العملات] --> F1[استلام السعر بالدولار]
  F1 --> F2[قراءة سعر الصرف الحالي]
  F2 --> F3[ضرب السعر بالمعدل]
  F3 --> F4[إرجاع السعر بالعملة المطلوبة]

  %% Price Display
  G[عرض الأسعار للعملاء] --> G1{المستخدم مسجل?}
  G1 -->|نعم| G2[التحقق من نوع المستخدم]
  G1 -->|لا| G3[عرض basePriceUSD كسعر أساسي]
  G2 --> G4{هل هو تاجر موافق?}
  G4 -->|نعم| G5[جلب نسبة خصم التاجر من User/Capabilities]
  G4 -->|لا| G3
  G5 --> G6[حساب السعر الأصلي مع تحويل العملة]
  G6 --> G7[تطبيق نسبة الخصم على السعر]
  G7 --> G8[حساب مبلغ الخصم]
  G8 --> G9[حساب السعر النهائي]
  G9 --> G10[تنسيق الأسعار]
  G10 --> G11[عرض السعر الأصلي ونسبة الخصم والسعر النهائي]
  G3 --> G12[عرض compareAtPriceUSD كسعر قديم إذا كان أعلى]
  G12 --> G13[حساب التوفير المئوي]
  G13 --> G14[عرض "خصم X%" إذا كان هناك سعر مقارنة]

  %% Cost Tracking
  H[تتبع التكاليف] --> H1[costPriceUSD للحسابات المالية]
  H1 --> H2[حساب الربحية]
  H2 --> H3[تحليل الهوامش]

  %% Price Validation
  I[التحقق من صحة الأسعار] --> I1[basePriceUSD > 0]
  I1 --> I2[compareAtPriceUSD > basePriceUSD إذا كان متوفراً]
  I2 --> I3[costPriceUSD < basePriceUSD]
  I3 --> I4[الأسعار منطقية]

  %% Bulk Price Updates
  J[تحديث الأسعار الجماعي] --> J1[تحديد منتجات متعددة]
  J1 --> J2[تحديد نوع التغيير]
  J2 --> J3[زيادة/تقليل بنسبة مئوية]
  J3 --> J4[أو تحديد قيمة ثابتة]
  J4 --> J5[تطبيق على جميع التنويعات المحددة]

  %% Wholesale Discount System
  M[نظام خصم التاجر] --> M1[عند تسجيل دخول التاجر]
  M1 --> M2[جلب wholesale_discount_percent من User]
  M2 --> M3{هل الخصم موجود في Capabilities?}
  M3 -->|نعم| M4[استخدام الخصم من Capabilities]
  M3 -->|لا| M5[استخدام الخصم من User مباشرة]
  M4 --> M6[تطبيق الخصم على جميع المنتجات]
  M5 --> M6
  M6 --> M7[إرجاع السعر الأصلي والسعر النهائي معاً]
  
  %% Currency Handling
  N[معالجة العملات] --> N1[جلب العملة المفضلة من المستخدم أو استخدام USD]
  N1 --> N2[تحويل الأسعار من USD للعملة المطلوبة]
  N2 --> N3[تطبيق الخصم على السعر المحول]
  N3 --> N4[تنسيق الأسعار بالعملة المحددة]

  %% End points
  C4 --> K[نهاية - عرض الأسعار]
  D5 --> K
  E5 --> K
  F4 --> K
  G11 --> K
  G14 --> K
  H3 --> K
  I4 --> K
  J5 --> K
  M7 --> K
  N4 --> K
