%% Product Catalog Display Flow
%% View at https://mermaid.live
flowchart TD
  A[عرض كتالوج المنتجات] --> B{نوع العرض?}
  B -->|قائمة عامة| C[عرض قائمة المنتجات]
  B -->|تفاصيل منتج| D[عرض تفاصيل منتج محدد]
  B -->|منتجات مميزة| E[عرض المنتجات المميزة]
  B -->|منتجات جديدة| F[عرض المنتجات الجديدة]

  %% Product List
  C --> C1[استعلام المنتجات النشطة]
  C1 --> C2[تطبيق الفلاتر والفرز]
  C2 --> C3[تطبيق البحث النصي]
  C3 --> C4[تقسيم النتائج لصفحات]
  C4 --> C5[إرجاع قائمة المنتجات]

  %% Product Details
  D --> D1[البحث عن المنتج بالمعرف أو الـ slug]
  D1 --> D2[التحقق من الحالة ACTIVE]
  D2 --> D3[تحميل التنويعات النشطة]
  D3 --> D4[تحميل الصور من مكتبة الوسائط]
  D4 --> D5{المستخدم مسجل?}
  D5 -->|نعم| D6[جلب نسبة خصم التاجر]
  D5 -->|لا| D7[تعيين نسبة الخصم = 0]
  D6 --> D8{هل هو تاجر موافق?}
  D8 -->|نعم| D9[استخدام نسبة الخصم]
  D8 -->|لا| D7
  D9 --> D10[جلب العملة المفضلة من المستخدم]
  D7 --> D11[استخدام العملة المطلوبة أو USD]
  D10 --> D12[حساب الأسعار مع خصم التاجر]
  D11 --> D12
  D12 --> D13[حساب نطاق الأسعار مع الخصم]
  D13 --> D14[إرجاع تفاصيل شاملة مع pricing information]

  %% Featured Products
  E --> E1[فلترة المنتجات حيث isFeatured = true]
  E1 --> E2[ترتيب حسب order ثم createdAt]
  E2 --> E3[تقييد العدد المطلوب]
  E3 --> E4[إرجاع قائمة المنتجات المميزة]

  %% New Products
  F --> F1[فلترة المنتجات حيث isNew = true]
  F1 --> F2[ترتيب حسب createdAt تنازلياً]
  F2 --> F3[تقييد العدد المطلوب]
  F3 --> F4[إرجاع قائمة المنتجات الجديدة]

  %% Filtering Options
  G[خيارات الفلترة] --> G1[categoryId: فلترة حسب التصنيف]
  G1 --> G2[brandId: فلترة حسب العلامة التجارية]
  G2 --> G3[priceRange: فلترة حسب النطاق السعري]
  G3 --> G4[status: فلترة حسب الحالة]

  %% Search Options
  H[خيارات البحث] --> H1[name: بحث في الاسم العربي]
  H1 --> H2[nameEn: بحث في الاسم الإنجليزي]
  H2 --> H3[description: بحث في الوصف العربي]
  H3 --> H4[descriptionEn: بحث في الوصف الإنجليزي]

  %% Sorting Options
  I[خيارات الترتيب] --> I1[createdAt: حسب تاريخ الإنشاء]
  I1 --> I2[price: حسب السعر]
  I2 --> I3[salesCount: حسب عدد المبيعات]
  I3 --> I4[viewsCount: حسب عدد المشاهدات]
  I4 --> I5[order: حسب الترتيب المخصص]

  %% Pagination
  J[الصفحات] --> J1[page: رقم الصفحة]
  J1 --> J2[limit: عدد العناصر لكل صفحة]
  J2 --> J3[skip: حساب العناصر المراد تجاهلها]
  J3 --> J4[total: إجمالي عدد النتائج]

  %% Response Structure
  K[هيكل الاستجابة] --> K1[product: بيانات المنتج]
  K1 --> K2[variants: مصفوفة التنويعات مع pricing]
  K2 --> K3[pagination: معلومات الصفحات - في القوائم]
  K3 --> K4[currency: العملة المستخدمة]
  K4 --> K5[userDiscount: معلومات خصم التاجر]
  K5 --> K6[totalCount: إجمالي العدد - في القوائم]
  
  %% Pricing Structure in Variant
  P[هيكل pricing في Variant] --> P1[basePrice: السعر الأصلي]
  P1 --> P2[compareAtPrice: سعر المقارنة]
  P2 --> P3[discountPercent: نسبة الخصم]
  P3 --> P4[discountAmount: مبلغ الخصم]
  P4 --> P5[finalPrice: السعر النهائي]
  P5 --> P6[currency: العملة]
  P6 --> P7[exchangeRate: سعر الصرف]
  P7 --> P8[formattedPrice: السعر المنسق]
  P8 --> P9[formattedFinalPrice: السعر النهائي المنسق]

  %% Performance Optimization
  L[تحسين الأداء] --> L1[indexes محسنة للبحث]
  L1 --> L2[تخزين مؤقت للاستعلامات الشائعة]
  L2 --> L3[تحميل الصور عند الحاجة]

  %% User Discount Info
  U[معلومات خصم المستخدم] --> U1[isWholesale: boolean]
  U1 --> U2[discountPercent: number]
  
  %% Currency Selection
  V[اختيار العملة] --> V1[قراءة currency من query parameter]
  V1 --> V2{currency موجود?}
  V2 -->|نعم| V3[استخدام العملة المحددة]
  V2 -->|لا| V4{المستخدم مسجل?}
  V4 -->|نعم| V5[استخدام preferredCurrency من JWT]
  V4 -->|لا| V6[استخدام USD كافتراضي]
  V5 --> V3
  V6 --> V3

  %% End points
  C5 --> M[نهاية - قائمة المنتجات]
  D14 --> M
  E4 --> M
  F4 --> M
  P9 --> M
  U2 --> M
  V3 --> M
