# تدفقات نظام أسعار الصرف (Exchange Rates Flows)

## الملفات المتاحة

### المخططات الرئيسية
- `exchange-rates-overview.mmd` - نظرة عامة على نظام أسعار الصرف
- `exchange-rates-management.mmd` - مخطط تدفق إدارة أسعار الصرف
- `currency-conversion.mmd` - مخطط تدفق تحويل العملات

## شرح التدفقات

### 1. إدارة أسعار الصرف (Exchange Rates Management)
- **تحديث أسعار الصرف:** تحديث أسعار الصرف اليدوي من قبل المديرين
- **حفظ تاريخ التحديثات:** حفظ معلومات التحديث مع بيانات المسؤول
- **أسعار افتراضية:** استخدام أسعار افتراضية في حالة عدم وجود أسعار محدثة
- **إدارة الملاحظات:** إضافة ملاحظات لكل تحديث

### 2. تحويل العملات (Currency Conversion)
- **تحويل شامل:** تحويل بين جميع العملات (USD, YER, SAR)
- **التحويل المباشر:** تحويل من USD إلى YER/SAR
- **التحويل العكسي:** تحويل من YER/SAR إلى USD
- **التحويل المتقاطع:** تحويل بين YER و SAR (عبر USD)
- **تنسيق النتائج:** تنسيق تلقائي للنتائج حسب العملة
- **حساب الإجماليات:** حساب الإجماليات بالعملات الثلاث تلقائياً

### 3. إدارة النظام (System Management)
- **مراقبة الأداء:** مراقبة أداء عمليات التحويل
- **إدارة السجلات:** حفظ سجل واحد للأسعار الحالية
- **الحماية من الإفراط:** حماية من الاستخدام المفرط للـ APIs

## المكونات الرئيسية

### 1. إدارة أسعار الصرف (Exchange Rates Management)
- **البيانات الأساسية:**
  - سعر الدولار للريال اليمني (usdToYer)
  - سعر الدولار للريال السعودي (usdToSar)
- **معلومات التحديث:**
  - آخر من قام بالتحديث (lastUpdatedBy)
  - وقت آخر تحديث (lastUpdatedAt)
  - الملاحظات (notes)
- **البيانات التلقائية:**
  - وقت الإنشاء (createdAt)
  - وقت آخر تحديث (updatedAt)

### 2. تحويل العملات (Currency Conversion)
- **التحويل الشامل:**
  - الحصول على سعر الصرف الحالي
  - حساب التحويل حسب نوع العملة
  - التحويل المباشر أو العكسي أو المتقاطع
  - تقريب النتيجة حسب العملة
  - تنسيق النتيجة للعرض
- **العملات المدعومة:**
  - **USD → YER/SAR:** التحويل المباشر من الدولار
  - **YER/SAR → USD:** التحويل العكسي إلى الدولار
  - **YER ↔ SAR:** التحويل المتقاطع (عبر USD)
- **الاتجاهات المدعومة (6 اتجاهات):**
  1. USD → YER
  2. USD → SAR
  3. YER → USD
  4. SAR → USD
  5. YER → SAR
  6. SAR → YER
- **حساب الإجماليات بالعملات الثلاث:**
  - تحويل جميع المبالغ إلى USD أولاً
  - حساب الإجماليات بالعملات الثلاث تلقائياً
  - يُستخدم في السلة والطلبات
- **تنسيق النتائج:**
  - تنسيق الريال اليمني مع الفواصل (بدون أرقام عشرية)
  - تنسيق الريال السعودي مع رقمين عشريين
  - تنسيق الدولار مع رقمين عشريين

### 3. إدارة النظام (System Management)
- **الأسعار الافتراضية:**
  - إنشاء أسعار افتراضية تلقائياً
  - استخدام الأسعار الافتراضية عند الحاجة
- **إدارة السجلات:**
  - حفظ سجل واحد للأسعار الحالية
  - حذف الأسعار القديمة عند التحديث
- **الحماية والأمان:**
  - حماية من الاستخدام المفرط
  - تسجيل العمليات للمراجعة

## العملات المدعومة

### العملات الأساسية
- **الدولار الأمريكي (USD):** العملة الأساسية للنظام
- **الريال اليمني (YER):** العملة المحلية اليمنية
- **الريال السعودي (SAR):** العملة السعودية

### أزواج العملات المدعومة (6 اتجاهات)
- **USD → YER:** الدولار الأمريكي إلى الريال اليمني
- **USD → SAR:** الدولار الأمريكي إلى الريال السعودي
- **YER → USD:** الريال اليمني إلى الدولار الأمريكي (التحويل العكسي)
- **SAR → USD:** الريال السعودي إلى الدولار الأمريكي (التحويل العكسي)
- **YER → SAR:** الريال اليمني إلى الريال السعودي (عبر USD)
- **SAR → YER:** الريال السعودي إلى الريال اليمني (عبر USD)

## مصادر أسعار الصرف

### المصادر اليدوية
- **إدخال يدوي:** إدخال أسعار الصرف يدوياً من قبل المديرين
- **التحقق اليدوي:** التحقق من صحة الأسعار يدوياً
- **التحديث اليدوي:** تحديث الأسعار يدوياً عند الحاجة
- **أسعار افتراضية:** استخدام أسعار افتراضية عند بدء النظام

### المصادر المستقبلية (مخططة)
- **APIs خارجية:** ربط النظام بـ APIs خارجية لأسعار الصرف (مخطط للتطوير المستقبلي)
- **التحديث التلقائي:** تحديث أسعار الصرف تلقائياً (مخطط للتطوير المستقبلي)

## خوارزميات التحويل

### التحويل الأساسي
```typescript
result = amount * exchangeRate
```

### التحويل المباشر (USD → YER/SAR)
```typescript
// USD إلى YER
yerResult = usdAmount * usdToYerRate
formattedResult = Math.round(yerResult).toLocaleString() + " $"

// USD إلى SAR
sarResult = usdAmount * usdToSarRate
formattedResult = sarResult.toFixed(2) + " $"
```

### التحويل العكسي (YER/SAR → USD)
```typescript
// YER إلى USD
usdResult = yerAmount * (1 / usdToYerRate)
formattedResult = "$" + usdResult.toFixed(2)

// SAR إلى USD
usdResult = sarAmount * (1 / usdToSarRate)
formattedResult = "$" + usdResult.toFixed(2)
```

### التحويل المتقاطع (YER ↔ SAR)
```typescript
// YER إلى SAR (عبر USD)
usdAmount = yerAmount / usdToYerRate
sarResult = usdAmount * usdToSarRate
rate = usdToSarRate / usdToYerRate
formattedResult = sarResult.toFixed(2) + " $"

// SAR إلى YER (عبر USD)
usdAmount = sarAmount / usdToSarRate
yerResult = usdAmount * usdToYerRate
rate = usdToYerRate / usdToSarRate
formattedResult = Math.round(yerResult).toLocaleString() + " $"
```

### حساب الإجماليات بالعملات الثلاث
```typescript
// تحويل جميع المبالغ إلى USD أولاً
usdSubtotal = convertToUSD(subtotal, currency)
usdShipping = convertToUSD(shipping, currency)
usdTax = convertToUSD(tax, currency)
usdDiscount = convertToUSD(discount, currency)

// حساب الإجماليات بالعملات الثلاث
totalsInAllCurrencies = {
  USD: {
    subtotal: usdSubtotal,
    shippingCost: usdShipping,
    tax: usdTax,
    totalDiscount: usdDiscount,
    total: usdSubtotal + usdShipping + usdTax - usdDiscount
  },
  YER: {
    subtotal: convertFromUSDToYER(usdSubtotal),
    shippingCost: convertFromUSDToYER(usdShipping),
    tax: convertFromUSDToYER(usdTax),
    totalDiscount: convertFromUSDToYER(usdDiscount),
    total: convertFromUSDToYER(usdTotal)
  },
  SAR: {
    subtotal: convertFromUSDToSAR(usdSubtotal),
    shippingCost: convertFromUSDToSAR(usdShipping),
    tax: convertFromUSDToSAR(usdTax),
    totalDiscount: convertFromUSDToSAR(usdDiscount),
    total: convertFromUSDToSAR(usdTotal)
  }
}
```

### التقريب التلقائي
```typescript
// الريال اليمني - تقريب لأقرب عدد صحيح
yerRounded = Math.round(yerResult)

// الريال السعودي - تقريب لرقمين عشريين
sarRounded = Math.round(sarResult * 100) / 100

// الدولار - تقريب لرقمين عشريين
usdRounded = Math.round(usdResult * 100) / 100
```

## قواعد التحقق

### التحقق من صحة البيانات
- **قيمة السعر:** التحقق من أن السعر موجب ورقمي (أكبر من 0.01)
- **المبلغ المراد تحويله:** التحقق من أن المبلغ موجب (أكبر من أو يساوي 0)
- **رموز العملات:** التحقق من دعم العملة المطلوبة (USD, YER, SAR)
- **الاتجاهات المدعومة:** التحقق من دعم اتجاه التحويل (6 اتجاهات)
- **منع التحويل لنفس العملة:** منع التحويل من عملة إلى نفسها

### التحقق من دقة التحويل
- **دقة الحساب:** التحقق من دقة العمليات الحسابية الأساسية
- **دقة التقريب:** التحقق من دقة عمليات التقريب حسب العملة
- **دقة النتائج:** التحقق من دقة النتائج النهائية والتنسيق

### التحقق من صحة المدخلات
- **تحديث الأسعار:** التحقق من صحة أسعار USD إلى YER و USD إلى SAR
- **الملاحظات:** التحقق من صحة الملاحظات (اختياري)

## الميزات المتقدمة (مخططة)

### 1. الذكاء الاصطناعي (مستقبلي)
- **التنبؤ بالأسعار:** التنبؤ بأسعار الصرف المستقبلية
- **تحليل الاتجاهات:** تحليل اتجاهات أسعار الصرف

### 2. الأتمتة المتقدمة (مستقبلي)
- **أتمتة التحديث:** تحديث تلقائي لأسعار الصرف من APIs خارجية
- **أتمتة التحقق:** تحقق تلقائي من دقة الأسعار
- **أتمتة الإشعارات:** إشعارات تلقائية عند التغيير

### 3. التحليلات المتقدمة (مستقبلي)
- **تحليل الأداء:** تحليل أداء نظام أسعار الصرف
- **تحليل الدقة:** تحليل دقة أسعار الصرف

### 4. الأمان والامتثال
- **أمان البيانات:** حماية بيانات أسعار الصرف
- **الحماية من الإفراط:** حماية من الاستخدام المفرط للـ APIs
- **تسجيل العمليات:** تسجيل شامل لجميع العمليات

## التكامل مع الأنظمة الأخرى

### تكامل مع نظام المنتجات
- **اعتماد USD كعملة أساسية:** جميع المنتجات تُخزن بالدولار الأمريكي
- **تحويل أسعار المنتجات:** تحويل أسعار المنتجات من الدولار إلى العملات المحلية
- **استخدام العملة المفضلة:** عرض أسعار المنتجات بالعملة المفضلة للمستخدم تلقائياً
- **Fallback إلى USD:** استخدام USD كافتراضي عند عدم وجود عملة مفضلة

### تكامل مع نظام السلة (Cart)
- **حساب إجماليات السلة:** تحويل إجماليات السلة بين العملات
- **الإجماليات بالعملات الثلاث:** إرجاع الإجماليات بالعملات الثلاث في preview السلة
- **تطبيق الخصومات:** تحويل قيم الخصومات (wholesale, coupons) حسب العملة
- **استخدام العملة المفضلة:** حساب السلة بالعملة المفضلة للمستخدم

### تكامل مع نظام الطلبات
- **حساب إجماليات الطلبات:** تحويل إجماليات الطلبات بين العملات
- **الإجماليات بالعملات الثلاث:** حفظ وإرجاع الإجماليات بالعملات الثلاث في كل طلب
- **تطبيق الخصومات:** تحويل قيم الخصومات حسب العملة
- **حفظ في Order Schema:** حقل `totalsInAllCurrencies` يحفظ الإجماليات بالعملات الثلاث

### تكامل مع نظام التسويق
- **تحويل أسعار التسويق:** تحويل أسعار العروض والتسويقات

### تكامل مع نظام التقارير
- **بيانات موحدة:** استخدام أسعار صرف موحدة في جميع التقارير

## نقاط مهمة
- **نظام شامل ومتكامل:** إدارة شاملة لأسعار الصرف مع دعم التحويل الكامل
- **الدولار كعملة أساسية:** جميع المنتجات والعروض تُخزن بالدولار الأمريكي
- **تحويل شامل:** تحويل دقيق بين جميع العملات (6 اتجاهات)
- **العملة المفضلة:** استخدام العملة المفضلة للمستخدم تلقائياً
- **الإجماليات بالعملات الثلاث:** إرجاع الإجماليات بالعملات الثلاث في السلة والطلبات
- **تحديث يدوي:** تحديث الأسعار يدوياً من قبل المديرين
- **أمان عالي:** حماية من الاستخدام المفرط وتسجيل العمليات
- **قابلية التوسع:** أساس قوي للتطوير المستقبلي (caching, history, notifications)
- **سهولة الصيانة:** صيانة مباشرة وبسيطة

## APIs المتاحة

### APIs عامة (للعملاء)

#### الحصول على أسعار الصرف الحالية
```http
GET /exchange-rates
```

**Response:**
```json
{
  "usdToYer": 250,
  "usdToSar": 3.75,
  "lastUpdated": "2024-01-15T10:30:00Z"
}
```

#### تحويل العملة
```http
POST /exchange-rates/convert
```

**Request:**
```json
{
  "amount": 100,
  "fromCurrency": "USD",
  "toCurrency": "YER"
}
```

**ملاحظة:** يدعم جميع الاتجاهات:
- `fromCurrency`: "USD" | "YER" | "SAR"
- `toCurrency`: "USD" | "YER" | "SAR"

**Response:**
```json
{
  "fromCurrency": "USD",
  "toCurrency": "YER",
  "amount": 100,
  "rate": 250,
  "result": 25000,
  "formatted": "25,000 $"
}
```

**أمثلة أخرى:**
```json
// YER إلى USD
{
  "amount": 25000,
  "fromCurrency": "YER",
  "toCurrency": "USD"
}
// Response: { "result": 100, "rate": 0.004, ... }

// SAR إلى YER
{
  "amount": 375,
  "fromCurrency": "SAR",
  "toCurrency": "YER"
}
// Response: { "result": 25000, "rate": 66.67, ... }
```

#### الحصول على سعر الدولار للريال اليمني
```http
GET /exchange-rates/usd-to-yer
```

**Response:**
```json
{
  "rate": 250,
  "currency": "YER",
  "formatted": "1 USD = 250 $"
}
```

#### الحصول على سعر الدولار للريال السعودي
```http
GET /exchange-rates/usd-to-sar
```

**Response:**
```json
{
  "rate": 3.75,
  "currency": "SAR",
  "formatted": "1 USD = 3.75 $"
}
```

### APIs إدارية (للأدمن)

#### الحصول على أسعار الصرف الحالية
```http
GET /admin/exchange-rates
Authorization: Bearer <admin_token>
```

#### تحديث أسعار الصرف
```http
POST /admin/exchange-rates/update
Authorization: Bearer <admin_token>
```

**Request:**
```json
{
  "usdToYer": 260,
  "usdToSar": 3.80,
  "notes": "تحديث يومي للأسعار"
}
```

#### تحويل العملة (للاختبار)
```http
POST /admin/exchange-rates/convert
Authorization: Bearer <admin_token>
```

#### الحصول على سعر الدولار للريال اليمني
```http
GET /admin/exchange-rates/usd-to-yer
Authorization: Bearer <admin_token>
```

#### الحصول على سعر الدولار للريال السعودي
```http
GET /admin/exchange-rates/usd-to-sar
Authorization: Bearer <admin_token>
```
