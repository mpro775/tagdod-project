# تدفقات نظام أسعار الصرف (Exchange Rates Flows)

## الملفات المتاحة

### المخططات الرئيسية
- `exchange-rates-overview.mmd` - نظرة عامة على نظام أسعار الصرف
- `exchange-rates-management.mmd` - مخطط تدفق إدارة أسعار الصرف
- `currency-conversion.mmd` - مخطط تدفق تحويل العملات

## شرح التدفقات

### 1. إدارة أسعار الصرف (Exchange Rates Management)
- **تحديث أسعار الصرف:** تحديث أسعار الصرف اليدوي من قبل المديرين
- **حفظ تاريخ التحديثات:** حفظ معلومات التحديث مع بيانات المسؤول
- **أسعار افتراضية:** استخدام أسعار افتراضية في حالة عدم وجود أسعار محدثة
- **إدارة الملاحظات:** إضافة ملاحظات لكل تحديث

### 2. تحويل العملات (Currency Conversion)
- **تحويل بسيط:** تحويل مبلغ من الدولار إلى الريال اليمني أو السعودي
- **تنسيق النتائج:** تنسيق تلقائي للنتائج حسب العملة
- **تحويل فردي:** معالجة طلب تحويل واحد في كل مرة

### 3. إدارة النظام (System Management)
- **مراقبة الأداء:** مراقبة أداء عمليات التحويل
- **إدارة السجلات:** حفظ سجل واحد للأسعار الحالية
- **الحماية من الإفراط:** حماية من الاستخدام المفرط للـ APIs

## المكونات الرئيسية

### 1. إدارة أسعار الصرف (Exchange Rates Management)
- **البيانات الأساسية:**
  - سعر الدولار للريال اليمني (usdToYer)
  - سعر الدولار للريال السعودي (usdToSar)
- **معلومات التحديث:**
  - آخر من قام بالتحديث (lastUpdatedBy)
  - وقت آخر تحديث (lastUpdatedAt)
  - الملاحظات (notes)
- **البيانات التلقائية:**
  - وقت الإنشاء (createdAt)
  - وقت آخر تحديث (updatedAt)

### 2. تحويل العملات (Currency Conversion)
- **التحويل البسيط:**
  - الحصول على سعر الصرف الحالي
  - حساب التحويل الأساسي
  - تقريب النتيجة حسب العملة
  - تنسيق النتيجة للعرض
- **العملات المدعومة:**
  - الدولار الأمريكي (USD) إلى الريال اليمني (YER)
  - الدولار الأمريكي (USD) إلى الريال السعودي (SAR)
- **تنسيق النتائج:**
  - تنسيق الريال اليمني مع الفواصل
  - تنسيق الريال السعودي مع رقمين عشريين

### 3. إدارة النظام (System Management)
- **الأسعار الافتراضية:**
  - إنشاء أسعار افتراضية تلقائياً
  - استخدام الأسعار الافتراضية عند الحاجة
- **إدارة السجلات:**
  - حفظ سجل واحد للأسعار الحالية
  - حذف الأسعار القديمة عند التحديث
- **الحماية والأمان:**
  - حماية من الاستخدام المفرط
  - تسجيل العمليات للمراجعة

## العملات المدعومة

### العملات الأساسية
- **الدولار الأمريكي (USD):** العملة الأساسية للنظام
- **الريال اليمني (YER):** العملة المحلية اليمنية
- **الريال السعودي (SAR):** العملة السعودية

### أزواج العملات المدعومة
- **USD إلى YER:** الدولار الأمريكي إلى الريال اليمني
- **USD إلى SAR:** الدولار الأمريكي إلى الريال السعودي

## مصادر أسعار الصرف

### المصادر اليدوية
- **إدخال يدوي:** إدخال أسعار الصرف يدوياً من قبل المديرين
- **التحقق اليدوي:** التحقق من صحة الأسعار يدوياً
- **التحديث اليدوي:** تحديث الأسعار يدوياً عند الحاجة
- **أسعار افتراضية:** استخدام أسعار افتراضية عند بدء النظام

### المصادر المستقبلية (مخططة)
- **APIs خارجية:** ربط النظام بـ APIs خارجية لأسعار الصرف (مخطط للتطوير المستقبلي)
- **التحديث التلقائي:** تحديث أسعار الصرف تلقائياً (مخطط للتطوير المستقبلي)

## خوارزميات التحويل

### التحويل الأساسي
```typescript
result = amount * exchangeRate
```

### التحويل للريال اليمني
```typescript
// USD إلى YER
yerResult = usdAmount * usdToYerRate
formattedResult = Math.round(yerResult).toLocaleString() + " ر.ي"
```

### التحويل للريال السعودي
```typescript
// USD إلى SAR
sarResult = usdAmount * usdToSarRate
formattedResult = sarResult.toFixed(2) + " ر.س"
```

### التقريب التلقائي
```typescript
// الريال اليمني - تقريب لأقرب عدد صحيح
yerRounded = Math.round(yerResult)

// الريال السعودي - تقريب لرقمين عشريين
sarRounded = Math.round(sarResult * 100) / 100
```

## قواعد التحقق

### التحقق من صحة البيانات
- **قيمة السعر:** التحقق من أن السعر موجب ورقمي (أكبر من 0.01)
- **المبلغ المراد تحويله:** التحقق من أن المبلغ موجب (أكبر من أو يساوي 0)
- **رموز العملات:** التحقق من دعم العملة المطلوبة (USD إلى YER أو SAR)

### التحقق من دقة التحويل
- **دقة الحساب:** التحقق من دقة العمليات الحسابية الأساسية
- **دقة التقريب:** التحقق من دقة عمليات التقريب حسب العملة
- **دقة النتائج:** التحقق من دقة النتائج النهائية والتنسيق

### التحقق من صحة المدخلات
- **تحديث الأسعار:** التحقق من صحة أسعار USD إلى YER و USD إلى SAR
- **الملاحظات:** التحقق من صحة الملاحظات (اختياري)

## الميزات المتقدمة (مخططة)

### 1. الذكاء الاصطناعي (مستقبلي)
- **التنبؤ بالأسعار:** التنبؤ بأسعار الصرف المستقبلية
- **تحليل الاتجاهات:** تحليل اتجاهات أسعار الصرف

### 2. الأتمتة المتقدمة (مستقبلي)
- **أتمتة التحديث:** تحديث تلقائي لأسعار الصرف من APIs خارجية
- **أتمتة التحقق:** تحقق تلقائي من دقة الأسعار
- **أتمتة الإشعارات:** إشعارات تلقائية عند التغيير

### 3. التحليلات المتقدمة (مستقبلي)
- **تحليل الأداء:** تحليل أداء نظام أسعار الصرف
- **تحليل الدقة:** تحليل دقة أسعار الصرف

### 4. الأمان والامتثال
- **أمان البيانات:** حماية بيانات أسعار الصرف
- **الحماية من الإفراط:** حماية من الاستخدام المفرط للـ APIs
- **تسجيل العمليات:** تسجيل شامل لجميع العمليات

## التكامل مع الأنظمة الأخرى

### تكامل مع نظام المنتجات
- **تحويل أسعار المنتجات:** تحويل أسعار المنتجات من الدولار إلى العملات المحلية
- **عرض الأسعار:** عرض أسعار المنتجات بالعملة المفضلة للمستخدم

### تكامل مع نظام الطلبات
- **حساب إجماليات الطلبات:** تحويل إجماليات الطلبات بين العملات
- **تطبيق الخصومات:** تحويل قيم الخصومات حسب العملة

### تكامل مع نظام التسويق
- **تحويل أسعار التسويق:** تحويل أسعار العروض والتسويقات

### تكامل مع نظام التقارير
- **بيانات موحدة:** استخدام أسعار صرف موحدة في جميع التقارير

## نقاط مهمة
- **نظام بسيط وفعال:** إدارة مباشرة لأسعار الصرف الأساسية
- **تحويل دقيق:** تحويل دقيق بين الدولار والعملات المحلية
- **تحديث يدوي:** تحديث الأسعار يدوياً من قبل المديرين
- **أمان عالي:** حماية من الاستخدام المفرط وتسجيل العمليات
- **قابلية التوسع:** أساس قوي للتطوير المستقبلي
- **سهولة الصيانة:** صيانة مباشرة وبسيطة

## APIs المتاحة

### APIs عامة (للعملاء)

#### الحصول على أسعار الصرف الحالية
```http
GET /exchange-rates
```

**Response:**
```json
{
  "usdToYer": 250,
  "usdToSar": 3.75,
  "lastUpdated": "2024-01-15T10:30:00Z"
}
```

#### تحويل العملة
```http
POST /exchange-rates/convert
```

**Request:**
```json
{
  "amount": 100,
  "fromCurrency": "USD",
  "toCurrency": "YER"
}
```

**Response:**
```json
{
  "fromCurrency": "USD",
  "toCurrency": "YER",
  "amount": 100,
  "rate": 250,
  "result": 25000,
  "formatted": "25,000 ر.ي"
}
```

#### الحصول على سعر الدولار للريال اليمني
```http
GET /exchange-rates/usd-to-yer
```

**Response:**
```json
{
  "rate": 250,
  "currency": "YER",
  "formatted": "1 USD = 250 ر.ي"
}
```

#### الحصول على سعر الدولار للريال السعودي
```http
GET /exchange-rates/usd-to-sar
```

**Response:**
```json
{
  "rate": 3.75,
  "currency": "SAR",
  "formatted": "1 USD = 3.75 ر.س"
}
```

### APIs إدارية (للأدمن)

#### الحصول على أسعار الصرف الحالية
```http
GET /admin/exchange-rates
Authorization: Bearer <admin_token>
```

#### تحديث أسعار الصرف
```http
POST /admin/exchange-rates/update
Authorization: Bearer <admin_token>
```

**Request:**
```json
{
  "usdToYer": 260,
  "usdToSar": 3.80,
  "notes": "تحديث يومي للأسعار"
}
```

#### تحويل العملة (للاختبار)
```http
POST /admin/exchange-rates/convert
Authorization: Bearer <admin_token>
```

#### الحصول على سعر الدولار للريال اليمني
```http
GET /admin/exchange-rates/usd-to-yer
Authorization: Bearer <admin_token>
```

#### الحصول على سعر الدولار للريال السعودي
```http
GET /admin/exchange-rates/usd-to-sar
Authorization: Bearer <admin_token>
```
