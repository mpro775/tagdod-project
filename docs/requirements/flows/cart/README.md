# تدفقات السلة (Cart Flows)

## الملفات المتاحة
- `add-sync.mmd` - مخطط إضافة العناصر ومزامنة السلة
- `abandoned-cart.mmd` - مخطط استرداد السلات المهجورة

## شرح التدفقات

### 1. إدارة السلة الأساسية
- **دعم الزوار:** استخدام deviceId لتتبع السلة
- **دعم المستخدمين:** ربط السلة بـ userId
- **التحقق:** فحص توفر المنتج في المخزون
- **السعة:** حد أقصى 200 عنصر لكل سلة
- **الكمية:** من 1 إلى 999 لكل عنصر

### 2. مزامنة سلة الزائر
- **المشكلة:** الزوار يفقدون السلة عند التسجيل
- **الحل:** دمج سلة deviceId مع سلة userId
- **التنفيذ:** 
  - البحث عن سلة الزائر بالـ deviceId
  - دمج العناصر في سلة المستخدم
  - حذف سلة الزائر القديمة
  - تعيين علامة isMerged و mergedAt

### 3. نظام الكوبونات والعروض
- **الكوبونات اليدوية:** تطبيق كوبونات يدوياً
- **الكوبونات التلقائية:** تطبيق كوبونات تلقائية
- **العروض الترويجية:** تطبيق عروض ترويجية
- **الخصومات التلقائية:** خصومات حسب نوع الحساب

### 4. نظام العملات المتعددة
- **العملات المدعومة:** USD, YER, SAR
- **تحويل الأسعار:** تحويل تلقائي بين العملات
- **تخزين الأسعار:** تخزين الأسعار لكل عملة
- **عرض الأسعار:** عرض الأسعار بالعملة المفضلة

### 5. نظام الخصومات المتقدم
- **خصم التاجر:** خصم الجملة للتجار
- **خصم المهندس:** خصم خاص للمهندسين
- **خصم العملاء:** خصم للعملاء العاديين
- **حساب تلقائي:** حساب الخصومات تلقائياً

### 6. استرداد السلات المهجورة
- **الكشف:** البحث عن السلات غير النشطة لمدة 24 ساعة
- **المرحلة الأولى:** إرسال تذكير أول بعد 24 ساعة
- **المرحلة الثانية:** تذكير مع خصم بعد 48 ساعة
- **المرحلة الأخيرة:** تذكير نهائي بعد 72 ساعة

### 7. تتبع التحويل والتحليلات
- **تتبع التحويل:** ربط السلة بالطلب
- **إحصائيات الهجر:** تتبع معدلات الهجر
- **تحليل السلوك:** تحليل سلوك المستخدمين
- **تحسين التحويل:** تحسين معدلات التحويل

### 8. نظام الـ Metadata والتتبع
- **مصدر الزيارة:** web/mobile/app
- **حملات التسويق:** UTM parameters
- **المرجع:** referrer tracking
- **التحليلات:** تفصيل كامل للزيارات

## API Endpoints المتاحة

### للمستخدمين المسجلين (محمي بـ JWT)
- **GET /cart** - الحصول على السلة
- **POST /cart/items** - إضافة عنصر للسلة
- **PATCH /cart/items/:itemId** - تحديث كمية العنصر
- **DELETE /cart/items/:itemId** - حذف عنصر من السلة
- **POST /cart/clear** - مسح السلة بالكامل
- **POST /cart/preview** - معاينة السلة مع الأسعار
- **POST /cart/coupons/apply** - تطبيق كوبون
- **DELETE /cart/coupons/remove** - إزالة كوبون

### للزوار (غير محمي)
- **GET /cart/guest** - الحصول على سلة الزائر
- **POST /cart/guest/items** - إضافة عنصر لسلة الزائر
- **PATCH /cart/guest/items/:itemId** - تحديث كمية العنصر
- **DELETE /cart/guest/items/:itemId** - حذف عنصر من السلة
- **POST /cart/guest/clear** - مسح سلة الزائر
- **POST /cart/guest/preview** - معاينة سلة الزائر
- **POST /cart/guest/coupons/apply** - تطبيق كوبون لسلة الزائر

### للمديرين (محمي بـ Admin Guard)
- **GET /cart/admin/abandoned** - الحصول على السلات المهجورة
- **POST /cart/admin/abandoned/send-reminder** - إرسال تذكير للسلات المهجورة
- **GET /cart/admin/analytics** - إحصائيات السلة

## هيكل البيانات

### حقول السلة الأساسية
- `userId`: معرف المستخدم (ObjectId) - اختياري للزوار
- `deviceId`: معرف الجهاز (string) - للزوار
- `status`: حالة السلة (active/abandoned/converted/expired)
- `items`: عناصر السلة (array)
- `currency`: العملة المفضلة (YER/USD/SAR)
- `accountType`: نوع الحساب (retail/wholesale/engineer)

### حقول الكوبونات والعروض
- `appliedCouponCode`: الكوبون المطبق (string)
- `couponDiscount`: خصم الكوبون (number)
- `autoAppliedCouponCodes`: كوبونات مطبقة تلقائياً (array)
- `autoAppliedDiscounts`: خصومات مطبقة تلقائياً (array)

### حقول الأسعار المحسوبة
- `pricingSummary`: ملخص الأسعار (object)
  - `subtotal`: المجموع الفرعي
  - `promotionDiscount`: خصم العروض
  - `couponDiscount`: خصم الكوبونات
  - `autoDiscount`: الخصم التلقائي
  - `totalDiscount`: إجمالي الخصم
  - `total`: المجموع النهائي
  - `itemsCount`: عدد العناصر
  - `currency`: العملة
  - `lastCalculatedAt`: آخر حساب

### حقول تتبع الهجر
- `lastActivityAt`: آخر نشاط (Date)
- `isAbandoned`: هل السلة مهجورة (boolean)
- `abandonmentEmailsSent`: عدد رسائل التذكير المرسلة (number)
- `lastAbandonmentEmailAt`: آخر تذكير مرسل (Date)

### حقول التحويل
- `convertedToOrderId`: معرف الطلب المحول إليه (ObjectId)
- `convertedAt`: تاريخ التحويل (Date)

### حقول دمج الزوار
- `isMerged`: هل تم دمج السلة (boolean)
- `mergedIntoUserId`: معرف المستخدم المدمج إليه (ObjectId)
- `mergedAt`: تاريخ الدمج (Date)

### حقول الـ Metadata
- `metadata`: بيانات إضافية (object)
  - `source`: مصدر الزيارة (web/mobile/app)
  - `campaign`: الحملة التسويقية
  - `referrer`: المرجع
  - `utmSource`: مصدر UTM
  - `utmMedium`: وسيلة UTM
  - `utmCampaign`: حملة UTM

### حقول انتهاء الصلاحية
- `expiresAt`: تاريخ انتهاء الصلاحية (Date)

## نقاط مهمة
- **سعة السلة:** حد أقصى 200 عنصر لكل سلة
- **الكمية:** من 1 إلى 999 لكل عنصر
- **العملات:** دعم USD, YER, SAR مع تحويل تلقائي
- **الكوبونات:** دعم كوبونات يدوية وتلقائية
- **الخصومات:** خصومات حسب نوع الحساب (تاجر/مهندس/عميل)
- **تتبع الهجر:** نظام متقدم لتتبع السلات المهجورة
- **التحويل:** ربط السلة بالطلب عند التحويل
- **التحليلات:** تتبع شامل للسلوك والإحصائيات
- **الـ Metadata:** تتبع مصدر الزيارة والحملات
- **انتهاء الصلاحية:** نظام انتهاء صلاحية للسلات
- **الدمج:** دمج سلس بين زوار ومستخدمين
- **الأداء:** فهرسة محسنة للاستعلامات السريعة