%% Cart: Coupons & Promotions System
%% View at https://mermaid.live
flowchart TD
  A[User applies coupon/promotion] --> B{Type of discount?}
  B -->|Manual Coupon| C[Enter coupon code]
  B -->|Auto Coupon| D[System applies auto coupon]
  B -->|Promotion| E[System applies promotion rule]
  
  %% Manual Coupon Flow (Multiple Coupons Support)
  C --> F[Validate coupon code]
  F --> G{Coupon valid?}
  G -->|No| H[Error: Invalid coupon]
  G -->|Yes| I[Check if coupon already applied]
  I --> J{Already applied?}
  J -->|Yes| K[Error: Coupon already applied]
  J -->|No| L[Check coupon conditions]
  L --> M{Conditions met?}
  M -->|No| N[Error: Conditions not met]
  M -->|Yes| O[Add coupon to appliedCouponCodes array]
  O --> P[Calculate cumulative discount]
  P --> Q[Apply discount on remaining subtotal]
  
  %% Auto Coupon Flow
  D --> M[Check cart value]
  M --> N[Check user type]
  N --> O[Find applicable auto coupons]
  O --> P{Any auto coupons?}
  P -->|No| Q[No auto discount applied]
  P -->|Yes| R[Apply best auto coupon]
  
  %% Promotion Flow
  E --> S[Check promotion rules]
  S --> T[Match cart items to rules]
  T --> U{Rules match?}
  U -->|No| V[No promotion applied]
  U -->|Yes| W[Apply promotion discount]
  
  %% Discount Application (Cumulative)
  Q --> X[Calculate discount on remaining amount]
  R --> X
  W --> X
  X --> Y[Sum all discounts (items + coupons + auto)]
  Y --> Z[Update cart pricing summary]
  Z --> AA[Store applied coupons details]
  AA --> AB[Update totalDiscount]
  AB --> AC[Recalculate final total]
  AC --> AD[Save cart with all discounts]
  AD --> AE[Return updated cart with breakdown]
  
  %% Error Handling
  H --> DD[Return error response]
  K --> DD
  N --> DD
  Q --> EE[Continue without discount]
  V --> EE
  
  %% End Points
  AE --> FF[End: Cart with multiple coupons]
  DD --> FF
  EE --> FF
