## موديول الكوبونات (Coupons Module)

### ما الهدف؟
- **الغرض**: إدارة كوبونات الخصم (إنشاء/تحديث/تفعيل/تعطيل/حذف) والتحقق من صلاحيتها وتطبيقها ضمن التسعير والدفع.
- **النطاق**: واجهات إدارية لإدارة الكوبونات، وواجهات عامة للتحقق من الكوبون واستعراض تفاصيله الأساسية.
- **المكان**: `backend/src/modules/coupons/`.

### المكونات
- **CouponsModule**: يهيئ مخططات الكوبونات ويعلن الكنترولرز والخدمة.
- **CouponsService**: منطق الأعمال لإدارة الكوبونات، صلاحية التاريخ، حدود الاستخدام، أنواع الخصومات.
- **CouponsAdminController**: واجهات الأدمن لإدارة الكوبونات.
- **CouponsPublicController**: واجهات عامة للتحقق من الكوبون وعرضه للمستخدمين.

### ما الذي يدعمه الكوبون؟
- **أنواع التأثير**: `percentOff` (نسبة خصم)، `amountOff` (مبلغ ثابت)، وربما `specialPrice` عند الربط بقواعد التسعير.
- **المدى الزمني**: `startAt` و`endAt` لتحديد فترة الصلاحية.
- **القيود**: حدود استخدام إجمالي `maxUses`، وإمكانية تتبّع `currentUses`، ودعم حدود لكل مستخدم إن كانت متاحة في الخدمة.
- **الحالة**: `active` للتفعيل/التعطيل.

### نقاط الدخول (Endpoints)
- إداري (يتطلب صلاحيات):
  - `POST /admin/coupons` إنشاء كوبون.
  - `PATCH /admin/coupons/:id` تحديث كوبون.
  - `GET /admin/coupons` استعراض الكوبونات مع ترقيم صفحات/فلترة (إن وُجد).
  - `GET /admin/coupons/:id` تفاصيل كوبون.
  - `POST /admin/coupons/:id/toggle` تفعيل/تعطيل.
  - `DELETE /admin/coupons/:id` حذف.

- عام:
  - `GET /coupons/:code/validate` أو `GET /coupons/:code` للتحقق من الصلاحية وإرجاع رسالة مناسبة.

ملاحظة: قد تتباين المسارات بدقة حسب التطبيق لديك (`coupons.public.controller.ts` و`coupons.admin.controller.ts`).

### سيناريوهات الاستخدام
- **إنشاء كوبون لحملة محددة زمنياً**:
  - أنشئ كوبونًا مع `startAt` و`endAt` وحدد التأثير (مثل 20% خصم)، وفعّله.
  - شارك كود الكوبون عبر بنر/حملة تسويقية.

- **التحقق أثناء الدفع**:
  - عند إدخال المستخدم للكوبون، استدعِ واجهة التحقق العامة.
  - إن كان صالحًا وغير منتهي ومتاحًا ضمن الحدود، اعرض الخصم المقدر ومرر الكوبون إلى عملية التسعير/الدفع.

### التكامل مع التسعير والعروض
- يمكن استخدام الكوبون كمدخل في موديول التسعير `PricingService` لتصفية القواعد أو تطبيق خصم مباشر.
- عند إتمام الطلب، ينبغي تحديث إحصائيات الكوبون (عدد الاستخدامات، الإيراد، التوفير) إن كانت الخدمة تدعم ذلك.

### أمثلة سريعة
- إنشاء كوبون (أدمن):
```json
POST /admin/coupons
{
  "code": "WELCOME20",
  "active": true,
  "startAt": "2025-01-01T00:00:00Z",
  "endAt": "2025-12-31T23:59:59Z",
  "effects": { "percentOff": 20 },
  "usageLimits": { "maxUses": 1000 }
}
```

- تفعيل/تعطيل:
```http
POST /admin/coupons/:id/toggle
```

- تحقق عام:
```http
GET /coupons/WELCOME20/validate
```

### قواعد عمل مقترحة
- رفض الكوبون إن كان:
  - غير موجود أو غير مفعّل.
  - قبل `startAt` أو بعد `endAt`.
  - وصل إلى `maxUses` (أو لكل مستخدم إن كان مدعومًا).
- تطبيق التأثيرات وفق ترتيب: `specialPrice` ثم `percentOff` ثم `amountOff` (حسب سياسة مشروعك).

### ملاحظات
- يُفضّل ربط الكوبونات ولوائح الاستخدام مع نظام التقارير لمتابعة الأداء.
- إن كانت الكوبونات جزءًا من Price Rules (Promotions)، حافظ على تناسق المنطق بين الموديولين.


