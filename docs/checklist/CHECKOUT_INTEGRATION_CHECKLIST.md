# ✅ Checkout Module Integration Checklist

> قائمة تحقق عملية لضمان تكامل نظام الطلبات والدفع مع تطبيق المستخدمين، المهندسين، والتجار من دون التطرق للمسارات أو الصلاحيات الإدارية.

## كيفية الاستخدام
- اتبع عناصر القائمة أثناء تشغيل اختبارات التكامل في بيئة مطابقة للإنتاج قدر الإمكان.
- حدّث خانة الملاحظات بعد كل قسم لتوثيق النتائج أو الأعطال.
- استخدم بيانات واقعية (سلة، عناوين، طرق دفع، مخزون) لضمان دقة النتائج.

---

## 1. التحضير العام
- [ ] تفعيل واعتماد وحدات `Cart`, `Addresses`, `Products`, `Payments`, `Inventory` في بيئة الاختبار.
- [ ] إعداد حسابات اختبار لأدوار `User`, `Engineer`, `Merchant` مع صلاحياتهم وقدراتهم الصحيحة.
- [ ] تجهيز بيانات سلة متنوّعة (عناصر بعملات ونوع حساب مختلف، كوبونات، خصومات).
- [ ] التأكد من توفر عناوين مستخدمين نشطة وصحيحة بما في ذلك الإحداثيات (للطلبات الفعلية).
- [ ] ضبط خدمات الدفع (Mock أو حقيقية) لإرجاع حالات نجاح/فشل متعددة.
- [ ] مراقبة السجلات (Logs/APM) والرسائل الصادرة عن `OrderService` أثناء الاختبارات.

ملاحظات:

---

## 2. نظرة عامة على المسارات (غير الإدارية)

| الفئة | المسار | الوصف | يتطلب JWT | ملاحظات |
|-------|--------|--------|------------|---------|
| Checkout | `POST /orders/checkout/preview` | معاينة الطلب قبل التأكيد | نعم | يعتمد على محتويات السلة والعنوان |
| Checkout | `POST /orders/checkout/confirm` | إنشاء الطلب وتحويل السلة | نعم | يحجز المخزون ويصدر الطلب |
| الطلبات | `GET /orders` | قائمة الطلبات للمستخدم | نعم | يدعم التصفية حسب الحالة |
| الطلبات | `GET /orders/recent` | أحدث الطلبات | نعم | يستخدم لعرض سريع في الواجهة |
| الطلبات | `GET /orders/:id` | تفاصيل الطلب | نعم | يشمل العناصر والعنوان والدفع |
| التتبع | `GET /orders/:id/track` | تتبع الحالة الحالية | نعم | يعرض الخط الزمني للحالات |
| التحديث | `POST /orders/:id/cancel` | إلغاء الطلب | نعم | يخضع لقواعد الحالة |
| التقييم | `POST /orders/:id/rate` | تقييم الطلب بعد التسليم | نعم | يقبل البيانات بعد حالة `DELIVERED` |
| الملاحظات | `POST /orders/:id/notes` | إضافة ملاحظات العميل | نعم | يربط الرسالة بالطلب |
| الإحصائيات | `GET /orders/stats/summary` | ملخص إحصائيات المستخدم | نعم | عدد الطلبات، المصروفات، إلخ |

> نقاط النهاية الإدارية (`/admin/orders/*`) والـ webhooks خارج نطاق هذه القائمة.

---

## 3. التحقق المشترك (جميع الأدوار)
- [ ] التأكد من رفض جميع المسارات أعلاه بدون JWT أو برمز JWT منتهي.
- [ ] تشغيل `POST /orders/checkout/preview` بسلة صالحة والتأكد من:
  - [ ] حساب الأسعار بعد الضرائب/الخصومات.
  - [ ] التحقق من المخزون المتاح.
  - [ ] التحقق من أن العنوان صالح ومملوك للمستخدم.
- [ ] التحقق من أن `POST /orders/checkout/confirm`:
  - [ ] يحجز المخزون (`reservation`) أو يقلل منه.
  - [ ] ينشئ سجل الطلب بالحالة `CONFIRMED` أو `PENDING_PAYMENT` حسب طريقة الدفع.
  - [ ] يحدّث `Cart` إلى حالة `converted`.
- [ ] مراقبة أن State Machine تمنع الانتقالات غير المسموح بها (مثل تأكيد طلب ملغي).
- [ ] التأكد من أن جميع الاستجابات تتبع البنية `{ success?, message?, data }`.
- [ ] التحقق من أن السجلات تحتوي على `orderId`, `userId`, `status` لكل انتقال حالة.

ملاحظات:

---

## 4. المستخدمون النهائيون (Users)
- [ ] تنفيذ سيناريو Checkout كامل:
  - [ ] معاينة السلة.
  - [ ] تأكيد الطلب باستخدام `COD`.
  - [ ] التأكد من أن الطلب يصل إلى حالة `CONFIRMED`.
- [ ] تجربة دفع إلكتروني (Mock):
  - [ ] عند نجاح الدفع → حالة `PAID` مع انتقال الطلب إلى `PROCESSING`.
  - [ ] عند فشل الدفع → حالة `PAYMENT_FAILED` مع بقاء الحجز حتى انتهاء TTL أو الإلغاء اليدوي.
- [ ] التحقق من أن `GET /orders` يعرض الطلب الجديد مع ملخص الأسعار.
- [ ] زيارة `GET /orders/:id` للتأكد من ظهور:
  - [ ] عناصر الطلب (لقطات المنتجات).
  - [ ] عنوان التوصيل بالتفاصيل الكاملة.
  - [ ] حالة الطلب والدفع والشحن.
- [ ] تجربة `POST /orders/:id/cancel`:
  - [ ] النجاح في حالة `PENDING_PAYMENT` أو `CONFIRMED` وفق قواعد النظام.
  - [ ] التأكد من إعادة المخزون عند الإلغاء.
- [ ] بعد وضع الحالة `DELIVERED` (يدوياً أو عبر أدوات المطور) جرّب `POST /orders/:id/rate`.

ملاحظات:

---

## 5. المهندسون (Engineers)
- [ ] تنفيذ نفس سيناريوهات المستخدم مع حساب يتمتع بقدرات مهندس:
  - [ ] التأكد من أن الأسعار تعكس خصومات المهندس (إن وجدت) في `preview`.
  - [ ] التأكد من أن الطلب النهائي يحتفظ بالقيم المناسبة للمهندس (`accountType`, `pricing`).
- [ ] تجربة طلب خدمة يتطلب مهندس (إن كانت الوحدة مرتبطة بالـ checkout):
  - [ ] التأكد من حفظ المرجع إلى طلب الخدمة داخل الطلب أو العكس حسب التصميم.
- [ ] التأكد من أن المهندس يستطيع إلغاء الطلب ضمن الحدود المسموحة، وأن حالة المخزون تتجهز حسب التوقعات.
- [ ] مراجعة السجلات للتأكد من تعقب `capabilities` أو `accountType` أثناء إنشاء الطلب.

ملاحظات:

---

## 6. التجار (Merchants)
- [ ] تنفيذ Checkout لحساب تاجر (wholesale):
  - [ ] التأكد من أن `preview` يعرض الأسعار بالجملة مع أي خصومات مرتبطة.
  - [ ] التأكد من أن `confirm` يحفظ نوع الحساب والخصومات في الطلب النهائي.
- [ ] التحقق من أن التحليلات في `GET /orders/stats/summary` تعكس طلبات التاجر بشكل منفصل (إن كانت هناك حقول خاصة).
- [ ] تجربة سيناريو إلغاء بعد التأكيد والتأكد من إعادة المخزون وتحديث إحصاءات المبيعات بالجملة.
- [ ] التأكد من أن ملاحظات التاجر (`POST /orders/:id/notes`) تظهر في واجهاتهم لاحقاً.

ملاحظات:

---

## 7. تكامل المخزون والحجز
- [ ] التأكد من أن تأكيد الطلب ينشئ سجلات في `inventory.schema` أو `reservation.schema`.
- [ ] اختبار سيناريو `RESERVATION_TTL_SECONDS` منتهي (انتظار انتهاء الصلاحية) والتأكد من تحرير المخزون تلقائياً.
- [ ] التحقق من أن التحويل إلى حالة `CANCELLED` أو `PAYMENT_FAILED` يعيد المخزون فوراً.
- [ ] مراقبة أن `inventory-ledger` يتم تحديثه لكل عملية خصم أو إعادة.

ملاحظات:

---

## 8. تكامل السلة والعناوين
- [ ] التأكد من استخدام `cartId` الصحيح في كل من `preview` و`confirm`.
- [ ] التحقق من أن السلة تتحول إلى `converted` وأن `usageCount` للعناوين يتم تحديثه بعد النجاح.
- [ ] اختبار سيناريو عنوان محذوف بعد المعاينة وقبل التأكيد للتأكد من معالجة الخطأ بشكل صحيح.
- [ ] التأكد من أن بيانات العنوان المخزنة في الطلب هي نسخة ثابتة (snapshot) مستقلة عن تغييرات المستخدم المستقبلية.

ملاحظات:

---

## 9. التتبع والإشعارات
- [ ] مراقبة أن `GET /orders/:id/track` يعرض تسلسل الحالات بالترتيب الصحيح.
- [ ] التأكد من إرسال أو تسجيل الإشعارات (حسب البيئة) عند الانتقال للحالات الرئيسية (`CONFIRMED`, `SHIPPED`, `DELIVERED`).
- [ ] اختبار إضافة ملاحظة (`POST /orders/:id/notes`) والتأكد من ظهورها في القنوات المناسبة (Email/SMS/لوحة التحكم).
- [ ] التأكد من أن أي نظام إشعارات خارجي (Webhooks أو Queue) لا يتداخل مع القائمة الحالية (خارج النطاق الإداري).

ملاحظات:

---

## 10. الاستقرار والمراقبة
- [ ] مراجعة السجلات لكل تغيير حالة والتأكد من وجود `performedBy` أو بيانات السياق.
- [ ] إعداد تنبيهات لأخطاء الدفع المتكررة أو معدلات إلغاء مرتفعة.
- [ ] تنفيذ اختبار تحميل خفيف على `preview` و`confirm` للتأكد من قدرة النظام على معالجة عدة طلبات متزامنة.
- [ ] مراجعة جداول قاعدة البيانات للتأكد من عدم وجود سجلات يتيمة (`orphaned` carts/reservations).
- [ ] مراقبة زمن استجابة واجهة `confirm` للتأكد من بقائها ضمن الحدود المقبولة.

ملاحظات:

---

## 11. متطلبات ما بعد التشغيل
- [ ] تحديث وثائق فرق الواجهة الأمامية حول الحقول المطلوبة في `checkout` ونماذج التتبع.
- [ ] مشاركة نتائج الاختبارات مع فرق الدعم للتعامل مع سيناريوهات فشل الدفع أو الإلغاء.
- [ ] جدولة مراجعة دورية (شهرية/ربع سنوية) لتدفقات Checkout بعد أي تغييرات على وحدات الدفع أو المخزون.
- [ ] توثيق أي حلول مؤقتة أو استثناءات تم استخدامها أثناء الاختبارات.

ملاحظات:

---

**عند إتمام جميع العناصر أعلاه يمكن اعتماد تكامل وحدة Checkout لجميع الأدوار بثقة.**

