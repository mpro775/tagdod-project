# ✅ Cart Module Integration Checklist

> قائمة تحقق عملية لتجربة تكامل سلال التسوق للمستخدمين والضيوف والمهندسين والتجار، دون التطرق إلى المسارات أو الصلاحيات الإدارية.

## كيفية الاستخدام
- فعّل العناصر بعد إتمام كل اختبار بنجاح وسجّل أي أعطال أو اختلافات.
- نفّذ الاختبارات في بيئة قريبة من الإنتاج مع بيانات منتجات وأسعار حقيقية.
- شارك النتائج مع فرق المنتجات والدعم للتأكد من تغطية السيناريوهات الحرجة.

---

## 1. التحضير العام
- [ ] تجهيز بيانات منتجات حقيقية أو Mock تحتوي على `variantId`، `productId`، أسعار متعددة العملات، وحالات مخزون.
- [ ] إنشاء حسابات اختبار لأدوار `User`, `Engineer`, `Merchant` وتحديد قدراتهم (retail/wholesale/engineer).
- [ ] تجهيز `deviceId` فريد لكل اختبار سلة ضيف.
- [ ] التأكد من تفعيل `CartModule` وكافة الاعتماديات (Products, Pricing, Coupons, Capabilities).
- [ ] التأكد من أن خدمات المزامنة (مثل `CartCronService`) معطلة أو مهيأة حسب البيئة لتجنّب حذف بيانات الاختبار.
- [ ] تفعيل مراقبة السجلات والتنبيهات أثناء التجارب لملاحظة أي أخطاء.

ملاحظات:

---

## 2. نظرة عامة على المسارات (غير الإدارية)

| الفئة | المسار | الوصف | يتطلب JWT | ملاحظات |
|-------|--------|--------|------------|---------|
| سلة المستخدم | `GET /cart` | جلب أو إنشاء سلة المستخدم الحالية | نعم | يعيد سلة كاملة مع الملخص |
| سلة المستخدم | `POST /cart/items` | إضافة عنصر (`productId` أو `variantId`) | نعم | يحدّث التسعير فوراً |
| سلة المستخدم | `PATCH /cart/items/:itemId` | تحديث الكمية | نعم | يتحقق من الحد الأدنى/الأقصى |
| سلة المستخدم | `DELETE /cart/items/:itemId` | إزالة عنصر | نعم | يعيد السلة المحدّثة |
| سلة المستخدم | `POST /cart/clear` | مسح جميع العناصر | نعم | يصفّر السلة ويعيد ملخصاً فارغاً |
| سلة المستخدم | `PATCH /cart/settings` | تحديث العملة أو نوع الحساب | نعم | يعيد التسعير بالعملة الجديدة |
| سلة المستخدم | `POST /cart/apply-coupon` | تطبيق كوبون | نعم | يتحقق من صلاحية الكوبون | 
| سلة المستخدم | `POST /cart/remove-coupon` | إزالة كوبون | نعم | يعيد ملخص التسعير بعد الإزالة |
| سلة المستخدم | `POST /cart/preview` | معاينة التسعير دون تعديل السلة | نعم | يستخدم نفس منطق `calculatePricing` |
| الدمج | `POST /cart/merge` | دمج سلة الضيف مع حساب المستخدم | نعم | يحتاج `deviceId` صالح |
| سلة الضيف | `GET /cart/guest` | جلب سلة الضيف | لا | يعتمد فقط على `deviceId` في الترويسة أو الجسم |
| سلة الضيف | `POST /cart/guest/items` | إضافة عنصر | لا | ينشئ سلة جديدة إذا لم يكن هناك واحدة |
| سلة الضيف | `PATCH /cart/guest/items/:itemId` | تحديث كمية عنصر | لا | يتحقق من حدود الكمية |
| سلة الضيف | `DELETE /cart/guest/items/:itemId` | حذف عنصر | لا | يعيد السلة المحدّثة |
| سلة الضيف | `POST /cart/guest/clear` | مسح سلة الضيف | لا | يعيد ملخصاً فارغاً |
| سلة الضيف | `POST /cart/guest/preview` | معاينة تسعير سلة الضيف | لا | يدعم اختيار العملة ونوع الحساب |

> تم استبعاد واجهات `admin/cart/*` والمهام المجدولة من هذه القائمة لأنها عمليات إدارية.

---

## 3. التحقق المشترك (جميع الأدوار)
- [ ] التأكد من أن جميع مسارات المستخدم ترفض الطلبات بدون JWT أو برموز منتهية الصلاحية.
- [ ] اختبار إضافة عنصر بنفس `variantId` مرتين للتأكد من دمج الكميات بشكل صحيح.
- [ ] التأكد من تحديث `pricingSummary` بعد كل عملية (إضافة، حذف، تحديث).
- [ ] التحقق من أن `metadata` (المصدر، الحملات) يتم حفظها عند تمريرها في الطلبات.
- [ ] اختبار تطبيق كوبون غير صالح والتأكد من الحصول على رسالة خطأ واضحة.
- [ ] اختبار تطبيق نفس الكوبون مرتين للتأكد من منع التكرار.
- [ ] التحقق من حفظ `productSnapshot` عند إضافة العناصر وحين تحديث الأسعار.
- [ ] مراقبة السجلات للتأكد من عدم حدوث Exceptions أو استثناءات غير معالجة.

ملاحظات:

---

## 4. المستخدمون النهائيون (Users)
- [ ] تسجيل الدخول كمستخدم تجزئة (retail) وإضافة عناصر متعددة بعملات مختلفة.
- [ ] تحديث `accountType` إلى `engineer` أو `wholesale` (إن كانت القدرة متاحة) والتأكد من تغير الأسعار وفقاً للقدرات.
- [ ] تجربة دمج سلة ضيف موجودة (`POST /cart/merge`) والتحقق من:
  - [ ] دمج العناصر بدون تكرار غير متوقّع.
  - [ ] احترام خيار `clearGuestCart`.
- [ ] التحقق من أن `apply-coupon` يعمل مع كوبون صالح وإعادة حساب الخصومات ضمن `pricingSummary`.
- [ ] تنفيذ تدفق Checkout للتأكد من إرسال `cartId` أو تفاصيل السلة بشكل صحيح للخدمات downstream (مثل الطلبات).
- [ ] اختبار مسح السلة والتأكد من إعادة القيم الافتراضية (itemsCount=0، total=0).
- [ ] التأكد من أن السلة تُحدّث `lastActivityAt` بعد العمليات.

ملاحظات:

---

## 5. المهندسون (Engineers)
- [ ] تسجيل الدخول كمستخدم لديه قدرة مهندس (`engineer_capable=true`).
- [ ] التأكد من أن `accountType` الافتراضي للسلة يصبح `engineer` وتنعكس خصومات المهندس على الأسعار.
- [ ] اختبار تغيير `accountType` يدوياً في `PATCH /cart/settings` والتأكد من عدم إرجاع خطأ.
- [ ] تطبيق كوبونات مخصصة للمهندسين (إن وجدت) والتأكد من قبولها.
- [ ] اختبار معاينة السلة (`POST /cart/preview`) للتحقق من الحسابات مع قدرات المهندس.
- [ ] التأكد من أن دمج سلة الضيف لا يفقد خصومات المهندس بعد التحويل.

ملاحظات:

---

## 6. التجار (Merchants)
- [ ] تسجيل الدخول كمستخدم لديه قدرة تاجر/جملة (`wholesale_capable=true`).
- [ ] التأكد من أن `accountType` يعكس `wholesale` وأن الأسعار تستخدم جداول التسعير الصحيحة.
- [ ] اختبار تطبيق كوبونات أو خصومات خاصة بالتجار والتأكد من منع الكوبونات غير المتوافقة.
- [ ] تنفيذ سيناريو دمج سلة ضيف مع حساب التاجر ومراقبة اختلافات التسعير قبل وبعد الدمج.
- [ ] التأكد من أن مخططات العروض الترويجية تعمل مع نوع الحساب wholesale.
- [ ] ربط السلة بعملية Checkout (B2B أو طلب卸) والتأكد من الحفاظ على `pricingSummary` والخصومات في الطلب النهائي.

ملاحظات:

---

## 7. سلال الضيوف (Guest Carts)
- [ ] استخدام `deviceId` ثابت للتأكد من بقاء السلة بين الطلبات.
- [ ] إضافة عناصر متعددة ثم معاينة التسعير والتأكد من دقة الأسعار.
- [ ] اختبار تغيير العملة أثناء معاينة الضيف (`POST /cart/guest/preview`) والتأكد من حساب الأسعار بشكل صحيح.
- [ ] حذف عنصر غير موجود والتأكد من الحصول على استجابة خطأ مناسبة.
- [ ] مسح سلة الضيف والتأكد من حذف جميع العناصر وإعادة إنشاء السلة عند الإضافة مرة أخرى.
- [ ] اختبار دمج السلة مع حساب مستخدم (`POST /cart/merge`) للتأكد من نقل العناصر بالكامل.

ملاحظات:

---

## 8. تكاملات إضافية
- [ ] التحقق من أن `CartService.convertToOrder(cartId)` (عند الاستدعاء من وحدات أخرى) يحافظ على لقطة السلة كاملة.
- [ ] التأكد من أن `checkout` أو `services` تستخدم `CartService.preview` قبل إتمام الطلبات للاستفادة من التسعير المحدث.
- [ ] اختبار سيناريو انتهاء صلاحية السلة (`expiresAt`) والتأكد من أن الوحدات downstream تتعامل مع الحالة بشكل صحيح.
- [ ] التأكد من أن خصومات القدرات (مهندس/تاجر) تنتقل بشكل صحيح إلى الوحدات التي تبني على السلة (مثل الطلبات أو الفوترة).

ملاحظات:

---

## 9. الاستقرار والمراقبة
- [ ] مراجعة السجلات للتأكد من تسجيل كل عملية مهمة (إضافة، تحديث، دمج، تطبيق كوبون) مع تفاصيل كافية مخصصة للدعم.
- [ ] إعداد تنبيهات لارتفاع معدلات أخطاء `422` (أخطاء التحقق من البيانات) أو `429` (الحد من المعدل) في مسارات السلة.
- [ ] مراقبة أداء استعلامات `CartService` تحت أحمال متعددة المستخدمين.
- [ ] التأكد من أن مهمات الـ Cron (إن كانت مفعلة) لا تؤثر على بيانات الاختبار أثناء التجارب.
- [ ] تنفيذ اختبار تحميل خفيف على مسارات الإضافة والتحديث للتأكد من الاستقرار.

ملاحظات:

---

## 10. متطلبات ما بعد التشغيل
- [ ] تحديث توثيق فرق الواجهة الأمامية بخصوص الحقول المطلوبة لكل مسار، خاصة `pricingSummary` و`metadata`.
- [ ] مشاركة نتائج الاختبار مع فرق المبيعات/الدعم للتأكد من تغطية سيناريوهات التاجر والمهندس.
- [ ] جدولة اختبار دوري (شهري/ربع سنوي) لتأكيد سلامة سلوك السلة بعد أي تحديثات تخص الأسعار أو المنتجات.
- [ ] توثيق أي استثناءات أو حلول مؤقتة تم اكتشافها أثناء الاختبارات.

ملاحظات:

---

**عند اكتمال العناصر أعلاه يمكن اعتماد تكامل وحدة السلة لكل من المستخدمين والضيوف والمهندسين والتجار بثقة.**

