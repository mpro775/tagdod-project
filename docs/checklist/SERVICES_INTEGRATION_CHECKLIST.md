# ✅ Services Module Integration Checklist

> قائمة تحقق لتجارب تكامل أوامر طلب المهندسين والعروض داخل تطبيقات المستخدمين، المهندسين، والتجار (إن تطلب العرض)، مع استثناء تام لواجهات الإدارة.

## كيفية الاستخدام
- نفّذ الاختبارات في بيئة قريبة من الإنتاج بحيث تتوفر بيانات مستخدمين، مهندسين، وعناوين صحيحة.
- استخدم الزوايا المختلفة (مستخدم، مهندس، تاجر إن وجد التقاء) للتأكد من التغطية.
- دوّن الملاحظات أو الأعطال في نهاية كل قسم لضمان المتابعة.

---

## 1. التحضير العام
- [ ] التأكد من أن `ServicesModule` مفعّل مع جميع الاعتماديات (`AddressesModule`, `UsersModule`, `NotificationsModule`, `Checkout` إن وُجد).
- [ ] تجهيز بيانات اختبار: عناوين مستخدمين، مهندسين مع مواقع دقيقة، أنواع خدمات مختلفة، وأوقات متاحة.
- [ ] تهيئة حسابات اختبار بأدوار واضحة (`customer`, `engineer`, وربما `merchant` إذا يتداخل).
- [ ] تحديث فهارس GeoJSON (`2dsphere`) والتأكد من عدم وجود مشكلات في قاعدة البيانات.
- [ ] تفعيل مراقبة السجلات لتتبع حساب المسافات، إنشاء العروض، وقبول الطلبات.

ملاحظات:

---

## 2. نظرة عامة على المسارات (غير الإدارية)

| الفئة | المسار | الوصف | يتطلب JWT | ملاحظات |
|-------|--------|--------|------------|---------|
| عملاء | `POST /services/requests` | إنشاء طلب خدمة جديد | نعم | يحتاج `addressId` صالح |
| عملاء | `GET /services/requests/my` | قائمة طلبات العميل | نعم | يدعم التصفية بالحالة |
| عملاء | `GET /services/requests/:id` | تفاصيل طلب | نعم | يشمل عروض المهندسين (إن سمح التصميم) |
| عملاء | `GET /services/requests/:id/offers` | قائمة عروض الطلب | نعم | يعرض السعر، المسافة، الملاحظات |
| عملاء | `POST /services/requests/:id/accept-offer` | قبول عرض مهندس | نعم | يحدّث حالة الطلب |
| عملاء | `POST /services/requests/:id/cancel` | إلغاء الطلب | نعم | يخضع لقواعد الحالة |
| عملاء | `POST /services/requests/:id/rate` | تقييم الخدمة بعد الإكمال | نعم | يستخدم بعد `complete` |
| مهندسون | `GET /services/requests/nearby` | جلب الطلبات القريبة حسب الموقع | نعم | يتطلب `lat`, `lng`, `radiusKm` |
| مهندسون | `POST /services/offers` | تقديم عرض على طلب | نعم | يحسب `distanceKm` تلقائياً |
| مهندسون | `GET /services/offers/my` | قائمة عروض المهندس | نعم | لمتابعة الطلبات النشطة |
| مهندسون | `PATCH /services/offers/:id` | تعديل عرض قبل القبول | نعم | السعر والملاحظات |
| مهندسون | `POST /services/requests/:id/start` | بدء تنفيذ الطلب بعد القبول | نعم | يحدث حالة الطلب والعرض |
| مهندسون | `POST /services/requests/:id/complete` | إنهاء الطلب | نعم | يسمح بالتقييم لاحقاً |

> المسارات الإدارية (`/admin/services/*`) مستبعدة بالكامل.

---

## 3. التحقق المشترك (جميع الأدوار)
- [ ] التأكد من أن الطلب لا يُنشأ إلا بعنوان مملوك للمستخدم (`addressId`).
- [ ] مراقبة حساب المسافة عند تقديم عرض (`distanceKm`) والتأكد من صحته بناءً على المواقع.
- [ ] التحقق من منع مهندس من عرض على طلبه الشخصي أو على طلبات خارج نطاقه.
- [ ] التأكد من أن حالة الطلب تنتقل بشكل صحيح بين `open → pending → in_progress → completed/cancelled`.
- [ ] اختبار معالجة الحالات الحدّية (طلب بدون عروض، عرض واحد، عروض متعددة).
- [ ] مراقبة تحديثات `notifications` أو أي نظام تنبيه بعد الأحداث الرئيسية (إن كانت متكاملة).

ملاحظات:

---

## 4. المستخدمون النهائيون (Customers)
- [ ] إنشاء طلب جديد باستخدام عنوان فعّال والتأكد من ظهور الطلب في `GET /services/requests/my`.
- [ ] التحقق من أن `GET /services/requests/:id` يعرض معلومات الطلب والعروض المرتبطة.
- [ ] قبول عرض من مهندس ومراقبة:
  - [ ] تحديث حالة الطلب إلى `pending` أو ما يقابلها.
  - [ ] ربط العرض المقبول بالطلب.
- [ ] إلغاء طلب قبل وبعد قبول العرض والتأكد من قواعد الحالة (مثلاً، لا يمكن الإلغاء بعد `complete`).
- [ ] استخدام `POST /services/requests/:id/rate` بعد اكتمال الخدمة والتأكد من حفظ التقييم.
- [ ] مراقبة سجلات النظام لاكتشاف أي أخطاء (مثل عدم تحديث المسافة أو التقييم).

ملاحظات:

---

## 5. المهندسون (Engineers)
- [ ] استخدام `GET /services/requests/nearby` بموقع محدد والتأكد من أن النتائج مرتبة حسب المسافة ثم السعر.
- [ ] تقديم عرض على طلب مفتوح والتأكد من أن `distanceKm` محسوب وأن العرض يظهر للعميل.
- [ ] تعديل العرض قبل قبوله (تغيير السعر أو الملاحظة) والتأكد من تحديثه في طلب العميل.
- [ ] بدء طلب (`start`) بعد القبول ثم إكماله (`complete`) ومراجعة حالات الطلب والعرض.
- [ ] التأكد من أن المهندس لا يستطيع بدء/إكمال طلب لم يتم قبول عرضه فيه.
- [ ] التحقق من أن قائمة عروض المهندس (`GET /services/offers/my`) تعكس الحالات المختلفة (معلق، مقبول، مرفوض، منتهٍ).

ملاحظات:

---

## 6. التجار (Merchants) *اختياري حسب التكامل*
- [ ] إذا كان التاجر جزءاً من تدفق الخدمات، تأكد من:
  - [ ] إمكانية متابعة طلبات الخدمات المرتبطة بمشاريعهم.
  - [ ] استلام إشعارات أو تحديثات عند تقدم الحالة.
- [ ] التأكد من أن التجار لا يمكنهم عرض أو تعديل عروض المهندسين إلا إذا كان ذلك جزءاً من سيناريو أعمال واضح.

ملاحظات:

---

## 7. التكامل مع الوحدات الأخرى
- [ ] التحقق من أن `AddressesModule` يعمل مع وحدة الخدمات (الاستعلام عن العنوان، التحقق من الملكية).
- [ ] اختبار التكامل مع `NotificationsModule` لإرسال إشعار عند تقديم عرض أو قبول عرض.
- [ ] التأكد من أن `Checkout/Payments` (إن كانت هناك مدفوعات) تتلقى مرجع الطلب بعد القبول أو الإكمال.
- [ ] مراقبة التحديثات في `Analytics` أو `Reporting` لوحدة الخدمات بعد إتمام طلبات اختبارية.

ملاحظات:

---

## 8. الاستقرار والمراقبة
- [ ] مراجعة السجلات للتأكد من عدم وجود أخطاء أثناء حساب Haversine أو تحديث الحالات.
- [ ] مراقبة استهلاك الموارد عند وجود عدد كبير من الطلبات/العروض المتزامنة (اختبار تحميل خفيف).
- [ ] التحقق من أن المهام المجدولة (إن وجدت) لا تقوم بتغيير حالات الطلبات بشكل غير متوقع.
- [ ] إعداد تنبيهات لحالات الفشل (مثل عدم القدرة على إيجاد عروض أو فشل في بدء/إكمال الطلب).

ملاحظات:

---

## 9. متطلبات ما بعد التشغيل
- [ ] تحديث دليل فرق الواجهة حول طريقة عرض الطلبات والعروض والقواعد الشرطية لكل حالة.
- [ ] مشاركة النتائج مع فرق خدمة العملاء لمعرفة حالات القبول، الإلغاء، والتقييمات المتكررة.
- [ ] جدولة مراجعة دورية (مثلاً شهرية) لأداء وحدة الخدمات ومراقبة سلوك المستخدمين والمهندسين.
- [ ] توثيق أي استثناءات أو تغييرات سلوكية ملاحظة أثناء الاختبارات لمرجع مستقبلي.

ملاحظات:

---

**عند اكتمال العناصر أعلاه يمكن اعتماد تكامل وحدة الخدمات بين المستخدمين والمهندسين (والتجار إن وجد تكامل) بثقة.**

