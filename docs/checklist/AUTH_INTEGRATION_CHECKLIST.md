# ✅ Auth Module Integration Checklist

> قائمة تحقق عملية لاختبار تكامل مصادقة OTP / JWT مع التطبيق عبر قنوات المستخدمين والمهندسين والتجار. **لا تشمل هذه القائمة المسارات أو الصلاحيات الإدارية.**

## كيفية الاستخدام
- فعّل كل عنصر عند اجتياز الاختبار بنجاح.
- نفّذ الاختبارات في بيئة تحاكي الإنتاج لضمان صحة النتائج.
- دوّن الملاحظات أو الأخطاء تحت كل قسم لتسهيل المتابعة.

---

## 1. التحضير العام
- [ ] توفير أرقام هواتف اختبارية لكل دور (`User`, `Engineer`, `Merchant`) مع إمكانية استقبال OTP (حقيقي أو Mock).
- [ ] التأكد من تهيئة Redis ووجود القيم البيئية (`REDIS_URL`, `OTP_TTL_SECONDS`, `OTP_LENGTH`, `OTP_DEV_ECHO`).
- [ ] ضبط مفاتيح JWT (`JWT_SECRET`, `REFRESH_SECRET`) وتأكيد صلاحيتها.
- [ ] تفعيل مراقبة السجلات (Logs) والتتبع (APM/Sentry) أثناء التنفيذ.
- [ ] التأكد من إعداد قنوات SMS أو Mock Service لإرسال OTP بنجاح.

ملاحظات:

---

## 2. نظرة عامة على المسارات (غير الإدارية)

| الفئة | المسار | الوصف | يتطلب JWT | ملاحظات |
|-------|--------|--------|------------|---------|
| مصادقة عامة | `POST /auth/send-otp` | إرسال OTP بالاعتماد على الهاتف | لا | يعيد `devCode` إذا كان `OTP_DEV_ECHO=true` |
| مصادقة عامة | `POST /auth/verify-otp` | التحقق من OTP وإصدار رموز JWT | لا | ينشئ حساباً جديداً إذا لم يوجد |
| استعادة كلمة المرور | `POST /auth/forgot-password` | إرسال OTP لسياق استعادة كلمة المرور | لا | يستخدم نفس بنية OTP |
| استعادة كلمة المرور | `POST /auth/reset-password` | التحقق من OTP وتعيين كلمة مرور جديدة | لا | يحتاج رمز صالح من سياق reset |
| إدارة الحساب | `POST /auth/set-password` | تعيين/تحديث كلمة المرور الحالية | نعم | يتطلب Access Token صالح |
| إدارة الحساب | `GET /auth/me` | جلب بيانات الحساب والقدرات | نعم | يستخدم `JwtAuthGuard` |
| إدارة الحساب | `PATCH /auth/me` | تعديل بيانات الملف الشخصي المسموح بها | نعم | يسمح بتحديث الاسم، الجنس، المسمى الوظيفي |
| إدارة الحساب | `PATCH /auth/preferred-currency` | تحديث العملة المفضّلة | نعم | يتحقق من صحة رمز العملة |
| إدارة الحساب | `DELETE /auth/me` | حذف الحساب الحالي | نعم | يحذف المستخدم وقدراته المرتبطة |

> تم استبعاد المسارات الإدارية (`/auth/admin/*`) والعمليات الخاصة بالبيئات التطويرية (`/auth/create-super-admin`, `/auth/dev-login`) من هذه القائمة.

---

## 3. التحقق المشترك (جميع الأدوار)
- [ ] التأكد من أن جميع المسارات ترفض الطلبات بدون أو برمز JWT منتهي الصلاحية.
- [ ] التحقق من أن الـ Payload في Access Token يحتوي `sub`, `phone`, `roles`, `permissions`, `preferredCurrency`.
- [ ] التأكد من أن Refresh Token يتم إصداره في كل عملية `verify-otp`.
- [ ] إعادة استخدام Refresh Token (إن وجد Endpoint لاحق) للتأكد من تجديد Access Token بنجاح.
- [ ] مراقبة أن OTP يتحذف من Redis بعد استخدامه أو انتهاء صلاحيته.
- [ ] اختبار حدود الزمن لـ OTP (`OTP_TTL_SECONDS`) والتأكد من رفض الرموز المنتهية.
- [ ] التأكد من أن جميع الردود تتبع البنية المعيارية `{ success?, message?, data }`.

ملاحظات:

---

## 4. المستخدمون النهائيون (Users)
- [ ] إرسال OTP برقم جديد والتأكد من وصول الرسالة/الرمز.
- [ ] التحقق من OTP صالحة وإنشاء الحساب وإصدار Tokens.
- [ ] التأكد من مزامنة المفضلات إذا تم تمرير `deviceId`.
- [ ] تحديث الملف الشخصي (`PATCH /auth/me`) والتأكد من ظهور التعديلات في `GET /auth/me`.
- [ ] اختبار تعيين كلمة مرور جديدة (`POST /auth/set-password`) ومن ثم تسجيل الدخول باستخدامها (إن وجد Endpoint).
- [ ] تنفيذ تدفق استرجاع كلمة المرور باستخدام `forgot-password` ثم `reset-password`.
- [ ] حذف الحساب (`DELETE /auth/me`) والتأكد من إزالة كل البيانات المرتبطة في قواعد البيانات/القدرات.

ملاحظات:

---

## 5. المهندسون (Engineers)
- [ ] تفعيل خيار طلب قدرة مهندس أثناء `verify-otp` عبر `capabilityRequest='engineer'`.
- [ ] التحقق من ضرورة وجود `jobTitle` وإلا يعاد الخطأ المتوقع.
- [ ] التأكد من أن الحساب يتم إنشاؤه مع حالة قدرة `engineer_status='pending'`.
- [ ] استخدام Access Token لمهندس والتحقق من إمكانية الوصول إلى مسارات الحساب (`/auth/me`, `/auth/me [PATCH]`, إلخ).
- [ ] التأكد من أن بيانات `capabilities` تعكس حالة الانتظار وعدم السماح بامتيازات إضافية قبل الموافقة.
- [ ] اختبار إعادة تقديم الطلب (إن وجد تدفق) والتأكد من تحديث الحالة أو منع الطلب المتكرر.

ملاحظات:

---

## 6. التجار (Merchants)
- [ ] أثناء التحقق من OTP، أرسل `capabilityRequest='merchant'` (أو `wholesale` حسب التسمية) وتأكد من إنشاء الطلب بالحالة `pending`.
- [ ] التحقق من أن حساب التاجر الجديد يملك القدرة الافتراضية `customer_capable=true` بالإضافة إلى طلب التاجر قيد الانتظار.
- [ ] تأكيد إمكانية تحديث الملف الشخصي والعملة المفضلة بنفس القيود المفروضة على المستخدم العادي.
- [ ] التأكد من أن محاولة استخدام امتيازات تاجر (قبل الموافقة) تُمنع وتعيد رسالة واضحة (يعتمد على وحدات أخرى).
- [ ] تجربة تسجيل خروج/دخول متعددة للتاجر والتأكد من استمرارية صلاحية Refresh Token خلال المدة المحددة.

ملاحظات:

---

## 7. الاستقرار والمراقبة
- [ ] مراجعة السجلات للتأكد من توثيق محاولات OTP الفاشلة مع إخفاء البيانات الحساسة.
- [ ] إعداد تنبيهات لعدد محاولات OTP الفاشلة أو الطلبات المرفوضة لأسباب أمنية.
- [ ] تنفيذ اختبار تحميل خفيف على `send-otp` و`verify-otp` للتأكد من قدرة Redis وخدمة الرسائل على التحمل.
- [ ] التأكد من عدم تسجيل رموز JWT أو OTP في السجلات بشكل صريح.
- [ ] مراجعة معدلات انتهاء الجلسات والتأكد من مطابقة سياسات الأمان.

ملاحظات:

---

## 8. متطلبات ما بعد التشغيل
- [ ] تحديث وثائق فرق الواجهة الأمامية حول كيفية التعامل مع حالات انتهاء الصلاحية وإعادة الإرسال.
- [ ] مشاركة نتائج الاختبارات مع فرق تجربة المستخدم والدعم الفني.
- [ ] جدولة مراجعة دورية (شهرية أو ربع سنوية) لمسارات المصادقة بعد أي تحديثات بنية تحتية.
- [ ] توثيق أي استثناءات أو سيناريوهات خاصة تمت ملاحظتها أثناء الاختبارات.

ملاحظات:

---

**عند اكتمال عناصر القائمة أعلاه يمكن اعتماد تكامل وحدة المصادقة لأدوار المستخدمين والمهندسين والتجار بثقة.**

