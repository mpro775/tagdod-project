# ✅ Notifications Module Integration Checklist

> قائمة تحقق عملية للتأكد من تكامل نظام الإشعارات مع تطبيق المستخدمين، المهندسين، والتجار عبر القنوات المختلفة، مع استثناء جميع المسارات والصلاحيات الإدارية.

## كيفية الاستخدام
- نفّذ الاختبارات في بيئة تمكّن من وصل المزودين الحقيقيين (أو Mock مع سجلات واضحة).
- استخدم حسابات متعددة (User, Engineer, Merchant) بالإضافة إلى سيناريوهات الزوار عند الحاجة.
- دوّن الملاحظات أو الأعطال أسفل كل قسم لضمان المتابعة وتحسين النظام.

---

## 1. التحضير العام
- [ ] تفعيل `NotificationsCompleteModule` أو `NotificationsUnifiedModule` في بيئة الاختبار حسب الحاجة.
- [ ] إعداد مزودي القنوات (SMTP, Twilio, FCM) أو تفعيل أوضاع الـ Mock مع التحقق من السجلات.
- [ ] تجهيز حسابات اختبار لأدوار المستخدمين المختلفة، مع التأكد من وجود بيانات اتصال صالحة (Email، رقم هاتف، Device Tokens).
- [ ] التأكد من وجود أحداث نظامية يمكنها إطلاق الإشعارات (طلبات، خدمات، دعم).
- [ ] تفعيل أدوات المراقبة (Logs/APM) لرصد عمليات الإرسال والفشل.

ملاحظات:

---

## 2. نظرة عامة على المسارات (غير الإدارية)

| الفئة | المسار | الوصف | يتطلب JWT | ملاحظات |
|-------|--------|--------|------------|---------|
| مستخدم | `GET /notifications` | جلب قائمة إشعارات المستخدم | نعم | يدعم الت分页/الفلترة حسب الحالة |
| مستخدم | `GET /notifications/unread-count` | عدد الإشعارات غير المقروءة | نعم | يستخدم للعرض السريع في الواجهة |
| مستخدم | `POST /notifications/mark-read` | تعليم مجموعة كمقروءة | نعم | يقبل قائمة معرفات |
| مستخدم | `POST /notifications/mark-all-read` | تعليم جميع الإشعارات كمقروءة | نعم | يعيد العدد المحدث |
| مستخدم | `GET /notifications/stats` | إحصائيات المستخدم حول الإشعارات | نعم | يتضمن قراءات/تفاعلات |

> المسارات الإدارية (`/notifications/admin/*`) مستبعدة تماماً من هذه القائمة.

---

## 3. التحقق المشترك (جميع الأدوار)
- [ ] التأكد من أن جميع المسارات تعيد 401 عند عدم تمرير JWT صالح.
- [ ] اختبار استلام إشعار واحد عبر كل قناة (In-App, Email, SMS, Push) والتأكد من تسجيله في قاعدة البيانات.
- [ ] التحقق من أن حالة الإشعار تنتقل من `unread` إلى `read` عند استخدام `mark-read`.
- [ ] مراقبة السجلات لضمان تسجيل نتائج الإرسال (success/failure) مع تفاصيل المزود.
- [ ] التأكد من أن الإشعارات تحترم تفضيلات المستخدم (عند تفعيلها) ولا تُرسل قنوات معطلة.
- [ ] اختبار التعامل مع أخطاء المزود (SMTP/FCM/Twilio) والتأكد من إعادة المحاولة أو تسجيل الخطأ.

ملاحظات:

---

## 4. المستخدمون النهائيون (Users)
- [ ] تنفيذ حدث نظامي (مثل تأكيد طلب) والتأكد من توليد إشعار مناسب.
- [ ] التحقق من ظهور الإشعار في `GET /notifications` ببيانات كاملة (العنوان، المحتوى، القناة، timestamp).
- [ ] استخدام `GET /notifications/unread-count` قبل وبعد قراءة الإشعار للتأكد من تحديث العدد.
- [ ] تعليم الإشعار كمقروء عبر `POST /notifications/mark-read` ومراقبة التغيير في واجهة المستخدم.
- [ ] التأكد من وصول البريد الإلكتروني أو الرسالة النصية (إذا كانت القناة مفعلة) وتطابقها مع القالب المتوقع.
- [ ] تجربة تعطيل قناة (إن كان هناك إعدادات) والتأكد من توقف الإشعارات عبرها.

ملاحظات:

---

## 5. المهندسون (Engineers)
- [ ] تشغيل حدث مرتبط بخدمات المهندسين (مثل قبول عرض) والتأكد من توليد الإشعار المناسب.
- [ ] التحقق من أن محتوى الإشعار يعكس بيانات المهندس (اسم العميل، تفاصيل الخدمة).
- [ ] التأكد من أن المهندس يمكنه تعليم الإشعار كمقروء والاستفادة من `stats`.
- [ ] اختبار وصول Push Notification إلى جهاز يحمل رمز توكن مهندس (أو تسجيل محاولة في Mock مع بيانات صحيحة).
- [ ] مراجعة السجلات للتأكد من تسجيل القناة المستخدمة (`targetUserTypes` أو تفضيلات المهندس).

ملاحظات:

---

## 6. التجار (Merchants)
- [ ] إطلاق حدث يتعلق بالتاجر (مثل إشعار بعرض أو انخفاض مخزون) والتأكد من استقبال الإشعار.
- [ ] التحقق من أن `GET /notifications` يعرض تفاصيل الحملة أو المنتج المرتبط بالتاجر.
- [ ] التأكد من إمكانية تاجر تعليم الإشعارات كمقروءة وأن `unread-count` يتحدث.
- [ ] اختبار إرسال رسالة SMS للتاجر (إن كانت مطلوبة) ومراقبة نتائج الإرسال.
- [ ] مراقبة إحصائيات الاستخدام للتجار عبر `GET /notifications/stats` (عدد الإشعارات، القراءات).

ملاحظات:

---

## 7. تدفق الزوار (Guest Flow)
- [ ] التأكد من أن المسارات العامة ترفض الطلبات بدون JWT (لا توجد قائمة إشعارات للزوار).
- [ ] اختبار إشعارات البريد أو SMS التي لا تتطلب تسجيل دخول (مثل OTP أو رسائل تسويقية) للتأكد من تسجيلها عبر النظام.
- [ ] مراقبة السجلات للتأكد من تمييز الإشعارات غير المرتبطة بحساب (إن وجدت) بسياق واضح.

ملاحظات:

---

## 8. التكامل مع الوحدات الأخرى
- [ ] التحقق من أن وحدات مثل `Orders`, `Services`, `Cart` تستدعي `notificationsService` عند الأحداث الرئيسية.
- [ ] اختبار قوالب معينة (مثل `CART_ABANDONMENT`, `ORDER_SHIPPED`) والتأكد من تعبئة البيانات الديناميكية بشكل صحيح.
- [ ] التأكد من أن الأحداث المتزامنة (عدة إشعارات لنفس المستخدم) تُدار بكفاءة ولا تُكرر القوالب دون داعٍ.
- [ ] التحقق من تخزين الروابط (`link`, `cta`) ضمن الإشعار وعملها في الواجهة.

ملاحظات:

---

## 9. القنوات المختلفة
- **In-App**
  - [ ] التأكد من ظهور الإشعارات في واجهة المستخدم ضمن قائمة الإشعارات أو الـ bell icon.
  - [ ] مراقبة `viewedAt` أو `readAt` عند فتح الإشعار في الواجهة.
- **Email**
  - [ ] اختبار قالب واحد على الأقل والتأكد من احتواء البريد على النصوص والصور المتوقعة.
  - [ ] مراجعة الرسائل المرتدة (bounce) والتأكد من تسجيلها في السجلات.
- **SMS**
  - [ ] إرسال رسالة اختبارية والتحقق من استخدام الرقم الصحيح والتنسيق المحلي.
  - [ ] التأكد من تسجيل الـ message SID أو معرف المزود في قاعدة البيانات.
- **Push**
  - [ ] إرسال إشعار Push مع بيانات إضافية (`data` payload) والتأكد من استقبالها على الجهاز أو في Mock.
  - [ ] مراقبة فشل الإرسال بسبب رموز توكن منتهية والتأكد من تنظيفها أو تسجيلها.

ملاحظات:

---

## 10. الاستقرار والمراقبة
- [ ] مراجعة السجلات للتأكد من تسجيل كل عملية إرسال مع حالة النجاح أو الفشل والمزود المستخدم.
- [ ] إعداد تنبيهات عند ارتفاع معدل أخطاء الإرسال لأي قناة (مثلاً أكثر من 5% فشل).
- [ ] اختبار معالجة عدد كبير من الإشعارات المتزامنة للتأكد من عدم وجود عنق زجاجة.
- [ ] مراقبة حجم قاعدة البيانات والضمان أن مهام التنظيف (cleanup) تعمل (حتى لو كانت إدارية، راقب تأثيرها).
- [ ] التحقق من بقاء الإشعارات المهمة في النظام وعدم حذفها عن طريق الخطأ في سيناريوهات الـ Soft Delete.

ملاحظات:

---

## 11. متطلبات ما بعد التشغيل
- [ ] تحديث الوثائق الداخلية لفرق الواجهة الأمامية حول كيفية عرض أو إدارة الإشعارات.
- [ ] مشاركة نتائج الاختبارات مع فرق الدعم لضمان قدرتهم على تتبع إشعارات المستخدمين عند طلب المساعدة.
- [ ] جدولة مراجعات دورية (شهرية/ربع سنوية) لتقييم أداء القنوات والتأكد من استمرار عمل المزودين الخارجيين.
- [ ] توثيق أي حالات استثنائية أو حلول مؤقتة ورفعها للفريق الهندسي لمتابعة تحسينها.

ملاحظات:

---

**عند اكتمال جميع العناصر أعلاه يمكن اعتماد تكامل وحدة الإشعارات عبر القنوات المختلفة والأدوار المتنوعة بثقة.**

