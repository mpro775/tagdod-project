# ✅ Favorites Module Integration Checklist

> قائمة تحقق عملية لضمان تكامل نظام المفضلة للمستخدمين والضيوف والمهندسين والتجار، مع التركيز على المسارات العامة فقط دون التطرق للأدمن.

## كيفية الاستخدام
- فعّل العناصر عند إتمام كل اختبار بنجاح.
- استخدم حسابات وأجهزة اختبار مختلفة لتمثيل كل حالة.
- دوّن النتائج أو الأعطال في خانة الملاحظات لكل قسم.

---

## 1. التحضير العام
- [ ] تجهيز بيانات منتجات حقيقية أو Mock مع `productId` و`variantId` صالحين.
- [ ] إعداد `deviceId` فريد لسيناريوهات الزوار (مثلاً من التخزين المحلي للتطبيق).
- [ ] إنشاء حسابات اختبار لأدوار `User`, `Engineer`, `Merchant` مع رموز JWT صالحة.
- [ ] التأكد من تفعيل `FavoritesModule` واعتمادياته (Products, Auth).
- [ ] تفعيل مراقبة السجلات لملاحظة عمليات المزامنة والـ errors أثناء الاختبار.

ملاحظات:

---

## 2. نظرة عامة على المسارات (غير الإدارية)

| الفئة | المسار | الوصف | يتطلب JWT | ملاحظات |
|-------|--------|--------|------------|---------|
| مستخدم | `GET /favorites` | جلب المفضلات للمستخدم | نعم | يدعم populate للمنتجات |
| مستخدم | `POST /favorites` | إضافة منتج للمفضلة | نعم | يقبل `note` اختيارية |
| مستخدم | `DELETE /favorites` | إزالة منتج محدد | نعم | يعتمد على `productId` أو `variantId` |
| مستخدم | `PATCH /favorites/:id` | تحديث ملاحظة المفضلة | نعم | تحديث `note` فقط |
| مستخدم | `POST /favorites/:id/view` | زيادة `viewsCount` | نعم | يعيد القيم الجديدة |
| مستخدم | `DELETE /favorites/clear/all` | حذف كل المفضلات | نعم | Soft delete |
| مستخدم | `GET /favorites/count` | عدد المفضلات | نعم | يستخدم للعرض السريع |
| مستخدم | `POST /favorites/sync` | مزامنة يدوية مع `deviceId` | نعم | تنقل بيانات الزائر للمستخدم |
| زائر | `GET /favorites/guest` | جلب مفضلات الزائر | لا | يعتمد على `deviceId` |
| زائر | `POST /favorites/guest` | إضافة مفضلة للزائر | لا | ينشئ سجلًا جديدًا |
| زائر | `DELETE /favorites/guest` | إزالة مفضلة للزائر | لا | يعتمد على `productId` |
| زائر | `DELETE /favorites/guest/clear` | حذف كل مفضلات الزائر | لا | يمسح السجل بالجهاز |
| زائر | `GET /favorites/guest/count` | عدد مفضلات الزائر | لا | يستخدم لعرض الأيقونة |

> يتم استبعاد المسارات الإدارية (`/admin/favorites/*`) من هذه القائمة.

---

## 3. التحقق المشترك (جميع الأدوار)
- [ ] التأكد من أن مسارات المستخدم ترفض الطلبات بدون JWT أو برمز منتهي.
- [ ] اختبار إضافة نفس المنتج مرتين والتأكد من عدم تكرار السجل (أو تحديث التاريخ فقط حسب السلوك).
- [ ] التحقق من أن `viewsCount` يزداد عند استدعاء `POST /favorites/:id/view`.
- [ ] التأكد من أن كل العمليات تحترم Soft Delete (السجلات تبقى مع `deletedAt`).
- [ ] مراقبة السجلات لمعرفة وقت حدوث `sync` أو `clear`.
- [ ] التحقق من أن الردود تتبع البنية `{ success?, message?, data }`.

ملاحظات:

---

## 4. المستخدمون النهائيون (Users)
- [ ] تسجيل الدخول كمستخدم وإضافة منتج واحد على الأقل للمفضلة.
- [ ] استخدام `GET /favorites` للتحقق من عرض جميع الحقول (product snapshot, note, syncedAt).
- [ ] تحديث الملاحظة عبر `PATCH /favorites/:id` والتأكد من انعكاسها في القائمة.
- [ ] اختبار `DELETE /favorites` لإزالة عنصر واحد والتأكد من عدم التأثير على العناصر الأخرى.
- [ ] تنفيذ `DELETE /favorites/clear/all` والتأكد من مسح السجل ثم إعادة الإضافة.
- [ ] استخدام `GET /favorites/count` بعد الإضافة والحذف للتأكد من دقة العدد.

ملاحظات:

---

## 5. المهندسون (Engineers)
- [ ] تسجيل الدخول بحساب لديه قدرة مهندس.
- [ ] إضافة منتجات مخصصة للمهندسين (إن وجدت) والتأكد من ظهورها في قائمة المفضلات.
- [ ] مراقبة أن قدرات المهندس لا تمنعه من الوصول إلى مسارات المفضلة العادية.
- [ ] اختبار المزامنة اليدوية `POST /favorites/sync` مع `deviceId` يحتوي على منتجات، والتحقق من دمجها بدون تكرار.
- [ ] التأكد من أن السجلات تحتفظ بمعلومات `isSynced` و`syncedAt`.

ملاحظات:

---

## 6. التجار (Merchants)
- [ ] تسجيل الدخول بحساب تاجر والتأكد من استخدام نفس المسارات المتاحة للمستخدم.
- [ ] إضافة منتجات من الكتالوج التجاري ومراقبة ظهورها في `GET /favorites`.
- [ ] التحقق من أن `viewsCount` يتغير عند الاستدعاء (يمكن استخدامه كإحصاء داخلي للتاجر).
- [ ] إعادة استخدام `POST /favorites/sync` إذا كان التاجر يستخدم التطبيق كزائر قبل التسجيل.
- [ ] التأكد من أن حذف المفضلات لا يؤثر على بيانات منتجات التاجر في وحدات أخرى.

ملاحظات:

---

## 7. الزوار (Guest Flow)
- [ ] استخدام `deviceId` ثابت وإضافة منتج عبر `POST /favorites/guest`.
- [ ] استدعاء `GET /favorites/guest` والتأكد من ظهور العناصر.
- [ ] تجربة `DELETE /favorites/guest` لإزالة عنصر محدد والتحقق من بقاء الآخرين.
- [ ] تنفيذ `DELETE /favorites/guest/clear` والتأكد من مسح القائمة بالكامل.
- [ ] استدعاء `GET /favorites/guest/count` بعد كل عملية للتأكد من دقة العدد.
- [ ] مراقبة السجلات للتأكد من عدم إنشاء سجلات مكررة لنفس `deviceId`.

ملاحظات:

---

## 8. المزامنة بين الزائر والمستخدم
- [ ] إضافة عناصر كمستخدم زائر (deviceId).
- [ ] إكمال تسجيل الدخول أو التحقق من OTP مع تمرير `deviceId` لضمان المزامنة التلقائية.
- [ ] بعد تسجيل الدخول، التأكد من أن `GET /favorites` يعرض عناصر الزائر.
- [ ] تجربة المزامنة اليدوية `POST /favorites/sync` للتأكد من دمج البيانات المتبقية (إن وجدت).
- [ ] التحقق من أن الحقول `isSynced` و`syncedAt` يتم تحديثها بعد المزامنة.
- [ ] التأكد من حذف أو تعليم السجلات القديمة للزائر بعد المزامنة (حسب السلوك المتوقع).

ملاحظات:

---

## 9. التكامل مع الوحدات الأخرى
- [ ] التحقق من أن وحدات المنتجات تستخدم الـ populate الصحيح عند جلب المفضلات.
- [ ] التأكد من أن أحداث حذف المنتجات تؤدي إلى تحديث أو إزالة المفضلات المرتبطة (إن كان هناك Hook).
- [ ] التأكد من أن لوحة المستخدم أو واجهات الطلبات تعرض عدد المفضلات المحدث.
- [ ] اختبار أي تدفق يعتمد على المفضلة (مثل توصيات المنتجات) للتأكد من استخدام بيانات دقيقة.

ملاحظات:

---

## 10. الاستقرار والمراقبة
- [ ] مراقبة السجلات لأي أخطاء تحقق (Validation) عند إدخال بيانات ناقصة أو غير صحيحة.
- [ ] إعداد تنبيه لعدد كبير من عمليات `sync` خلال فترة قصيرة (قد تدل على سوء استخدام).
- [ ] تنفيذ اختبار تحميل خفيف على مسارات الإضافة والحذف للتأكد من تحمل النظام.
- [ ] مراجعة قاعدة البيانات للتأكد من استخدام الفهارس بشكل صحيح وعدم وجود سجلات يتيمة.

ملاحظات:

---

## 11. متطلبات ما بعد التشغيل
- [ ] تحديث وثائق الواجهة الأمامية لشرح كيفية التعامل مع `deviceId` والمزامنة.
- [ ] مشاركة نتائج الاختبار مع فرق الدعم لتوضيح كيفية حل مشكلات المزامنة للمستخدمين.
- [ ] جدولة مراجعة دورية لتدفقات المفضلة بعد تحديثات الكتالوج أو نظام الهوية.
- [ ] توثيق أي حلول مؤقتة أو اختلافات عن السلوك المتوقع تم اكتشافها أثناء الاختبارات.

ملاحظات:

---

**عند اكتمال العناصر أعلاه يمكن اعتماد تكامل وحدة المفضلة عبر السيناريوهات المختلفة بثقة.**

