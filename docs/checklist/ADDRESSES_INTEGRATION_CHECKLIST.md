# ✅ Addresses Module Integration Checklist

> قائمة تحقق ميدانية للتأكد من تكامل خدمات العناوين مع التطبيق دون التطرق للمسارات أو الصلاحيات الإدارية.

## كيفية الاستخدام
- استخدم مربعات الاختيار لتوثيق حالة الاختبار.
- نفّذ الاختبارات في بيئة متطابقة للإنتاج قدر الإمكان.
- دوّن أي ملاحظات أو أعطال أسفل كل قسم.

---

## 1. التحضير العام
- [ ] إعداد حسابات اختبار مفعّلة لكل دور (`User`, `Engineer`, `Merchant`) مع رموز JWT صالحة.
- [ ] التأكد من أن `AddressesModule` و `AddressesService` متاحان في بيئة الاختبار.
- [ ] تفعيل أدوات المراقبة (Logs, APM) لمتابعة الأخطاء المحتملة أثناء التجارب.
- [ ] تجهيز بيانات مواقع واقعية (إحداثيات دقيقة) للاستخدام أثناء الاختبار.

ملاحظات:

---

## 2. نظرة عامة على المسارات غير الإدارية

| الفئة | المسار | الوصف | يتطلب JWT | ملاحظات |
|-------|--------|--------|------------|---------|
| مشترك بين جميع الأدوار | `GET /addresses` | جلب كل العناوين (مع خيار `includeDeleted`) | نعم | ترتيب ذكي + يعيد المحذوفة إذا طلبت |
| مشترك | `GET /addresses/active` | جلب العناوين النشطة فقط | نعم | يستبعد المعطّلة أو المحذوفة |
| مشترك | `GET /addresses/default` | جلب العنوان الافتراضي أو يضبطه تلقائياً | نعم | يعيد `null` في حال عدم وجود عناوين |
| مشترك | `GET /addresses/:id` | جلب عنوان محدّد مملوك للمستخدم | نعم | يعيد 404 إذا لم يكن العنوان مملوكاً |
| مشترك | `POST /addresses` | إنشاء عنوان جديد | نعم | العنوان الأول يصبح افتراضياً تلقائياً |
| مشترك | `PATCH /addresses/:id` | تحديث عنوان موجود | نعم | يدعم تعديل الإحداثيات أو جعله افتراضياً |
| مشترك | `DELETE /addresses/:id` | حذف (Soft Delete) | نعم | يمنع حذف العنوان الوحيد |
| مشترك | `POST /addresses/:id/set-default` | تعيين كعنوان افتراضي | نعم | يزيل الافتراضية عن باقي العناوين |
| مشترك | `POST /addresses/:id/restore` | استعادة عنوان محذوف | نعم | يعيد التفعيل ويترك الإحصاءات |
| مشترك | `GET /addresses/validate/:id` | التحقق من الملكية قبل الاستخدام | نعم | يعيد `{ valid: boolean }` |

> لا يوجد حالياً أي مسارات عامة تماماً (بدون JWT) في وحدة العناوين.

---

## 3. التحقق المشترك (جميع الأدوار)
- [ ] التحقق من رفض الطلبات بدون ترويسة `Authorization`.
- [ ] التأكد من أن كلاود جيت واي/البوابة تعيد 401 عند انتهاء صلاحية الرمز.
- [ ] مصادقة أن كل الردود تتبع تنسيق `{ success?, message?, data }` المتفق عليه.
- [ ] مراقبة أن `usageCount` و `lastUsedAt` يتم تحديثهما بعد كل استخدام فعلي.
- [ ] التحقق من عدم إمكانية الوصول إلى عناوين مستخدم آخر (يجب أن تعود 404).

ملاحظات:

---

## 4. المستخدمون النهائيون (Users)
- [ ] إنشاء أول عنوان للمستخدم والتأكد من تعيينه كافتراضي تلقائياً.
- [ ] إنشاء عنوان إضافي والتأكد من إمكانية تغييره ليصبح الافتراضي.
- [ ] اختبار حذف العنوان الافتراضي مع وجود عناوين أخرى (يجب أن يُعاد تعيين افتراضي جديد).
- [ ] التأكد من منع حذف العنوان الوحيد واستلام رسالة خطأ مناسبة.
- [ ] تجربة سيناريو استعادة عنوان محذوف والتحقق من عودته بنفس المعرف والبيانات.
- [ ] ربط العنوان بعملية Checkout والتأكد من:
  - [ ] نجاح التحقق عبر `GET /addresses/validate/:id`.
  - [ ] حفظ معلومات العنوان الكاملة داخل سجل الطلب.
  - [ ] تحديث `usageCount` و `lastUsedAt`.

ملاحظات:

---

## 5. المهندسون (Engineers)
- [ ] تأكيد أن حساب المهندس يستطيع استخدام نفس مجموعة المسارات أعلاه.
- [ ] إنشاء عنوان واستخدامه في `CreateServiceRequest`:
  - [ ] اجتياز التحقق من الملكية قبل قبول الطلب.
  - [ ] تخزين الإحداثيات في الحقل الجغرافي للطلب.
  - [ ] تحديث إحصاءات الاستخدام بنجاح.
- [ ] تجربة تحديث العنوان بعد ربطه بطلب خدمة والتأكد من أن الطلبات السابقة تحتفظ بالبيانات القديمة (Snapshots).
- [ ] مراجعة السجلات للتأكد من عدم توليد استثناءات عند تزامن الطلبات المتعددة على نفس العنوان.

ملاحظات:

---

## 6. التجار (Merchants)
- [ ] التأكد من أن حساب التاجر يملك صلاحية الوصول لنفس المسارات الخاصة بالمستخدم.
- [ ] تسجيل عنوان لاستلام أو تسليم الطلبات ومراقبة:
  - [ ] نجاح استهلاكه من واجهة التاجر (على سبيل المثال إعدادات المتجر).
  - [ ] إمكانية جعله افتراضياً وتحديث واجهات العرض تبعاً لذلك.
- [ ] ربط العنوان بعملية إنشاء طلب تاجر (B2B أو إعادة شحن) والتأكد من:
  - [ ] اجتياز تحقق الملكية.
  - [ ] حفظ نسخة من العنوان في كيان الطلب أو الشحنة.
  - [ ] تحديث الإحصاءات دون التأثير على عناوين المستخدمين الآخرين.
- [ ] اختبار سيناريو حذف عنوان مستخدم في عمليات تاجر نشطة والتأكد من عدم تعطل العمليات المرتبطة به.

ملاحظات:

---

## 7. الاستقرار والمراقبة
- [ ] مراجعة الـ Logs للتأكد من وجود رسائل خطأ مفهومة للمستخدم النهائي.
- [ ] تفعيل تنبيهات عند تجاوز معدل أخطاء محدد في مسارات العناوين.
- [ ] التأكد من أن جميع الأحداث المهمة (إنشاء، تحديث، حذف، استعادة) يتم تسجيلها لأغراض التدقيق.
- [ ] إجراء اختبار تحميل خفيف للتأكد من تحمل `AddressesService` لعدد كبير من الطلبات المتزامنة.

ملاحظات:

---

## 8. متطلبات ما بعد التشغيل
- [ ] تحديث وثائق الواجهة الأمامية للإشارة إلى خطوات التحقق من العنوان الافتراضي.
- [ ] مشاركة نتائج الاختبارات مع فريق تجربة المستخدم لضمان تطابق السلوك مع التوقعات.
- [ ] جدولة اختبار دوري (شهري/ربع سنوي) لإعادة التحقق من تدفق العناوين بعد أي نشرات جديدة.

ملاحظات:

---

**عند اكتمال جميع العناصر أعلاه، يمكن اعتماد تكامل وحدة العناوين للأدوار الثلاثة (Users, Engineers, Merchants) بثقة.**

