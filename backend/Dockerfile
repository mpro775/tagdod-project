# -------- BUILD STAGE --------
FROM node:22-slim AS build

WORKDIR /app

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª package
COPY package*.json ./

# ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ dependencies
RUN npm install

# Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ
COPY . .

# Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
RUN npm run build

# -------- RUNNER STAGE --------
FROM node:22-slim AS runner
WORKDIR /app
ENV NODE_ENV=production

# 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø²Ù… ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© + wget (Ù…Ù‡Ù… Ù„ØªØ­Ù…ÙŠÙ„ Ù…ÙˆÙ†Ø¬Ùˆ)
RUN apt-get update && apt-get install -y \
    wget \
    gnupg \
    tzdata \
    libvips-dev \
    chromium \
    chromium-sandbox \
    fonts-liberation \
    libappindicator3-1 \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libcups2 \
    libdbus-1-3 \
    libgdk-pixbuf2.0-0 \
    libnspr4 \
    libnss3 \
    libx11-xcb1 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    xdg-utils \
    libharfbuzz0b \
    libharfbuzz-icu0 \
    libicu-dev \
    fonts-noto-color-emoji \
    fonts-noto-hinted \
    fonts-noto-unhinted \
    && rm -rf /var/lib/apt/lists/*

# 2. ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆØ§Øª MongoDB Database Tools (mongodump/mongorestore) ğŸ”¥
# Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø®Ø© Debian 12 Ù„Ø£Ù† ØµÙˆØ±Ø© node:22 Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„ÙŠÙ‡Ø§
RUN wget https://fastdl.mongodb.org/tools/db/mongodb-database-tools-debian12-x86_64-100.9.4.deb && \
    apt-get install -y ./mongodb-database-tools-debian12-x86_64-100.9.4.deb && \
    rm mongodb-database-tools-debian12-x86_64-100.9.4.deb

# ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ù„Ù€ Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

# Ù†Ø³Ø® package.json Ùˆ package-lock.json
COPY --from=build /app/package*.json ./

# ØªØ«Ø¨ÙŠØª production dependencies ÙÙ‚Ø·
RUN npm install --only=production && npm cache clean --force

# Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¨Ù†ÙŠØ© Ù…Ù† Ù…Ø±Ø­Ù„Ø© build
COPY --from=build /app/dist ./dist

# Ù†Ø³Ø® assets
RUN mkdir -p /app/assets
COPY --from=build /app/assets /app/assets

EXPOSE 3000

CMD ["node", "dist/main.js"]