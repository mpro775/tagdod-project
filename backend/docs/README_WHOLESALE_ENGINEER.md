# ูุธุงู ุงูุชุงุฌุฑ ูุงููููุฏุณ - ุชูููุฐ ุงุญุชุฑุงูู โจ

> โ๏ธ **ููุงุญุธุฉ ูููุฉ:** ุงููุดุฑูุน ูุณุชุฎุฏู **ูุธุงู ุฑุฏูุฏ ููุญุฏ** ู**ุญูุงูุงุช ูุชุนุฏุฏุฉ ุงูุทุจูุงุช (Guards)**.  
> ุฌููุน ุงูุฃูุซูุฉ ูู ูุฐุง ุงูุฏููู ุชุชุจุน ุงููุนุงููุฑ ุงูุตุญูุญุฉ.

## ๐ ูุธุงู ุงูุญูุงูุงุช ูุงูุฑุฏูุฏ

### ุงูุญูุงูุงุช (Guards):
- **JwtAuthGuard**: ุงูุชุญูู ูู ุตุญุฉ ุงูุชููู
- **AdminGuard**: ุงูุชุญูู ูู ุตูุงุญูุงุช ุงูุฅุฏุงุฑุฉ (`isAdmin: true`)
- **EngineerGuard**: ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููููุฏุณ (`engineer_capable: true`)

### ูุธุงู ุงูุฑุฏูุฏ ุงูููุญุฏ:
```json
// ุฑุฏ ูุงุฌุญ
{
  "success": true,
  "data": { ... },
  "meta": { ... },  // ุงุฎุชูุงุฑู
  "requestId": "req-xxx"
}

// ุฑุฏ ุฎุทุฃ
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "ุฑุณุงูุฉ ุงูุฎุทุฃ",
    "details": null,
    "fieldErrors": null
  },
  "requestId": "req-xxx"
}
```

---

## ๐ฏ ูุง ุชู ุชูููุฐูุ

ุชู ุชุทููุฑ ูุธุงู ูุชูุงูู ูุฏุนู ููุนูู ูู ุงููุณุชุฎุฏููู ุงููุชุฎุตุตูู:

### 1. **ุงูุชุงุฌุฑ (Wholesale Customer)** ๐ผ
- ูุญุตู ุนูู **ุฎุตู ูุณุจุฉ ูุฆููุฉ** (ูุญุฏุฏู ุงูุฅุฏุงุฑุฉ)
- ูุทุจู ุงูุฎุตู **ุชููุงุฆูุงู** ุนูู ูู ุทูุจุงุชู
- ุงูุฎุตู ูุทุจู **ุจุนุฏ** ุงูุนุฑูุถ ุงูุชุฑููุฌูุฉ
- **ููุณ** ูุธุงู ุดุฑุงุก ุจุงูุฌููุฉ - ููุท ุฎุตู ูุฎุตุต

### 2. **ุงููููุฏุณ (Engineer)** ๐ง
- ูุถูู **ูุณูู ูุธููู** ุนูุฏ ุงูุชุณุฌูู (ูุซู: "ููุฑุจุงุฆู")
- ูุณุชูู **ุทูุจุงุช ุฎุฏูุงุช** ูู ุงูุนููุงุก
- ููุฏู **ุนุฑูุถู** ุนูู ุงูุทูุจุงุช
- **ูุง ูุฑู** ุทูุจุงุชู ุงูุฎุงุตุฉ ูู ูุชุงุฆุฌ ุงูุจุญุซ
- **ูุง ููููู** ุชูุฏูู ุนุฑุถ ุนูู ุทูุจู
- ูุดุชุฑู ุจุดูู **ุนุงุฏู** (ุจุฏูู ุฎุตู)

---

## ๐ ุงููููุงุช ุงูุฑุฆูุณูุฉ

| ุงูููู | ุงูุบุฑุถ |
|------|-------|
| `QUICK_START_WHOLESALE_ENGINEER.md` | ๐ฅ ุงูุจุฏุก ุงูุณุฑูุน (ุงุจุฏุฃ ููุง!) |
| `README_WHOLESALE_ENGINEER.md` | ูุธุฑุฉ ุนุงูุฉ ุดุงููุฉ |
| `WHOLESALE_AND_ENGINEER_SYSTEM.md` | ุฏููู ุชูุตููู ูููุธุงู |
| `API_EXAMPLES_WHOLESALE_ENGINEER.md` | ุฃูุซูุฉ ุนูููุฉ ูุน ูุธุงู ุงูุฑุฏูุฏ ุงูููุญุฏ |
| `CHANGES_SUMMARY.md` | ููุฎุต ุงูุชุบููุฑุงุช ุงูุชูููุฉ |

---

## ๐ ุงูุจุฏุก ุงูุณุฑูุน

### 1. ูุฑุงุกุฉ ุงูุชูุซูู
```bash
# ุงูุชุญ ูุฐู ุงููููุงุช ุจุงูุชุฑุชูุจ:
1. QUICK_START_WHOLESALE_ENGINEER.md  # ๐ฅ ุงูุจุฏุก ุงูุณุฑูุน (ุงุจุฏุฃ ููุง!)
2. README_WHOLESALE_ENGINEER.md  # ูุฐุง ุงูููู - ูุธุฑุฉ ุนุงูุฉ
3. WHOLESALE_AND_ENGINEER_SYSTEM.md  # ุงูุฏููู ุงูุดุงูู
4. API_EXAMPLES_WHOLESALE_ENGINEER.md  # ุฃูุซูุฉ ุนูููุฉ ูุน ูุธุงู ุงูุฑุฏูุฏ ุงูููุญุฏ
5. CHANGES_SUMMARY.md  # ุชูุงุตูู ุงูุชุบููุฑุงุช
```

### 2. ุงุฎุชุจุงุฑ ุงููุธุงู
```bash
# ุงุณุชุฎุฏู Postman/Thunder Client ูุน ุงูุฃูุซูุฉ ูู:
API_EXAMPLES_WHOLESALE_ENGINEER.md
```

---

## ๐ ููุงุฑูุฉ ุณุฑูุนุฉ

| ุงูููุฒุฉ | ุนููู ุนุงุฏู | ุชุงุฌุฑ | ูููุฏุณ |
|-------|-----------|------|-------|
| ุงูุดุฑุงุก | โ ุนุงุฏู | โ ุจุฎุตู | โ ุนุงุฏู |
| ุฎุตู ุชููุงุฆู | โ | โ | โ |
| ุทูุจ ุฎุฏูุงุช | โ | โ | โ |
| ุชูุฏูู ุฎุฏูุงุช | โ | โ | โ |
| ูุณูู ูุธููู | โ | โ | โ ูุทููุจ |
| ููุงููุฉ ุงูุฅุฏุงุฑุฉ | โ | โ | โ |

---

## ๐ Flow Diagrams

### ุชุณุฌูู ุงูุชุงุฌุฑ:
```
1. POST /auth/send-otp
2. POST /auth/verify-otp { capabilityRequest: "wholesale" }
3. ุญุงูุฉ: pending
4. POST /auth/admin/approve { wholesaleDiscountPercent: 15 }
5. ุญุงูุฉ: approved + ุฎุตู 15%
6. ุฌููุน ุงูุทูุจุงุช ุชุญุตู ุนูู ุฎุตู ุชููุงุฆู
```

### ุชุณุฌูู ุงููููุฏุณ:
```
1. POST /auth/send-otp
2. POST /auth/verify-otp { 
     capabilityRequest: "engineer",
     jobTitle: "ููุฑุจุงุฆู" โ๏ธ ูุทููุจ
   }
3. ุญุงูุฉ: pending
4. POST /auth/admin/approve
5. ุญุงูุฉ: approved
6. ููููู ุงุณุชูุงู ุทูุจุงุช ุงูุฎุฏูุงุช
```

### ุฎุตู ุงูุชุงุฌุฑ:
```
ุงูุณุนุฑ: 1000 ุฑูุงู
  โ
ุนุฑุถ ุชุฑููุฌู (10%): 900 ุฑูุงู
  โ
ุฎุตู ุงูุชุงุฌุฑ (15%): 765 ุฑูุงู
  โ
ุงูุณุนุฑ ุงูููุงุฆู: 765 ุฑูุงู
ุงูุฎุตู ุงูุฅุฌูุงูู: 235 ุฑูุงู
```

### ุงููููุฏุณ ูุจุญุซ ุนู ุทูุจุงุช:
```
ุทูุจุงุช ูุชุงุญุฉ:
- ุทูุจ A (ุนููู 1) โ ูุธูุฑ
- ุทูุจ B (ุนููู 2) โ ูุธูุฑ
- ุทูุจ C (ุงููููุฏุณ ููุณู) โ ูุง ูุธูุฑ
```

---

## ๐งช ุงุฎุชุจุงุฑุงุช ุฃุณุงุณูุฉ

### โ ูุฌุจ ุฃู ุชูุฌุญ:
```bash
# 1. ุชุณุฌูู ุชุงุฌุฑ ูุน ููุงููุฉ
POST /auth/verify-otp { capabilityRequest: "wholesale" }
POST /auth/admin/approve { wholesaleDiscountPercent: 15 }
GET /cart/preview  # ุชููุน: ุฎุตู 15%

# 2. ุชุณุฌูู ูููุฏุณ ูุน jobTitle
POST /auth/verify-otp { 
  capabilityRequest: "engineer",
  jobTitle: "ููุฑุจุงุฆู"
}
POST /auth/admin/approve
GET /services/requests/nearby  # ูุง ูุฑู ุทูุจุงุชู
```

### โ ูุฌุจ ุฃู ุชูุดู:
```bash
# 1. ูููุฏุณ ุจุฏูู jobTitle
POST /auth/verify-otp { 
  capabilityRequest: "engineer"
  # jobTitle ููููุฏ
}
# ุชููุน: AUTH_JOB_TITLE_REQUIRED

# 2. ูููุฏุณ ููุฏู ุนุฑุถ ุนูู ุทูุจู
POST /services/offers { requestId: "ุทูุจ_ุงููููุฏุณ_ููุณู" }
# ุชููุน: SELF_NOT_ALLOWED
```

---

## ๐ Checklist ูููุทูุฑ

### ูุจู ุงูุงุฎุชุจุงุฑ:
- [ ] ูุฑุงุกุฉ `WHOLESALE_AND_ENGINEER_SYSTEM.md`
- [ ] ููู ุงููุฑู ุจูู ุงูุชุงุฌุฑ ูุงููููุฏุณ
- [ ] ุชุญุถูุฑ Postman/Thunder Client

### ุฃุซูุงุก ุงูุงุฎุชุจุงุฑ:
- [ ] ุชุณุฌูู ุชุงุฌุฑ ูููุงููุฉ ุงูุฅุฏุงุฑุฉ
- [ ] ุงูุชุญูู ูู ุฎุตู ุงูุชุงุฌุฑ ูู ุงูุณูุฉ
- [ ] ุงูุชุญูู ูู ุญูุธ ุงูุฎุตู ูู ุงูุทูุจ
- [ ] ุชุณุฌูู ูููุฏุณ ูุน jobTitle
- [ ] ุงูุชุญูู ูู ุนุฏู ุฑุคูุฉ ุงููููุฏุณ ูุทูุจุงุชู
- [ ] ุงูุชุญูู ูู ููุน ุงููููุฏุณ ูู ุชูุฏูู ุนุฑุถ ุนูู ุทูุจู

### ุจุนุฏ ุงูุงุฎุชุจุงุฑ:
- [ ] ูุญุต logs ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
- [ ] ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [ ] ุชูุซูู ุฃู ูุดุงูู

---

## ๐จ ูุซุงู ูุงูุนู

### ุงูุณููุงุฑูู: ุนูู ุงูุชุงุฌุฑ

```javascript
// 1. ุงูุชุณุฌูู
POST /auth/verify-otp
{
  "phone": "0555111111",
  "code": "123456",
  "firstName": "ุนูู",
  "lastName": "ุงูุชุงุฌุฑ",
  "capabilityRequest": "wholesale"
}

// 2. ุงูุฅุฏุงุฑุฉ ุชูุงูู ูุชุนุทูู ุฎุตู 20%
POST /auth/admin/approve
{
  "userId": "...",
  "capability": "wholesale",
  "approve": true,
  "wholesaleDiscountPercent": 20
}

// 3. ุนูู ูุชุณูู
POST /cart/items { "variantId": "product_a", "qty": 10 }

// 4. ุนูู ูุนุงูู ุงูุณูุฉ
GET /cart/preview
// Response:
{
  "subtotal": 8000,  // ูุงู 10000 ูุจู ุงูุฎุตู
  "meta": {
    "wholesaleDiscountPercent": 20,
    "wholesaleDiscountAmount": 2000
  }
}

// 5. ุนูู ูุดุชุฑู
POST /checkout/confirm
// ูุชู ุญูุธ ูุนูููุงุช ุงูุฎุตู ูู ุงูุทูุจ
```

### ุงูุณููุงุฑูู: ุฎุงูุฏ ุงููููุฏุณ

```javascript
// 1. ุงูุชุณุฌูู
POST /auth/verify-otp
{
  "phone": "0555222222",
  "code": "654321",
  "firstName": "ุฎุงูุฏ",
  "lastName": "ุงููููุฏุณ",
  "capabilityRequest": "engineer",
  "jobTitle": "ููุฑุจุงุฆู ูุนุชูุฏ"  // โ๏ธ ูุทููุจ
}

// 2. ุงูุฅุฏุงุฑุฉ ุชูุงูู
POST /auth/admin/approve
{
  "userId": "...",
  "capability": "engineer",
  "approve": true
}

// 3. ุฎุงูุฏ ููุดุฆ ุทูุจ ุฎุฏูุฉ ูููุณู
POST /services/requests
{
  "title": "ุฃุญุชุงุฌ ููุฑุจุงุฆู",
  "type": "ELECTRICAL"
}

// 4. ุฎุงูุฏ ูุจุญุซ ุนู ุทูุจุงุช
GET /services/requests/nearby?lat=24.7&lng=46.6&radiusKm=10
// Response:
{
  "data": [
    { "title": "ุฅุตูุงุญ ููุฑุจุงุก ููุนููู ุฃุญูุฏ" },  // โ ูุธูุฑ
    { "title": "ุตูุงูุฉ ููุนููู ูุญูุฏ" }          // โ ูุธูุฑ
    // โ "ุฃุญุชุงุฌ ููุฑุจุงุฆู" (ุทูุจ ุฎุงูุฏ) ูุง ูุธูุฑ
  ]
}

// 5. ุฎุงูุฏ ูุญุงูู ุชูุฏูู ุนุฑุถ ุนูู ุทูุจู
POST /services/offers
{
  "requestId": "ุทูุจ_ุฎุงูุฏ",
  "amount": 500
}
// Response: { "error": "SELF_NOT_ALLOWED" }  โ

// 6. ุฎุงูุฏ ูุชุณูู
GET /cart/preview
// Response: ูุง ููุฌุฏ ุฎุตู (ูุดุชุฑู ุจุณุนุฑ ุนุงุฏู)
```

---

## ๐ ุงูุฃูุงู ูุงูุฌูุฏุฉ

### โ ุชู ุงูุชุทุจูู:
1. **Server-side calculations**: ุฌููุน ุงูุญุณุงุจุงุช ูู ุงูุณูุฑูุฑ
2. **Validation**: ุงูุชุญูู ูู ุงูุจูุงูุงุช ูู ูู ุฎุทูุฉ
3. **Authorization**: ูุญุต ุงูุตูุงุญูุงุช
4. **Audit trail**: ุญูุธ ูุนูููุงุช ุงูุฎุตู ูู ุงูุทูุจ
5. **Business logic**: ููุน ุงููููุฏุณ ูู ุฑุคูุฉ ุทูุจุงุชู

### ๐ซ ูุง ูููู:
- โ ุงูุชูุงุนุจ ุจูุณุจุฉ ุงูุฎุตู ูู ุงูุนููู
- โ ุงููููุฏุณ ูุฑู ุทูุจุงุชู ูู ุงูุจุญุซ
- โ ุงููููุฏุณ ููุฏู ุนุฑุถ ุนูู ุทูุจู
- โ ุงูุญุตูู ุนูู ุฎุตู ุจุฏูู ููุงููุฉ ุงูุฅุฏุงุฑุฉ

---

## ๐ ุงููููุงุช ุงูุชูููุฉ

### Database Schemas:
- `capabilities.schema.ts` - ุฅุถุงูุฉ `wholesale_discount_percent`
- `user.schema.ts` - ุฅุถุงูุฉ `jobTitle`
- `order.schema.ts` - ุฅุถุงูุฉ `wholesaleDiscountPercent` ู `wholesaleDiscountAmount`

### Services:
- `cart.service.ts` - ุชุทุจูู ุฎุตู ุงูุชุงุฌุฑ ุชููุงุฆูุงู
- `services.service.ts` - ููุน ุงููููุฏุณ ูู ุฑุคูุฉ ุทูุจุงุชู

### Controllers:
- `auth.controller.ts` - ุงูุชุญูู ูู jobTitle ูุฅุถุงูุฉ wholesaleDiscountPercent

### DTOs:
- `verify-otp.dto.ts` - ุฅุถุงูุฉ `jobTitle`

---

## ๐ก ูุตุงุฆุญ ูููุทูุฑูู

1. **ุนูุฏ ุฅุถุงูุฉ ููุฒุงุช ุฌุฏูุฏุฉ:**
   - ุชุฃูุฏ ูู ุชุทุจูู ุงูุฎุตู ูู ุฌููุน ุงูุญุงูุงุช
   - ุงุญูุธ ูุนูููุงุช ุงูุฎุตู ูู ุงูุทูุจ
   - ุฑุงุนู ุงูุฃูุงู (server-side)

2. **ุนูุฏ ุชุนุฏูู ุงูุฃุณุนุงุฑ:**
   - ุชุทุจูู ุงูุนุฑูุถ ุงูุชุฑููุฌูุฉ ุฃููุงู
   - ุซู ุชุทุจูู ุฎุตู ุงูุชุงุฌุฑ
   - ุซู ุญูุธ ุงูุณุนุฑ ุงูููุงุฆู

3. **ุนูุฏ ุฅุถุงูุฉ ููุฒุงุช ูููููุฏุณ:**
   - ุชุฃูุฏ ูู ุนุฏู ุฑุคูุชู ูุทูุจุงุชู
   - ุชุฃูุฏ ูู ุนุฏู ุชูุฏููู ุนุฑูุถ ุนูู ุทูุจุงุชู
   - ุงุณุชุฎุฏู `userId: { $ne: engineerUserId }`

---

## ๐ ูููุจุชุฏุฆูู

### ููู ูุนูู ุงููุธุงูุ

1. **ุงูุชุงุฌุฑ:**
   ```
   ูุณุฌู โ ุงูุฅุฏุงุฑุฉ ุชูุงูู ูุน ุฎุตู โ ูุชุณูู โ ุฎุตู ุชููุงุฆู
   ```

2. **ุงููููุฏุณ:**
   ```
   ูุณุฌู + jobTitle โ ุงูุฅุฏุงุฑุฉ ุชูุงูู โ ูุณุชูู ุทูุจุงุช โ ููุฏู ุนุฑูุถ
   ```

### ุฃูู ุงูููุฏุ

- **ุฎุตู ุงูุชุงุฌุฑ:** `cart.service.ts` (ุงูุณุทุฑ 162-189)
- **ุงููุณูู ุงููุธููู:** `auth.controller.ts` (ุงูุณุทุฑ 43-62)
- **ููุน ุฑุคูุฉ ุงูุทูุจุงุช:** `services.service.ts` (ุงูุณุทุฑ 106)

---

## ๐ ุญู ุงููุดุงูู

### ุงููุดููุฉ: ุงูุชุงุฌุฑ ูุง ูุญุตู ุนูู ุฎุตู
```bash
# 1. ุชุญูู ูู ุงูููุงููุฉ
GET /auth/me
# ูุฌุจ: wholesale_capable = true, wholesale_discount_percent > 0

# 2. ุชุญูู ูู ุงูุณูุฉ
GET /cart/preview
# ูุฌุจ: meta.wholesaleDiscountPercent > 0
```

### ุงููุดููุฉ: ุงููููุฏุณ ูุฑู ุทูุจุงุชู
```bash
# 1. ุชุญูู ูู ุงูููุฏ ูู services.service.ts
# ูุฌุจ ุฃู ูุญุชูู ุนูู: userId: { $ne: engineerUserId }

# 2. ุงุฎุชุจุฑ
GET /services/requests/nearby
# ูุฌุจ: ูุง ุชูุฌุฏ ุทูุจุงุช ูููููุฏุณ ููุณู
```

### ุงููุดููุฉ: ุฎุทุฃ ุนูุฏ ุชุณุฌูู ุงููููุฏุณ
```bash
# ุงูุฎุทุฃ: AUTH_JOB_TITLE_REQUIRED
# ุงูุญู: ุฃุถู jobTitle ูู ุงูุทูุจ
POST /auth/verify-otp
{
  "capabilityRequest": "engineer",
  "jobTitle": "ููุฑุจุงุฆู"  // โฌ๏ธ ูุง ุชูุณ
}
```

---

## ๐ ุงูุฏุนู

- **ุงูุฃุณุฆูุฉ ุงูุชูููุฉ:** ุฑุงุฌุน `CHANGES_SUMMARY.md`
- **ุฃูุซูุฉ ุนูููุฉ:** ุฑุงุฌุน `API_EXAMPLES_WHOLESALE_ENGINEER.md`
- **ุงูุฏููู ุงูุดุงูู:** ุฑุงุฌุน `WHOLESALE_AND_ENGINEER_SYSTEM.md`

---

## โจ ุงูุฎูุงุตุฉ

ุชู ุชุทุจูู ูุธุงู ุงุญุชุฑุงูู ููุชูุงูู ูุฏุนู:
- โ ุงูุชุงุฌุฑ ุจุฎุตู ุชููุงุฆู ูุฎุตุต
- โ ุงููููุฏุณ ูุน ูุณูู ูุธููู ูุชูุฏูู ุฎุฏูุงุช
- โ ุฃูุงู ูุงูู ูููุน ุงูุชูุงุนุจ
- โ ุชูุซูู ุดุงูู ูุน ุฃูุซูุฉ ุนูููุฉ

**ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูุงูุงุฎุชุจุงุฑ! ๐**

---

**ุชู ุจูุงุณุทุฉ:** Claude Sonnet 4.5  
**ุงูุชุงุฑูุฎ:** 13 ุฃูุชูุจุฑ 2025  
**ุงููุดุฑูุน:** Tagadodo

