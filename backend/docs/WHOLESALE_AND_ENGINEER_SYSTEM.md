# ูุธุงู ุงูุชุงุฌุฑ ูุงููููุฏุณ - ุฏููู ุดุงูู

> โ๏ธ **ููุงุญุธุฉ ูููุฉ:** ุงูุฃูุซูุฉ ูู ูุฐุง ุงูููู ูุจุณุทุฉ ููุชูุถูุญ ููุท.  
> ููุฃูุซูุฉ ุงููุงููุฉ ูุน **ูุธุงู ุงูุฑุฏูุฏ ุงูููุญุฏ ูุงูุญูุงูุงุช**ุ ุฑุงุฌุน: [`API_EXAMPLES_WHOLESALE_ENGINEER.md`](./API_EXAMPLES_WHOLESALE_ENGINEER.md)

## ๐ ุฌุฏูู ุงููุญุชููุงุช
1. [ูุธุฑุฉ ุนุงูุฉ](#ูุธุฑุฉ-ุนุงูุฉ)
2. [ูุธุงู ุงูุชุงุฌุฑ (Wholesale)](#ูุธุงู-ุงูุชุงุฌุฑ-wholesale)
3. [ูุธุงู ุงููููุฏุณ (Engineer)](#ูุธุงู-ุงููููุฏุณ-engineer)
4. [ุณููุงุฑูู ุงูุชุณุฌูู ุงููุงูู](#ุณููุงุฑูู-ุงูุชุณุฌูู-ุงููุงูู)
5. [ุฃูุซูุฉ API](#ุฃูุซูุฉ-api)
6. [ุงูุชุนุฏููุงุช ุงูุชูููุฉ](#ุงูุชุนุฏููุงุช-ุงูุชูููุฉ)

---

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทููุฑ ูุธุงู ูุชูุงูู ูุฏุนู ุซูุงุซุฉ ุฃููุงุน ูู ุงููุณุชุฎุฏููู:

| ุงูููุน | ุงููุฏุฑุงุช | ุงูููุฒุงุช ุงูุฎุงุตุฉ |
|------|---------|----------------|
| **ุนููู ุนุงุฏู (Customer)** | ุงูุดุฑุงุก ุงูุนุงุฏู | โ ููุนูู ุชููุงุฆูุงู ุนูุฏ ุงูุชุณุฌูู |
| **ุชุงุฌุฑ (Wholesale)** | ุงูุดุฑุงุก ุจุฎุตู ูุฎุตุต | โ ุฎุตู ูุณุจุฉ ูุฆููุฉ ูุทุจู ุชููุงุฆูุงู ุนูู ูู ุงูุทูุจุงุช<br>โ ูุญุชุงุฌ ููุงููุฉ ุงูุฅุฏุงุฑุฉ<br>โ ููููู ุทูุจ ูููุฏุณูู |
| **ูููุฏุณ (Engineer)** | ุงูุดุฑุงุก ุงูุนุงุฏู + ุชูุฏูู ุฎุฏูุงุช | โ ูุณุชูู ุทูุจุงุช ุฎุฏูุงุช ูู ูุฌุงูู<br>โ ููุฏู ุนุฑูุถ ุนูู ุงูุทูุจุงุช<br>โ ูุง ูุณุชูู ุทูุจุงุชู ุงูุฎุงุตุฉ<br>โ ูุถูู ูุณูู ูุธููู ุนูุฏ ุงูุชุณุฌูู<br>โ ูุญุชุงุฌ ููุงููุฉ ุงูุฅุฏุงุฑุฉ |

---

## ูุธุงู ุงูุชุงุฌุฑ (Wholesale)

### ๐ฏ ุงููุฏู
ุงูุชุงุฌุฑ **ููุณ** ูู ุงููุฏุฑุฉ ุนูู ุงูุดุฑุงุก ุจุงูุฌููุฉุ ุจู ูุญุตู ุนูู **ุฎุตู ูุณุจุฉ ูุฆููุฉ** ูุชู ุชุญุฏูุฏู ูู ููุญุฉ ุงูุชุญูู ููุทุจู ุชููุงุฆูุงู ุนูู ูู ุทูุจุงุชู.

### ๐ ุงูุจูุงูุงุช ุงููุฎุฒูุฉ

#### ูู `Capabilities Schema`:
```typescript
{
  userId: ObjectId,
  wholesale_capable: boolean,           // true = ูููุนูู ูุชุงุฌุฑ
  wholesale_status: string,             // 'pending' | 'approved' | 'rejected'
  wholesale_discount_percent: number,   // 0-100 ูุณุจุฉ ุงูุฎุตู
}
```

#### ูู `Order Schema`:
```typescript
{
  wholesaleDiscountPercent: number,   // ูุณุจุฉ ุงูุฎุตู ุงููุทุจูุฉ
  wholesaleDiscountAmount: number,    // ูุจูุบ ุงูุฎุตู ุจุงูุนููุฉ
}
```

### ๐ ุขููุฉ ุนูู ุงูุฎุตู

1. **ุนูุฏ ุงูุชุณุฌูู**: ูุฎุชุงุฑ ุงููุณุชุฎุฏู `capabilityRequest: 'wholesale'`
2. **ุนูุฏ ุงูููุงููุฉ**: ุงูุฅุฏุงุฑุฉ ุชุถูู ูุณุจุฉ ุงูุฎุตู (ูุซูุงู: 15%)
3. **ุนูุฏ ุงูุดุฑุงุก**: 
   - ูุชู ุฌูุจ ูุณุจุฉ ุงูุฎุตู ูู `Capabilities`
   - ุชุทุจูู ุงูุนุฑูุถ ุงูุชุฑููุฌูุฉ ุฃููุงู (ุฅู ูุฌุฏุช)
   - ุซู ุชุทุจูู ุฎุตู ุงูุชุงุฌุฑ ุนูู ุงูุณุนุฑ ุงูููุงุฆู
   - ุญูุธ ูุนูููุงุช ุงูุฎุตู ูู ุงูุทูุจ

### ๐ก ูุซุงู ุญุณุงุจู

```
ุงูุณุนุฑ ุงูุฃุตูู: 1000 ุฑูุงู
ุนุฑุถ ุชุฑููุฌู (-10%): 900 ุฑูุงู
ุฎุตู ุงูุชุงุฌุฑ (15%): 900 - 135 = 765 ุฑูุงู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ุงูุณุนุฑ ุงูููุงุฆู: 765 ุฑูุงู
ุงูุฎุตู ุงูุฅุฌูุงูู: 235 ุฑูุงู (23.5%)
```

### โ ุงููุฏุฑุงุช
- โ ุงูุดุฑุงุก ุจุฎุตู ูุฎุตุต
- โ ุทูุจ ุฎุฏูุงุช ูููุฏุณูู
- โ **ูุง** ููุฌุฏ ุดุฑุงุก ุจุงูุฌููุฉ

---

## ูุธุงู ุงููููุฏุณ (Engineer)

### ๐ฏ ุงููุฏู
ุงููููุฏุณ ููููู ุชูุฏูู ุฎุฏูุงุชู ููุนููุงุก ุนุจุฑ ุชููู ุทูุจุงุช ุงูุฎุฏูุฉ ูุชูุฏูู ุนุฑูุถ ุนูููุง.

### ๐ ุงูุจูุงูุงุช ุงููุฎุฒูุฉ

#### ูู `User Schema`:
```typescript
{
  jobTitle: string,  // "ููุฑุจุงุฆู" | "ุณุจุงู" | "ูุฌุงุฑ" | ุงูุฎ...
}
```

#### ูู `Capabilities Schema`:
```typescript
{
  userId: ObjectId,
  engineer_capable: boolean,     // true = ูููุนูู ููููุฏุณ
  engineer_status: string,       // 'pending' | 'approved' | 'rejected'
}
```

### ๐ ุขููุฉ ุนูู ูุธุงู ุงููููุฏุณ

1. **ุนูุฏ ุงูุชุณุฌูู**: 
   - ูุฎุชุงุฑ `capabilityRequest: 'engineer'`
   - **ูุฌุจ** ุฅุถุงูุฉ `jobTitle` (ุงููุณูู ุงููุธููู)
   
2. **ุนูุฏ ุงูููุงููุฉ**: 
   - ุงูุฅุฏุงุฑุฉ ุชูุงูู ุนูู ุงูุทูุจ
   - ุงููููุฏุณ ูุตุจุญ ูุงุฏุฑุงู ุนูู ุงุณุชูุงู ุงูุทูุจุงุช

3. **ุงุณุชูุงู ุงูุทูุจุงุช**:
   - ูุจุญุซ ุนู ุทูุจุงุช ูุฑูุจุฉ ููู ุฌุบุฑุงููุงู
   - **ูุง ูุฑู** ุทูุจุงุชู ุงูุฎุงุตุฉ
   - ููุฏู ุนุฑูุถู ุนูู ุงูุทูุจุงุช

4. **ุชูููุฐ ุงูุฎุฏูุฉ**:
   - ุงูุนููู ููุจู ุนุฑุถู
   - ุงููููุฏุณ ูุจุฏุฃ ุงูุนูู
   - ุงููููุฏุณ ูููู ุงูุฎุฏูุฉ
   - ุงูุนููู ููููู ุงูุฎุฏูุฉ

### โ ุงููุฏุฑุงุช
- โ ุงูุดุฑุงุก ุงูุนุงุฏู (ุจุฏูู ุฎุตู)
- โ ุงุณุชูุงู ุทูุจุงุช ุฎุฏูุงุช
- โ ุชูุฏูู ุนุฑูุถ ุนูู ุงูุทูุจุงุช
- โ ุทูุจ ูููุฏุณูู ุขุฎุฑูู (ุบูุฑ ููุณู)
- โ **ูุง ูุฑู** ุทูุจุงุชู ุงูุฎุงุตุฉ
- โ **ูุง ูููู** ุชูุฏูู ุนุฑุถ ุนูู ุทูุจู

---

## ุณููุงุฑูู ุงูุชุณุฌูู ุงููุงูู

### 1๏ธโฃ ุชุณุฌูู ุนููู ุนุงุฏู

```http
POST /auth/send-otp
{
  "phone": "0512345678",
  "context": "register"
}

POST /auth/verify-otp
{
  "phone": "0512345678",
  "code": "123456",
  "firstName": "ุฃุญูุฏ",
  "lastName": "ูุญูุฏ"
}

โ ุงููุชูุฌุฉ:
- ุญุณุงุจ ุนููู ุนุงุฏู
- customer_capable: true
```

---

### 2๏ธโฃ ุชุณุฌูู ุชุงุฌุฑ (Wholesale)

```http
POST /auth/send-otp
{
  "phone": "0512345678",
  "context": "register"
}

POST /auth/verify-otp
{
  "phone": "0512345678",
  "code": "123456",
  "firstName": "ุนูู",
  "lastName": "ุงูุชุงุฌุฑ",
  "capabilityRequest": "wholesale"
}

โ ุงููุชูุฌุฉ:
- ุญุณุงุจ ุนููู ุนุงุฏู
- ุทูุจ ุชุงุฌุฑ ุจุญุงูุฉ: pending
- ููุชุธุฑ ููุงููุฉ ุงูุฅุฏุงุฑุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงูุฅุฏุงุฑุฉ ุชูุงูู ูุชุถูู ุฎุตู 15%:

POST /auth/admin/approve
{
  "userId": "507f1f77bcf86cd799439011",
  "capability": "wholesale",
  "approve": true,
  "wholesaleDiscountPercent": 15
}

โ ุงููุชูุฌุฉ:
- wholesale_capable: true
- wholesale_discount_percent: 15
- ุฌููุน ุทูุจุงุชู ุณุชุญุตู ุนูู ุฎุตู 15% ุชููุงุฆูุงู
```

---

### 3๏ธโฃ ุชุณุฌูู ูููุฏุณ (Engineer)

```http
POST /auth/send-otp
{
  "phone": "0512345678",
  "context": "register"
}

POST /auth/verify-otp
{
  "phone": "0512345678",
  "code": "123456",
  "firstName": "ุฎุงูุฏ",
  "lastName": "ุงููููุฏุณ",
  "capabilityRequest": "engineer",
  "jobTitle": "ููุฑุจุงุฆู ูุนุชูุฏ"  โ๏ธ ูุทููุจ ูููููุฏุณ
}

โ ุงููุชูุฌุฉ:
- ุญุณุงุจ ุนููู ุนุงุฏู
- ุทูุจ ูููุฏุณ ุจุญุงูุฉ: pending
- jobTitle: "ููุฑุจุงุฆู ูุนุชูุฏ"
- ููุชุธุฑ ููุงููุฉ ุงูุฅุฏุงุฑุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงูุฅุฏุงุฑุฉ ุชูุงูู:

POST /auth/admin/approve
{
  "userId": "507f1f77bcf86cd799439011",
  "capability": "engineer",
  "approve": true
}

โ ุงููุชูุฌุฉ:
- engineer_capable: true
- ููููู ุงุณุชูุงู ุทูุจุงุช ุงูุฎุฏูุงุช
```

---

## ุฃูุซูุฉ API

### ๐ ุณูุฉ ุงูุชุงุฌุฑ (ูุน ุงูุฎุตู ุงูุชููุงุฆู)

```http
GET /cart/preview?currency=YER
Authorization: Bearer <token>

Response:
{
  "currency": "YER",
  "subtotal": 850,  // ุจุนุฏ ุชุทุจูู ุงูุฎุตู
  "items": [
    {
      "variantId": "...",
      "qty": 2,
      "unit": {
        "base": 500,   // ุงูุณุนุฑ ุงูุฃุณุงุณู
        "final": 425,  // 500 - 15% = 425
        "currency": "YER"
      },
      "lineTotal": 850  // 425 ร 2
    }
  ],
  "meta": {
    "count": 1,
    "wholesaleDiscountPercent": 15,
    "wholesaleDiscountAmount": 150  // ูุจูุบ ุงูุฎุตู
  }
}
```

### ๐ฆ ุฅูุดุงุก ุทูุจ (ูุน ุญูุธ ูุนูููุงุช ุงูุฎุตู)

```http
POST /checkout/confirm
Authorization: Bearer <token>
{
  "currency": "YER",
  "paymentMethod": "COD"
}

โ ูุชู ุญูุธ ูู Order:
{
  "total": 850,
  "wholesaleDiscountPercent": 15,
  "wholesaleDiscountAmount": 150,
  "items": [...]
}
```

### ๐ง ุงููููุฏุณ ูุจุญุซ ุนู ุทูุจุงุช ูุฑูุจุฉ

```http
GET /services/requests/nearby?lat=24.7136&lng=46.6753&radiusKm=10
Authorization: Bearer <engineer-token>

โ ูุฑุฌุน ุทูุจุงุช ุงูุฎุฏูุงุช ุงููุฑูุจุฉ
โ ูุง ูุฑุฌุน ุทูุจุงุช ุงููููุฏุณ ููุณู
```

### ๐ผ ุงููููุฏุณ ููุฏู ุนุฑุถ

```http
POST /services/offers
Authorization: Bearer <engineer-token>
{
  "requestId": "...",
  "amount": 500,
  "note": "ูููููู ุฅุชูุงู ุงูุนูู ุฎูุงู 3 ุฃูุงู"
}

โ ุฅุฐุง ูุงู ุงูุทูุจ ูุนููู ุขุฎุฑ: โ
โ ุฅุฐุง ูุงู ุงูุทูุจ ูููููุฏุณ ููุณู: SELF_NOT_ALLOWED
```

### ๐ค ูุนูููุงุช ุงููุณุชุฎุฏู

```http
GET /auth/me
Authorization: Bearer <token>

Response (ุชุงุฌุฑ):
{
  "user": {
    "id": "...",
    "phone": "0512345678",
    "firstName": "ุนูู",
    "lastName": "ุงูุชุงุฌุฑ",
    "jobTitle": null
  },
  "capabilities": {
    "customer_capable": true,
    "wholesale_capable": true,
    "wholesale_discount_percent": 15,
    "engineer_capable": false
  }
}

Response (ูููุฏุณ):
{
  "user": {
    "id": "...",
    "phone": "0598765432",
    "firstName": "ุฎุงูุฏ",
    "lastName": "ุงููููุฏุณ",
    "jobTitle": "ููุฑุจุงุฆู ูุนุชูุฏ"
  },
  "capabilities": {
    "customer_capable": true,
    "wholesale_capable": false,
    "engineer_capable": true
  }
}
```

---

## ุงูุชุนุฏููุงุช ุงูุชูููุฉ

### ๐ ุงููููุงุช ุงููุนุฏูุฉ

#### 1. **Capabilities Schema** (`capabilities.schema.ts`)
```typescript
+ wholesale_discount_percent: number  // 0-100
```

#### 2. **User Schema** (`user.schema.ts`)
```typescript
+ jobTitle?: string  // ูููููุฏุณ
```

#### 3. **VerifyOtpDto** (`verify-otp.dto.ts`)
```typescript
+ jobTitle?: string  // ูุทููุจ ูููููุฏุณ
```

#### 4. **Auth Controller** (`auth.controller.ts`)
- โ ุงูุชุญูู ูู ูุฌูุฏ `jobTitle` ุนูุฏ ุงูุชุณุฌูู ููููุฏุณ
- โ ุญูุธ `jobTitle` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุชุญุฏูุซ `/admin/approve` ูุฏุนู `wholesaleDiscountPercent`
- โ ุฅุฑุฌุงุน `jobTitle` ูู `/auth/me`
- โ ุงูุณูุงุญ ุจุชุญุฏูุซ `jobTitle` ูู `/auth/me PATCH`

#### 5. **Cart Service** (`cart.service.ts`)
- โ ุฌูุจ ูุฏุฑุงุช ุงููุณุชุฎุฏู
- โ ุชุทุจูู ุฎุตู ุงูุชุงุฌุฑ ุชููุงุฆูุงู ุจุนุฏ ุงูุนุฑูุถ ุงูุชุฑููุฌูุฉ
- โ ุญุณุงุจ ูุจูุบ ุงูุฎุตู
- โ ุฅุฑุฌุงุน ูุนูููุงุช ุงูุฎุตู ูู `preview`

#### 6. **Cart Module** (`cart.module.ts`)
```typescript
+ Capabilities Schema ูู imports
```

#### 7. **Order Schema** (`order.schema.ts`)
```typescript
+ wholesaleDiscountPercent?: number
+ wholesaleDiscountAmount?: number
```

#### 8. **Checkout Service** (`checkout.service.ts`)
- โ ุญูุธ `wholesaleDiscountPercent` ู `wholesaleDiscountAmount` ูู ุงูุทูุจ

#### 9. **Services Service** (`services.service.ts`)
- โ ููุน ุงููููุฏุณ ูู ุฑุคูุฉ ุทูุจุงุชู ูู `nearby()`
- โ ููุน ุงููููุฏุณ ูู ุชูุฏูู ุนุฑุถ ุนูู ุทูุจู ูู `offer()`

---

## ๐ฏ ููุงุท ุงูููุฉ ูู ุงูุชุตููู

### 1. **ุงูุฃูุงู** ๐
- โ ุฎุตู ุงูุชุงุฌุฑ ููุญุณุจ ูู ุงูุณูุฑูุฑ (ูุง ูููู ุงูุชูุงุนุจ ุจู)
- โ ุงููููุฏุณ ูุง ููููู ุชูุฏูู ุนุฑุถ ุนูู ุทูุจู
- โ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูู ูู ุฎุทูุฉ

### 2. **ุงููุฑููุฉ** ๐
- โ ุงูุฅุฏุงุฑุฉ ุชุชุญูู ูู ูุณุจุฉ ุงูุฎุตู ููู ุชุงุฌุฑ
- โ ูููู ุชุญุฏูุซ ูุณุจุฉ ุงูุฎุตู ูู ุฃู ููุช
- โ ุงููููุฏุณ ููููู ุงูุดุฑุงุก ุจุดูู ุทุจูุนู

### 3. **ุงูุดูุงููุฉ** ๐
- โ ุญูุธ ูุนูููุงุช ุงูุฎุตู ูู ูู ุทูุจ (ููุชูุงุฑูุฑ)
- โ ุงูุนููู ูุฑู ุงูุฎุตู ุงููุทุจู ูุงุถุญุงู
- โ ุณูููุฉ ุชุชุจุน ุงููุจูุนุงุช ููุชุฌุงุฑ

### 4. **ูุงุจููุฉ ุงูุชูุณุน** ๐
- โ ูููู ุฅุถุงูุฉ ุฃููุงุน ุฎุตููุงุช ุฃุฎุฑู ูุณุชูุจูุงู
- โ ุงูุจููุฉ ุชุฏุนู ุทูุจุงุช ูุฏุฑุงุช ูุชุนุฏุฏุฉ
- โ ุณูููุฉ ุฅุถุงูุฉ ุชุฎุตุตุงุช ูููููุฏุณูู

---

## โ ูุงุฆูุฉ ุงูุชุญูู

### ุงูุชุงุฌุฑ:
- [x] ุฅุถุงูุฉ ุญูู `wholesale_discount_percent` ูู Capabilities
- [x] ููุงููุฉ ุงูุฅุฏุงุฑุฉ ูุน ูุณุจุฉ ุงูุฎุตู
- [x] ุชุทุจูู ุงูุฎุตู ุชููุงุฆูุงู ูู ุงูุณูุฉ
- [x] ุญูุธ ูุนูููุงุช ุงูุฎุตู ูู ุงูุทูุจ
- [x] ุฅุฑุฌุงุน ูุนูููุงุช ุงูุฎุตู ูู Preview

### ุงููููุฏุณ:
- [x] ุฅุถุงูุฉ ุญูู `jobTitle` ูู User
- [x] ุทูุจ ุงููุณูู ุงููุธููู ุนูุฏ ุงูุชุณุฌูู
- [x] ููุน ุงููููุฏุณ ูู ุฑุคูุฉ ุทูุจุงุชู
- [x] ููุน ุงููููุฏุณ ูู ุชูุฏูู ุนุฑุถ ุนูู ุทูุจู
- [x] ุงูุณูุงุญ ุจุงูุดุฑุงุก ุงูุนุงุฏู
- [x] ุงูุณูุงุญ ุจุทูุจ ูููุฏุณูู ุขุฎุฑูู

---

## ๐ ุงูุฏุนู

ูุฃู ุงุณุชูุณุงุฑุงุช ุฃู ุชุญุณููุงุชุ ูุฑุฌู ุงูุชูุงุตู ูุน ูุฑูู ุงูุชุทููุฑ.

**ุชู ุงูุชุทููุฑ ุจู โค๏ธ ููุธุงู Tagadodo**

