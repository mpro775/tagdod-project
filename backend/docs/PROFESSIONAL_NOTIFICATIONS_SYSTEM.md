# ğŸ”” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„

## ğŸ¯ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø´Ø§Ù…Ù„Ø©

Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙŠØ¯Ø¹Ù… Push Notifications, SMS, Email, Ùˆ In-App Notifications Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ù‚ÙˆØ§Ù„Ø¨ØŒ ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø°ÙƒÙŠØ©.

## âœ¨ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

### ğŸ“± Ù‚Ù†ÙˆØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (Multi-Channel)
- **In-App Notifications**: Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
- **Push Notifications**: Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠØ© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„ÙˆÙŠØ¨
- **SMS**: Ø±Ø³Ø§Ø¦Ù„ Ù†ØµÙŠØ© Ù‚ØµÙŠØ±Ø©
- **Email**: Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¹ Ø¯Ø¹Ù… HTML

### ğŸ¨ Ù†Ø¸Ø§Ù… Ù‚ÙˆØ§Ù„Ø¨ Ù…ØªÙ‚Ø¯Ù…
- Ù‚ÙˆØ§Ù„Ø¨ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ®ØµÙŠØµ Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø¥Ø´Ø¹Ø§Ø±
- Ø¯Ø¹Ù… Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª (Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
- Ù…ØªØºÙŠØ±Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (Placeholders)
- Ù†Ø¸Ø§Ù… Ø£ÙˆÙ„ÙˆÙŠØ§Øª
- Ø´Ø±ÙˆØ· ÙˆØªØµÙ†ÙŠÙØ§Øª

### âš™ï¸ ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
- Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
- Quiet Hours (Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù‡Ø¯ÙˆØ¡)
- ØªÙØ¶ÙŠÙ„Ø§Øª Ù„ÙƒÙ„ ÙØ¦Ø© ÙˆÙ‚Ù†Ø§Ø©
- Ø­Ø¯ÙˆØ¯ Ø§Ù„ØªØ±Ø¯Ø¯
- Ù„ØºØ© Ù…ÙØ¶Ù„Ø©

### ğŸ“Š ØªØªØ¨Ø¹ ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª
- ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Sent, Delivered, Read, Clicked)
- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø©
- Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ÙØªØ­ ÙˆØ§Ù„Ù†Ù‚Ø±
- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡
- Logs Ù…ÙØµÙ„Ø©

### ğŸ”— Webhooks
- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ø¨Ø± Webhooks Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
- Retry mechanism Ø°ÙƒÙŠ
- Authentication Ù…ØªØ¹Ø¯Ø¯
- Filters Ù…Ø®ØµØµØ©

### â° Ø¬Ø¯ÙˆÙ„Ø© Ø°ÙƒÙŠØ©
- Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯ÙˆÙ„
- Delay configurations
- Batch sending
- Quiet hours respect

## ğŸ“ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©

```
notifications/
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ notification.schema.ts              # Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
â”‚   â”œâ”€â”€ notification-log.schema.ts          # Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
â”‚   â”œâ”€â”€ notification-template.schema.ts     # Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
â”‚   â”œâ”€â”€ notification-preference.schema.ts   # Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª
â”‚   â”œâ”€â”€ notification-webhook.schema.ts      # Webhooks
â”‚   â””â”€â”€ device-token.schema.ts              # Device tokens
â”œâ”€â”€ dto/
â”‚   â””â”€â”€ notifications.dto.ts                # Ø¬Ù…ÙŠØ¹ DTOs
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ notifications.service.ts            # Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
â”‚   â”œâ”€â”€ template.service.ts                 # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
â”‚   â”œâ”€â”€ preference.service.ts               # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª
â”‚   â””â”€â”€ webhook.service.ts                  # Ø¥Ø¯Ø§Ø±Ø© Webhooks
â”œâ”€â”€ ports/
â”‚   â”œâ”€â”€ push.port.ts                        # Push notifications
â”‚   â”œâ”€â”€ sms.port.ts                         # SMS
â”‚   â””â”€â”€ email.port.ts                       # Email
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ notifications.controller.ts         # User endpoints
â”‚   â””â”€â”€ admin.notifications.controller.ts   # Admin endpoints
â””â”€â”€ notifications.module.ts
```

## ğŸ”Œ API Endpoints

### Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

#### 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
```http
GET /api/notifications
Query Parameters:
  - page: number (default: 1)
  - limit: number (default: 20)
  - channel: inApp|push|sms|email
  - status: pending|sent|read|failed
  - unreadOnly: boolean
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "_id": "notification_id",
      "title": "Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„",
      "body": "Ø·Ù„Ø¨Ùƒ #ORD-2024-00123 ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„ÙŠÙƒ",
      "channel": "inApp",
      "status": "sent",
      "actionUrl": "/orders/ORD-2024-00123",
      "imageUrl": "https://...",
      "sentAt": "2024-01-15T10:30:00Z",
      "readAt": null,
      "createdAt": "2024-01-15T10:30:00Z"
    }
  ],
  "meta": {
    "page": 1,
    "limit": 20,
    "total": 45,
    "unread": 12
  }
}
```

#### 2. Ø¹Ø¯Ø¯ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡
```http
GET /api/notifications/unread-count
```

**Response:**
```json
{
  "success": true,
  "data": {
    "total": 12,
    "byChannel": {
      "inApp": 8,
      "push": 0,
      "email": 4
    },
    "byCategory": {
      "order": 5,
      "promotion": 3,
      "system": 4
    }
  }
}
```

#### 3. ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù‚Ø±ÙˆØ¡
```http
POST /api/notifications/mark-read
Content-Type: application/json

{
  "notificationIds": ["id1", "id2"]
}
```

#### 4. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
```http
POST /api/notifications/mark-all-read
Content-Type: application/json

{
  "channel": "inApp"  // optional
}
```

#### 5. Ø­Ø°Ù Ø¥Ø´Ø¹Ø§Ø±
```http
DELETE /api/notifications/:id
```

#### 6. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª
```http
GET /api/notifications/preferences
```

**Response:**
```json
{
  "success": true,
  "data": {
    "enableNotifications": true,
    "enableInApp": true,
    "enablePush": true,
    "enableSms": false,
    "enableEmail": true,
    "quietHours": {
      "enabled": true,
      "startTime": "22:00",
      "endTime": "08:00",
      "timezone": "Asia/Riyadh"
    },
    "categoryPreferences": {
      "order": {
        "inApp": true,
        "push": true,
        "sms": false,
        "email": true
      },
      "promotion": {
        "inApp": true,
        "push": false,
        "sms": false,
        "email": false
      }
    }
  }
}
```

#### 7. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª
```http
PUT /api/notifications/preferences
Content-Type: application/json

{
  "enablePush": false,
  "quietHours": {
    "enabled": true,
    "startTime": "23:00",
    "endTime": "07:00"
  },
  "categoryPreferences": {
    "promotion": {
      "push": false,
      "email": false
    }
  }
}
```

#### 8. ØªØ³Ø¬ÙŠÙ„ Ø¬Ù‡Ø§Ø² (Device Token)
```http
POST /api/notifications/devices/register
Content-Type: application/json

{
  "platform": "ios",
  "token": "device_fcm_token_here",
  "deviceName": "iPhone 13 Pro",
  "appVersion": "1.0.0"
}
```

#### 9. Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø¬Ù‡Ø§Ø²
```http
DELETE /api/notifications/devices/:tokenId
```

### Ù„Ù„Ø£Ø¯Ù…Ù†

#### 1. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø®ØµØµ
```http
POST /api/admin/notifications/send
Content-Type: application/json

{
  "targetUsers": ["user_id_1", "user_id_2"],
  "targetRoles": ["customer"],
  "templateKey": "custom.announcement",
  "channels": ["inApp", "push", "email"],
  "variables": {
    "title": "Ø¹Ø±Ø¶ Ø®Ø§Øµ",
    "message": "Ø®ØµÙ… 30% Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª"
  },
  "priority": "high",
  "scheduleAt": "2024-01-20T10:00:00Z"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "jobId": "job_123",
    "targetCount": 1500,
    "estimatedDelivery": "2024-01-20T10:00:00Z",
    "channels": ["inApp", "push", "email"]
  }
}
```

#### 2. Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ (Broadcast)
```http
POST /api/admin/notifications/broadcast
Content-Type: application/json

{
  "templateKey": "promotion.flash_sale",
  "channels": ["inApp", "push"],
  "filters": {
    "roles": ["customer"],
    "hasOrders": true,
    "minOrderCount": 1
  },
  "variables": {
    "discount": "50",
    "endTime": "23:59"
  }
}
```

#### 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨

##### Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨
```http
POST /api/admin/notifications/templates
Content-Type: application/json

{
  "key": "order.delivered",
  "name": "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨",
  "nameEn": "Order Delivered",
  "category": "order",
  "priority": "high",
  "enabledChannels": ["inApp", "push", "sms", "email"],
  "variables": ["orderNumber", "customerName", "deliveryAddress"],
  "inApp": {
    "titleAr": "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø·Ù„Ø¨Ùƒ",
    "titleEn": "Your Order Delivered",
    "bodyAr": "Ø·Ù„Ø¨Ùƒ {{orderNumber}} ØªÙ… ØªØ³Ù„ÙŠÙ…Ù‡ Ø¨Ù†Ø¬Ø§Ø­",
    "bodyEn": "Your order {{orderNumber}} has been delivered",
    "actionUrl": "/orders/{{orderNumber}}"
  },
  "push": {
    "titleAr": "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…",
    "titleEn": "Delivered âœ…",
    "bodyAr": "Ø·Ù„Ø¨Ùƒ {{orderNumber}} ÙˆØµÙ„ Ø¨Ø³Ù„Ø§Ù…",
    "bodyEn": "Your order {{orderNumber}} arrived safely"
  },
  "email": {
    "subjectAr": "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø·Ù„Ø¨Ùƒ {{orderNumber}}",
    "subjectEn": "Your order {{orderNumber}} has been delivered",
    "htmlAr": "<html>...</html>",
    "htmlEn": "<html>...</html>"
  }
}
```

##### Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
```http
GET /api/admin/notifications/templates
Query Parameters:
  - category: order|product|promotion|account|system
  - isActive: boolean
  - page: number
  - limit: number
```

##### ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ù„Ø¨
```http
PUT /api/admin/notifications/templates/:key
```

##### Ø­Ø°Ù Ù‚Ø§Ù„Ø¨
```http
DELETE /api/admin/notifications/templates/:key
```

#### 4. Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±

##### Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©
```http
GET /api/admin/notifications/stats
Query Parameters:
  - startDate: YYYY-MM-DD
  - endDate: YYYY-MM-DD
  - channel: inApp|push|sms|email
  - category: order|product|promotion
```

**Response:**
```json
{
  "success": true,
  "data": {
    "overview": {
      "totalSent": 125000,
      "totalDelivered": 120000,
      "totalRead": 85000,
      "totalClicked": 35000,
      "totalFailed": 5000
    },
    "byChannel": {
      "inApp": {
        "sent": 50000,
        "read": 40000,
        "readRate": 80
      },
      "push": {
        "sent": 45000,
        "delivered": 43000,
        "deliveryRate": 95.6
      },
      "email": {
        "sent": 25000,
        "opened": 12000,
        "openRate": 48,
        "clicked": 5000,
        "clickRate": 20
      },
      "sms": {
        "sent": 5000,
        "delivered": 4900,
        "deliveryRate": 98
      }
    },
    "topTemplates": [
      {
        "key": "order.shipped",
        "sent": 25000,
        "readRate": 85,
        "clickRate": 45
      }
    ],
    "performance": {
      "averageDeliveryTime": 2.5,
      "averageReadTime": 15.3
    }
  }
}
```

##### Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ù„Ø¨ Ù…Ø­Ø¯Ø¯
```http
GET /api/admin/notifications/templates/:key/stats
```

##### Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
```http
GET /api/admin/notifications/logs
Query Parameters:
  - userId: string
  - channel: string
  - status: string
  - templateKey: string
  - startDate: string
  - endDate: string
  - page: number
  - limit: number
```

#### 5. Ø¥Ø¯Ø§Ø±Ø© Webhooks

##### Ø¥Ù†Ø´Ø§Ø¡ webhook
```http
POST /api/admin/notifications/webhooks
Content-Type: application/json

{
  "name": "Order Notifications Webhook",
  "url": "https://api.example.com/webhooks/notifications",
  "events": [
    "notification.sent",
    "notification.delivered",
    "notification.read"
  ],
  "authentication": {
    "type": "bearer",
    "token": "your_bearer_token"
  },
  "filters": {
    "channels": ["push", "email"],
    "templateKeys": ["order.created", "order.shipped"]
  }
}
```

##### Ù‚Ø§Ø¦Ù…Ø© Webhooks
```http
GET /api/admin/notifications/webhooks
```

##### ØªØ­Ø¯ÙŠØ« webhook
```http
PUT /api/admin/notifications/webhooks/:id
```

##### Ø­Ø°Ù webhook
```http
DELETE /api/admin/notifications/webhooks/:id
```

##### Ø§Ø®ØªØ¨Ø§Ø± webhook
```http
POST /api/admin/notifications/webhooks/:id/test
```

## ğŸ“Š Schemas & Data Models

### 1. NotificationLog Schema
```typescript
{
  userId: ObjectId,
  templateId: ObjectId,
  templateKey: string,
  channel: 'inApp' | 'push' | 'sms' | 'email',
  status: 'pending' | 'queued' | 'sending' | 'sent' | 'delivered' | 'read' | 'clicked' | 'failed',
  
  title: string,
  body: string,
  data: object,
  actionUrl?: string,
  imageUrl?: string,
  
  recipientEmail?: string,
  recipientPhone?: string,
  deviceToken?: string,
  platform?: 'ios' | 'android' | 'web',
  
  scheduledAt?: Date,
  sentAt?: Date,
  deliveredAt?: Date,
  readAt?: Date,
  clickedAt?: Date,
  failedAt?: Date,
  
  errorMessage?: string,
  errorCode?: string,
  retryCount: number,
  
  trackingId?: string,
  externalId?: string,
  
  metadata: {
    provider?: string,
    cost?: number,
    campaign?: string
  },
  
  priority: 'low' | 'medium' | 'high' | 'urgent',
  groupId?: string,
  batchId?: string
}
```

### 2. NotificationTemplate Schema
```typescript
{
  key: string,                  // unique identifier
  name: string,
  nameEn: string,
  category: 'order' | 'product' | 'promotion' | 'account' | 'system',
  priority: 'low' | 'medium' | 'high' | 'urgent',
  
  inApp?: {
    titleAr: string,
    titleEn: string,
    bodyAr: string,
    bodyEn: string,
    actionUrl?: string,
    icon?: string,
    image?: string
  },
  
  push?: {
    titleAr: string,
    titleEn: string,
    bodyAr: string,
    bodyEn: string,
    sound?: string,
    badge?: number
  },
  
  sms?: {
    messageAr: string,
    messageEn: string,
    senderId?: string
  },
  
  email?: {
    subjectAr: string,
    subjectEn: string,
    htmlAr: string,
    htmlEn: string
  },
  
  variables: string[],
  enabledChannels: string[],
  isActive: boolean,
  
  stats: {
    totalSent: number,
    totalRead: number,
    totalClicked: number
  }
}
```

### 3. NotificationPreference Schema
```typescript
{
  userId: ObjectId,
  
  enableNotifications: boolean,
  enableInApp: boolean,
  enablePush: boolean,
  enableSms: boolean,
  enableEmail: boolean,
  
  quietHours?: {
    enabled: boolean,
    startTime: string,
    endTime: string,
    timezone: string
  },
  
  categoryPreferences: {
    order?: { inApp, push, sms, email },
    product?: { inApp, push, sms, email },
    promotion?: { inApp, push, sms, email }
  },
  
  mutedTemplates: string[],
  priorityTemplates: string[],
  
  preferredLanguage: 'ar' | 'en',
  
  frequencyLimits?: {
    maxNotificationsPerDay?: number,
    maxEmailsPerWeek?: number
  }
}
```

## ğŸ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ (Templates)

### Ù‚ÙˆØ§Ù„Ø¨ Ø¬Ø§Ù‡Ø²Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹

#### Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Orders)
- `order.created` - Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
- `order.confirmed` - ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
- `order.processing` - Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
- `order.shipped` - ØªÙ… Ø§Ù„Ø´Ø­Ù†
- `order.out_for_delivery` - ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ù„Ù„ØªØ³Ù„ÙŠÙ…
- `order.delivered` - ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…
- `order.completed` - Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨
- `order.cancelled` - Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
- `order.refunded` - Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº

#### Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Products)
- `product.back_in_stock` - Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
- `product.price_drop` - Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø³Ø¹Ø±
- `product.low_stock` - Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶
- `product.new_arrival` - Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©

#### Ø§Ù„Ø¹Ø±ÙˆØ¶ (Promotions)
- `promotion.new` - Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯
- `promotion.expiring_soon` - ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹
- `promotion.exclusive` - Ø¹Ø±Ø¶ Ø­ØµØ±ÙŠ
- `promotion.flash_sale` - ØªØ®ÙÙŠØ¶Ø§Øª Ø³Ø±ÙŠØ¹Ø©

#### Ø§Ù„Ø­Ø³Ø§Ø¨ (Account)
- `account.welcome` - ØªØ±Ø­ÙŠØ¨
- `account.verification` - ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯
- `account.password_reset` - Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
- `account.profile_updated` - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù
- `account.suspicious_activity` - Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡

#### Ø§Ù„Ù†Ø¸Ø§Ù… (System)
- `system.maintenance` - ØµÙŠØ§Ù†Ø©
- `system.update` - ØªØ­Ø¯ÙŠØ«
- `system.announcement` - Ø¥Ø¹Ù„Ø§Ù†

### Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ (Variables)

Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨:

```typescript
// Order related
{
  orderNumber: "ORD-2024-00123",
  customerName: "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯",
  totalAmount: "2500",
  currency: "YER",
  itemsCount: "5",
  deliveryAddress: "Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©",
  trackingNumber: "TRACK-123456",
  estimatedDelivery: "2024-01-20"
}

// Product related
{
  productName: "Solar Panel 300W",
  productImage: "https://...",
  oldPrice: "3000",
  newPrice: "2500",
  discount: "500",
  discountPercentage: "17"
}

// User related
{
  userName: "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯",
  userEmail: "ahmad@example.com",
  userPhone: "+966501234567"
}

// Coupon related
{
  couponCode: "SUMMER2024",
  couponDiscount: "30",
  couponExpiry: "2024-06-30"
}
```

### Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª

ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ØŒ Ø§Ø³ØªØ®Ø¯Ù… `{{variableName}}` Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª:

```
Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: "Ø·Ù„Ø¨Ùƒ {{orderNumber}} Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„"
Ø§Ù„Ù†Øµ: "Ø¹Ø²ÙŠØ²ÙŠ {{customerName}}ØŒ Ø·Ù„Ø¨Ùƒ Ø¨Ù‚ÙŠÙ…Ø© {{totalAmount}} {{currency}} ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ"
```

## âš™ï¸ Ø§Ù„ØªÙƒÙˆÙŠÙ† ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª

### Environment Variables

```env
# Firebase Cloud Messaging (Push)
FCM_SERVER_KEY=your_fcm_server_key
FCM_SENDER_ID=your_sender_id

# SMS Provider (Twilio/etc)
SMS_PROVIDER=twilio
SMS_ACCOUNT_SID=your_account_sid
SMS_AUTH_TOKEN=your_auth_token
SMS_FROM_NUMBER=+1234567890

# Email Provider (SendGrid/etc)
EMAIL_PROVIDER=sendgrid
EMAIL_API_KEY=your_sendgrid_api_key
EMAIL_FROM_NAME=Tagadodo
EMAIL_FROM_EMAIL=noreply@tagadodo.com

# Notification Settings
NOTIFICATIONS_ENABLED=true
NOTIFICATIONS_BATCH_SIZE=100
NOTIFICATIONS_RETRY_ATTEMPTS=3
NOTIFICATIONS_RETRY_DELAY=60000
```

### Module Configuration

```typescript
// notifications.module.ts
@Module({
  imports: [
    MongooseModule.forFeature([
      { name: NotificationLog.name, schema: NotificationLogSchema },
      { name: NotificationTemplate.name, schema: NotificationTemplateSchema },
      { name: NotificationPreference.name, schema: NotificationPreferenceSchema },
      { name: NotificationWebhook.name, schema: NotificationWebhookSchema },
      { name: DeviceToken.name, schema: DeviceTokenSchema },
    ]),
    BullModule.registerQueue({
      name: 'notifications',
    }),
    CacheModule,
  ],
  controllers: [NotificationsController, AdminNotificationsController],
  providers: [
    NotificationsService,
    TemplateService,
    PreferenceService,
    WebhookService,
    PushNotificationPort,
    SmsPort,
    EmailPort,
  ],
  exports: [NotificationsService],
})
```

## ğŸš€ Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

### ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (Service Layer)

#### 1. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ·
```typescript
await this.notificationsService.send({
  userId: 'user_id',
  templateKey: 'order.created',
  channels: ['inApp', 'push'],
  variables: {
    orderNumber: 'ORD-2024-00123',
    customerName: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯',
    totalAmount: '2500'
  }
});
```

#### 2. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¬Ø¯ÙˆÙ„
```typescript
await this.notificationsService.sendScheduled({
  userId: 'user_id',
  templateKey: 'order.delivery_reminder',
  channels: ['push', 'sms'],
  variables: { orderNumber: 'ORD-2024-00123' },
  scheduleAt: new Date('2024-01-20T10:00:00Z')
});
```

#### 3. Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ
```typescript
await this.notificationsService.sendBroadcast({
  templateKey: 'promotion.flash_sale',
  channels: ['push'],
  filters: {
    roles: ['customer'],
    hasOrders: true
  },
  variables: {
    discount: '50',
    endTime: '23:59'
  }
});
```

#### 4. Ø¥Ø±Ø³Ø§Ù„ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
```typescript
await this.notificationsService.sendBulk({
  userIds: ['user1', 'user2', 'user3'],
  templateKey: 'product.back_in_stock',
  channels: ['inApp', 'email'],
  variables: {
    productName: 'Solar Panel 300W',
    productUrl: '/products/solar-panel-300w'
  }
});
```

## ğŸ“ˆ Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª

### Event Tracking

ØªØªØ¨Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø­Ø¯Ø§Ø«:
- `notification.created` - Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
- `notification.queued` - Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø·Ø§Ø¨ÙˆØ±
- `notification.sending` - Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
- `notification.sent` - Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­
- `notification.delivered` - Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… (Push/SMS/Email)
- `notification.read` - Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
- `notification.clicked` - Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
- `notification.failed` - Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
- `notification.bounced` - Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ (Email)

### Metrics & KPIs

Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…ØªÙˆÙØ±Ø©:
- **Delivery Rate**: Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…
- **Open Rate**: Ù†Ø³Ø¨Ø© Ø§Ù„ÙØªØ­
- **Click Rate**: Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø±
- **Conversion Rate**: Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„
- **Bounce Rate**: Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯
- **Average Read Time**: Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
- **Average Response Time**: Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©

## ğŸ”’ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©

### Data Protection
- ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
- Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 90 ÙŠÙˆÙ…
- Soft delete Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
- GDPR compliance

### Rate Limiting
```typescript
// Per user limits
maxNotificationsPerDay: 100,
maxEmailsPerWeek: 20,
maxSmsPerMonth: 10,
maxPushPerHour: 10
```

### Authentication & Authorization
- JWT authentication Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ endpoints
- Role-based access control
- Admin-only endpoints
- User-specific data isolation

## ğŸ¯ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª

### 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
âœ… **Ø§ÙØ¹Ù„**: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹
âŒ **Ù„Ø§ ØªÙØ¹Ù„**: Ù„Ø§ ØªØ±Ø³Ù„ Ù…Ø­ØªÙˆÙ‰ Ù…Ø¨Ø§Ø´Ø±

### 2. Ø§Ø­ØªØ±Ø§Ù… ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
âœ… **Ø§ÙØ¹Ù„**: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
âŒ **Ù„Ø§ ØªÙØ¹Ù„**: Ù„Ø§ ØªØ±Ø³Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø£ÙˆÙ‚ÙÙˆØ§ Ù†ÙˆØ¹ Ù…Ø¹ÙŠÙ†

### 3. Quiet Hours
âœ… **Ø§ÙØ¹Ù„**: Ø§Ø­ØªØ±Ù… Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù‡Ø¯ÙˆØ¡
âŒ **Ù„Ø§ ØªÙØ¹Ù„**: Ù„Ø§ ØªØ±Ø³Ù„ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ Ø¥Ù„Ø§ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©

### 4. Ø§Ù„ØªØ®ØµÙŠØµ
âœ… **Ø§ÙØ¹Ù„**: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
âŒ **Ù„Ø§ ØªÙØ¹Ù„**: Ù„Ø§ ØªØ±Ø³Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø§Ù…Ø©

### 5. Ø§Ù„ØªÙˆÙ‚ÙŠØª
âœ… **Ø§ÙØ¹Ù„**: Ø£Ø±Ø³Ù„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
âŒ **Ù„Ø§ ØªÙØ¹Ù„**: Ù„Ø§ ØªØ±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠØ©

## ğŸ› ï¸ Troubleshooting

### Ù…Ø´Ø§ÙƒÙ„ Ø´Ø§Ø¦Ø¹Ø© ÙˆØ­Ù„ÙˆÙ„Ù‡Ø§

#### 1. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø§ ØªÙØ±Ø³Ù„
```bash
# ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø©
GET /api/admin/notifications/health

# ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
GET /api/admin/notifications/queue/status

# ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª
GET /api/notifications/preferences
```

#### 2. Push Notifications Ù„Ø§ ØªØ¹Ù…Ù„
- ØªØ­Ù‚Ù‚ Ù…Ù† FCM credentials
- ØªØ­Ù‚Ù‚ Ù…Ù† Device tokens
- ØªØ­Ù‚Ù‚ Ù…Ù† SSL certificates
- Ø±Ø§Ø¬Ø¹ console errors

#### 3. Email Ù„Ø§ ÙŠØµÙ„
- ØªØ­Ù‚Ù‚ Ù…Ù† SMTP settings
- Ø±Ø§Ø¬Ø¹ spam folder
- ØªØ­Ù‚Ù‚ Ù…Ù† email template
- Ø±Ø§Ø¬Ø¹ provider logs

## ğŸ“š Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯

### Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
- [Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging)
- [Twilio SMS](https://www.twilio.com/docs/sms)
- [SendGrid Email](https://docs.sendgrid.com/)

### Ø§Ù„Ø£Ø¯ÙˆØ§Øª
- [Postman Collection](./postman/notifications.json)
- [Template Editor](./tools/template-editor)
- [Test Console](./tools/test-console)

---

## ğŸ‰ Ø§Ù„Ø®Ù„Ø§ØµØ©

Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠ Ø´Ø§Ù…Ù„ ÙŠØ¯Ø¹Ù…:
- âœ… Ù‚Ù†ÙˆØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (In-App, Push, SMS, Email)
- âœ… Ù‚ÙˆØ§Ù„Ø¨ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ®ØµÙŠØµ
- âœ… ØªÙØ¶ÙŠÙ„Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªÙ‚Ø¯Ù…Ø©
- âœ… Ø¬Ø¯ÙˆÙ„Ø© Ø°ÙƒÙŠØ©
- âœ… ØªØªØ¨Ø¹ ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø©
- âœ… Webhooks Ù„Ù„ØªÙƒØ§Ù…Ù„
- âœ… Ø£Ø¯Ø§Ø¡ Ø¹Ø§Ù„ÙŠ ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„ØªÙˆØ³Ø¹
- âœ… Ø¢Ù…Ù† ÙˆÙ…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ GDPR

**Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙˆØ±ÙŠ!** ğŸš€

---

**Ø§Ù„Ù†Ø³Ø®Ø©**: 1.0.0  
**Ø§Ù„Ø­Ø§Ù„Ø©**: âœ… Production Ready  
**Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«**: 2024-01-15

