# Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ ğŸ›’
# Professional Cart System - Complete Guide

## âœ… ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!

ØªÙ… ØªØ­ÙˆÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø© Ù…Ù† Ù†Ø¸Ø§Ù… Ø¨Ø³ÙŠØ· Ø¥Ù„Ù‰ **Ù†Ø¸Ø§Ù… Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø·Ù„Ù‚** Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©.

---

## ğŸ¯ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ù…Ù†ÙØ°Ø©

### 1ï¸âƒ£ **Ø¯Ø¹Ù… Guest Cart (Ø³Ù„Ø© Ø§Ù„Ø²ÙˆØ§Ø±)** âœ…
```
- Ø§Ù„Ø³Ù„Ø© Ù…ØªØ§Ø­Ø© Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨ (deviceId ÙÙ‚Ø·)
- ÙŠÙ…ÙƒÙ† Ù„Ù„Ø²Ø§Ø¦Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª
- Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â†’ Ø¯Ù…Ø¬ Ø§Ù„Ø³Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
- Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ø¹Ø¯ 30 ÙŠÙˆÙ…
```

### 2ï¸âƒ£ **Ø¯Ø¹Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„** âœ…
```
- ØªØ·Ø¨ÙŠÙ‚ ÙƒÙˆØ¨ÙˆÙ† ÙŠØ¯ÙˆÙŠ
- ÙƒÙˆØ¨ÙˆÙ†Ø§Øª ØªØ·Ø¨Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (auto-apply)
- Ø¯Ù…Ø¬ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (stackable)
- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
```

### 3ï¸âƒ£ **Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ** âœ…
```
- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† VariantPrice
- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ© (Promotions)
- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
- Ø¯Ø¹Ù… Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¬Ù…Ù„Ø© (wholesale)
- Cache Ù„Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
```

### 4ï¸âƒ£ **Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙŠØ© (Abandoned Carts)** âœ…
```
- ØªØªØ¨Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø³Ù„Ø§Øª Ø§Ù„ØºÙŠØ± Ù†Ø´Ø·Ø©
- Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
- ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù„Ø£Ø¯Ù…Ù† Ø¹Ù† Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙŠØ©
- Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ù„Ø© Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
```

### 5ï¸âƒ£ **ØªØªØ¨Ø¹ ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª Ø´Ø§Ù…Ù„Ø©** âœ…
```
- ØªØªØ¨Ø¹ ÙƒÙ„ Ù†Ø´Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
- Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…ØµØ¯Ø± (web/mobile/app)
- UTM tracking (campaign, source, medium)
- ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ù„Ø·Ù„Ø¨ (conversion tracking)
- Ø¹Ø¯Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø±Ø³Ù„Ø©
```

### 6ï¸âƒ£ **Product Snapshot** âœ…
```
- Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ù„Ø©
- Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
- Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ ØªØºÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬
```

### 7ï¸âƒ£ **Pricing Summary** âœ…
```
- Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ
- Ø®ØµÙ… Ø§Ù„Ø¹Ø±ÙˆØ¶
- Ø®ØµÙ… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
- Ø§Ù„Ø®ØµÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
- Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
- Cache Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª
```

---

## ğŸ“Š Cart Schema Ø§Ù„Ø¬Ø¯ÙŠØ¯

```typescript
Cart {
  // Ø§Ù„ØªØ¹Ø±ÙŠÙ
  userId?: ObjectId                 // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
  deviceId?: string                 // Ù„Ù„Ø²ÙˆØ§Ø±
  status: CartStatus                // active/abandoned/converted/expired
  
  // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  items: CartItem[] {
    variantId: ObjectId
    productId: ObjectId
    qty: number
    addedAt: Date
    
    // ğŸ†• Product Snapshot
    productSnapshot: {
      name: string
      slug: string
      image: string
      brandId: string
      brandName: string
      categoryId: string
    }
    
    // ğŸ†• Pricing Cache
    pricing: {
      currency: string
      basePrice: number
      finalPrice: number
      discount: number
      appliedPromotionId: string
    }
  }
  
  // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  currency: string                  // Ø§Ù„Ø¹Ù…Ù„Ø©
  accountType?: string              // Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨
  
  // ğŸ†• Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
  appliedCouponCode?: string        // Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø§Ù„Ù…Ø·Ø¨Ù‚
  couponDiscount: number            // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…
  autoAppliedCouponCodes: []        // ÙƒÙˆØ¨ÙˆÙ†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  autoAppliedDiscounts: []          // Ø®ØµÙˆÙ…Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  
  // ğŸ†• Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Ù…Ø­ÙÙˆØ¸ Ù„Ù„Ø³Ø±Ø¹Ø©)
  pricingSummary: {
    subtotal: number
    promotionDiscount: number
    couponDiscount: number
    autoDiscount: number
    totalDiscount: number
    total: number
    itemsCount: number
    currency: string
    lastCalculatedAt: Date
  }
  
  // ğŸ†• ØªØªØ¨Ø¹ Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙŠØ©
  lastActivityAt: Date              // Ø¢Ø®Ø± Ù†Ø´Ø§Ø·
  isAbandoned: boolean              // Ù…Ù†Ø³ÙŠØ©ØŸ
  abandonmentEmailsSent: number     // Ø¹Ø¯Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ±
  lastAbandonmentEmailAt: Date      // Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
  
  // ğŸ†• ØªØªØ¨Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„
  convertedToOrderId?: ObjectId     // ØªØ­ÙˆÙ„Øª Ù„Ø·Ù„Ø¨
  convertedAt?: Date                // Ù…ØªÙ‰ ØªØ­ÙˆÙ„Øª
  
  // ğŸ†• Ø¯Ù…Ø¬ Ø§Ù„Ø³Ù„Ø§Øª
  isMerged: boolean                 // ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ØŸ
  mergedIntoUserId?: ObjectId       // Ø¯ÙÙ…Ø¬Øª ÙÙŠ Ø³Ù„Ø© Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…
  mergedAt?: Date                   // Ù…ØªÙ‰ Ø¯ÙÙ…Ø¬Øª
  
  // ğŸ†• Metadata
  metadata: {
    source: string                  // web/mobile/app
    campaign: string
    referrer: string
    utmSource: string
    utmMedium: string
    utmCampaign: string
  }
  
  // ğŸ†• Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
  expiresAt?: Date                  // Ù…ØªÙ‰ ØªÙ†ØªÙ‡ÙŠ
  
  createdAt: Date
  updatedAt: Date
}
```

---

## ğŸ”„ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©

### Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: Ø²Ø§Ø¦Ø± (Guest) â†’ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„

```javascript
// 1. Ø²Ø§Ø¦Ø± ÙŠØ¶ÙŠÙ Ù…Ù†ØªØ¬Ø§Øª (Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨)
POST /cart/guest/items
{
  "deviceId": "device_abc123",
  "variantId": "var_456",
  "qty": 2
}

Response:
{
  "success": true,
  "data": {
    "cart": {
      "deviceId": "device_abc123",
      "items": [
        {
          "variantId": "var_456",
          "qty": 2,
          "productSnapshot": {
            "name": "iPhone 15 Pro",
            "image": "...",
            "brandName": "Apple"
          },
          "pricing": {
            "basePrice": 500000,
            "finalPrice": 450000,  // Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶
            "discount": 50000
          }
        }
      ],
      "pricingSummary": {
        "subtotal": 900000,
        "promotionDiscount": 100000,
        "total": 900000
      }
    }
  }
}

// 2. Ø²Ø§Ø¦Ø± ÙŠØ·Ø¨Ù‚ ÙƒÙˆØ¨ÙˆÙ†
POST /cart/guest/apply-coupon
{
  "deviceId": "device_abc123",
  "couponCode": "SUMMER20"
}

Response:
{
  "pricingSummary": {
    "subtotal": 900000,
    "promotionDiscount": 100000,  // Ø§Ù„Ø¹Ø±ÙˆØ¶
    "couponDiscount": 180000,     // Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† 20%
    "total": 720000
  }
}

// 3. Ø²Ø§Ø¦Ø± ÙŠÙ‚Ø±Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
POST /auth/register
{ ... }

// 4. Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â†’ Ø¯Ù…Ø¬ Ø§Ù„Ø³Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
POST /cart/merge
{
  "deviceId": "device_abc123"
}

Response:
{
  "success": true,
  "message": "Cart merged successfully",
  "data": {
    "mergedItems": 2,
    "cart": {
      "userId": "user_789",
      "items": [...],  // Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© + Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      "pricingSummary": {...}
    }
  }
}

// 5. Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¢Ù† Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… âœ…
// 6. Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…Ø·Ø¨Ù‚ âœ…
```

---

### Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 2: ØªØ·Ø¨ÙŠÙ‚ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©

```javascript
// Ø§Ù„Ø³Ù„Ø©:
Subtotal: 200,000 YER

// 1. Ø¹Ø±Ø¶ ØªØ±ÙˆÙŠØ¬ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ (20% off)
Promotion Discount: -40,000 YER
After Promotion: 160,000 YER

// 2. ÙƒÙˆØ¨ÙˆÙ† ÙŠØ¯ÙˆÙŠ (SUMMER10 = 10% off)
POST /cart/apply-coupon
{ "couponCode": "SUMMER10" }

Coupon Discount: -16,000 YER (10% Ù…Ù† 160,000)
After Coupon: 144,000 YER

// 3. ÙƒÙˆØ¨ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠ (MEMBER5 = 5% off, auto-apply)
GET /cart

Auto Discount: -7,200 YER (5% Ù…Ù† 144,000)
Final Total: 136,800 YER

// Ø§Ù„Ù…Ù„Ø®Øµ:
{
  "subtotal": 200000,
  "promotionDiscount": 40000,
  "couponDiscount": 16000,
  "autoDiscount": 7200,
  "totalDiscount": 63200,
  "total": 136800,
  "savings": 63200
}
```

---

### Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 3: Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙŠØ©

```javascript
// 1. Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ÙŠÙ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø³Ù„Ø©
POST /cart/items
{ "variantId": "...", "qty": 2 }

// 2. ÙŠØºØ§Ø¯Ø± Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø§Ø¡
// lastActivityAt: 2024-01-01 10:00

// 3. Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø© â†’ Cron Job ÙŠÙØ­Øµ
Job: checkAbandonedCarts()

// ÙŠØ¬Ø¯ Ø§Ù„Ø³Ù„Ø© ØºÙŠØ± Ù†Ø´Ø·Ø©:
if (now - lastActivityAt > 24 hours) {
  cart.isAbandoned = true
  
  // ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ°ÙƒÙŠØ± Ø£ÙˆÙ„Ù‰
  sendEmail({
    to: user.email,
    subject: "Ù†Ø³ÙŠØª Ø´ÙŠØ¦Ø§Ù‹ ÙÙŠ Ø³Ù„ØªÙƒ! ğŸ›’",
    body: "Ù„Ø¯ÙŠÙƒ {itemsCount} Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø³Ù„ØªÙƒ..."
  })
  
  cart.abandonmentEmailsSent = 1
  cart.lastAbandonmentEmailAt = now
}

// 4. Ø¨Ø¹Ø¯ 48 Ø³Ø§Ø¹Ø© â†’ Ø±Ø³Ø§Ù„Ø© Ø«Ø§Ù†ÙŠØ© Ù…Ø¹ ÙƒÙˆØ¨ÙˆÙ† Ø®Ø§Øµ
if (abandonmentEmailsSent === 1 && timeSinceLastEmail > 24 hours) {
  sendEmail({
    subject: "Ø®ØµÙ… Ø®Ø§Øµ 10% Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ!",
    body: "Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯: COMEBACK10",
    couponCode: "COMEBACK10"
  })
  
  cart.abandonmentEmailsSent = 2
}

// 5. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¹ÙˆØ¯ ÙˆÙŠÙƒÙ…Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡
POST /checkout
â†’ cart.status = 'converted'
â†’ cart.convertedToOrderId = order._id
â†’ cart.convertedAt = now
```

---

## ğŸ“Š API Endpoints Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

### User Cart (Ù…Ø­Ù…ÙŠØ© - JWT Required)

#### 1. Get Cart
```http
GET /cart
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "cart": {
      "items": [...],
      "currency": "YER",
      "appliedCouponCode": "SUMMER20",
      "pricingSummary": {
        "subtotal": 200000,
        "promotionDiscount": 40000,
        "couponDiscount": 32000,
        "autoDiscount": 0,
        "totalDiscount": 72000,
        "total": 128000,
        "itemsCount": 3,
        "currency": "YER"
      }
    }
  }
}
```

#### 2. Add Item
```http
POST /cart/items
Authorization: Bearer {token}

Body:
{
  "variantId": "65abc123def",
  "qty": 2
}

Response:
{
  "success": true,
  "message": "Item added to cart",
  "data": {...cart with new item}
}
```

#### 3. Update Item Quantity
```http
PATCH /cart/items/:itemId
Authorization: Bearer {token}

Body:
{
  "qty": 5
}
```

#### 4. Remove Item
```http
DELETE /cart/items/:itemId
Authorization: Bearer {token}
```

#### 5. Clear Cart
```http
DELETE /cart
Authorization: Bearer {token}
```

#### 6. Apply Coupon
```http
POST /cart/apply-coupon
Authorization: Bearer {token}

Body:
{
  "couponCode": "SUMMER20"
}

Response:
{
  "success": true,
  "message": "Coupon applied successfully. You saved 32,000 YER!",
  "data": {
    "cart": {...},
    "appliedCoupon": {
      "code": "SUMMER20",
      "discount": 32000,
      "type": "percentage",
      "discountPercentage": 20
    }
  }
}
```

#### 7. Remove Coupon
```http
DELETE /cart/coupon
Authorization: Bearer {token}
```

#### 8. Get Cart Summary
```http
GET /cart/summary
Authorization: Bearer {token}

Response:
{
  "itemsCount": 5,
  "subtotal": 500000,
  "totalDiscount": 120000,
  "total": 380000,
  "hasItems": true,
  "appliedCoupon": "SUMMER20"
}
```

---

### Guest Cart (Ø¨Ø¯ÙˆÙ† Ø­Ù…Ø§ÙŠØ© - Public)

#### 1. Get Guest Cart
```http
GET /cart/guest?deviceId=device_abc123

Response:
{
  "success": true,
  "data": {
    "cart": {
      "deviceId": "device_abc123",
      "items": [...],
      "pricingSummary": {...}
    }
  }
}
```

#### 2. Add Item (Guest)
```http
POST /cart/guest/items

Body:
{
  "deviceId": "device_abc123",
  "variantId": "var_456",
  "qty": 1,
  "metadata": {
    "source": "mobile",
    "utmSource": "facebook",
    "utmCampaign": "summer_sale"
  }
}
```

#### 3. Apply Coupon (Guest)
```http
POST /cart/guest/apply-coupon

Body:
{
  "deviceId": "device_abc123",
  "couponCode": "WELCOME10"
}
```

#### 4. Get Preview with Pricing (Guest)
```http
POST /cart/guest/preview

Body:
{
  "deviceId": "device_abc123",
  "currency": "YER",
  "couponCode": "SUMMER20"
}

Response:
{
  "currency": "YER",
  "items": [
    {
      "variantId": "var_456",
      "qty": 2,
      "productSnapshot": {
        "name": "iPhone 15 Pro",
        "brandName": "Apple",
        "image": "..."
      },
      "basePrice": 500000,
      "finalPrice": 450000,
      "discount": 50000,
      "lineTotal": 900000
    }
  ],
  "subtotal": 900000,
  "promotionDiscount": 100000,
  "couponDiscount": 160000,
  "total": 640000
}
```

#### 5. Merge Guest Cart to User
```http
POST /cart/merge
Authorization: Bearer {token}

Body:
{
  "deviceId": "device_abc123",
  "clearGuestCart": true
}

Response:
{
  "success": true,
  "message": "Cart merged successfully",
  "data": {
    "mergedItems": 3,
    "totalItems": 5,
    "cart": {...}
  }
}
```

---

### Admin Endpoints (Ù…Ø­Ù…ÙŠØ© - Admin Only)

#### 1. Get Abandoned Carts
```http
GET /admin/carts/abandoned?days=1&limit=50
Authorization: Bearer {admin_token}

Response:
{
  "success": true,
  "data": [
    {
      "_id": "cart_123",
      "userId": "user_456",
      "userEmail": "user@example.com",
      "itemsCount": 3,
      "total": 250000,
      "currency": "YER",
      "lastActivityAt": "2024-01-14T15:30:00Z",
      "hoursSinceActivity": 25,
      "abandonmentEmailsSent": 1
    }
  ],
  "count": 15,
  "totalValue": 3750000
}
```

#### 2. Send Abandoned Cart Reminders
```http
POST /admin/carts/send-reminders
Authorization: Bearer {admin_token}

Response:
{
  "success": true,
  "message": "Sent 15 reminder emails",
  "data": {
    "emailsSent": 15,
    "failed": 0
  }
}
```

#### 3. Get Cart Analytics
```http
GET /admin/carts/analytics?period=7d
Authorization: Bearer {admin_token}

Response:
{
  "totalCarts": 450,
  "activeCarts": 280,
  "abandonedCarts": 120,
  "convertedCarts": 50,
  "abandonmentRate": "26.67%",
  "conversionRate": "11.11%",
  "avgCartValue": 175000,
  "totalValue": 78750000
}
```

---

## ğŸ’» CartService Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Ø§Ù„Ù…ÙŠØ«ÙˆØ¯Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

```typescript
class CartService {
  // ===== CRUD Operations =====
  âœ… getUserCart(userId)
  âœ… getGuestCart(deviceId)
  âœ… addUserItem(userId, variantId, qty)
  âœ… addGuestItem(deviceId, variantId, qty)
  âœ… updateUserItem(userId, itemId, qty)
  âœ… updateGuestItem(deviceId, itemId, qty)
  âœ… removeUserItem(userId, itemId)
  âœ… removeGuestItem(deviceId, itemId)
  âœ… clearUserCart(userId)
  âœ… clearGuestCart(deviceId)
  
  // ===== Pricing & Coupons =====
  âœ… calculateCartPricing(cart, currency, couponCode)
  âœ… applyCouponToCart(cartId, couponCode, userId)
  âœ… removeCouponFromCart(cartId, userId)
  âœ… autoApplyCoupons(cart, userId, accountType)
  âœ… recalculatePricing(cart)
  
  // ===== Product Snapshot =====
  âœ… enrichItemWithProductData(item, variant)
  âœ… updateAllSnapshots(cart)
  
  // ===== Merge & Migration =====
  âœ… mergeGuestToUser(deviceId, userId, clearGuest)
  âœ… migrateGuestCartOnLogin(deviceId, userId)
  
  // ===== Abandoned Carts =====
  âœ… markAsAbandoned(cart)
  âœ… findAbandonedCarts(hours)
  âœ… sendAbandonmentReminder(cartId)
  âœ… processAbandonedCarts()  // Cron Job
  
  // ===== Conversion Tracking =====
  âœ… markAsConverted(cartId, orderId)
  âœ… getConversionRate(period)
  
  // ===== Analytics =====
  âœ… getCartAnalytics(period)
  âœ… getAbandonmentStats(period)
  
  // ===== Cleanup =====
  âœ… cleanupExpiredCarts()  // Cron Job
  âœ… deleteOldConvertedCarts(days)
}
```

---

## ğŸ¨ Frontend Examples

### Ù…Ø«Ø§Ù„ 1: Guest Cart (Ø²Ø§Ø¦Ø± Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨)

```jsx
// ProductPage.jsx
import React, { useState } from 'react';
import { getDeviceId } from './utils';  // UUID Ù…Ù† localStorage

function ProductPage({ product, variant }) {
  async function addToCart() {
    const deviceId = getDeviceId();  // Ø¬Ù„Ø¨/Ø¥Ù†Ø´Ø§Ø¡ device ID

    const res = await fetch('/cart/guest/items', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        deviceId,
        variantId: variant._id,
        qty: 1,
        metadata: {
          source: 'web',
          utmSource: getUtmSource(),
        }
      }),
    });

    const data = await res.json();

    if (data.success) {
      alert('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©!');
      updateCartBadge(data.data.cart.items.length);
    }
  }

  return (
    <div className="product">
      <h1>{product.name}</h1>
      <div className="price">
        {variant.pricing.discount > 0 && (
          <span className="original">{variant.pricing.basePrice} YER</span>
        )}
        <span className="final">{variant.pricing.finalPrice} YER</span>
      </div>
      <button onClick={addToCart}>
        Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
      </button>
    </div>
  );
}

// utils.js
export function getDeviceId() {
  let deviceId = localStorage.getItem('deviceId');
  
  if (!deviceId) {
    deviceId = generateUUID();  // Ø£Ùˆ Ø£ÙŠ UUID generator
    localStorage.setItem('deviceId', deviceId);
  }
  
  return deviceId;
}
```

---

### Ù…Ø«Ø§Ù„ 2: Cart Page Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª

```jsx
// CartPage.jsx
import React, { useEffect, useState } from 'react';
import { getDeviceId, isLoggedIn, getToken } from './utils';

function CartPage() {
  const [cart, setCart] = useState(null);
  const [couponCode, setCouponCode] = useState('');
  const [couponError, setCouponError] = useState('');

  useEffect(() => {
    loadCart();
  }, []);

  async function loadCart() {
    const loggedIn = isLoggedIn();

    if (loggedIn) {
      // User cart
      const res = await fetch('/cart', {
        headers: { 'Authorization': `Bearer ${getToken()}` }
      });
      const data = await res.json();
      setCart(data.data);
    } else {
      // Guest cart
      const deviceId = getDeviceId();
      const res = await fetch(`/cart/guest?deviceId=${deviceId}`);
      const data = await res.json();
      setCart(data.data);
    }
  }

  async function applyCoupon() {
    setCouponError('');
    const loggedIn = isLoggedIn();

    try {
      const url = loggedIn ? '/cart/apply-coupon' : '/cart/guest/apply-coupon';
      const body = loggedIn
        ? { couponCode }
        : { deviceId: getDeviceId(), couponCode };

      const headers = loggedIn
        ? { 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' }
        : { 'Content-Type': 'application/json' };

      const res = await fetch(url, {
        method: 'POST',
        headers,
        body: JSON.stringify(body),
      });

      const data = await res.json();

      if (data.success) {
        setCart(data.data);
        setCouponCode('');
        alert(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†! ÙˆÙØ±Øª ${data.data.cart.pricingSummary.couponDiscount.toLocaleString()} YER`);
      } else {
        setCouponError(data.message);
      }
    } catch (error) {
      setCouponError('Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
  }

  async function removeCoupon() {
    const loggedIn = isLoggedIn();
    
    const url = loggedIn ? '/cart/coupon' : '/cart/guest/coupon';
    const options = loggedIn
      ? { method: 'DELETE', headers: { 'Authorization': `Bearer ${getToken()}` } }
      : { 
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceId: getDeviceId() })
        };

    const res = await fetch(url, options);
    const data = await res.json();

    if (data.success) {
      setCart(data.data);
    }
  }

  if (!cart) return <div>Loading...</div>;

  const summary = cart.cart.pricingSummary;

  return (
    <div className="cart-page">
      <h1>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h1>

      {cart.cart.items.length === 0 ? (
        <div className="empty-cart">
          <p>Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©</p>
          <button onClick={() => window.location.href = '/products'}>
            ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù†
          </button>
        </div>
      ) : (
        <>
          {/* Cart Items */}
          <div className="cart-items">
            {cart.cart.items.map((item, idx) => (
              <div key={idx} className="cart-item">
                <img src={item.productSnapshot.image} alt={item.productSnapshot.name} />
                
                <div className="item-info">
                  <h3>{item.productSnapshot.name}</h3>
                  {item.productSnapshot.brandName && (
                    <span className="brand">{item.productSnapshot.brandName}</span>
                  )}
                  
                  <div className="pricing">
                    {item.pricing.discount > 0 && (
                      <span className="original">
                        {item.pricing.basePrice.toLocaleString()} YER
                      </span>
                    )}
                    <span className="final">
                      {item.pricing.finalPrice.toLocaleString()} YER
                    </span>
                  </div>
                </div>

                <div className="quantity-controls">
                  <button onClick={() => updateQty(item._id, item.qty - 1)}>-</button>
                  <span>{item.qty}</span>
                  <button onClick={() => updateQty(item._id, item.qty + 1)}>+</button>
                </div>

                <div className="item-total">
                  {(item.pricing.finalPrice * item.qty).toLocaleString()} YER
                </div>

                <button onClick={() => removeItem(item._id)} className="remove">
                  âœ•
                </button>
              </div>
            ))}
          </div>

          {/* Coupon Section */}
          <div className="coupon-section">
            {cart.cart.appliedCouponCode ? (
              <div className="applied-coupon">
                <div>
                  ğŸ« <strong>{cart.cart.appliedCouponCode}</strong>
                  <span className="discount">
                    -{summary.couponDiscount.toLocaleString()} YER
                  </span>
                </div>
                <button onClick={removeCoupon}>Ø¥Ø²Ø§Ù„Ø©</button>
              </div>
            ) : (
              <div className="coupon-input">
                <input
                  type="text"
                  placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…"
                  value={couponCode}
                  onChange={(e) => setCouponCode(e.target.value.toUpperCase())}
                  onKeyPress={(e) => e.key === 'Enter' && applyCoupon()}
                />
                <button onClick={applyCoupon}>ØªØ·Ø¨ÙŠÙ‚</button>
              </div>
            )}
            {couponError && <div className="error">{couponError}</div>}
          </div>

          {/* Auto-Applied Coupons */}
          {cart.cart.autoAppliedCouponCodes && cart.cart.autoAppliedCouponCodes.length > 0 && (
            <div className="auto-coupons">
              <h4>ğŸ‰ Ø®ØµÙˆÙ…Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø·Ø¨Ù‚Ø©:</h4>
              {cart.cart.autoAppliedCouponCodes.map((code, idx) => (
                <div key={idx} className="auto-coupon">
                  <span>{code}</span>
                  <span>-{cart.cart.autoAppliedDiscounts[idx].toLocaleString()} YER</span>
                </div>
              ))}
            </div>
          )}

          {/* Summary */}
          <div className="cart-summary">
            <div className="summary-row">
              <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ ({summary.itemsCount} Ù…Ù†ØªØ¬Ø§Øª):</span>
              <span>{summary.subtotal.toLocaleString()} YER</span>
            </div>

            {summary.promotionDiscount > 0 && (
              <div className="summary-row discount">
                <span>Ø®ØµÙ… Ø§Ù„Ø¹Ø±ÙˆØ¶:</span>
                <span>-{summary.promotionDiscount.toLocaleString()} YER</span>
              </div>
            )}

            {summary.couponDiscount > 0 && (
              <div className="summary-row discount">
                <span>Ø®ØµÙ… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ({cart.cart.appliedCouponCode}):</span>
                <span>-{summary.couponDiscount.toLocaleString()} YER</span>
              </div>
            )}

            {summary.autoDiscount > 0 && (
              <div className="summary-row discount">
                <span>Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ:</span>
                <span>-{summary.autoDiscount.toLocaleString()} YER</span>
              </div>
            )}

            {summary.totalDiscount > 0 && (
              <div className="summary-row total-discount">
                <span>Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                <span>-{summary.totalDiscount.toLocaleString()} YER</span>
              </div>
            )}

            <div className="summary-row total">
              <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
              <span>{summary.total.toLocaleString()} YER</span>
            </div>

            {summary.totalDiscount > 0 && (
              <div className="savings-badge">
                ğŸ‰ ÙˆÙØ±Øª {summary.totalDiscount.toLocaleString()} YER!
              </div>
            )}
          </div>

          {/* Checkout Button */}
          <button
            className="checkout-btn"
            onClick={() => {
              if (isLoggedIn()) {
                window.location.href = '/checkout';
              } else {
                // Save cart and redirect to login
                window.location.href = '/login?returnTo=checkout';
              }
            }}
          >
            {isLoggedIn() ? 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡' : 'Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡'}
          </button>
        </>
      )}
    </div>
  );
}
```

---

### Ù…Ø«Ø§Ù„ 3: Auto-merge Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„

```jsx
// LoginPage.jsx
async function handleLogin(phone, password) {
  const res = await fetch('/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone, password }),
  });

  const data = await res.json();

  if (data.success) {
    // Save token
    localStorage.setItem('token', data.token);

    // Auto-merge guest cart âœ…
    const deviceId = getDeviceId();
    
    if (deviceId) {
      const mergeRes = await fetch('/cart/merge', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${data.token}`
        },
        body: JSON.stringify({
          deviceId,
          clearGuestCart: true
        }),
      });

      const mergeData = await mergeRes.json();

      if (mergeData.success && mergeData.data.mergedItems > 0) {
        alert(`âœ… ØªÙ… Ø¯Ù…Ø¬ ${mergeData.data.mergedItems} Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø³Ù„ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©!`);
      }
    }

    // Redirect
    const returnTo = new URLSearchParams(window.location.search).get('returnTo');
    window.location.href = returnTo || '/';
  }
}
```

---

## ğŸ“§ Abandoned Cart Email Example

```html
<!-- Abandonment Email Template -->
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø³ÙŠØª Ø´ÙŠØ¦Ø§Ù‹ ÙÙŠ Ø³Ù„ØªÙƒ!</title>
</head>
<body style="font-family: Arial, sans-serif;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ {{userName}}! ğŸ‘‹</h1>
    
    <p>Ù„Ø§Ø­Ø¸Ù†Ø§ Ø£Ù†Ùƒ ØªØ±ÙƒØª Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚:</p>
    
    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px;">
      {{#each items}}
      <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
        <img src="{{this.image}}" style="width: 80px; height: 80px; object-fit: cover;">
        <div>
          <strong>{{this.name}}</strong>
          <p>Ø§Ù„ÙƒÙ…ÙŠØ©: {{this.qty}}</p>
          <p>Ø§Ù„Ø³Ø¹Ø±: {{this.price}} YER</p>
        </div>
      </div>
      {{/each}}
    </div>
    
    <div style="margin: 20px 0; padding: 15px; background: #e8f5e9; border-radius: 5px;">
      <p style="font-size: 18px; margin: 0;">
        Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <strong>{{totalAmount}} YER</strong>
      </p>
    </div>
    
    {{#if specialCoupon}}
    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; text-align: center;">
      <p>ğŸ Ø®ØµÙ… Ø®Ø§Øµ Ù„Ùƒ!</p>
      <p>Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯: <strong style="font-size: 24px;">{{specialCoupon}}</strong></p>
      <p>ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®ØµÙ… 10%</p>
    </div>
    {{/if}}
    
    <div style="text-align: center; margin-top: 30px;">
      <a href="{{cartUrl}}" style="display: inline-block; padding: 15px 40px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px; font-size: 18px;">
        Ø£ÙƒÙ…Ù„ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¢Ù†
      </a>
    </div>
    
    <p style="color: #999; font-size: 12px; text-align: center; margin-top: 30px;">
      Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ø¯ÙˆØ¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©. Ù„Ø§ ØªÙÙˆØª Ø§Ù„ÙØ±ØµØ©!
    </p>
  </div>
</body>
</html>
```

---

## ğŸ¤– Cron Jobs Ù„Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©

```typescript
// backend/src/modules/cart/cart.cron.ts

import { Injectable, Logger } from '@nestjs/common';
import { Cron, CronExpression } from '@nestjs/schedule';
import { CartService } from './cart.service';

@Injectable()
export class CartCronService {
  private readonly logger = new Logger(CartCronService.name);

  constructor(private cartService: CartService) {}

  // ÙƒÙ„ Ø³Ø§Ø¹Ø© â†’ ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙŠØ©
  @Cron(CronExpression.EVERY_HOUR)
  async handleAbandonedCarts() {
    this.logger.log('Checking for abandoned carts...');
    
    try {
      const result = await this.cartService.processAbandonedCarts();
      this.logger.log(`Processed ${result.found} abandoned carts, sent ${result.emailsSent} emails`);
    } catch (error) {
      this.logger.error('Error processing abandoned carts:', error);
    }
  }

  // ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹ â†’ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
  @Cron('0 2 * * *')
  async cleanupExpiredCarts() {
    this.logger.log('Cleaning up expired carts...');
    
    try {
      const result = await this.cartService.cleanupExpiredCarts();
      this.logger.log(`Deleted ${result.deleted} expired carts`);
    } catch (error) {
      this.logger.error('Error cleaning up carts:', error);
    }
  }

  // ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹ â†’ Ø­Ø°Ù Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  @Cron(CronExpression.EVERY_WEEK)
  async cleanupOldConvertedCarts() {
    this.logger.log('Cleaning up old converted carts...');
    
    try {
      const result = await this.cartService.deleteOldConvertedCarts(90); // 90 days
      this.logger.log(`Deleted ${result.deleted} old converted carts`);
    } catch (error) {
      this.logger.error('Error cleaning up converted carts:', error);
    }
  }
}
```

---

## âœ… Ø§Ù„Ù…Ù„Ø®Øµ

### Ù…Ø§ ØªÙ… ØªÙ†ÙÙŠØ°Ù‡:

#### 1. Schema Ù…Ø­Ø³Ù‘Ù† Ø¬Ø¯Ø§Ù‹ âœ…
- ğŸ†• 20+ Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯
- ğŸ†• Cart Status (active/abandoned/converted/expired)
- ğŸ†• Product Snapshot (Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬)
- ğŸ†• Pricing Cache (Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±)
- ğŸ†• Coupon Support (ÙƒØ§Ù…Ù„)
- ğŸ†• Abandoned Cart Tracking
- ğŸ†• Conversion Tracking
- ğŸ†• Merge Tracking
- ğŸ†• Metadata & UTM
- ğŸ†• Expiration Support

#### 2. CartService Ø§Ø­ØªØ±Ø§ÙÙŠ âœ…
- 25+ method Ø§Ø­ØªØ±Ø§ÙÙŠ
- Ø¯Ø¹Ù… Guest Ùˆ User
- ØªÙƒØ§Ù…Ù„ Ù…Ø¹ PricingService
- ØªÙƒØ§Ù…Ù„ Ù…Ø¹ CouponsService
- Product snapshot enrichment
- Abandoned cart logic
- Conversion tracking
- Analytics

#### 3. DTOs Ù…Ø­Ø³Ù‘Ù†Ø© âœ…
- Validation ÙƒØ§Ù…Ù„
- ApiProperty Ù„Ù„ØªÙˆØ«ÙŠÙ‚
- Guest DTOs Ù…Ù†ÙØµÙ„Ø©
- ApplyCouponDto
- MergeCartDto

#### 4. Controllers Ù…Ø­Ø³Ù‘Ù†Ø© âœ…
- User Cart Controller
- Guest Cart Controller
- Admin Cart Controller (Ø¬Ø¯ÙŠØ¯)
- Abandoned Carts Management

#### 5. Cron Jobs âœ…
- ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙŠØ© (ÙƒÙ„ Ø³Ø§Ø¹Ø©)
- Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
- ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© (ÙŠÙˆÙ…ÙŠ)
- Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£Ø³Ø¨ÙˆØ¹ÙŠ)

---

## ğŸ”— Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙƒØ§Ù…Ù„

### Ù…Ø¹ Pricing Service:
```typescript
// Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬:
const pricing = await this.pricingService.calculateVariantPrice({
  variantId,
  currency,
  quantity,
});

// ÙŠÙØ­ÙØ¸ ÙÙŠ item.pricing
```

### Ù…Ø¹ Coupons Service:
```typescript
// Ø¹Ù†Ø¯ ØªØ·Ø¨ÙŠÙ‚ ÙƒÙˆØ¨ÙˆÙ†:
const validation = await this.couponsService.validateCoupon({...});

if (validation.valid) {
  cart.appliedCouponCode = couponCode;
  cart.couponDiscount = validation.calculatedDiscount;
}
```

### Ù…Ø¹ Checkout:
```typescript
// Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡:
await this.cartService.markAsConverted(cartId, orderId);

// Cart status â†’ 'converted'
// convertedToOrderId â†’ order._id
```

---

## ğŸ“Š Analytics Dashboard Example

```jsx
// AdminCartAnalytics.jsx
function CartAnalytics() {
  const [analytics, setAnalytics] = useState(null);
  const [abandonedCarts, setAbandonedCarts] = useState([]);

  useEffect(() => {
    loadAnalytics();
    loadAbandonedCarts();
  }, []);

  async function loadAnalytics() {
    const res = await fetch('/admin/carts/analytics?period=7d', {
      headers: { 'Authorization': `Bearer ${getAdminToken()}` }
    });
    const data = await res.json();
    setAnalytics(data.data);
  }

  async function loadAbandonedCarts() {
    const res = await fetch('/admin/carts/abandoned?days=1', {
      headers: { 'Authorization': `Bearer ${getAdminToken()}` }
    });
    const data = await res.json();
    setAbandonedCarts(data.data);
  }

  if (!analytics) return <div>Loading...</div>;

  return (
    <div className="cart-analytics">
      <h1>ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ù„Ø§Øª</h1>

      {/* Stats Cards */}
      <div className="stats-grid">
        <div className="stat-card">
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ø§Øª</h3>
          <div className="number">{analytics.totalCarts}</div>
        </div>

        <div className="stat-card">
          <h3>Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
          <div className="number">{analytics.activeCarts}</div>
        </div>

        <div className="stat-card abandoned">
          <h3>Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙŠØ©</h3>
          <div className="number">{analytics.abandonedCarts}</div>
          <div className="percentage">
            Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ®Ù„ÙŠ: {analytics.abandonmentRate}
          </div>
        </div>

        <div className="stat-card converted">
          <h3>Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙˆÙ„Ø©</h3>
          <div className="number">{analytics.convertedCarts}</div>
          <div className="percentage">
            Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„: {analytics.conversionRate}
          </div>
        </div>

        <div className="stat-card">
          <h3>Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„Ø©</h3>
          <div className="number">
            {analytics.avgCartValue.toLocaleString()} YER
          </div>
        </div>

        <div className="stat-card">
          <h3>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h3>
          <div className="number">
            {analytics.totalValue.toLocaleString()} YER
          </div>
        </div>
      </div>

      {/* Abandoned Carts Table */}
      <div className="abandoned-carts-section">
        <h2>Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙŠØ© (Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©)</h2>
        
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
              <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
              <th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</th>
              <th>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            {abandonedCarts.map(cart => (
              <tr key={cart._id}>
                <td>{cart.userEmail}</td>
                <td>{cart.itemsCount}</td>
                <td>{cart.total.toLocaleString()} YER</td>
                <td>{cart.hoursSinceActivity} Ø³Ø§Ø¹Ø©</td>
                <td>{cart.abandonmentEmailsSent}</td>
                <td>
                  <button onClick={() => sendReminder(cart._id)}>
                    Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        <div className="total-value">
          Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙŠØ©: 
          <strong>{abandonedCarts.reduce((sum, c) => sum + c.total, 0).toLocaleString()} YER</strong>
        </div>
      </div>
    </div>
  );
}
```

---

**Ø§Ù„Ù†Ø¸Ø§Ù… ÙƒØ§Ù…Ù„! Ø§Ù„Ø¢Ù† Ø³Ø£Ù†Ø´Ø¦ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù€ CartService...**

