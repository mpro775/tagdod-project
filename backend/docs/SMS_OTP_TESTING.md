# ุฏููู ุงุฎุชุจุงุฑ OTP ุนุจุฑ SMS

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุถุงูุฉ ููุฒุฉ ุฅุฑุณุงู OTP ุนุจุฑ SMS ุนูุฏ ุฅูุดุงุก ุงูุญุณุงุจ. ุงููุธุงู ูููู ุชููุงุฆูุงู ุจู:
1. ุชุทุจูุน ุฃุฑูุงู ุงูููุงุชู ุงูููููุฉ (ุฅุถุงูุฉ +967)
2. ุฅุฑุณุงู OTP ุนุจุฑ SMS ุจุนุฏ ุฅูุดุงุก ุงูุญุณุงุจ
3. ุฏุนู ุฌููุน ุตูุบ ุงูุฃุฑูุงู ุงูููููุฉ

---

## ๐ฑ ุตูุบ ุงูุฃุฑูุงู ุงููุฏุนููุฉ

ุงููุธุงู ูุฏุนู ุงูุตูุบ ุงูุชุงููุฉ ูุฃุฑูุงู ุงูููุงุชู ุงูููููุฉ:

- `0501234567` โ `+967501234567`
- `501234567` โ `+967501234567`
- `712345678` โ `+967712345678`
- `+967501234567` โ `+967501234567` (ููุจูู ููุง ูู)
- `967501234567` โ `+967501234567`

### ุงููุดุบููู ุงููุฏุนูููู:
- **+96773** - MTN
- **+96771** - Sabafon
- **+96770** - Y Telecom
- **+96777** - Yemen Mobile

---

## ๐งช ุงุฎุชุจุงุฑ ูู Postman

### 1. ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ ูุน ุฅุฑุณุงู OTP

**Endpoint:**
```
POST http://localhost:3000/auth/user-signup
```

**Headers:**
```json
{
  "Content-Type": "application/json"
}
```

**Request Body:**
```json
{
  "phone": "775019485",
  "password": "MyPassword123!",
  "firstName": "ุฃุญูุฏ",
  "lastName": "ูุญูุฏ",
  "gender": "male",
  "city": "ุตูุนุงุก"
}
```

**ููุงุญุธุฉ:** ููููู ุฅุฏุฎุงู ุงูุฑูู ุจุฏูู `+967` - ุณูุชู ุฅุถุงูุชูุง ุชููุงุฆูุงู!

**Response (ูุฌุงุญ):**
```json
{
  "success": true,
  "message": "ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ. ูุฑุฌู ุงูุชุญูู ูู ุฑูู ุงููุงุชู ุนุจุฑ ุฑูุฒ OTP ุงููุฑุณู",
  "phone": "+967775019485",
  "requiresVerification": true
}
```

**โ๏ธ ููู:** ุงูุญุณุงุจ ูููุดุฃ ุจุญุงูุฉ `PENDING` - ูุฌุจ ุงูุชุญูู ูู OTP ุฃููุงู!

**ูุง ูุญุฏุซ:**
1. โ ูุชู ุชุทุจูุน ุงูุฑูู ูู `775019485` ุฅูู `+967775019485`
2. โ ูุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจุญุงูุฉ `PENDING` (ุบูุฑ ููุนูู)
3. โ ูุชู ุฅุฑุณุงู OTP ุนุจุฑ SMS ุชููุงุฆูุงู ุฅูู `+967775019485`
4. โ๏ธ **ูุง ูุชู ุฅุฑุฌุงุน Tokens** - ูุฌุจ ุงูุชุญูู ูู OTP ุฃููุงู

---

### 2. ุฅุฑุณุงู OTP ูุฏููุงู

**Endpoint:**
```
POST http://localhost:3000/auth/send-otp
```

**Request Body:**
```json
{
  "phone": "775019485",
  "context": "register"
}
```

**Response:**
```json
{
  "sent": true,
  "devCode": "123456"
}
```

**ููุงุญุธุฉ:** `devCode` ููุฌูุฏ ููุท ูู ุจูุฆุฉ ุงูุชุทููุฑ (`OTP_DEV_ECHO=true`)

---

### 3. ุงูุชุญูู ูู OTP ูุชูุนูู ุงูุญุณุงุจ

**Endpoint:**
```
POST http://localhost:3000/auth/verify-otp
```

**Request Body:**
```json
{
  "phone": "775019485",
  "code": "123456"
}
```

**ููุงุญุธุฉ:** ููููู ุฅุฏุฎุงู ุงูุฑูู ุจุฏูู `+967` - ุณูุชู ุชุทุจูุนู ุชููุงุฆูุงู!

**Response (ูุฌุงุญ):**
```json
{
  "tokens": {
    "access": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  },
  "me": {
    "id": "507f1f77bcf86cd799439011",
    "phone": "+967775019485",
    "firstName": "ุฃุญูุฏ",
    "lastName": "ูุญูุฏ",
    "gender": "male",
    "city": "ุตูุนุงุก",
    "roles": [],
    "permissions": [],
    "isAdmin": false,
    "preferredCurrency": "USD",
    "status": "active"
  }
}
```

**ูุง ูุญุฏุซ:**
1. โ ูุชู ุชุทุจูุน ุงูุฑูู ูู `775019485` ุฅูู `+967775019485`
2. โ ูุชู ุงูุชุญูู ูู OTP ูู Redis
3. โ ุฅุฐุง ูุงู ุงูุญุณุงุจ ููุฌูุฏุงู ุจุญุงูุฉ `PENDING`ุ ูุชู ุชูุนููู ุฅูู `ACTIVE`
4. โ ูุชู ุฅุฑุฌุงุน Tokens ูููุณุชุฎุฏู

---

## โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุจูุฆุฉ

ุชุฃูุฏ ูู ุฅุถุงูุฉ ุงููุชุบูุฑุงุช ุงูุชุงููุฉ ูู ููู `.env`:

```env
# SMS Provider
SMS_PROVIDER=alawael

# Alawael SMS Configuration
ALAWAEL_SMS_ORG_NAME=Demosms
ALAWAEL_SMS_USER_NAME=Tagdodapp
ALAWAEL_SMS_PASSWORD=Tagdodapp@277
ALAWAEL_SMS_BASE_URL=https://sms.alawaeltec.com

# OTP Configuration
OTP_TTL_SECONDS=300
OTP_LENGTH=6
OTP_DEV_ECHO=true  # ููุญุตูู ุนูู OTP ูู Response (ููุชุทููุฑ ููุท)
```

---

## ๐ ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### ุงูุณููุงุฑูู 1: ุฅูุดุงุก ุญุณุงุจ ุจุฑูู ุจุฏูู +967
```json
{
  "phone": "775019485",
  ...
}
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุชู ุชุทุจูุน ุงูุฑูู ุฅูู `+967775019485` ูุฅุฑุณุงู OTP

### ุงูุณููุงุฑูู 2: ุฅูุดุงุก ุญุณุงุจ ุจุฑูู ุจุตูุบุฉ 05
```json
{
  "phone": "0501234567",
  ...
}
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุชู ุชุทุจูุน ุงูุฑูู ุฅูู `+967501234567` ูุฅุฑุณุงู OTP

### ุงูุณููุงุฑูู 3: ุฅูุดุงุก ุญุณุงุจ ุจุฑูู ุจุตูุบุฉ +967
```json
{
  "phone": "+967775019485",
  ...
}
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุชู ูุจูู ุงูุฑูู ููุง ูู ูุฅุฑุณุงู OTP

### ุงูุณููุงุฑูู 4: ุฑูู ุบูุฑ ุตุญูุญ
```json
{
  "phone": "123456789",
  ...
}
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ุฎุทุฃ ูู ุงูุชุญูู - ุฑูู ุบูุฑ ุตุญูุญ

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุชุทุจูุน ุชููุงุฆู:** ุฌููุน ุงูุฃุฑูุงู ูุชู ุชุทุจูุนูุง ุชููุงุฆูุงู ุฅูู `+967XXXXXXXXX`
2. **ุฅุฑุณุงู SMS:** ูุชู ุฅุฑุณุงู OTP ุนุจุฑ SMS ุชููุงุฆูุงู ุนูุฏ ุฅูุดุงุก ุงูุญุณุงุจ
3. **ุชูุนูู ุงูุญุณุงุจ:** ุงูุญุณุงุจ ูููุดุฃ ุจุญุงูุฉ `PENDING` ููุชู ุชูุนููู ุฅูู `ACTIVE` ุนูุฏ ุงูุชุญูู ูู OTP
4. **ุงูุชุญูู ุงูุฅูุฒุงูู:** ูุง ูููู ุชุณุฌูู ุงูุฏุฎูู ุจูููุฉ ุงููุฑูุฑ ุญุชู ูุชู ุงูุชุญูู ูู OTP
5. **Fallback:** ุฅุฐุง ูุดู ุฅุฑุณุงู SMSุ ูุชู ุญูุธ OTP ูู Redis ููููู ุงูุชุญูู ููู
6. **Logging:** ุฌููุน ุงูุนูููุงุช ูุชู ุชุณุฌูููุง ูู Logs

## ๐ ุงูุชุฏูู ุงููุงูู

### ุงูุณููุงุฑูู 1: ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
1. **POST** `/auth/user-signup` โ ุงูุญุณุงุจ ูููุดุฃ ุจุญุงูุฉ `PENDING` + ุฅุฑุณุงู OTP
2. **POST** `/auth/verify-otp` โ ุงูุชุญูู ูู OTP + ุชูุนูู ุงูุญุณุงุจ ุฅูู `ACTIVE` + ุฅุฑุฌุงุน Tokens
3. **POST** `/auth/user-login` โ ุชุณุฌูู ุงูุฏุฎูู ุจูููุฉ ุงููุฑูุฑ (ุงูุขู ูููู ูุฃู ุงูุญุณุงุจ `ACTIVE`)

### ุงูุณููุงุฑูู 2: ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู ูุจู ุงูุชุญูู
1. **POST** `/auth/user-signup` โ ุงูุญุณุงุจ `PENDING`
2. **POST** `/auth/user-login` โ โ ุฎุทุฃ: "ุงูุญุณุงุจ ูู ุงูุชุธุงุฑ ุงูุชุญูู ูู ุฑูู ุงููุงุชู"
3. **POST** `/auth/verify-otp` โ ุชูุนูู ุงูุญุณุงุจ
4. **POST** `/auth/user-login` โ โ ูุฌุงุญ

### ุงูุณููุงุฑูู 3: ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ
1. **POST** `/auth/forgot-password` โ ุฅุฑุณุงู OTP ุนุจุฑ SMS
2. **POST** `/auth/reset-password` โ ุงูุชุญูู ูู OTP + ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ

---

## 4. ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ

### 4.1. ุทูุจ OTP ูุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ

**Endpoint:** `POST http://localhost:3000/auth/forgot-password`

**Body:**
```json
{
  "phone": "775815074"
}
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุชู ุชุทุจูุน ุงูุฑูู ูู `775815074` ุฅูู `+967775815074`
- โ ูุชู ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ูุชู ุฅุฑุณุงู OTP ุนุจุฑ SMS ุฅูู `+967775815074`
- โ Response:
  ```json
  {
    "success": true,
    "data": {
      "sent": true,
      "devCode": "123456"
    }
  }
  ```

### 4.2. ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ ุจุงุณุชุฎุฏุงู OTP

**Endpoint:** `POST http://localhost:3000/auth/reset-password`

**Body:**
```json
{
  "phone": "775815074",
  "code": "123456",
  "newPassword": "MyNewPassword123!"
}
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุชู ุชุทุจูุน ุงูุฑูู ูู `775815074` ุฅูู `+967775815074`
- โ ูุชู ุงูุชุญูู ูู OTP ูู Redis
- โ ูุชู ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู
- โ ูุชู ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ Response:
  ```json
  {
    "success": true,
    "data": {
      "updated": true
    }
  }
  ```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: OTP ูุง ูุตู ุนุจุฑ SMS

**ุงูุชุญูู ูู:**
1. โ ูุชุบูุฑุงุช ุงูุจูุฆุฉ `ALAWAEL_SMS_*` ููุฌูุฏุฉ ูุตุญูุญุฉ
2. โ `SMS_PROVIDER=alawael` ูู `.env`
3. โ ุฑุตูุฏ SMS ูู ุญุณุงุจ Alawael
4. โ Logs ุงูุณูุฑูุฑ ููุฃุฎุทุงุก

### ุงููุดููุฉ: ุฑูู ุงููุงุชู ุบูุฑ ููุจูู

**ุงูุชุญูู ูู:**
1. โ ุงูุฑูู ูุจุฏุฃ ุจู `05`, `5`, `7`, ุฃู `+967`
2. โ ุงูุฑูู ูุญุชูู ุนูู 9-10 ุฃุฑูุงู (ุจุนุฏ ุฅุฒุงูุฉ ุงูุจุงุฏุฆุฉ)
3. โ ุงูุฑูู ูุชุจุน ุฃุญุฏ ุงููุดุบููู ุงููุฏุนูููู

---

## ๐ ุฏุนู

ูููุณุงุนุฏุฉุ ุฑุงุฌุน:
- [SMS Integration Guide](../modules/notifications/README.md)
- [Auth Module README](../modules/auth/README.md)

